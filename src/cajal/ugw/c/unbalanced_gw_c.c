// Generated by Futhark 0.26.0 (prerelease - include info below when reporting bugs).
// Compiled with GHC 9.4.7.

// We need to define _GNU_SOURCE before
// _any_ headers files are imported to get
// the usage statistics of a thread (i.e. have RUSAGE_THREAD) on GNU/Linux
// https://manpages.courier-mta.org/htmlman2/getrusage.2.html
#ifndef _GNU_SOURCE // Avoid possible double-definition warning.
#define _GNU_SOURCE
#endif

#ifdef __clang__
#pragma clang diagnostic ignored "-Wunused-function"
#pragma clang diagnostic ignored "-Wunused-variable"
#pragma clang diagnostic ignored "-Wunused-const-variable"
#pragma clang diagnostic ignored "-Wparentheses"
#pragma clang diagnostic ignored "-Wunused-label"
#pragma clang diagnostic ignored "-Wunused-but-set-variable"
#elif __GNUC__
#pragma GCC diagnostic ignored "-Wunused-function"
#pragma GCC diagnostic ignored "-Wunused-variable"
#pragma GCC diagnostic ignored "-Wunused-const-variable"
#pragma GCC diagnostic ignored "-Wparentheses"
#pragma GCC diagnostic ignored "-Wunused-label"
#pragma GCC diagnostic ignored "-Wunused-but-set-variable"
#endif

// Headers
#include <stdint.h>
#include <stddef.h>
#include <stdbool.h>
#include <stdio.h>
#include <float.h>

#ifdef __cplusplus
extern "C" {
#endif

// Initialisation
struct futhark_context_config;
struct futhark_context_config *futhark_context_config_new(void);
void futhark_context_config_free(struct futhark_context_config *cfg);
int futhark_context_config_set_tuning_param(struct futhark_context_config *cfg, const char *param_name, size_t new_value);
struct futhark_context;
struct futhark_context *futhark_context_new(struct futhark_context_config *cfg);
void futhark_context_free(struct futhark_context *cfg);
void futhark_context_config_set_debugging(struct futhark_context_config *cfg, int flag);
void futhark_context_config_set_profiling(struct futhark_context_config *cfg, int flag);
void futhark_context_config_set_logging(struct futhark_context_config *cfg, int flag);
int futhark_get_tuning_param_count(void);
const char *futhark_get_tuning_param_name(int);
const char *futhark_get_tuning_param_class(int);

// Arrays
struct futhark_f64_1d;
struct futhark_f64_1d *futhark_new_f64_1d(struct futhark_context *ctx, const double *data, int64_t dim0);
struct futhark_f64_1d *futhark_new_raw_f64_1d(struct futhark_context *ctx, unsigned char *data, int64_t dim0);
int futhark_free_f64_1d(struct futhark_context *ctx, struct futhark_f64_1d *arr);
int futhark_values_f64_1d(struct futhark_context *ctx, struct futhark_f64_1d *arr, double *data);
int futhark_index_f64_1d(struct futhark_context *ctx, double *out, struct futhark_f64_1d *arr, int64_t i0);
unsigned char *futhark_values_raw_f64_1d(struct futhark_context *ctx, struct futhark_f64_1d *arr);
const int64_t *futhark_shape_f64_1d(struct futhark_context *ctx, struct futhark_f64_1d *arr);
struct futhark_f64_2d;
struct futhark_f64_2d *futhark_new_f64_2d(struct futhark_context *ctx, const double *data, int64_t dim0, int64_t dim1);
struct futhark_f64_2d *futhark_new_raw_f64_2d(struct futhark_context *ctx, unsigned char *data, int64_t dim0, int64_t dim1);
int futhark_free_f64_2d(struct futhark_context *ctx, struct futhark_f64_2d *arr);
int futhark_values_f64_2d(struct futhark_context *ctx, struct futhark_f64_2d *arr, double *data);
int futhark_index_f64_2d(struct futhark_context *ctx, double *out, struct futhark_f64_2d *arr, int64_t i0, int64_t i1);
unsigned char *futhark_values_raw_f64_2d(struct futhark_context *ctx, struct futhark_f64_2d *arr);
const int64_t *futhark_shape_f64_2d(struct futhark_context *ctx, struct futhark_f64_2d *arr);
struct futhark_f64_3d;
struct futhark_f64_3d *futhark_new_f64_3d(struct futhark_context *ctx, const double *data, int64_t dim0, int64_t dim1, int64_t dim2);
struct futhark_f64_3d *futhark_new_raw_f64_3d(struct futhark_context *ctx, unsigned char *data, int64_t dim0, int64_t dim1, int64_t dim2);
int futhark_free_f64_3d(struct futhark_context *ctx, struct futhark_f64_3d *arr);
int futhark_values_f64_3d(struct futhark_context *ctx, struct futhark_f64_3d *arr, double *data);
int futhark_index_f64_3d(struct futhark_context *ctx, double *out, struct futhark_f64_3d *arr, int64_t i0, int64_t i1, int64_t i2);
unsigned char *futhark_values_raw_f64_3d(struct futhark_context *ctx, struct futhark_f64_3d *arr);
const int64_t *futhark_shape_f64_3d(struct futhark_context *ctx, struct futhark_f64_3d *arr);

// Opaque values



// Entry points
int futhark_entry_ugw_armijo(struct futhark_context *ctx, struct futhark_f64_1d **out0, const double in0, const double in1, const double in2, const struct futhark_f64_2d *in3, const struct futhark_f64_1d *in4, const struct futhark_f64_2d *in5, const struct futhark_f64_1d *in6, const double in7, const double in8, const double in9, const double in10);
int futhark_entry_ugw_armijo_euclidean(struct futhark_context *ctx, struct futhark_f64_2d **out0, const double in0, const double in1, const double in2, const struct futhark_f64_3d *in3, const double in4, const double in5, const double in6, const double in7);
int futhark_entry_ugw_armijo_pairwise(struct futhark_context *ctx, struct futhark_f64_2d **out0, const double in0, const double in1, const double in2, const struct futhark_f64_3d *in3, const struct futhark_f64_2d *in4, const double in5, const double in6, const double in7, const double in8);
int futhark_entry_ugw_armijo_pairwise_unif(struct futhark_context *ctx, struct futhark_f64_2d **out0, const double in0, const double in1, const double in2, const struct futhark_f64_3d *in3, const double in4, const double in5, const double in6, const double in7);

// Miscellaneous
int futhark_context_sync(struct futhark_context *ctx);
void futhark_context_config_set_cache_file(struct futhark_context_config *cfg, const char *f);
char *futhark_context_get_error(struct futhark_context *ctx);
void futhark_context_set_logging_file(struct futhark_context *ctx, FILE *f);
void futhark_context_pause_profiling(struct futhark_context *ctx);
void futhark_context_unpause_profiling(struct futhark_context *ctx);
char *futhark_context_report(struct futhark_context *ctx);
int futhark_context_clear_caches(struct futhark_context *ctx);
#define FUTHARK_BACKEND_c
#define FUTHARK_SUCCESS 0
#define FUTHARK_PROGRAM_ERROR 2
#define FUTHARK_OUT_OF_MEMORY 3

#ifdef __cplusplus
}
#endif

#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>
#include <math.h>
#include <stdint.h>
// If NDEBUG is set, the assert() macro will do nothing. Since Futhark
// (unfortunately) makes use of assert() for error detection (and even some
// side effects), we want to avoid that.
#undef NDEBUG
#include <assert.h>
#include <stdarg.h>
#define SCALAR_FUN_ATTR static inline
// Start of util.h.
//
// Various helper functions that are useful in all generated C code.

#include <errno.h>
#include <string.h>

static const char *fut_progname = "(embedded Futhark)";

static void futhark_panic(int eval, const char *fmt, ...) __attribute__((noreturn));
static char* msgprintf(const char *s, ...);
static void* slurp_file(const char *filename, size_t *size);
static int dump_file(const char *file, const void *buf, size_t n);
struct str_builder;
static void str_builder_init(struct str_builder *b);
static void str_builder(struct str_builder *b, const char *s, ...);
static char *strclone(const char *str);

static void futhark_panic(int eval, const char *fmt, ...) {
  va_list ap;
  va_start(ap, fmt);
  fprintf(stderr, "%s: ", fut_progname);
  vfprintf(stderr, fmt, ap);
  va_end(ap);
  exit(eval);
}

// For generating arbitrary-sized error messages.  It is the callers
// responsibility to free the buffer at some point.
static char* msgprintf(const char *s, ...) {
  va_list vl;
  va_start(vl, s);
  size_t needed = 1 + (size_t)vsnprintf(NULL, 0, s, vl);
  char *buffer = (char*) malloc(needed);
  va_start(vl, s); // Must re-init.
  vsnprintf(buffer, needed, s, vl);
  return buffer;
}

static inline void check_err(int errval, int sets_errno, const char *fun, int line,
                             const char *msg, ...) {
  if (errval) {
    char errnum[10];

    va_list vl;
    va_start(vl, msg);

    fprintf(stderr, "ERROR: ");
    vfprintf(stderr, msg, vl);
    fprintf(stderr, " in %s() at line %d with error code %s\n",
            fun, line,
            sets_errno ? strerror(errno) : errnum);
    exit(errval);
  }
}

#define CHECK_ERR(err, ...) check_err(err, 0, __func__, __LINE__, __VA_ARGS__)
#define CHECK_ERRNO(err, ...) check_err(err, 1, __func__, __LINE__, __VA_ARGS__)

// Read the rest of an open file into a NUL-terminated string; returns
// NULL on error.
static void* fslurp_file(FILE *f, size_t *size) {
  long start = ftell(f);
  fseek(f, 0, SEEK_END);
  long src_size = ftell(f)-start;
  fseek(f, start, SEEK_SET);
  unsigned char *s = (unsigned char*) malloc((size_t)src_size + 1);
  if (fread(s, 1, (size_t)src_size, f) != (size_t)src_size) {
    free(s);
    s = NULL;
  } else {
    s[src_size] = '\0';
  }

  if (size) {
    *size = (size_t)src_size;
  }

  return s;
}

// Read a file into a NUL-terminated string; returns NULL on error.
static void* slurp_file(const char *filename, size_t *size) {
  FILE *f = fopen(filename, "rb"); // To avoid Windows messing with linebreaks.
  if (f == NULL) return NULL;
  unsigned char *s = fslurp_file(f, size);
  fclose(f);
  return s;
}

// Dump 'n' bytes from 'buf' into the file at the designated location.
// Returns 0 on success.
static int dump_file(const char *file, const void *buf, size_t n) {
  FILE *f = fopen(file, "w");

  if (f == NULL) {
    return 1;
  }

  if (fwrite(buf, sizeof(char), n, f) != n) {
    return 1;
  }

  if (fclose(f) != 0) {
    return 1;
  }

  return 0;
}

struct str_builder {
  char *str;
  size_t capacity; // Size of buffer.
  size_t used; // Bytes used, *not* including final zero.
};

static void str_builder_init(struct str_builder *b) {
  b->capacity = 10;
  b->used = 0;
  b->str = malloc(b->capacity);
  b->str[0] = 0;
}

static void str_builder(struct str_builder *b, const char *s, ...) {
  va_list vl;
  va_start(vl, s);
  size_t needed = (size_t)vsnprintf(NULL, 0, s, vl);

  while (b->capacity < b->used + needed + 1) {
    b->capacity *= 2;
    b->str = realloc(b->str, b->capacity);
  }

  va_start(vl, s); // Must re-init.
  vsnprintf(b->str+b->used, b->capacity-b->used, s, vl);
  b->used += needed;
}

static void str_builder_str(struct str_builder *b, const char *s) {
  size_t needed = strlen(s);
  if (b->capacity < b->used + needed + 1) {
    b->capacity *= 2;
    b->str = realloc(b->str, b->capacity);
  }
  strcpy(b->str+b->used, s);
  b->used += needed;
}

static void str_builder_char(struct str_builder *b, char c) {
  size_t needed = 1;
  if (b->capacity < b->used + needed + 1) {
    b->capacity *= 2;
    b->str = realloc(b->str, b->capacity);
  }
  b->str[b->used] = c;
  b->str[b->used+1] = 0;
  b->used += needed;
}

static void str_builder_json_str(struct str_builder* sb, const char* s) {
  str_builder_char(sb, '"');
  for (int j = 0; s[j]; j++) {
    char c = s[j];
    switch (c) {
    case '\n':
      str_builder_str(sb, "\\n");
      break;
    case '"':
      str_builder_str(sb, "\\\"");
      break;
    default:
      str_builder_char(sb, c);
    }
  }
  str_builder_char(sb, '"');
}

static char *strclone(const char *str) {
  size_t size = strlen(str) + 1;
  char *copy = (char*) malloc(size);
  if (copy == NULL) {
    return NULL;
  }

  memcpy(copy, str, size);
  return copy;
}

// Assumes NULL-terminated.
static char *strconcat(const char *src_fragments[]) {
  size_t src_len = 0;
  const char **p;

  for (p = src_fragments; *p; p++) {
    src_len += strlen(*p);
  }

  char *src = (char*) malloc(src_len + 1);
  size_t n = 0;
  for (p = src_fragments; *p; p++) {
    strcpy(src + n, *p);
    n += strlen(*p);
  }

  return src;
}

// End of util.h.
// Start of cache.h

#define CACHE_HASH_SIZE 8 // In 32-bit words.

struct cache_hash {
  uint32_t hash[CACHE_HASH_SIZE];
};

// Initialise a blank cache.
static void cache_hash_init(struct cache_hash *c);

// Hash some bytes and add them to the accumulated hash.
static void cache_hash(struct cache_hash *out, const char *in, size_t n);

// Try to restore cache contents from a file with the given name.
// Assumes the cache is invalid if it contains the given hash.
// Allocates memory and reads the cache conents, which is returned in
// *buf with size *buflen.  If the cache is successfully loaded, this
// function returns 0.  Otherwise it returns nonzero.  Errno is set if
// the failure to load the cache is due to anything except invalid
// cache conents.  Note that failing to restore the cache is not
// necessarily a problem: it might just be invalid or not created yet.
static int cache_restore(const char *fname, const struct cache_hash *hash,
                         unsigned char **buf, size_t *buflen);

// Store cache contents in the given file, with the given hash.
static int cache_store(const char *fname, const struct cache_hash *hash,
                       const unsigned char *buf, size_t buflen);

// Now for the implementation.

static void cache_hash_init(struct cache_hash *c) {
  memset(c->hash, 0, CACHE_HASH_SIZE * sizeof(uint32_t));
}

static void cache_hash(struct cache_hash *out, const char *in, size_t n) {
  // Adaptation of djb2 for larger output size by storing intermediate
  // states.
  uint32_t hash = 5381;
  for (size_t i = 0; i < n; i++) {
    hash = ((hash << 5) + hash) + in[i];
    out->hash[i % CACHE_HASH_SIZE] ^= hash;
  }
}

#define CACHE_HEADER_SIZE 8
static const char cache_header[CACHE_HEADER_SIZE] = "FUTHARK\0";

static int cache_restore(const char *fname, const struct cache_hash *hash,
                         unsigned char **buf, size_t *buflen) {
  FILE *f = fopen(fname, "rb");

  if (f == NULL) {
    return 1;
  }

  char f_header[CACHE_HEADER_SIZE];

  if (fread(f_header, sizeof(char), CACHE_HEADER_SIZE, f) != CACHE_HEADER_SIZE) {
    goto error;
  }

  if (memcmp(f_header, cache_header, CACHE_HEADER_SIZE) != 0) {
    goto error;
  }

  if (fseek(f, 0, SEEK_END) != 0) {
    goto error;
  }
  int64_t f_size = (int64_t)ftell(f);
  if (fseek(f, CACHE_HEADER_SIZE, SEEK_SET) != 0) {
    goto error;
  }

  int64_t expected_size;

  if (fread(&expected_size, sizeof(int64_t), 1, f) != 1) {
    goto error;
  }

  if (f_size != expected_size) {
    errno = 0;
    goto error;
  }

  int32_t f_hash[CACHE_HASH_SIZE];

  if (fread(f_hash, sizeof(int32_t), CACHE_HASH_SIZE, f) != CACHE_HASH_SIZE) {
    goto error;
  }

  if (memcmp(f_hash, hash->hash, CACHE_HASH_SIZE) != 0) {
    errno = 0;
    goto error;
  }

  *buflen = f_size - CACHE_HEADER_SIZE - sizeof(int64_t) - CACHE_HASH_SIZE*sizeof(int32_t);
  *buf = malloc(*buflen);
  if (fread(*buf, sizeof(char), *buflen, f) != *buflen) {
    free(*buf);
    goto error;
  }

  fclose(f);

  return 0;

 error:
  fclose(f);
  return 1;
}

static int cache_store(const char *fname, const struct cache_hash *hash,
                       const unsigned char *buf, size_t buflen) {
  FILE *f = fopen(fname, "wb");

  if (f == NULL) {
    return 1;
  }

  if (fwrite(cache_header, CACHE_HEADER_SIZE, 1, f) != 1) {
    goto error;
  }

  int64_t size = CACHE_HEADER_SIZE + sizeof(int64_t) + CACHE_HASH_SIZE*sizeof(int32_t) + buflen;

  if (fwrite(&size, sizeof(size), 1, f) != 1) {
    goto error;
  }

  if (fwrite(hash->hash, sizeof(int32_t), CACHE_HASH_SIZE, f) != CACHE_HASH_SIZE) {
    goto error;
  }

  if (fwrite(buf, sizeof(unsigned char), buflen, f) != buflen) {
    goto error;
  }

  fclose(f);

  return 0;

 error:
  fclose(f);
  return 1;
}

// End of cache.h
// Start of half.h.

// Conversion functions are from http://half.sourceforge.net/, but
// translated to C.
//
// Copyright (c) 2012-2021 Christian Rau
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

#ifndef __OPENCL_VERSION__
#define __constant
#endif

__constant static const uint16_t base_table[512] = {
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
  0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0001, 0x0002, 0x0004, 0x0008, 0x0010, 0x0020, 0x0040, 0x0080, 0x0100,
  0x0200, 0x0400, 0x0800, 0x0C00, 0x1000, 0x1400, 0x1800, 0x1C00, 0x2000, 0x2400, 0x2800, 0x2C00, 0x3000, 0x3400, 0x3800, 0x3C00,
  0x4000, 0x4400, 0x4800, 0x4C00, 0x5000, 0x5400, 0x5800, 0x5C00, 0x6000, 0x6400, 0x6800, 0x6C00, 0x7000, 0x7400, 0x7800, 0x7C00,
  0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00,
  0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00,
  0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00,
  0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00,
  0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00,
  0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00,
  0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00, 0x7C00,
  0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000,
  0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000,
  0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000,
  0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000,
  0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000,
  0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000,
  0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8000, 0x8001, 0x8002, 0x8004, 0x8008, 0x8010, 0x8020, 0x8040, 0x8080, 0x8100,
  0x8200, 0x8400, 0x8800, 0x8C00, 0x9000, 0x9400, 0x9800, 0x9C00, 0xA000, 0xA400, 0xA800, 0xAC00, 0xB000, 0xB400, 0xB800, 0xBC00,
  0xC000, 0xC400, 0xC800, 0xCC00, 0xD000, 0xD400, 0xD800, 0xDC00, 0xE000, 0xE400, 0xE800, 0xEC00, 0xF000, 0xF400, 0xF800, 0xFC00,
  0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00,
  0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00,
  0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00,
  0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00,
  0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00,
  0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00,
  0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00, 0xFC00 };

__constant static const unsigned char shift_table[512] = {
  24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
  24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
  24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
  24, 24, 24, 24, 24, 24, 24, 23, 22, 21, 20, 19, 18, 17, 16, 15, 14, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13,
  13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
  24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
  24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
  24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 13,
  24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
  24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
  24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
  24, 24, 24, 24, 24, 24, 24, 23, 22, 21, 20, 19, 18, 17, 16, 15, 14, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13,
  13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
  24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
  24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24,
  24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 24, 13 };

__constant static const uint32_t mantissa_table[2048] = {
  0x00000000, 0x33800000, 0x34000000, 0x34400000, 0x34800000, 0x34A00000, 0x34C00000, 0x34E00000, 0x35000000, 0x35100000, 0x35200000, 0x35300000, 0x35400000, 0x35500000, 0x35600000, 0x35700000,
  0x35800000, 0x35880000, 0x35900000, 0x35980000, 0x35A00000, 0x35A80000, 0x35B00000, 0x35B80000, 0x35C00000, 0x35C80000, 0x35D00000, 0x35D80000, 0x35E00000, 0x35E80000, 0x35F00000, 0x35F80000,
  0x36000000, 0x36040000, 0x36080000, 0x360C0000, 0x36100000, 0x36140000, 0x36180000, 0x361C0000, 0x36200000, 0x36240000, 0x36280000, 0x362C0000, 0x36300000, 0x36340000, 0x36380000, 0x363C0000,
  0x36400000, 0x36440000, 0x36480000, 0x364C0000, 0x36500000, 0x36540000, 0x36580000, 0x365C0000, 0x36600000, 0x36640000, 0x36680000, 0x366C0000, 0x36700000, 0x36740000, 0x36780000, 0x367C0000,
  0x36800000, 0x36820000, 0x36840000, 0x36860000, 0x36880000, 0x368A0000, 0x368C0000, 0x368E0000, 0x36900000, 0x36920000, 0x36940000, 0x36960000, 0x36980000, 0x369A0000, 0x369C0000, 0x369E0000,
  0x36A00000, 0x36A20000, 0x36A40000, 0x36A60000, 0x36A80000, 0x36AA0000, 0x36AC0000, 0x36AE0000, 0x36B00000, 0x36B20000, 0x36B40000, 0x36B60000, 0x36B80000, 0x36BA0000, 0x36BC0000, 0x36BE0000,
  0x36C00000, 0x36C20000, 0x36C40000, 0x36C60000, 0x36C80000, 0x36CA0000, 0x36CC0000, 0x36CE0000, 0x36D00000, 0x36D20000, 0x36D40000, 0x36D60000, 0x36D80000, 0x36DA0000, 0x36DC0000, 0x36DE0000,
  0x36E00000, 0x36E20000, 0x36E40000, 0x36E60000, 0x36E80000, 0x36EA0000, 0x36EC0000, 0x36EE0000, 0x36F00000, 0x36F20000, 0x36F40000, 0x36F60000, 0x36F80000, 0x36FA0000, 0x36FC0000, 0x36FE0000,
  0x37000000, 0x37010000, 0x37020000, 0x37030000, 0x37040000, 0x37050000, 0x37060000, 0x37070000, 0x37080000, 0x37090000, 0x370A0000, 0x370B0000, 0x370C0000, 0x370D0000, 0x370E0000, 0x370F0000,
  0x37100000, 0x37110000, 0x37120000, 0x37130000, 0x37140000, 0x37150000, 0x37160000, 0x37170000, 0x37180000, 0x37190000, 0x371A0000, 0x371B0000, 0x371C0000, 0x371D0000, 0x371E0000, 0x371F0000,
  0x37200000, 0x37210000, 0x37220000, 0x37230000, 0x37240000, 0x37250000, 0x37260000, 0x37270000, 0x37280000, 0x37290000, 0x372A0000, 0x372B0000, 0x372C0000, 0x372D0000, 0x372E0000, 0x372F0000,
  0x37300000, 0x37310000, 0x37320000, 0x37330000, 0x37340000, 0x37350000, 0x37360000, 0x37370000, 0x37380000, 0x37390000, 0x373A0000, 0x373B0000, 0x373C0000, 0x373D0000, 0x373E0000, 0x373F0000,
  0x37400000, 0x37410000, 0x37420000, 0x37430000, 0x37440000, 0x37450000, 0x37460000, 0x37470000, 0x37480000, 0x37490000, 0x374A0000, 0x374B0000, 0x374C0000, 0x374D0000, 0x374E0000, 0x374F0000,
  0x37500000, 0x37510000, 0x37520000, 0x37530000, 0x37540000, 0x37550000, 0x37560000, 0x37570000, 0x37580000, 0x37590000, 0x375A0000, 0x375B0000, 0x375C0000, 0x375D0000, 0x375E0000, 0x375F0000,
  0x37600000, 0x37610000, 0x37620000, 0x37630000, 0x37640000, 0x37650000, 0x37660000, 0x37670000, 0x37680000, 0x37690000, 0x376A0000, 0x376B0000, 0x376C0000, 0x376D0000, 0x376E0000, 0x376F0000,
  0x37700000, 0x37710000, 0x37720000, 0x37730000, 0x37740000, 0x37750000, 0x37760000, 0x37770000, 0x37780000, 0x37790000, 0x377A0000, 0x377B0000, 0x377C0000, 0x377D0000, 0x377E0000, 0x377F0000,
  0x37800000, 0x37808000, 0x37810000, 0x37818000, 0x37820000, 0x37828000, 0x37830000, 0x37838000, 0x37840000, 0x37848000, 0x37850000, 0x37858000, 0x37860000, 0x37868000, 0x37870000, 0x37878000,
  0x37880000, 0x37888000, 0x37890000, 0x37898000, 0x378A0000, 0x378A8000, 0x378B0000, 0x378B8000, 0x378C0000, 0x378C8000, 0x378D0000, 0x378D8000, 0x378E0000, 0x378E8000, 0x378F0000, 0x378F8000,
  0x37900000, 0x37908000, 0x37910000, 0x37918000, 0x37920000, 0x37928000, 0x37930000, 0x37938000, 0x37940000, 0x37948000, 0x37950000, 0x37958000, 0x37960000, 0x37968000, 0x37970000, 0x37978000,
  0x37980000, 0x37988000, 0x37990000, 0x37998000, 0x379A0000, 0x379A8000, 0x379B0000, 0x379B8000, 0x379C0000, 0x379C8000, 0x379D0000, 0x379D8000, 0x379E0000, 0x379E8000, 0x379F0000, 0x379F8000,
  0x37A00000, 0x37A08000, 0x37A10000, 0x37A18000, 0x37A20000, 0x37A28000, 0x37A30000, 0x37A38000, 0x37A40000, 0x37A48000, 0x37A50000, 0x37A58000, 0x37A60000, 0x37A68000, 0x37A70000, 0x37A78000,
  0x37A80000, 0x37A88000, 0x37A90000, 0x37A98000, 0x37AA0000, 0x37AA8000, 0x37AB0000, 0x37AB8000, 0x37AC0000, 0x37AC8000, 0x37AD0000, 0x37AD8000, 0x37AE0000, 0x37AE8000, 0x37AF0000, 0x37AF8000,
  0x37B00000, 0x37B08000, 0x37B10000, 0x37B18000, 0x37B20000, 0x37B28000, 0x37B30000, 0x37B38000, 0x37B40000, 0x37B48000, 0x37B50000, 0x37B58000, 0x37B60000, 0x37B68000, 0x37B70000, 0x37B78000,
  0x37B80000, 0x37B88000, 0x37B90000, 0x37B98000, 0x37BA0000, 0x37BA8000, 0x37BB0000, 0x37BB8000, 0x37BC0000, 0x37BC8000, 0x37BD0000, 0x37BD8000, 0x37BE0000, 0x37BE8000, 0x37BF0000, 0x37BF8000,
  0x37C00000, 0x37C08000, 0x37C10000, 0x37C18000, 0x37C20000, 0x37C28000, 0x37C30000, 0x37C38000, 0x37C40000, 0x37C48000, 0x37C50000, 0x37C58000, 0x37C60000, 0x37C68000, 0x37C70000, 0x37C78000,
  0x37C80000, 0x37C88000, 0x37C90000, 0x37C98000, 0x37CA0000, 0x37CA8000, 0x37CB0000, 0x37CB8000, 0x37CC0000, 0x37CC8000, 0x37CD0000, 0x37CD8000, 0x37CE0000, 0x37CE8000, 0x37CF0000, 0x37CF8000,
  0x37D00000, 0x37D08000, 0x37D10000, 0x37D18000, 0x37D20000, 0x37D28000, 0x37D30000, 0x37D38000, 0x37D40000, 0x37D48000, 0x37D50000, 0x37D58000, 0x37D60000, 0x37D68000, 0x37D70000, 0x37D78000,
  0x37D80000, 0x37D88000, 0x37D90000, 0x37D98000, 0x37DA0000, 0x37DA8000, 0x37DB0000, 0x37DB8000, 0x37DC0000, 0x37DC8000, 0x37DD0000, 0x37DD8000, 0x37DE0000, 0x37DE8000, 0x37DF0000, 0x37DF8000,
  0x37E00000, 0x37E08000, 0x37E10000, 0x37E18000, 0x37E20000, 0x37E28000, 0x37E30000, 0x37E38000, 0x37E40000, 0x37E48000, 0x37E50000, 0x37E58000, 0x37E60000, 0x37E68000, 0x37E70000, 0x37E78000,
  0x37E80000, 0x37E88000, 0x37E90000, 0x37E98000, 0x37EA0000, 0x37EA8000, 0x37EB0000, 0x37EB8000, 0x37EC0000, 0x37EC8000, 0x37ED0000, 0x37ED8000, 0x37EE0000, 0x37EE8000, 0x37EF0000, 0x37EF8000,
  0x37F00000, 0x37F08000, 0x37F10000, 0x37F18000, 0x37F20000, 0x37F28000, 0x37F30000, 0x37F38000, 0x37F40000, 0x37F48000, 0x37F50000, 0x37F58000, 0x37F60000, 0x37F68000, 0x37F70000, 0x37F78000,
  0x37F80000, 0x37F88000, 0x37F90000, 0x37F98000, 0x37FA0000, 0x37FA8000, 0x37FB0000, 0x37FB8000, 0x37FC0000, 0x37FC8000, 0x37FD0000, 0x37FD8000, 0x37FE0000, 0x37FE8000, 0x37FF0000, 0x37FF8000,
  0x38000000, 0x38004000, 0x38008000, 0x3800C000, 0x38010000, 0x38014000, 0x38018000, 0x3801C000, 0x38020000, 0x38024000, 0x38028000, 0x3802C000, 0x38030000, 0x38034000, 0x38038000, 0x3803C000,
  0x38040000, 0x38044000, 0x38048000, 0x3804C000, 0x38050000, 0x38054000, 0x38058000, 0x3805C000, 0x38060000, 0x38064000, 0x38068000, 0x3806C000, 0x38070000, 0x38074000, 0x38078000, 0x3807C000,
  0x38080000, 0x38084000, 0x38088000, 0x3808C000, 0x38090000, 0x38094000, 0x38098000, 0x3809C000, 0x380A0000, 0x380A4000, 0x380A8000, 0x380AC000, 0x380B0000, 0x380B4000, 0x380B8000, 0x380BC000,
  0x380C0000, 0x380C4000, 0x380C8000, 0x380CC000, 0x380D0000, 0x380D4000, 0x380D8000, 0x380DC000, 0x380E0000, 0x380E4000, 0x380E8000, 0x380EC000, 0x380F0000, 0x380F4000, 0x380F8000, 0x380FC000,
  0x38100000, 0x38104000, 0x38108000, 0x3810C000, 0x38110000, 0x38114000, 0x38118000, 0x3811C000, 0x38120000, 0x38124000, 0x38128000, 0x3812C000, 0x38130000, 0x38134000, 0x38138000, 0x3813C000,
  0x38140000, 0x38144000, 0x38148000, 0x3814C000, 0x38150000, 0x38154000, 0x38158000, 0x3815C000, 0x38160000, 0x38164000, 0x38168000, 0x3816C000, 0x38170000, 0x38174000, 0x38178000, 0x3817C000,
  0x38180000, 0x38184000, 0x38188000, 0x3818C000, 0x38190000, 0x38194000, 0x38198000, 0x3819C000, 0x381A0000, 0x381A4000, 0x381A8000, 0x381AC000, 0x381B0000, 0x381B4000, 0x381B8000, 0x381BC000,
  0x381C0000, 0x381C4000, 0x381C8000, 0x381CC000, 0x381D0000, 0x381D4000, 0x381D8000, 0x381DC000, 0x381E0000, 0x381E4000, 0x381E8000, 0x381EC000, 0x381F0000, 0x381F4000, 0x381F8000, 0x381FC000,
  0x38200000, 0x38204000, 0x38208000, 0x3820C000, 0x38210000, 0x38214000, 0x38218000, 0x3821C000, 0x38220000, 0x38224000, 0x38228000, 0x3822C000, 0x38230000, 0x38234000, 0x38238000, 0x3823C000,
  0x38240000, 0x38244000, 0x38248000, 0x3824C000, 0x38250000, 0x38254000, 0x38258000, 0x3825C000, 0x38260000, 0x38264000, 0x38268000, 0x3826C000, 0x38270000, 0x38274000, 0x38278000, 0x3827C000,
  0x38280000, 0x38284000, 0x38288000, 0x3828C000, 0x38290000, 0x38294000, 0x38298000, 0x3829C000, 0x382A0000, 0x382A4000, 0x382A8000, 0x382AC000, 0x382B0000, 0x382B4000, 0x382B8000, 0x382BC000,
  0x382C0000, 0x382C4000, 0x382C8000, 0x382CC000, 0x382D0000, 0x382D4000, 0x382D8000, 0x382DC000, 0x382E0000, 0x382E4000, 0x382E8000, 0x382EC000, 0x382F0000, 0x382F4000, 0x382F8000, 0x382FC000,
  0x38300000, 0x38304000, 0x38308000, 0x3830C000, 0x38310000, 0x38314000, 0x38318000, 0x3831C000, 0x38320000, 0x38324000, 0x38328000, 0x3832C000, 0x38330000, 0x38334000, 0x38338000, 0x3833C000,
  0x38340000, 0x38344000, 0x38348000, 0x3834C000, 0x38350000, 0x38354000, 0x38358000, 0x3835C000, 0x38360000, 0x38364000, 0x38368000, 0x3836C000, 0x38370000, 0x38374000, 0x38378000, 0x3837C000,
  0x38380000, 0x38384000, 0x38388000, 0x3838C000, 0x38390000, 0x38394000, 0x38398000, 0x3839C000, 0x383A0000, 0x383A4000, 0x383A8000, 0x383AC000, 0x383B0000, 0x383B4000, 0x383B8000, 0x383BC000,
  0x383C0000, 0x383C4000, 0x383C8000, 0x383CC000, 0x383D0000, 0x383D4000, 0x383D8000, 0x383DC000, 0x383E0000, 0x383E4000, 0x383E8000, 0x383EC000, 0x383F0000, 0x383F4000, 0x383F8000, 0x383FC000,
  0x38400000, 0x38404000, 0x38408000, 0x3840C000, 0x38410000, 0x38414000, 0x38418000, 0x3841C000, 0x38420000, 0x38424000, 0x38428000, 0x3842C000, 0x38430000, 0x38434000, 0x38438000, 0x3843C000,
  0x38440000, 0x38444000, 0x38448000, 0x3844C000, 0x38450000, 0x38454000, 0x38458000, 0x3845C000, 0x38460000, 0x38464000, 0x38468000, 0x3846C000, 0x38470000, 0x38474000, 0x38478000, 0x3847C000,
  0x38480000, 0x38484000, 0x38488000, 0x3848C000, 0x38490000, 0x38494000, 0x38498000, 0x3849C000, 0x384A0000, 0x384A4000, 0x384A8000, 0x384AC000, 0x384B0000, 0x384B4000, 0x384B8000, 0x384BC000,
  0x384C0000, 0x384C4000, 0x384C8000, 0x384CC000, 0x384D0000, 0x384D4000, 0x384D8000, 0x384DC000, 0x384E0000, 0x384E4000, 0x384E8000, 0x384EC000, 0x384F0000, 0x384F4000, 0x384F8000, 0x384FC000,
  0x38500000, 0x38504000, 0x38508000, 0x3850C000, 0x38510000, 0x38514000, 0x38518000, 0x3851C000, 0x38520000, 0x38524000, 0x38528000, 0x3852C000, 0x38530000, 0x38534000, 0x38538000, 0x3853C000,
  0x38540000, 0x38544000, 0x38548000, 0x3854C000, 0x38550000, 0x38554000, 0x38558000, 0x3855C000, 0x38560000, 0x38564000, 0x38568000, 0x3856C000, 0x38570000, 0x38574000, 0x38578000, 0x3857C000,
  0x38580000, 0x38584000, 0x38588000, 0x3858C000, 0x38590000, 0x38594000, 0x38598000, 0x3859C000, 0x385A0000, 0x385A4000, 0x385A8000, 0x385AC000, 0x385B0000, 0x385B4000, 0x385B8000, 0x385BC000,
  0x385C0000, 0x385C4000, 0x385C8000, 0x385CC000, 0x385D0000, 0x385D4000, 0x385D8000, 0x385DC000, 0x385E0000, 0x385E4000, 0x385E8000, 0x385EC000, 0x385F0000, 0x385F4000, 0x385F8000, 0x385FC000,
  0x38600000, 0x38604000, 0x38608000, 0x3860C000, 0x38610000, 0x38614000, 0x38618000, 0x3861C000, 0x38620000, 0x38624000, 0x38628000, 0x3862C000, 0x38630000, 0x38634000, 0x38638000, 0x3863C000,
  0x38640000, 0x38644000, 0x38648000, 0x3864C000, 0x38650000, 0x38654000, 0x38658000, 0x3865C000, 0x38660000, 0x38664000, 0x38668000, 0x3866C000, 0x38670000, 0x38674000, 0x38678000, 0x3867C000,
  0x38680000, 0x38684000, 0x38688000, 0x3868C000, 0x38690000, 0x38694000, 0x38698000, 0x3869C000, 0x386A0000, 0x386A4000, 0x386A8000, 0x386AC000, 0x386B0000, 0x386B4000, 0x386B8000, 0x386BC000,
  0x386C0000, 0x386C4000, 0x386C8000, 0x386CC000, 0x386D0000, 0x386D4000, 0x386D8000, 0x386DC000, 0x386E0000, 0x386E4000, 0x386E8000, 0x386EC000, 0x386F0000, 0x386F4000, 0x386F8000, 0x386FC000,
  0x38700000, 0x38704000, 0x38708000, 0x3870C000, 0x38710000, 0x38714000, 0x38718000, 0x3871C000, 0x38720000, 0x38724000, 0x38728000, 0x3872C000, 0x38730000, 0x38734000, 0x38738000, 0x3873C000,
  0x38740000, 0x38744000, 0x38748000, 0x3874C000, 0x38750000, 0x38754000, 0x38758000, 0x3875C000, 0x38760000, 0x38764000, 0x38768000, 0x3876C000, 0x38770000, 0x38774000, 0x38778000, 0x3877C000,
  0x38780000, 0x38784000, 0x38788000, 0x3878C000, 0x38790000, 0x38794000, 0x38798000, 0x3879C000, 0x387A0000, 0x387A4000, 0x387A8000, 0x387AC000, 0x387B0000, 0x387B4000, 0x387B8000, 0x387BC000,
  0x387C0000, 0x387C4000, 0x387C8000, 0x387CC000, 0x387D0000, 0x387D4000, 0x387D8000, 0x387DC000, 0x387E0000, 0x387E4000, 0x387E8000, 0x387EC000, 0x387F0000, 0x387F4000, 0x387F8000, 0x387FC000,
  0x38000000, 0x38002000, 0x38004000, 0x38006000, 0x38008000, 0x3800A000, 0x3800C000, 0x3800E000, 0x38010000, 0x38012000, 0x38014000, 0x38016000, 0x38018000, 0x3801A000, 0x3801C000, 0x3801E000,
  0x38020000, 0x38022000, 0x38024000, 0x38026000, 0x38028000, 0x3802A000, 0x3802C000, 0x3802E000, 0x38030000, 0x38032000, 0x38034000, 0x38036000, 0x38038000, 0x3803A000, 0x3803C000, 0x3803E000,
  0x38040000, 0x38042000, 0x38044000, 0x38046000, 0x38048000, 0x3804A000, 0x3804C000, 0x3804E000, 0x38050000, 0x38052000, 0x38054000, 0x38056000, 0x38058000, 0x3805A000, 0x3805C000, 0x3805E000,
  0x38060000, 0x38062000, 0x38064000, 0x38066000, 0x38068000, 0x3806A000, 0x3806C000, 0x3806E000, 0x38070000, 0x38072000, 0x38074000, 0x38076000, 0x38078000, 0x3807A000, 0x3807C000, 0x3807E000,
  0x38080000, 0x38082000, 0x38084000, 0x38086000, 0x38088000, 0x3808A000, 0x3808C000, 0x3808E000, 0x38090000, 0x38092000, 0x38094000, 0x38096000, 0x38098000, 0x3809A000, 0x3809C000, 0x3809E000,
  0x380A0000, 0x380A2000, 0x380A4000, 0x380A6000, 0x380A8000, 0x380AA000, 0x380AC000, 0x380AE000, 0x380B0000, 0x380B2000, 0x380B4000, 0x380B6000, 0x380B8000, 0x380BA000, 0x380BC000, 0x380BE000,
  0x380C0000, 0x380C2000, 0x380C4000, 0x380C6000, 0x380C8000, 0x380CA000, 0x380CC000, 0x380CE000, 0x380D0000, 0x380D2000, 0x380D4000, 0x380D6000, 0x380D8000, 0x380DA000, 0x380DC000, 0x380DE000,
  0x380E0000, 0x380E2000, 0x380E4000, 0x380E6000, 0x380E8000, 0x380EA000, 0x380EC000, 0x380EE000, 0x380F0000, 0x380F2000, 0x380F4000, 0x380F6000, 0x380F8000, 0x380FA000, 0x380FC000, 0x380FE000,
  0x38100000, 0x38102000, 0x38104000, 0x38106000, 0x38108000, 0x3810A000, 0x3810C000, 0x3810E000, 0x38110000, 0x38112000, 0x38114000, 0x38116000, 0x38118000, 0x3811A000, 0x3811C000, 0x3811E000,
  0x38120000, 0x38122000, 0x38124000, 0x38126000, 0x38128000, 0x3812A000, 0x3812C000, 0x3812E000, 0x38130000, 0x38132000, 0x38134000, 0x38136000, 0x38138000, 0x3813A000, 0x3813C000, 0x3813E000,
  0x38140000, 0x38142000, 0x38144000, 0x38146000, 0x38148000, 0x3814A000, 0x3814C000, 0x3814E000, 0x38150000, 0x38152000, 0x38154000, 0x38156000, 0x38158000, 0x3815A000, 0x3815C000, 0x3815E000,
  0x38160000, 0x38162000, 0x38164000, 0x38166000, 0x38168000, 0x3816A000, 0x3816C000, 0x3816E000, 0x38170000, 0x38172000, 0x38174000, 0x38176000, 0x38178000, 0x3817A000, 0x3817C000, 0x3817E000,
  0x38180000, 0x38182000, 0x38184000, 0x38186000, 0x38188000, 0x3818A000, 0x3818C000, 0x3818E000, 0x38190000, 0x38192000, 0x38194000, 0x38196000, 0x38198000, 0x3819A000, 0x3819C000, 0x3819E000,
  0x381A0000, 0x381A2000, 0x381A4000, 0x381A6000, 0x381A8000, 0x381AA000, 0x381AC000, 0x381AE000, 0x381B0000, 0x381B2000, 0x381B4000, 0x381B6000, 0x381B8000, 0x381BA000, 0x381BC000, 0x381BE000,
  0x381C0000, 0x381C2000, 0x381C4000, 0x381C6000, 0x381C8000, 0x381CA000, 0x381CC000, 0x381CE000, 0x381D0000, 0x381D2000, 0x381D4000, 0x381D6000, 0x381D8000, 0x381DA000, 0x381DC000, 0x381DE000,
  0x381E0000, 0x381E2000, 0x381E4000, 0x381E6000, 0x381E8000, 0x381EA000, 0x381EC000, 0x381EE000, 0x381F0000, 0x381F2000, 0x381F4000, 0x381F6000, 0x381F8000, 0x381FA000, 0x381FC000, 0x381FE000,
  0x38200000, 0x38202000, 0x38204000, 0x38206000, 0x38208000, 0x3820A000, 0x3820C000, 0x3820E000, 0x38210000, 0x38212000, 0x38214000, 0x38216000, 0x38218000, 0x3821A000, 0x3821C000, 0x3821E000,
  0x38220000, 0x38222000, 0x38224000, 0x38226000, 0x38228000, 0x3822A000, 0x3822C000, 0x3822E000, 0x38230000, 0x38232000, 0x38234000, 0x38236000, 0x38238000, 0x3823A000, 0x3823C000, 0x3823E000,
  0x38240000, 0x38242000, 0x38244000, 0x38246000, 0x38248000, 0x3824A000, 0x3824C000, 0x3824E000, 0x38250000, 0x38252000, 0x38254000, 0x38256000, 0x38258000, 0x3825A000, 0x3825C000, 0x3825E000,
  0x38260000, 0x38262000, 0x38264000, 0x38266000, 0x38268000, 0x3826A000, 0x3826C000, 0x3826E000, 0x38270000, 0x38272000, 0x38274000, 0x38276000, 0x38278000, 0x3827A000, 0x3827C000, 0x3827E000,
  0x38280000, 0x38282000, 0x38284000, 0x38286000, 0x38288000, 0x3828A000, 0x3828C000, 0x3828E000, 0x38290000, 0x38292000, 0x38294000, 0x38296000, 0x38298000, 0x3829A000, 0x3829C000, 0x3829E000,
  0x382A0000, 0x382A2000, 0x382A4000, 0x382A6000, 0x382A8000, 0x382AA000, 0x382AC000, 0x382AE000, 0x382B0000, 0x382B2000, 0x382B4000, 0x382B6000, 0x382B8000, 0x382BA000, 0x382BC000, 0x382BE000,
  0x382C0000, 0x382C2000, 0x382C4000, 0x382C6000, 0x382C8000, 0x382CA000, 0x382CC000, 0x382CE000, 0x382D0000, 0x382D2000, 0x382D4000, 0x382D6000, 0x382D8000, 0x382DA000, 0x382DC000, 0x382DE000,
  0x382E0000, 0x382E2000, 0x382E4000, 0x382E6000, 0x382E8000, 0x382EA000, 0x382EC000, 0x382EE000, 0x382F0000, 0x382F2000, 0x382F4000, 0x382F6000, 0x382F8000, 0x382FA000, 0x382FC000, 0x382FE000,
  0x38300000, 0x38302000, 0x38304000, 0x38306000, 0x38308000, 0x3830A000, 0x3830C000, 0x3830E000, 0x38310000, 0x38312000, 0x38314000, 0x38316000, 0x38318000, 0x3831A000, 0x3831C000, 0x3831E000,
  0x38320000, 0x38322000, 0x38324000, 0x38326000, 0x38328000, 0x3832A000, 0x3832C000, 0x3832E000, 0x38330000, 0x38332000, 0x38334000, 0x38336000, 0x38338000, 0x3833A000, 0x3833C000, 0x3833E000,
  0x38340000, 0x38342000, 0x38344000, 0x38346000, 0x38348000, 0x3834A000, 0x3834C000, 0x3834E000, 0x38350000, 0x38352000, 0x38354000, 0x38356000, 0x38358000, 0x3835A000, 0x3835C000, 0x3835E000,
  0x38360000, 0x38362000, 0x38364000, 0x38366000, 0x38368000, 0x3836A000, 0x3836C000, 0x3836E000, 0x38370000, 0x38372000, 0x38374000, 0x38376000, 0x38378000, 0x3837A000, 0x3837C000, 0x3837E000,
  0x38380000, 0x38382000, 0x38384000, 0x38386000, 0x38388000, 0x3838A000, 0x3838C000, 0x3838E000, 0x38390000, 0x38392000, 0x38394000, 0x38396000, 0x38398000, 0x3839A000, 0x3839C000, 0x3839E000,
  0x383A0000, 0x383A2000, 0x383A4000, 0x383A6000, 0x383A8000, 0x383AA000, 0x383AC000, 0x383AE000, 0x383B0000, 0x383B2000, 0x383B4000, 0x383B6000, 0x383B8000, 0x383BA000, 0x383BC000, 0x383BE000,
  0x383C0000, 0x383C2000, 0x383C4000, 0x383C6000, 0x383C8000, 0x383CA000, 0x383CC000, 0x383CE000, 0x383D0000, 0x383D2000, 0x383D4000, 0x383D6000, 0x383D8000, 0x383DA000, 0x383DC000, 0x383DE000,
  0x383E0000, 0x383E2000, 0x383E4000, 0x383E6000, 0x383E8000, 0x383EA000, 0x383EC000, 0x383EE000, 0x383F0000, 0x383F2000, 0x383F4000, 0x383F6000, 0x383F8000, 0x383FA000, 0x383FC000, 0x383FE000,
  0x38400000, 0x38402000, 0x38404000, 0x38406000, 0x38408000, 0x3840A000, 0x3840C000, 0x3840E000, 0x38410000, 0x38412000, 0x38414000, 0x38416000, 0x38418000, 0x3841A000, 0x3841C000, 0x3841E000,
  0x38420000, 0x38422000, 0x38424000, 0x38426000, 0x38428000, 0x3842A000, 0x3842C000, 0x3842E000, 0x38430000, 0x38432000, 0x38434000, 0x38436000, 0x38438000, 0x3843A000, 0x3843C000, 0x3843E000,
  0x38440000, 0x38442000, 0x38444000, 0x38446000, 0x38448000, 0x3844A000, 0x3844C000, 0x3844E000, 0x38450000, 0x38452000, 0x38454000, 0x38456000, 0x38458000, 0x3845A000, 0x3845C000, 0x3845E000,
  0x38460000, 0x38462000, 0x38464000, 0x38466000, 0x38468000, 0x3846A000, 0x3846C000, 0x3846E000, 0x38470000, 0x38472000, 0x38474000, 0x38476000, 0x38478000, 0x3847A000, 0x3847C000, 0x3847E000,
  0x38480000, 0x38482000, 0x38484000, 0x38486000, 0x38488000, 0x3848A000, 0x3848C000, 0x3848E000, 0x38490000, 0x38492000, 0x38494000, 0x38496000, 0x38498000, 0x3849A000, 0x3849C000, 0x3849E000,
  0x384A0000, 0x384A2000, 0x384A4000, 0x384A6000, 0x384A8000, 0x384AA000, 0x384AC000, 0x384AE000, 0x384B0000, 0x384B2000, 0x384B4000, 0x384B6000, 0x384B8000, 0x384BA000, 0x384BC000, 0x384BE000,
  0x384C0000, 0x384C2000, 0x384C4000, 0x384C6000, 0x384C8000, 0x384CA000, 0x384CC000, 0x384CE000, 0x384D0000, 0x384D2000, 0x384D4000, 0x384D6000, 0x384D8000, 0x384DA000, 0x384DC000, 0x384DE000,
  0x384E0000, 0x384E2000, 0x384E4000, 0x384E6000, 0x384E8000, 0x384EA000, 0x384EC000, 0x384EE000, 0x384F0000, 0x384F2000, 0x384F4000, 0x384F6000, 0x384F8000, 0x384FA000, 0x384FC000, 0x384FE000,
  0x38500000, 0x38502000, 0x38504000, 0x38506000, 0x38508000, 0x3850A000, 0x3850C000, 0x3850E000, 0x38510000, 0x38512000, 0x38514000, 0x38516000, 0x38518000, 0x3851A000, 0x3851C000, 0x3851E000,
  0x38520000, 0x38522000, 0x38524000, 0x38526000, 0x38528000, 0x3852A000, 0x3852C000, 0x3852E000, 0x38530000, 0x38532000, 0x38534000, 0x38536000, 0x38538000, 0x3853A000, 0x3853C000, 0x3853E000,
  0x38540000, 0x38542000, 0x38544000, 0x38546000, 0x38548000, 0x3854A000, 0x3854C000, 0x3854E000, 0x38550000, 0x38552000, 0x38554000, 0x38556000, 0x38558000, 0x3855A000, 0x3855C000, 0x3855E000,
  0x38560000, 0x38562000, 0x38564000, 0x38566000, 0x38568000, 0x3856A000, 0x3856C000, 0x3856E000, 0x38570000, 0x38572000, 0x38574000, 0x38576000, 0x38578000, 0x3857A000, 0x3857C000, 0x3857E000,
  0x38580000, 0x38582000, 0x38584000, 0x38586000, 0x38588000, 0x3858A000, 0x3858C000, 0x3858E000, 0x38590000, 0x38592000, 0x38594000, 0x38596000, 0x38598000, 0x3859A000, 0x3859C000, 0x3859E000,
  0x385A0000, 0x385A2000, 0x385A4000, 0x385A6000, 0x385A8000, 0x385AA000, 0x385AC000, 0x385AE000, 0x385B0000, 0x385B2000, 0x385B4000, 0x385B6000, 0x385B8000, 0x385BA000, 0x385BC000, 0x385BE000,
  0x385C0000, 0x385C2000, 0x385C4000, 0x385C6000, 0x385C8000, 0x385CA000, 0x385CC000, 0x385CE000, 0x385D0000, 0x385D2000, 0x385D4000, 0x385D6000, 0x385D8000, 0x385DA000, 0x385DC000, 0x385DE000,
  0x385E0000, 0x385E2000, 0x385E4000, 0x385E6000, 0x385E8000, 0x385EA000, 0x385EC000, 0x385EE000, 0x385F0000, 0x385F2000, 0x385F4000, 0x385F6000, 0x385F8000, 0x385FA000, 0x385FC000, 0x385FE000,
  0x38600000, 0x38602000, 0x38604000, 0x38606000, 0x38608000, 0x3860A000, 0x3860C000, 0x3860E000, 0x38610000, 0x38612000, 0x38614000, 0x38616000, 0x38618000, 0x3861A000, 0x3861C000, 0x3861E000,
  0x38620000, 0x38622000, 0x38624000, 0x38626000, 0x38628000, 0x3862A000, 0x3862C000, 0x3862E000, 0x38630000, 0x38632000, 0x38634000, 0x38636000, 0x38638000, 0x3863A000, 0x3863C000, 0x3863E000,
  0x38640000, 0x38642000, 0x38644000, 0x38646000, 0x38648000, 0x3864A000, 0x3864C000, 0x3864E000, 0x38650000, 0x38652000, 0x38654000, 0x38656000, 0x38658000, 0x3865A000, 0x3865C000, 0x3865E000,
  0x38660000, 0x38662000, 0x38664000, 0x38666000, 0x38668000, 0x3866A000, 0x3866C000, 0x3866E000, 0x38670000, 0x38672000, 0x38674000, 0x38676000, 0x38678000, 0x3867A000, 0x3867C000, 0x3867E000,
  0x38680000, 0x38682000, 0x38684000, 0x38686000, 0x38688000, 0x3868A000, 0x3868C000, 0x3868E000, 0x38690000, 0x38692000, 0x38694000, 0x38696000, 0x38698000, 0x3869A000, 0x3869C000, 0x3869E000,
  0x386A0000, 0x386A2000, 0x386A4000, 0x386A6000, 0x386A8000, 0x386AA000, 0x386AC000, 0x386AE000, 0x386B0000, 0x386B2000, 0x386B4000, 0x386B6000, 0x386B8000, 0x386BA000, 0x386BC000, 0x386BE000,
  0x386C0000, 0x386C2000, 0x386C4000, 0x386C6000, 0x386C8000, 0x386CA000, 0x386CC000, 0x386CE000, 0x386D0000, 0x386D2000, 0x386D4000, 0x386D6000, 0x386D8000, 0x386DA000, 0x386DC000, 0x386DE000,
  0x386E0000, 0x386E2000, 0x386E4000, 0x386E6000, 0x386E8000, 0x386EA000, 0x386EC000, 0x386EE000, 0x386F0000, 0x386F2000, 0x386F4000, 0x386F6000, 0x386F8000, 0x386FA000, 0x386FC000, 0x386FE000,
  0x38700000, 0x38702000, 0x38704000, 0x38706000, 0x38708000, 0x3870A000, 0x3870C000, 0x3870E000, 0x38710000, 0x38712000, 0x38714000, 0x38716000, 0x38718000, 0x3871A000, 0x3871C000, 0x3871E000,
  0x38720000, 0x38722000, 0x38724000, 0x38726000, 0x38728000, 0x3872A000, 0x3872C000, 0x3872E000, 0x38730000, 0x38732000, 0x38734000, 0x38736000, 0x38738000, 0x3873A000, 0x3873C000, 0x3873E000,
  0x38740000, 0x38742000, 0x38744000, 0x38746000, 0x38748000, 0x3874A000, 0x3874C000, 0x3874E000, 0x38750000, 0x38752000, 0x38754000, 0x38756000, 0x38758000, 0x3875A000, 0x3875C000, 0x3875E000,
  0x38760000, 0x38762000, 0x38764000, 0x38766000, 0x38768000, 0x3876A000, 0x3876C000, 0x3876E000, 0x38770000, 0x38772000, 0x38774000, 0x38776000, 0x38778000, 0x3877A000, 0x3877C000, 0x3877E000,
  0x38780000, 0x38782000, 0x38784000, 0x38786000, 0x38788000, 0x3878A000, 0x3878C000, 0x3878E000, 0x38790000, 0x38792000, 0x38794000, 0x38796000, 0x38798000, 0x3879A000, 0x3879C000, 0x3879E000,
  0x387A0000, 0x387A2000, 0x387A4000, 0x387A6000, 0x387A8000, 0x387AA000, 0x387AC000, 0x387AE000, 0x387B0000, 0x387B2000, 0x387B4000, 0x387B6000, 0x387B8000, 0x387BA000, 0x387BC000, 0x387BE000,
  0x387C0000, 0x387C2000, 0x387C4000, 0x387C6000, 0x387C8000, 0x387CA000, 0x387CC000, 0x387CE000, 0x387D0000, 0x387D2000, 0x387D4000, 0x387D6000, 0x387D8000, 0x387DA000, 0x387DC000, 0x387DE000,
  0x387E0000, 0x387E2000, 0x387E4000, 0x387E6000, 0x387E8000, 0x387EA000, 0x387EC000, 0x387EE000, 0x387F0000, 0x387F2000, 0x387F4000, 0x387F6000, 0x387F8000, 0x387FA000, 0x387FC000, 0x387FE000 };
__constant static const uint32_t exponent_table[64] = {
  0x00000000, 0x00800000, 0x01000000, 0x01800000, 0x02000000, 0x02800000, 0x03000000, 0x03800000, 0x04000000, 0x04800000, 0x05000000, 0x05800000, 0x06000000, 0x06800000, 0x07000000, 0x07800000,
  0x08000000, 0x08800000, 0x09000000, 0x09800000, 0x0A000000, 0x0A800000, 0x0B000000, 0x0B800000, 0x0C000000, 0x0C800000, 0x0D000000, 0x0D800000, 0x0E000000, 0x0E800000, 0x0F000000, 0x47800000,
  0x80000000, 0x80800000, 0x81000000, 0x81800000, 0x82000000, 0x82800000, 0x83000000, 0x83800000, 0x84000000, 0x84800000, 0x85000000, 0x85800000, 0x86000000, 0x86800000, 0x87000000, 0x87800000,
  0x88000000, 0x88800000, 0x89000000, 0x89800000, 0x8A000000, 0x8A800000, 0x8B000000, 0x8B800000, 0x8C000000, 0x8C800000, 0x8D000000, 0x8D800000, 0x8E000000, 0x8E800000, 0x8F000000, 0xC7800000 };
__constant static const unsigned short offset_table[64] = {
  0, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024,
  0, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024, 1024 };

SCALAR_FUN_ATTR uint16_t float2halfbits(float value) {
  union { float x; uint32_t y; } u;
  u.x = value;
  uint32_t bits = u.y;

  uint16_t hbits = base_table[bits>>23] + (uint16_t)((bits&0x7FFFFF)>>shift_table[bits>>23]);;

  return hbits;
}

SCALAR_FUN_ATTR float halfbits2float(uint16_t value) {
  uint32_t bits = mantissa_table[offset_table[value>>10]+(value&0x3FF)] + exponent_table[value>>10];

  union { uint32_t x; float y; } u;
  u.x = bits;
  return u.y;
}

SCALAR_FUN_ATTR uint16_t halfbitsnextafter(uint16_t from, uint16_t to) {
  int fabs = from & 0x7FFF, tabs = to & 0x7FFF;
  if(fabs > 0x7C00 || tabs > 0x7C00) {
    return ((from&0x7FFF)>0x7C00) ? (from|0x200) : (to|0x200);
  }
  if(from == to || !(fabs|tabs)) {
    return to;
  }
  if(!fabs) {
    return (to&0x8000)+1;
  }
  unsigned int out =
    from +
    (((from>>15)^(unsigned int)((from^(0x8000|(0x8000-(from>>15))))<(to^(0x8000|(0x8000-(to>>15))))))<<1)
    - 1;
  return out;
}

// End of half.h.
// Start of timing.h.

// The function get_wall_time() returns the wall time in microseconds
// (with an unspecified offset).

#ifdef _WIN32

#include <windows.h>

static int64_t get_wall_time(void) {
  LARGE_INTEGER time,freq;
  assert(QueryPerformanceFrequency(&freq));
  assert(QueryPerformanceCounter(&time));
  return ((double)time.QuadPart / freq.QuadPart) * 1000000;
}

#else
// Assuming POSIX

#include <time.h>
#include <sys/time.h>

static int64_t get_wall_time(void) {
  struct timeval time;
  assert(gettimeofday(&time,NULL) == 0);
  return time.tv_sec * 1000000 + time.tv_usec;
}

static int64_t get_wall_time_ns(void) {
  struct timespec time;
  assert(clock_gettime(CLOCK_REALTIME, &time) == 0);
  return time.tv_sec * 1000000000 + time.tv_nsec;
}

#endif

// End of timing.h.
// Start of lock.h.

// A very simple cross-platform implementation of locks.  Uses
// pthreads on Unix and some Windows thing there.  Futhark's
// host-level code is not multithreaded, but user code may be, so we
// need some mechanism for ensuring atomic access to API functions.
// This is that mechanism.  It is not exposed to user code at all, so
// we do not have to worry about name collisions.

#ifdef _WIN32

typedef HANDLE lock_t;

static void create_lock(lock_t *lock) {
  *lock = CreateMutex(NULL,  // Default security attributes.
                      FALSE, // Initially unlocked.
                      NULL); // Unnamed.
}

static void lock_lock(lock_t *lock) {
  assert(WaitForSingleObject(*lock, INFINITE) == WAIT_OBJECT_0);
}

static void lock_unlock(lock_t *lock) {
  assert(ReleaseMutex(*lock));
}

static void free_lock(lock_t *lock) {
  CloseHandle(*lock);
}

#else
// Assuming POSIX

#include <pthread.h>

typedef pthread_mutex_t lock_t;

static void create_lock(lock_t *lock) {
  int r = pthread_mutex_init(lock, NULL);
  assert(r == 0);
}

static void lock_lock(lock_t *lock) {
  int r = pthread_mutex_lock(lock);
  assert(r == 0);
}

static void lock_unlock(lock_t *lock) {
  int r = pthread_mutex_unlock(lock);
  assert(r == 0);
}

static void free_lock(lock_t *lock) {
  // Nothing to do for pthreads.
  (void)lock;
}

#endif

// End of lock.h.
// Start of free_list.h.

typedef uintptr_t fl_mem;

// An entry in the free list.  May be invalid, to avoid having to
// deallocate entries as soon as they are removed.  There is also a
// tag, to help with memory reuse.
struct free_list_entry {
  size_t size;
  fl_mem mem;
  const char *tag;
  unsigned char valid;
};

struct free_list {
  struct free_list_entry *entries; // Pointer to entries.
  int capacity;                    // Number of entries.
  int used;                        // Number of valid entries.
  lock_t lock;                     // Thread safety.
};

static void free_list_init(struct free_list *l) {
  l->capacity = 30; // Picked arbitrarily.
  l->used = 0;
  l->entries = (struct free_list_entry*) malloc(sizeof(struct free_list_entry) * l->capacity);
  for (int i = 0; i < l->capacity; i++) {
    l->entries[i].valid = 0;
  }
  create_lock(&l->lock);
}

// Remove invalid entries from the free list.
static void free_list_pack(struct free_list *l) {
  lock_lock(&l->lock);
  int p = 0;
  for (int i = 0; i < l->capacity; i++) {
    if (l->entries[i].valid) {
      l->entries[p] = l->entries[i];
      if (i > p) {
        l->entries[i].valid = 0;
      }
      p++;
    }
  }

  // Now p is the number of used elements.  We don't want it to go
  // less than the default capacity (although in practice it's OK as
  // long as it doesn't become 1).
  if (p < 30) {
    p = 30;
  }
  l->entries = realloc(l->entries, p * sizeof(struct free_list_entry));
  l->capacity = p;
  lock_unlock(&l->lock);
}

static void free_list_destroy(struct free_list *l) {
  assert(l->used == 0);
  free(l->entries);
  free_lock(&l->lock);
}

// Not part of the interface, so no locking.
static int free_list_find_invalid(struct free_list *l) {
  int i;
  for (i = 0; i < l->capacity; i++) {
    if (!l->entries[i].valid) {
      break;
    }
  }
  return i;
}

static void free_list_insert(struct free_list *l, size_t size, fl_mem mem, const char *tag) {
  lock_lock(&l->lock);
  int i = free_list_find_invalid(l);

  if (i == l->capacity) {
    // List is full; so we have to grow it.
    int new_capacity = l->capacity * 2 * sizeof(struct free_list_entry);
    l->entries = realloc(l->entries, new_capacity);
    for (int j = 0; j < l->capacity; j++) {
      l->entries[j+l->capacity].valid = 0;
    }
    l->capacity *= 2;
  }

  // Now 'i' points to the first invalid entry.
  l->entries[i].valid = 1;
  l->entries[i].size = size;
  l->entries[i].mem = mem;
  l->entries[i].tag = tag;

  l->used++;
  lock_unlock(&l->lock);
}

// Determine whether this entry in the free list is acceptable for
// satisfying the request.  Not public, so no locking.
static bool free_list_acceptable(size_t size, const char* tag, struct free_list_entry *entry) {
  // We check not just the hard requirement (is the entry acceptable
  // and big enough?) but also put a cap on how much wasted space
  // (internal fragmentation) we allow.  This is necessarily a
  // heuristic, and a crude one.

  if (!entry->valid) {
    return false;
  }

  if (size > entry->size) {
    return false;
  }

  // We know the block fits.  Now the question is whether it is too
  // big.  Our policy is as follows:
  //
  // 1) We don't care about wasted space below 4096 bytes (to avoid
  // churn in tiny allocations).
  //
  // 2) If the tag matches, we allow _any_ amount of wasted space.
  //
  // 3) Otherwise we allow up to 50% wasted space.

  if (entry->size < 4096) {
    return true;
  }

  if (entry->tag == tag) {
    return true;
  }

  if (entry->size < size * 2) {
    return true;
  }

  return false;
}

// Find and remove a memory block of the indicated tag, or if that
// does not exist, another memory block with exactly the desired size.
// Returns 0 on success.
static int free_list_find(struct free_list *l, size_t size, const char *tag,
                          size_t *size_out, fl_mem *mem_out) {
  lock_lock(&l->lock);
  int size_match = -1;
  int i;
  int ret = 1;
  for (i = 0; i < l->capacity; i++) {
    if (free_list_acceptable(size, tag, &l->entries[i]) &&
        (size_match < 0 || l->entries[i].size < l->entries[size_match].size)) {
      // If this entry is valid, has sufficient size, and is smaller than the
      // best entry found so far, use this entry.
      size_match = i;
    }
  }

  if (size_match >= 0) {
    l->entries[size_match].valid = 0;
    *size_out = l->entries[size_match].size;
    *mem_out = l->entries[size_match].mem;
    l->used--;
    ret = 0;
  }
  lock_unlock(&l->lock);
  return ret;
}

// Remove the first block in the free list.  Returns 0 if a block was
// removed, and nonzero if the free list was already empty.
static int free_list_first(struct free_list *l, fl_mem *mem_out) {
  lock_lock(&l->lock);
  int ret = 1;
  for (int i = 0; i < l->capacity; i++) {
    if (l->entries[i].valid) {
      l->entries[i].valid = 0;
      *mem_out = l->entries[i].mem;
      l->used--;
      ret = 0;
      break;
    }
  }
  lock_unlock(&l->lock);
  return ret;
}

// End of free_list.h.
// Start of event_list.h

typedef int (*event_report_fn)(struct str_builder*, void*);

struct event {
  void* data;
  event_report_fn f;
  const char* name;
  char *description;
};

struct event_list {
  struct event *events;
  int num_events;
  int capacity;
};

static void event_list_init(struct event_list *l) {
  l->capacity = 100;
  l->num_events = 0;
  l->events = calloc(l->capacity, sizeof(struct event));
}

static void event_list_free(struct event_list *l) {
  free(l->events);
}

static void add_event_to_list(struct event_list *l,
                              const char* name,
                              char* description,
                              void* data,
                              event_report_fn f) {
  if (l->num_events == l->capacity) {
    l->capacity *= 2;
    l->events = realloc(l->events, l->capacity * sizeof(struct event));
  }
  l->events[l->num_events].name = name;
  l->events[l->num_events].description = description;
  l->events[l->num_events].data = data;
  l->events[l->num_events].f = f;
  l->num_events++;
}

static int report_events_in_list(struct event_list *l,
                                 struct str_builder* sb) {
  int ret = 0;
  for (int i = 0; i < l->num_events; i++) {
    if (i != 0) {
      str_builder_str(sb, ",");
    }
    str_builder_str(sb, "{\"name\":");
    str_builder_json_str(sb, l->events[i].name);
    str_builder_str(sb, ",\"description\":");
    str_builder_json_str(sb, l->events[i].description);
    free(l->events[i].description);
    if (l->events[i].f(sb, l->events[i].data) != 0) {
      ret = 1;
      break;
    }
    str_builder(sb, "}");
  }
  event_list_free(l);
  event_list_init(l);
  return ret;
}

// End of event_list.h

#ifdef _MSC_VER
#define inline __inline
#endif
#include <string.h>
#include <string.h>
#include <errno.h>
#include <assert.h>
#include <ctype.h>



#define FUTHARK_F64_ENABLED

// Start of scalar.h.

// Implementation of the primitive scalar operations.  Very
// repetitive.  This code is inserted directly into both CUDA and
// OpenCL programs, as well as the CPU code, so it has some #ifdefs to
// work everywhere.  Some operations are defined as macros because
// this allows us to use them as constant expressions in things like
// array sizes and static initialisers.

// Some of the #ifdefs are because OpenCL uses type-generic functions
// for some operations (e.g. sqrt), while C and CUDA sensibly use
// distinct functions for different precisions (e.g. sqrtf() and
// sqrt()).  This is quite annoying.  Due to C's unfortunate casting
// rules, it is also really easy to accidentally implement
// floating-point functions in the wrong precision, so be careful.

// Double-precision definitions are only included if the preprocessor
// macro FUTHARK_F64_ENABLED is set.

SCALAR_FUN_ATTR int32_t futrts_to_bits32(float x);
SCALAR_FUN_ATTR float futrts_from_bits32(int32_t x);

SCALAR_FUN_ATTR uint8_t add8(uint8_t x, uint8_t y) {
  return x + y;
}

SCALAR_FUN_ATTR uint16_t add16(uint16_t x, uint16_t y) {
  return x + y;
}

SCALAR_FUN_ATTR uint32_t add32(uint32_t x, uint32_t y) {
  return x + y;
}

SCALAR_FUN_ATTR uint64_t add64(uint64_t x, uint64_t y) {
  return x + y;
}

SCALAR_FUN_ATTR uint8_t sub8(uint8_t x, uint8_t y) {
  return x - y;
}

SCALAR_FUN_ATTR uint16_t sub16(uint16_t x, uint16_t y) {
  return x - y;
}

SCALAR_FUN_ATTR uint32_t sub32(uint32_t x, uint32_t y) {
  return x - y;
}

SCALAR_FUN_ATTR uint64_t sub64(uint64_t x, uint64_t y) {
  return x - y;
}

SCALAR_FUN_ATTR uint8_t mul8(uint8_t x, uint8_t y) {
  return x * y;
}

SCALAR_FUN_ATTR uint16_t mul16(uint16_t x, uint16_t y) {
  return x * y;
}

SCALAR_FUN_ATTR uint32_t mul32(uint32_t x, uint32_t y) {
  return x * y;
}

SCALAR_FUN_ATTR uint64_t mul64(uint64_t x, uint64_t y) {
  return x * y;
}

#if ISPC

SCALAR_FUN_ATTR uint8_t udiv8(uint8_t x, uint8_t y) {
  // This strange pattern is used to prevent the ISPC compiler from
  // causing SIGFPEs and bogus results on divisions where inactive lanes
  // have 0-valued divisors. It ensures that any inactive lane instead
  // has a divisor of 1. https://github.com/ispc/ispc/issues/2292
  uint8_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return x / ys;
}

SCALAR_FUN_ATTR uint16_t udiv16(uint16_t x, uint16_t y) {
  uint16_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return x / ys;
}

SCALAR_FUN_ATTR uint32_t udiv32(uint32_t x, uint32_t y) {
  uint32_t ys = 1;
  foreach_active(i){
    ys = y;
  }


  return x / ys;
}

SCALAR_FUN_ATTR uint64_t udiv64(uint64_t x, uint64_t y) {
  uint64_t ys = 1;
  foreach_active(i){
    ys = y;
  }


  return x / ys;
}

SCALAR_FUN_ATTR uint8_t udiv_up8(uint8_t x, uint8_t y) {
  uint8_t ys = 1;
  foreach_active(i){
    ys = y;
  }


  return (x + y - 1) / ys;
}

SCALAR_FUN_ATTR uint16_t udiv_up16(uint16_t x, uint16_t y) {
  uint16_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return (x + y - 1) / ys;
}

SCALAR_FUN_ATTR uint32_t udiv_up32(uint32_t x, uint32_t y) {
  uint32_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return (x + y - 1) / ys;
}

SCALAR_FUN_ATTR uint64_t udiv_up64(uint64_t x, uint64_t y) {
  uint64_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return (x + y - 1) / ys;
}

SCALAR_FUN_ATTR uint8_t umod8(uint8_t x, uint8_t y) {
  uint8_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return x % ys;
}

SCALAR_FUN_ATTR uint16_t umod16(uint16_t x, uint16_t y) {
  uint16_t ys = 1;
  foreach_active(i){
    ys = y;
  }


  return x % ys;
}

SCALAR_FUN_ATTR uint32_t umod32(uint32_t x, uint32_t y) {
  uint32_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return x % ys;
}

SCALAR_FUN_ATTR uint64_t umod64(uint64_t x, uint64_t y) {
  uint64_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return x % ys;
}

SCALAR_FUN_ATTR uint8_t udiv_safe8(uint8_t x, uint8_t y) {
  uint8_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x / ys;
}

SCALAR_FUN_ATTR uint16_t udiv_safe16(uint16_t x, uint16_t y) {
  uint16_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x / ys;
}

SCALAR_FUN_ATTR uint32_t udiv_safe32(uint32_t x, uint32_t y) {
  uint32_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x / ys;
}

SCALAR_FUN_ATTR uint64_t udiv_safe64(uint64_t x, uint64_t y) {
  uint64_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x / ys;
}

SCALAR_FUN_ATTR uint8_t udiv_up_safe8(uint8_t x, uint8_t y) {
  uint8_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : (x + y - 1) / ys;
}

SCALAR_FUN_ATTR uint16_t udiv_up_safe16(uint16_t x, uint16_t y) {
  uint16_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : (x + y - 1) / ys;
}

SCALAR_FUN_ATTR uint32_t udiv_up_safe32(uint32_t x, uint32_t y) {
  uint32_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : (x + y - 1) / ys;
}

SCALAR_FUN_ATTR uint64_t udiv_up_safe64(uint64_t x, uint64_t y) {
  uint64_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : (x + y - 1) / ys;
}

SCALAR_FUN_ATTR uint8_t umod_safe8(uint8_t x, uint8_t y) {
  uint8_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x % ys;
}

SCALAR_FUN_ATTR uint16_t umod_safe16(uint16_t x, uint16_t y) {
  uint16_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x % ys;
}

SCALAR_FUN_ATTR uint32_t umod_safe32(uint32_t x, uint32_t y) {
  uint32_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x % ys;
}

SCALAR_FUN_ATTR uint64_t umod_safe64(uint64_t x, uint64_t y) {
  uint64_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x % ys;
}

SCALAR_FUN_ATTR int8_t sdiv8(int8_t x, int8_t y) {
  int8_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  int8_t q = x / ys;
  int8_t r = x % ys;

  return q - ((r != 0 && r < 0 != y < 0) ? 1 : 0);
}

SCALAR_FUN_ATTR int16_t sdiv16(int16_t x, int16_t y) {
  int16_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  int16_t q = x / ys;
  int16_t r = x % ys;

  return q - ((r != 0 && r < 0 != y < 0) ? 1 : 0);
}

SCALAR_FUN_ATTR int32_t sdiv32(int32_t x, int32_t y) {
  int32_t ys = 1;
  foreach_active(i){
    ys = y;
  }
  int32_t q = x / ys;
  int32_t r = x % ys;

  return q - ((r != 0 && r < 0 != y < 0) ? 1 : 0);
}

SCALAR_FUN_ATTR int64_t sdiv64(int64_t x, int64_t y) {
  int64_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  int64_t q = x / ys;
  int64_t r = x % ys;

  return q - ((r != 0 && r < 0 != y < 0) ? 1 : 0);
}

SCALAR_FUN_ATTR int8_t sdiv_up8(int8_t x, int8_t y) {
  return sdiv8(x + y - 1, y);
}

SCALAR_FUN_ATTR int16_t sdiv_up16(int16_t x, int16_t y) {
  return sdiv16(x + y - 1, y);
}

SCALAR_FUN_ATTR int32_t sdiv_up32(int32_t x, int32_t y) {
  return sdiv32(x + y - 1, y);
}

SCALAR_FUN_ATTR int64_t sdiv_up64(int64_t x, int64_t y) {
  return sdiv64(x + y - 1, y);
}

SCALAR_FUN_ATTR int8_t smod8(int8_t x, int8_t y) {
  int8_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  int8_t r = x % ys;

  return r + (r == 0 || (x > 0 && y > 0) || (x < 0 && y < 0) ? 0 : y);
}

SCALAR_FUN_ATTR int16_t smod16(int16_t x, int16_t y) {
  int16_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  int16_t r = x % ys;

  return r + (r == 0 || (x > 0 && y > 0) || (x < 0 && y < 0) ? 0 : y);
}

SCALAR_FUN_ATTR int32_t smod32(int32_t x, int32_t y) {
  int32_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  int32_t r = x % ys;

  return r + (r == 0 || (x > 0 && y > 0) || (x < 0 && y < 0) ? 0 : y);
}

SCALAR_FUN_ATTR int64_t smod64(int64_t x, int64_t y) {
  int64_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  int64_t r = x % ys;

  return r + (r == 0 || (x > 0 && y > 0) || (x < 0 && y < 0) ? 0 : y);
}

SCALAR_FUN_ATTR int8_t sdiv_safe8(int8_t x, int8_t y) {
  return y == 0 ? 0 : sdiv8(x, y);
}

SCALAR_FUN_ATTR int16_t sdiv_safe16(int16_t x, int16_t y) {
  return y == 0 ? 0 : sdiv16(x, y);
}

SCALAR_FUN_ATTR int32_t sdiv_safe32(int32_t x, int32_t y) {
  return y == 0 ? 0 : sdiv32(x, y);
}

SCALAR_FUN_ATTR int64_t sdiv_safe64(int64_t x, int64_t y) {
  return y == 0 ? 0 : sdiv64(x, y);
}

SCALAR_FUN_ATTR int8_t sdiv_up_safe8(int8_t x, int8_t y) {
  return sdiv_safe8(x + y - 1, y);
}

SCALAR_FUN_ATTR int16_t sdiv_up_safe16(int16_t x, int16_t y) {
  return sdiv_safe16(x + y - 1, y);
}

SCALAR_FUN_ATTR int32_t sdiv_up_safe32(int32_t x, int32_t y) {
  return sdiv_safe32(x + y - 1, y);
}

SCALAR_FUN_ATTR int64_t sdiv_up_safe64(int64_t x, int64_t y) {
  return sdiv_safe64(x + y - 1, y);
}

SCALAR_FUN_ATTR int8_t smod_safe8(int8_t x, int8_t y) {
  return y == 0 ? 0 : smod8(x, y);
}

SCALAR_FUN_ATTR int16_t smod_safe16(int16_t x, int16_t y) {
  return y == 0 ? 0 : smod16(x, y);
}

SCALAR_FUN_ATTR int32_t smod_safe32(int32_t x, int32_t y) {
  return y == 0 ? 0 : smod32(x, y);
}

SCALAR_FUN_ATTR int64_t smod_safe64(int64_t x, int64_t y) {
  return y == 0 ? 0 : smod64(x, y);
}

SCALAR_FUN_ATTR int8_t squot8(int8_t x, int8_t y) {
  int8_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return x / ys;
}

SCALAR_FUN_ATTR int16_t squot16(int16_t x, int16_t y) {
  int16_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return x / ys;
}

SCALAR_FUN_ATTR int32_t squot32(int32_t x, int32_t y) {
  int32_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return x / ys;
}

SCALAR_FUN_ATTR int64_t squot64(int64_t x, int64_t y) {
  int64_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return x / ys;
}

SCALAR_FUN_ATTR int8_t srem8(int8_t x, int8_t y) {
  int8_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return x % ys;
}

SCALAR_FUN_ATTR int16_t srem16(int16_t x, int16_t y) {
  int16_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return x % ys;
}

SCALAR_FUN_ATTR int32_t srem32(int32_t x, int32_t y) {
  int32_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return x % ys;
}

SCALAR_FUN_ATTR int64_t srem64(int64_t x, int64_t y) {
  int8_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return x % ys;
}

SCALAR_FUN_ATTR int8_t squot_safe8(int8_t x, int8_t y) {
  int8_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x / ys;
}

SCALAR_FUN_ATTR int16_t squot_safe16(int16_t x, int16_t y) {
  int16_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x / ys;
}

SCALAR_FUN_ATTR int32_t squot_safe32(int32_t x, int32_t y) {
  int32_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x / ys;
}

SCALAR_FUN_ATTR int64_t squot_safe64(int64_t x, int64_t y) {
  int64_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x / ys;
}

SCALAR_FUN_ATTR int8_t srem_safe8(int8_t x, int8_t y) {
  int8_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x % ys;
}

SCALAR_FUN_ATTR int16_t srem_safe16(int16_t x, int16_t y) {
  int16_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x % ys;
}

SCALAR_FUN_ATTR int32_t srem_safe32(int32_t x, int32_t y) {
  int32_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x % ys;
}

SCALAR_FUN_ATTR int64_t srem_safe64(int64_t x, int64_t y) {
  int64_t ys = 1;
  foreach_active(i){
    ys = y;
  }

  return y == 0 ? 0 : x % ys;
}

#else

SCALAR_FUN_ATTR uint8_t udiv8(uint8_t x, uint8_t y) {
  return x / y;
}

SCALAR_FUN_ATTR uint16_t udiv16(uint16_t x, uint16_t y) {
  return x / y;
}

SCALAR_FUN_ATTR uint32_t udiv32(uint32_t x, uint32_t y) {
  return x / y;
}

SCALAR_FUN_ATTR uint64_t udiv64(uint64_t x, uint64_t y) {
  return x / y;
}

SCALAR_FUN_ATTR uint8_t udiv_up8(uint8_t x, uint8_t y) {
  return (x + y - 1) / y;
}

SCALAR_FUN_ATTR uint16_t udiv_up16(uint16_t x, uint16_t y) {
  return (x + y - 1) / y;
}

SCALAR_FUN_ATTR uint32_t udiv_up32(uint32_t x, uint32_t y) {
  return (x + y - 1) / y;
}

SCALAR_FUN_ATTR uint64_t udiv_up64(uint64_t x, uint64_t y) {
  return (x + y - 1) / y;
}

SCALAR_FUN_ATTR uint8_t umod8(uint8_t x, uint8_t y) {
  return x % y;
}

SCALAR_FUN_ATTR uint16_t umod16(uint16_t x, uint16_t y) {
  return x % y;
}

SCALAR_FUN_ATTR uint32_t umod32(uint32_t x, uint32_t y) {
  return x % y;
}

SCALAR_FUN_ATTR uint64_t umod64(uint64_t x, uint64_t y) {
  return x % y;
}

SCALAR_FUN_ATTR uint8_t udiv_safe8(uint8_t x, uint8_t y) {
  return y == 0 ? 0 : x / y;
}

SCALAR_FUN_ATTR uint16_t udiv_safe16(uint16_t x, uint16_t y) {
  return y == 0 ? 0 : x / y;
}

SCALAR_FUN_ATTR uint32_t udiv_safe32(uint32_t x, uint32_t y) {
  return y == 0 ? 0 : x / y;
}

SCALAR_FUN_ATTR uint64_t udiv_safe64(uint64_t x, uint64_t y) {
  return y == 0 ? 0 : x / y;
}

SCALAR_FUN_ATTR uint8_t udiv_up_safe8(uint8_t x, uint8_t y) {
  return y == 0 ? 0 : (x + y - 1) / y;
}

SCALAR_FUN_ATTR uint16_t udiv_up_safe16(uint16_t x, uint16_t y) {
  return y == 0 ? 0 : (x + y - 1) / y;
}

SCALAR_FUN_ATTR uint32_t udiv_up_safe32(uint32_t x, uint32_t y) {
  return y == 0 ? 0 : (x + y - 1) / y;
}

SCALAR_FUN_ATTR uint64_t udiv_up_safe64(uint64_t x, uint64_t y) {
  return y == 0 ? 0 : (x + y - 1) / y;
}

SCALAR_FUN_ATTR uint8_t umod_safe8(uint8_t x, uint8_t y) {
  return y == 0 ? 0 : x % y;
}

SCALAR_FUN_ATTR uint16_t umod_safe16(uint16_t x, uint16_t y) {
  return y == 0 ? 0 : x % y;
}

SCALAR_FUN_ATTR uint32_t umod_safe32(uint32_t x, uint32_t y) {
  return y == 0 ? 0 : x % y;
}

SCALAR_FUN_ATTR uint64_t umod_safe64(uint64_t x, uint64_t y) {
  return y == 0 ? 0 : x % y;
}

SCALAR_FUN_ATTR int8_t sdiv8(int8_t x, int8_t y) {
  int8_t q = x / y;
  int8_t r = x % y;

  return q - ((r != 0 && r < 0 != y < 0) ? 1 : 0);
}

SCALAR_FUN_ATTR int16_t sdiv16(int16_t x, int16_t y) {
  int16_t q = x / y;
  int16_t r = x % y;

  return q - ((r != 0 && r < 0 != y < 0) ? 1 : 0);
}

SCALAR_FUN_ATTR int32_t sdiv32(int32_t x, int32_t y) {
  int32_t q = x / y;
  int32_t r = x % y;

  return q - ((r != 0 && r < 0 != y < 0) ? 1 : 0);
}

SCALAR_FUN_ATTR int64_t sdiv64(int64_t x, int64_t y) {
  int64_t q = x / y;
  int64_t r = x % y;

  return q - ((r != 0 && r < 0 != y < 0) ? 1 : 0);
}

SCALAR_FUN_ATTR int8_t sdiv_up8(int8_t x, int8_t y) {
  return sdiv8(x + y - 1, y);
}

SCALAR_FUN_ATTR int16_t sdiv_up16(int16_t x, int16_t y) {
  return sdiv16(x + y - 1, y);
}

SCALAR_FUN_ATTR int32_t sdiv_up32(int32_t x, int32_t y) {
  return sdiv32(x + y - 1, y);
}

SCALAR_FUN_ATTR int64_t sdiv_up64(int64_t x, int64_t y) {
  return sdiv64(x + y - 1, y);
}

SCALAR_FUN_ATTR int8_t smod8(int8_t x, int8_t y) {
  int8_t r = x % y;

  return r + (r == 0 || (x > 0 && y > 0) || (x < 0 && y < 0) ? 0 : y);
}

SCALAR_FUN_ATTR int16_t smod16(int16_t x, int16_t y) {
  int16_t r = x % y;

  return r + (r == 0 || (x > 0 && y > 0) || (x < 0 && y < 0) ? 0 : y);
}

SCALAR_FUN_ATTR int32_t smod32(int32_t x, int32_t y) {
  int32_t r = x % y;

  return r + (r == 0 || (x > 0 && y > 0) || (x < 0 && y < 0) ? 0 : y);
}

SCALAR_FUN_ATTR int64_t smod64(int64_t x, int64_t y) {
  int64_t r = x % y;

  return r + (r == 0 || (x > 0 && y > 0) || (x < 0 && y < 0) ? 0 : y);
}

SCALAR_FUN_ATTR int8_t sdiv_safe8(int8_t x, int8_t y) {
  return y == 0 ? 0 : sdiv8(x, y);
}

SCALAR_FUN_ATTR int16_t sdiv_safe16(int16_t x, int16_t y) {
  return y == 0 ? 0 : sdiv16(x, y);
}

SCALAR_FUN_ATTR int32_t sdiv_safe32(int32_t x, int32_t y) {
  return y == 0 ? 0 : sdiv32(x, y);
}

SCALAR_FUN_ATTR int64_t sdiv_safe64(int64_t x, int64_t y) {
  return y == 0 ? 0 : sdiv64(x, y);
}

SCALAR_FUN_ATTR int8_t sdiv_up_safe8(int8_t x, int8_t y) {
  return sdiv_safe8(x + y - 1, y);
}

SCALAR_FUN_ATTR int16_t sdiv_up_safe16(int16_t x, int16_t y) {
  return sdiv_safe16(x + y - 1, y);
}

SCALAR_FUN_ATTR int32_t sdiv_up_safe32(int32_t x, int32_t y) {
  return sdiv_safe32(x + y - 1, y);
}

SCALAR_FUN_ATTR int64_t sdiv_up_safe64(int64_t x, int64_t y) {
  return sdiv_safe64(x + y - 1, y);
}

SCALAR_FUN_ATTR int8_t smod_safe8(int8_t x, int8_t y) {
  return y == 0 ? 0 : smod8(x, y);
}

SCALAR_FUN_ATTR int16_t smod_safe16(int16_t x, int16_t y) {
  return y == 0 ? 0 : smod16(x, y);
}

SCALAR_FUN_ATTR int32_t smod_safe32(int32_t x, int32_t y) {
  return y == 0 ? 0 : smod32(x, y);
}

SCALAR_FUN_ATTR int64_t smod_safe64(int64_t x, int64_t y) {
  return y == 0 ? 0 : smod64(x, y);
}

SCALAR_FUN_ATTR int8_t squot8(int8_t x, int8_t y) {
  return x / y;
}

SCALAR_FUN_ATTR int16_t squot16(int16_t x, int16_t y) {
  return x / y;
}

SCALAR_FUN_ATTR int32_t squot32(int32_t x, int32_t y) {
  return x / y;
}

SCALAR_FUN_ATTR int64_t squot64(int64_t x, int64_t y) {
  return x / y;
}

SCALAR_FUN_ATTR int8_t srem8(int8_t x, int8_t y) {
  return x % y;
}

SCALAR_FUN_ATTR int16_t srem16(int16_t x, int16_t y) {
  return x % y;
}

SCALAR_FUN_ATTR int32_t srem32(int32_t x, int32_t y) {
  return x % y;
}

SCALAR_FUN_ATTR int64_t srem64(int64_t x, int64_t y) {
  return x % y;
}

SCALAR_FUN_ATTR int8_t squot_safe8(int8_t x, int8_t y) {
  return y == 0 ? 0 : x / y;
}

SCALAR_FUN_ATTR int16_t squot_safe16(int16_t x, int16_t y) {
  return y == 0 ? 0 : x / y;
}

SCALAR_FUN_ATTR int32_t squot_safe32(int32_t x, int32_t y) {
  return y == 0 ? 0 : x / y;
}

SCALAR_FUN_ATTR int64_t squot_safe64(int64_t x, int64_t y) {
  return y == 0 ? 0 : x / y;
}

SCALAR_FUN_ATTR int8_t srem_safe8(int8_t x, int8_t y) {
  return y == 0 ? 0 : x % y;
}

SCALAR_FUN_ATTR int16_t srem_safe16(int16_t x, int16_t y) {
  return y == 0 ? 0 : x % y;
}

SCALAR_FUN_ATTR int32_t srem_safe32(int32_t x, int32_t y) {
  return y == 0 ? 0 : x % y;
}

SCALAR_FUN_ATTR int64_t srem_safe64(int64_t x, int64_t y) {
  return y == 0 ? 0 : x % y;
}

#endif

SCALAR_FUN_ATTR int8_t smin8(int8_t x, int8_t y) {
  return x < y ? x : y;
}

SCALAR_FUN_ATTR int16_t smin16(int16_t x, int16_t y) {
  return x < y ? x : y;
}

SCALAR_FUN_ATTR int32_t smin32(int32_t x, int32_t y) {
  return x < y ? x : y;
}

SCALAR_FUN_ATTR int64_t smin64(int64_t x, int64_t y) {
  return x < y ? x : y;
}

SCALAR_FUN_ATTR uint8_t umin8(uint8_t x, uint8_t y) {
  return x < y ? x : y;
}

SCALAR_FUN_ATTR uint16_t umin16(uint16_t x, uint16_t y) {
  return x < y ? x : y;
}

SCALAR_FUN_ATTR uint32_t umin32(uint32_t x, uint32_t y) {
  return x < y ? x : y;
}

SCALAR_FUN_ATTR uint64_t umin64(uint64_t x, uint64_t y) {
  return x < y ? x : y;
}

SCALAR_FUN_ATTR int8_t smax8(int8_t x, int8_t y) {
  return x < y ? y : x;
}

SCALAR_FUN_ATTR int16_t smax16(int16_t x, int16_t y) {
  return x < y ? y : x;
}

SCALAR_FUN_ATTR int32_t smax32(int32_t x, int32_t y) {
  return x < y ? y : x;
}

SCALAR_FUN_ATTR int64_t smax64(int64_t x, int64_t y) {
  return x < y ? y : x;
}

SCALAR_FUN_ATTR uint8_t umax8(uint8_t x, uint8_t y) {
  return x < y ? y : x;
}

SCALAR_FUN_ATTR uint16_t umax16(uint16_t x, uint16_t y) {
  return x < y ? y : x;
}

SCALAR_FUN_ATTR uint32_t umax32(uint32_t x, uint32_t y) {
  return x < y ? y : x;
}

SCALAR_FUN_ATTR uint64_t umax64(uint64_t x, uint64_t y) {
  return x < y ? y : x;
}

SCALAR_FUN_ATTR uint8_t shl8(uint8_t x, uint8_t y) {
  return (uint8_t)(x << y);
}

SCALAR_FUN_ATTR uint16_t shl16(uint16_t x, uint16_t y) {
  return (uint16_t)(x << y);
}

SCALAR_FUN_ATTR uint32_t shl32(uint32_t x, uint32_t y) {
  return x << y;
}

SCALAR_FUN_ATTR uint64_t shl64(uint64_t x, uint64_t y) {
  return x << y;
}

SCALAR_FUN_ATTR uint8_t lshr8(uint8_t x, uint8_t y) {
  return x >> y;
}

SCALAR_FUN_ATTR uint16_t lshr16(uint16_t x, uint16_t y) {
  return x >> y;
}

SCALAR_FUN_ATTR uint32_t lshr32(uint32_t x, uint32_t y) {
  return x >> y;
}

SCALAR_FUN_ATTR uint64_t lshr64(uint64_t x, uint64_t y) {
  return x >> y;
}

SCALAR_FUN_ATTR int8_t ashr8(int8_t x, int8_t y) {
  return x >> y;
}

SCALAR_FUN_ATTR int16_t ashr16(int16_t x, int16_t y) {
  return x >> y;
}

SCALAR_FUN_ATTR int32_t ashr32(int32_t x, int32_t y) {
  return x >> y;
}

SCALAR_FUN_ATTR int64_t ashr64(int64_t x, int64_t y) {
  return x >> y;
}

SCALAR_FUN_ATTR uint8_t and8(uint8_t x, uint8_t y) {
  return x & y;
}

SCALAR_FUN_ATTR uint16_t and16(uint16_t x, uint16_t y) {
  return x & y;
}

SCALAR_FUN_ATTR uint32_t and32(uint32_t x, uint32_t y) {
  return x & y;
}

SCALAR_FUN_ATTR uint64_t and64(uint64_t x, uint64_t y) {
  return x & y;
}

SCALAR_FUN_ATTR uint8_t or8(uint8_t x, uint8_t y) {
  return x | y;
}

SCALAR_FUN_ATTR uint16_t or16(uint16_t x, uint16_t y) {
  return x | y;
}

SCALAR_FUN_ATTR uint32_t or32(uint32_t x, uint32_t y) {
  return x | y;
}

SCALAR_FUN_ATTR uint64_t or64(uint64_t x, uint64_t y) {
  return x | y;
}

SCALAR_FUN_ATTR uint8_t xor8(uint8_t x, uint8_t y) {
  return x ^ y;
}

SCALAR_FUN_ATTR uint16_t xor16(uint16_t x, uint16_t y) {
  return x ^ y;
}

SCALAR_FUN_ATTR uint32_t xor32(uint32_t x, uint32_t y) {
  return x ^ y;
}

SCALAR_FUN_ATTR uint64_t xor64(uint64_t x, uint64_t y) {
  return x ^ y;
}

SCALAR_FUN_ATTR bool ult8(uint8_t x, uint8_t y) {
  return x < y;
}

SCALAR_FUN_ATTR bool ult16(uint16_t x, uint16_t y) {
  return x < y;
}

SCALAR_FUN_ATTR bool ult32(uint32_t x, uint32_t y) {
  return x < y;
}

SCALAR_FUN_ATTR bool ult64(uint64_t x, uint64_t y) {
  return x < y;
}

SCALAR_FUN_ATTR bool ule8(uint8_t x, uint8_t y) {
  return x <= y;
}

SCALAR_FUN_ATTR bool ule16(uint16_t x, uint16_t y) {
  return x <= y;
}

SCALAR_FUN_ATTR bool ule32(uint32_t x, uint32_t y) {
  return x <= y;
}

SCALAR_FUN_ATTR bool ule64(uint64_t x, uint64_t y) {
  return x <= y;
}

SCALAR_FUN_ATTR bool slt8(int8_t x, int8_t y) {
  return x < y;
}

SCALAR_FUN_ATTR bool slt16(int16_t x, int16_t y) {
  return x < y;
}

SCALAR_FUN_ATTR bool slt32(int32_t x, int32_t y) {
  return x < y;
}

SCALAR_FUN_ATTR bool slt64(int64_t x, int64_t y) {
  return x < y;
}

SCALAR_FUN_ATTR bool sle8(int8_t x, int8_t y) {
  return x <= y;
}

SCALAR_FUN_ATTR bool sle16(int16_t x, int16_t y) {
  return x <= y;
}

SCALAR_FUN_ATTR bool sle32(int32_t x, int32_t y) {
  return x <= y;
}

SCALAR_FUN_ATTR bool sle64(int64_t x, int64_t y) {
  return x <= y;
}

SCALAR_FUN_ATTR uint8_t pow8(uint8_t x, uint8_t y) {
  uint8_t res = 1, rem = y;

  while (rem != 0) {
    if (rem & 1)
      res *= x;
    rem >>= 1;
    x *= x;
  }
  return res;
}

SCALAR_FUN_ATTR uint16_t pow16(uint16_t x, uint16_t y) {
  uint16_t res = 1, rem = y;

  while (rem != 0) {
    if (rem & 1)
      res *= x;
    rem >>= 1;
    x *= x;
  }
  return res;
}

SCALAR_FUN_ATTR uint32_t pow32(uint32_t x, uint32_t y) {
  uint32_t res = 1, rem = y;

  while (rem != 0) {
    if (rem & 1)
      res *= x;
    rem >>= 1;
    x *= x;
  }
  return res;
}

SCALAR_FUN_ATTR uint64_t pow64(uint64_t x, uint64_t y) {
  uint64_t res = 1, rem = y;

  while (rem != 0) {
    if (rem & 1)
      res *= x;
    rem >>= 1;
    x *= x;
  }
  return res;
}

SCALAR_FUN_ATTR bool itob_i8_bool(int8_t x) {
  return x != 0;
}

SCALAR_FUN_ATTR bool itob_i16_bool(int16_t x) {
  return x != 0;
}

SCALAR_FUN_ATTR bool itob_i32_bool(int32_t x) {
  return x != 0;
}

SCALAR_FUN_ATTR bool itob_i64_bool(int64_t x) {
  return x != 0;
}

SCALAR_FUN_ATTR int8_t btoi_bool_i8(bool x) {
  return x;
}

SCALAR_FUN_ATTR int16_t btoi_bool_i16(bool x) {
  return x;
}

SCALAR_FUN_ATTR int32_t btoi_bool_i32(bool x) {
  return x;
}

SCALAR_FUN_ATTR int64_t btoi_bool_i64(bool x) {
  return x;
}

#define sext_i8_i8(x) ((int8_t) (int8_t) (x))
#define sext_i8_i16(x) ((int16_t) (int8_t) (x))
#define sext_i8_i32(x) ((int32_t) (int8_t) (x))
#define sext_i8_i64(x) ((int64_t) (int8_t) (x))
#define sext_i16_i8(x) ((int8_t) (int16_t) (x))
#define sext_i16_i16(x) ((int16_t) (int16_t) (x))
#define sext_i16_i32(x) ((int32_t) (int16_t) (x))
#define sext_i16_i64(x) ((int64_t) (int16_t) (x))
#define sext_i32_i8(x) ((int8_t) (int32_t) (x))
#define sext_i32_i16(x) ((int16_t) (int32_t) (x))
#define sext_i32_i32(x) ((int32_t) (int32_t) (x))
#define sext_i32_i64(x) ((int64_t) (int32_t) (x))
#define sext_i64_i8(x) ((int8_t) (int64_t) (x))
#define sext_i64_i16(x) ((int16_t) (int64_t) (x))
#define sext_i64_i32(x) ((int32_t) (int64_t) (x))
#define sext_i64_i64(x) ((int64_t) (int64_t) (x))
#define zext_i8_i8(x) ((int8_t) (uint8_t) (x))
#define zext_i8_i16(x) ((int16_t) (uint8_t) (x))
#define zext_i8_i32(x) ((int32_t) (uint8_t) (x))
#define zext_i8_i64(x) ((int64_t) (uint8_t) (x))
#define zext_i16_i8(x) ((int8_t) (uint16_t) (x))
#define zext_i16_i16(x) ((int16_t) (uint16_t) (x))
#define zext_i16_i32(x) ((int32_t) (uint16_t) (x))
#define zext_i16_i64(x) ((int64_t) (uint16_t) (x))
#define zext_i32_i8(x) ((int8_t) (uint32_t) (x))
#define zext_i32_i16(x) ((int16_t) (uint32_t) (x))
#define zext_i32_i32(x) ((int32_t) (uint32_t) (x))
#define zext_i32_i64(x) ((int64_t) (uint32_t) (x))
#define zext_i64_i8(x) ((int8_t) (uint64_t) (x))
#define zext_i64_i16(x) ((int16_t) (uint64_t) (x))
#define zext_i64_i32(x) ((int32_t) (uint64_t) (x))
#define zext_i64_i64(x) ((int64_t) (uint64_t) (x))

SCALAR_FUN_ATTR int8_t abs8(int8_t x) {
  return (int8_t)abs(x);
}

SCALAR_FUN_ATTR int16_t abs16(int16_t x) {
  return (int16_t)abs(x);
}

SCALAR_FUN_ATTR int32_t abs32(int32_t x) {
  return abs(x);
}

SCALAR_FUN_ATTR int64_t abs64(int64_t x) {
#if defined(__OPENCL_VERSION__) || defined(ISPC)
  return abs(x);
#else
  return llabs(x);
#endif
}

#if defined(__OPENCL_VERSION__)
SCALAR_FUN_ATTR int32_t futrts_popc8(int8_t x) {
  return popcount(x);
}

SCALAR_FUN_ATTR int32_t futrts_popc16(int16_t x) {
  return popcount(x);
}

SCALAR_FUN_ATTR int32_t futrts_popc32(int32_t x) {
  return popcount(x);
}

SCALAR_FUN_ATTR int32_t futrts_popc64(int64_t x) {
  return popcount(x);
}
#elif defined(__CUDA_ARCH__)

SCALAR_FUN_ATTR int32_t futrts_popc8(int8_t x) {
  return __popc(zext_i8_i32(x));
}

SCALAR_FUN_ATTR int32_t futrts_popc16(int16_t x) {
  return __popc(zext_i16_i32(x));
}

SCALAR_FUN_ATTR int32_t futrts_popc32(int32_t x) {
  return __popc(x);
}

SCALAR_FUN_ATTR int32_t futrts_popc64(int64_t x) {
  return __popcll(x);
}

#else // Not OpenCL or CUDA, but plain C.

SCALAR_FUN_ATTR int32_t futrts_popc8(uint8_t x) {
  int c = 0;
  for (; x; ++c) { x &= x - 1; }
  return c;
}

SCALAR_FUN_ATTR int32_t futrts_popc16(uint16_t x) {
  int c = 0;
  for (; x; ++c) { x &= x - 1; }
  return c;
}

SCALAR_FUN_ATTR int32_t futrts_popc32(uint32_t x) {
  int c = 0;
  for (; x; ++c) { x &= x - 1; }
  return c;
}

SCALAR_FUN_ATTR int32_t futrts_popc64(uint64_t x) {
  int c = 0;
  for (; x; ++c) { x &= x - 1; }
  return c;
}
#endif

#if defined(__OPENCL_VERSION__)
SCALAR_FUN_ATTR uint8_t  futrts_umul_hi8 ( uint8_t a,  uint8_t b) { return mul_hi(a, b); }
SCALAR_FUN_ATTR uint16_t futrts_umul_hi16(uint16_t a, uint16_t b) { return mul_hi(a, b); }
SCALAR_FUN_ATTR uint32_t futrts_umul_hi32(uint32_t a, uint32_t b) { return mul_hi(a, b); }
SCALAR_FUN_ATTR uint64_t futrts_umul_hi64(uint64_t a, uint64_t b) { return mul_hi(a, b); }
SCALAR_FUN_ATTR uint8_t  futrts_smul_hi8 ( int8_t a,  int8_t b) { return mul_hi(a, b); }
SCALAR_FUN_ATTR uint16_t futrts_smul_hi16(int16_t a, int16_t b) { return mul_hi(a, b); }
SCALAR_FUN_ATTR uint32_t futrts_smul_hi32(int32_t a, int32_t b) { return mul_hi(a, b); }
SCALAR_FUN_ATTR uint64_t futrts_smul_hi64(int64_t a, int64_t b) { return mul_hi(a, b); }
#elif defined(__CUDA_ARCH__)
SCALAR_FUN_ATTR  uint8_t futrts_umul_hi8(uint8_t a, uint8_t b) { return ((uint16_t)a) * ((uint16_t)b) >> 8; }
SCALAR_FUN_ATTR uint16_t futrts_umul_hi16(uint16_t a, uint16_t b) { return ((uint32_t)a) * ((uint32_t)b) >> 16; }
SCALAR_FUN_ATTR uint32_t futrts_umul_hi32(uint32_t a, uint32_t b) { return __umulhi(a, b); }
SCALAR_FUN_ATTR uint64_t futrts_umul_hi64(uint64_t a, uint64_t b) { return __umul64hi(a, b); }
SCALAR_FUN_ATTR  uint8_t futrts_smul_hi8 ( int8_t a, int8_t b) { return ((int16_t)a) * ((int16_t)b) >> 8; }
SCALAR_FUN_ATTR uint16_t futrts_smul_hi16(int16_t a, int16_t b) { return ((int32_t)a) * ((int32_t)b) >> 16; }
SCALAR_FUN_ATTR uint32_t futrts_smul_hi32(int32_t a, int32_t b) { return __mulhi(a, b); }
SCALAR_FUN_ATTR uint64_t futrts_smul_hi64(int64_t a, int64_t b) { return __mul64hi(a, b); }
#elif ISPC
SCALAR_FUN_ATTR uint8_t futrts_umul_hi8(uint8_t a, uint8_t b) { return ((uint16_t)a) * ((uint16_t)b) >> 8; }
SCALAR_FUN_ATTR uint16_t futrts_umul_hi16(uint16_t a, uint16_t b) { return ((uint32_t)a) * ((uint32_t)b) >> 16; }
SCALAR_FUN_ATTR uint32_t futrts_umul_hi32(uint32_t a, uint32_t b) { return ((uint64_t)a) * ((uint64_t)b) >> 32; }
SCALAR_FUN_ATTR uint64_t futrts_umul_hi64(uint64_t a, uint64_t b) {
  uint64_t ah = a >> 32;
  uint64_t al = a & 0xffffffff;
  uint64_t bh = b >> 32;
  uint64_t bl = b & 0xffffffff;

  uint64_t p1 = al * bl;
  uint64_t p2 = al * bh;
  uint64_t p3 = ah * bl;
  uint64_t p4 = ah * bh;

  uint64_t p1h = p1 >> 32;
  uint64_t p2h = p2 >> 32;
  uint64_t p3h = p3 >> 32;
  uint64_t p2l = p2 & 0xffffffff;
  uint64_t p3l = p3 & 0xffffffff;

  uint64_t l = p1h + p2l + p3l;
  uint64_t m = (p2 >> 32) + (p3 >> 32);
  uint64_t h = (l >> 32) + m + p4;

  return h;
}
SCALAR_FUN_ATTR  int8_t futrts_smul_hi8 ( int8_t a,  int8_t b) { return ((uint16_t)a) * ((uint16_t)b) >> 8; }
SCALAR_FUN_ATTR int16_t futrts_smul_hi16(int16_t a, int16_t b) { return ((uint32_t)a) * ((uint32_t)b) >> 16; }
SCALAR_FUN_ATTR int32_t futrts_smul_hi32(int32_t a, int32_t b) { return ((uint64_t)a) * ((uint64_t)b) >> 32; }
SCALAR_FUN_ATTR int64_t futrts_smul_hi64(int64_t a, int64_t b) {
  uint64_t ah = a >> 32;
  uint64_t al = a & 0xffffffff;
  uint64_t bh = b >> 32;
  uint64_t bl = b & 0xffffffff;

  uint64_t p1 =  al * bl;
  int64_t  p2 = al * bh;
  int64_t  p3 = ah * bl;
  uint64_t p4 =  ah * bh;

  uint64_t p1h = p1 >> 32;
  uint64_t p2h = p2 >> 32;
  uint64_t p3h = p3 >> 32;
  uint64_t p2l = p2 & 0xffffffff;
  uint64_t p3l = p3 & 0xffffffff;

  uint64_t l = p1h + p2l + p3l;
  uint64_t m = (p2 >> 32) + (p3 >> 32);
  uint64_t h = (l >> 32) + m + p4;

  return h;
}

#else // Not OpenCL, ISPC, or CUDA, but plain C.
SCALAR_FUN_ATTR uint8_t futrts_umul_hi8(uint8_t a, uint8_t b) { return ((uint16_t)a) * ((uint16_t)b) >> 8; }
SCALAR_FUN_ATTR uint16_t futrts_umul_hi16(uint16_t a, uint16_t b) { return ((uint32_t)a) * ((uint32_t)b) >> 16; }
SCALAR_FUN_ATTR uint32_t futrts_umul_hi32(uint32_t a, uint32_t b) { return ((uint64_t)a) * ((uint64_t)b) >> 32; }
SCALAR_FUN_ATTR uint64_t futrts_umul_hi64(uint64_t a, uint64_t b) { return ((__uint128_t)a) * ((__uint128_t)b) >> 64; }
SCALAR_FUN_ATTR int8_t futrts_smul_hi8(int8_t a, int8_t b) { return ((int16_t)a) * ((int16_t)b) >> 8; }
SCALAR_FUN_ATTR int16_t futrts_smul_hi16(int16_t a, int16_t b) { return ((int32_t)a) * ((int32_t)b) >> 16; }
SCALAR_FUN_ATTR int32_t futrts_smul_hi32(int32_t a, int32_t b) { return ((int64_t)a) * ((int64_t)b) >> 32; }
SCALAR_FUN_ATTR int64_t futrts_smul_hi64(int64_t a, int64_t b) { return ((__int128_t)a) * ((__int128_t)b) >> 64; }
#endif

#if defined(__OPENCL_VERSION__)
SCALAR_FUN_ATTR  uint8_t futrts_umad_hi8 ( uint8_t a,  uint8_t b,  uint8_t c) { return mad_hi(a, b, c); }
SCALAR_FUN_ATTR uint16_t futrts_umad_hi16(uint16_t a, uint16_t b, uint16_t c) { return mad_hi(a, b, c); }
SCALAR_FUN_ATTR uint32_t futrts_umad_hi32(uint32_t a, uint32_t b, uint32_t c) { return mad_hi(a, b, c); }
SCALAR_FUN_ATTR uint64_t futrts_umad_hi64(uint64_t a, uint64_t b, uint64_t c) { return mad_hi(a, b, c); }
SCALAR_FUN_ATTR  uint8_t futrts_smad_hi8( int8_t a,  int8_t b,   int8_t c) { return mad_hi(a, b, c); }
SCALAR_FUN_ATTR uint16_t futrts_smad_hi16(int16_t a, int16_t b, int16_t c) { return mad_hi(a, b, c); }
SCALAR_FUN_ATTR uint32_t futrts_smad_hi32(int32_t a, int32_t b, int32_t c) { return mad_hi(a, b, c); }
SCALAR_FUN_ATTR uint64_t futrts_smad_hi64(int64_t a, int64_t b, int64_t c) { return mad_hi(a, b, c); }
#else // Not OpenCL

SCALAR_FUN_ATTR  uint8_t futrts_umad_hi8( uint8_t a,  uint8_t b,  uint8_t c) { return futrts_umul_hi8(a, b) + c; }
SCALAR_FUN_ATTR uint16_t futrts_umad_hi16(uint16_t a, uint16_t b, uint16_t c) { return futrts_umul_hi16(a, b) + c; }
SCALAR_FUN_ATTR uint32_t futrts_umad_hi32(uint32_t a, uint32_t b, uint32_t c) { return futrts_umul_hi32(a, b) + c; }
SCALAR_FUN_ATTR uint64_t futrts_umad_hi64(uint64_t a, uint64_t b, uint64_t c) { return futrts_umul_hi64(a, b) + c; }
SCALAR_FUN_ATTR  uint8_t futrts_smad_hi8 ( int8_t a,  int8_t b,  int8_t c) { return futrts_smul_hi8(a, b) + c; }
SCALAR_FUN_ATTR uint16_t futrts_smad_hi16(int16_t a, int16_t b, int16_t c) { return futrts_smul_hi16(a, b) + c; }
SCALAR_FUN_ATTR uint32_t futrts_smad_hi32(int32_t a, int32_t b, int32_t c) { return futrts_smul_hi32(a, b) + c; }
SCALAR_FUN_ATTR uint64_t futrts_smad_hi64(int64_t a, int64_t b, int64_t c) { return futrts_smul_hi64(a, b) + c; }
#endif

#if defined(__OPENCL_VERSION__)
SCALAR_FUN_ATTR int32_t futrts_clzz8(int8_t x) {
  return clz(x);
}

SCALAR_FUN_ATTR int32_t futrts_clzz16(int16_t x) {
  return clz(x);
}

SCALAR_FUN_ATTR int32_t futrts_clzz32(int32_t x) {
  return clz(x);
}

SCALAR_FUN_ATTR int32_t futrts_clzz64(int64_t x) {
  return clz(x);
}

#elif defined(__CUDA_ARCH__)

SCALAR_FUN_ATTR int32_t futrts_clzz8(int8_t x) {
  return __clz(zext_i8_i32(x)) - 24;
}

SCALAR_FUN_ATTR int32_t futrts_clzz16(int16_t x) {
  return __clz(zext_i16_i32(x)) - 16;
}

SCALAR_FUN_ATTR int32_t futrts_clzz32(int32_t x) {
  return __clz(x);
}

SCALAR_FUN_ATTR int32_t futrts_clzz64(int64_t x) {
  return __clzll(x);
}

#elif ISPC

SCALAR_FUN_ATTR int32_t futrts_clzz8(int8_t x) {
  return count_leading_zeros((int32_t)(uint8_t)x)-24;
}

SCALAR_FUN_ATTR int32_t futrts_clzz16(int16_t x) {
  return count_leading_zeros((int32_t)(uint16_t)x)-16;
}

SCALAR_FUN_ATTR int32_t futrts_clzz32(int32_t x) {
  return count_leading_zeros(x);
}

SCALAR_FUN_ATTR int32_t futrts_clzz64(int64_t x) {
  return count_leading_zeros(x);
}

#else // Not OpenCL, ISPC or CUDA, but plain C.

SCALAR_FUN_ATTR int32_t futrts_clzz8(int8_t x) {
  return x == 0 ? 8 : __builtin_clz((uint32_t)zext_i8_i32(x)) - 24;
}

SCALAR_FUN_ATTR int32_t futrts_clzz16(int16_t x) {
  return x == 0 ? 16 : __builtin_clz((uint32_t)zext_i16_i32(x)) - 16;
}

SCALAR_FUN_ATTR int32_t futrts_clzz32(int32_t x) {
  return x == 0 ? 32 : __builtin_clz((uint32_t)x);
}

SCALAR_FUN_ATTR int32_t futrts_clzz64(int64_t x) {
  return x == 0 ? 64 : __builtin_clzll((uint64_t)x);
}
#endif

#if defined(__OPENCL_VERSION__)
SCALAR_FUN_ATTR int32_t futrts_ctzz8(int8_t x) {
  int i = 0;
  for (; i < 8 && (x & 1) == 0; i++, x >>= 1)
    ;
  return i;
}

SCALAR_FUN_ATTR int32_t futrts_ctzz16(int16_t x) {
  int i = 0;
  for (; i < 16 && (x & 1) == 0; i++, x >>= 1)
    ;
  return i;
}

SCALAR_FUN_ATTR int32_t futrts_ctzz32(int32_t x) {
  int i = 0;
  for (; i < 32 && (x & 1) == 0; i++, x >>= 1)
    ;
  return i;
}

SCALAR_FUN_ATTR int32_t futrts_ctzz64(int64_t x) {
  int i = 0;
  for (; i < 64 && (x & 1) == 0; i++, x >>= 1)
    ;
  return i;
}

#elif defined(__CUDA_ARCH__)

SCALAR_FUN_ATTR int32_t futrts_ctzz8(int8_t x) {
  int y = __ffs(x);
  return y == 0 ? 8 : y - 1;
}

SCALAR_FUN_ATTR int32_t futrts_ctzz16(int16_t x) {
  int y = __ffs(x);
  return y == 0 ? 16 : y - 1;
}

SCALAR_FUN_ATTR int32_t futrts_ctzz32(int32_t x) {
  int y = __ffs(x);
  return y == 0 ? 32 : y - 1;
}

SCALAR_FUN_ATTR int32_t futrts_ctzz64(int64_t x) {
  int y = __ffsll(x);
  return y == 0 ? 64 : y - 1;
}

#elif ISPC

SCALAR_FUN_ATTR int32_t futrts_ctzz8(int8_t x) {
  return x == 0 ? 8 : count_trailing_zeros((int32_t)x);
}

SCALAR_FUN_ATTR int32_t futrts_ctzz16(int16_t x) {
  return x == 0 ? 16 : count_trailing_zeros((int32_t)x);
}

SCALAR_FUN_ATTR int32_t futrts_ctzz32(int32_t x) {
  return count_trailing_zeros(x);
}

SCALAR_FUN_ATTR int32_t futrts_ctzz64(int64_t x) {
  return count_trailing_zeros(x);
}

#else // Not OpenCL or CUDA, but plain C.

SCALAR_FUN_ATTR int32_t futrts_ctzz8(int8_t x) {
  return x == 0 ? 8 : __builtin_ctz((uint32_t)x);
}

SCALAR_FUN_ATTR int32_t futrts_ctzz16(int16_t x) {
  return x == 0 ? 16 : __builtin_ctz((uint32_t)x);
}

SCALAR_FUN_ATTR int32_t futrts_ctzz32(int32_t x) {
  return x == 0 ? 32 : __builtin_ctz((uint32_t)x);
}

SCALAR_FUN_ATTR int32_t futrts_ctzz64(int64_t x) {
  return x == 0 ? 64 : __builtin_ctzll((uint64_t)x);
}
#endif

SCALAR_FUN_ATTR float fdiv32(float x, float y) {
  return x / y;
}

SCALAR_FUN_ATTR float fadd32(float x, float y) {
  return x + y;
}

SCALAR_FUN_ATTR float fsub32(float x, float y) {
  return x - y;
}

SCALAR_FUN_ATTR float fmul32(float x, float y) {
  return x * y;
}

SCALAR_FUN_ATTR bool cmplt32(float x, float y) {
  return x < y;
}

SCALAR_FUN_ATTR bool cmple32(float x, float y) {
  return x <= y;
}

SCALAR_FUN_ATTR float sitofp_i8_f32(int8_t x) {
  return (float) x;
}

SCALAR_FUN_ATTR float sitofp_i16_f32(int16_t x) {
  return (float) x;
}

SCALAR_FUN_ATTR float sitofp_i32_f32(int32_t x) {
  return (float) x;
}

SCALAR_FUN_ATTR float sitofp_i64_f32(int64_t x) {
  return (float) x;
}

SCALAR_FUN_ATTR float uitofp_i8_f32(uint8_t x) {
  return (float) x;
}

SCALAR_FUN_ATTR float uitofp_i16_f32(uint16_t x) {
  return (float) x;
}

SCALAR_FUN_ATTR float uitofp_i32_f32(uint32_t x) {
  return (float) x;
}

SCALAR_FUN_ATTR float uitofp_i64_f32(uint64_t x) {
  return (float) x;
}

#ifdef __OPENCL_VERSION__
SCALAR_FUN_ATTR float fabs32(float x) {
  return fabs(x);
}

SCALAR_FUN_ATTR float fmax32(float x, float y) {
  return fmax(x, y);
}

SCALAR_FUN_ATTR float fmin32(float x, float y) {
  return fmin(x, y);
}

SCALAR_FUN_ATTR float fpow32(float x, float y) {
  return pow(x, y);
}

#elif ISPC

SCALAR_FUN_ATTR float fabs32(float x) {
  return abs(x);
}

SCALAR_FUN_ATTR float fmax32(float x, float y) {
  return isnan(x) ? y : isnan(y) ? x : max(x, y);
}

SCALAR_FUN_ATTR float fmin32(float x, float y) {
  return isnan(x) ? y : isnan(y) ? x : min(x, y);
}

SCALAR_FUN_ATTR float fpow32(float a, float b) {
  float ret;
  foreach_active (i) {
      uniform float r = __stdlib_powf(extract(a, i), extract(b, i));
      ret = insert(ret, i, r);
  }
  return ret;
}

#else // Not OpenCL, but CUDA or plain C.

SCALAR_FUN_ATTR float fabs32(float x) {
  return fabsf(x);
}

SCALAR_FUN_ATTR float fmax32(float x, float y) {
  return fmaxf(x, y);
}

SCALAR_FUN_ATTR float fmin32(float x, float y) {
  return fminf(x, y);
}

SCALAR_FUN_ATTR float fpow32(float x, float y) {
  return powf(x, y);
}
#endif

SCALAR_FUN_ATTR bool futrts_isnan32(float x) {
  return isnan(x);
}

#if ISPC

SCALAR_FUN_ATTR bool futrts_isinf32(float x) {
  return !isnan(x) && isnan(x - x);
}

SCALAR_FUN_ATTR bool futrts_isfinite32(float x) {
  return !isnan(x) && !futrts_isinf32(x);
}

#else

SCALAR_FUN_ATTR bool futrts_isinf32(float x) {
  return isinf(x);
}

#endif

SCALAR_FUN_ATTR int8_t fptosi_f32_i8(float x) {
  if (futrts_isnan32(x) || futrts_isinf32(x)) {
    return 0;
  } else {
    return (int8_t) x;
  }
}

SCALAR_FUN_ATTR int16_t fptosi_f32_i16(float x) {
  if (futrts_isnan32(x) || futrts_isinf32(x)) {
    return 0;
  } else {
    return (int16_t) x;
  }
}

SCALAR_FUN_ATTR int32_t fptosi_f32_i32(float x) {
  if (futrts_isnan32(x) || futrts_isinf32(x)) {
    return 0;
  } else {
    return (int32_t) x;
  }
}

SCALAR_FUN_ATTR int64_t fptosi_f32_i64(float x) {
  if (futrts_isnan32(x) || futrts_isinf32(x)) {
    return 0;
  } else {
    return (int64_t) x;
  };
}

SCALAR_FUN_ATTR uint8_t fptoui_f32_i8(float x) {
  if (futrts_isnan32(x) || futrts_isinf32(x)) {
    return 0;
  } else {
    return (uint8_t) (int8_t) x;
  }
}

SCALAR_FUN_ATTR uint16_t fptoui_f32_i16(float x) {
  if (futrts_isnan32(x) || futrts_isinf32(x)) {
    return 0;
  } else {
    return (uint16_t) (int16_t) x;
  }
}

SCALAR_FUN_ATTR uint32_t fptoui_f32_i32(float x) {
  if (futrts_isnan32(x) || futrts_isinf32(x)) {
    return 0;
  } else {
    return (uint32_t) (int32_t) x;
  }
}

SCALAR_FUN_ATTR uint64_t fptoui_f32_i64(float x) {
  if (futrts_isnan32(x) || futrts_isinf32(x)) {
    return 0;
  } else {
    return (uint64_t) (int64_t) x;
  }
}

SCALAR_FUN_ATTR bool ftob_f32_bool(float x) {
  return x != 0;
}

SCALAR_FUN_ATTR float btof_bool_f32(bool x) {
  return x ? 1 : 0;
}

#ifdef __OPENCL_VERSION__
SCALAR_FUN_ATTR float futrts_log32(float x) {
  return log(x);
}

SCALAR_FUN_ATTR float futrts_log2_32(float x) {
  return log2(x);
}

SCALAR_FUN_ATTR float futrts_log10_32(float x) {
  return log10(x);
}

SCALAR_FUN_ATTR float futrts_log1p_32(float x) {
  return log1p(x);
}

SCALAR_FUN_ATTR float futrts_sqrt32(float x) {
  return sqrt(x);
}

SCALAR_FUN_ATTR float futrts_cbrt32(float x) {
  return cbrt(x);
}

SCALAR_FUN_ATTR float futrts_exp32(float x) {
  return exp(x);
}

SCALAR_FUN_ATTR float futrts_cos32(float x) {
  return cos(x);
}

SCALAR_FUN_ATTR float futrts_sin32(float x) {
  return sin(x);
}

SCALAR_FUN_ATTR float futrts_tan32(float x) {
  return tan(x);
}

SCALAR_FUN_ATTR float futrts_acos32(float x) {
  return acos(x);
}

SCALAR_FUN_ATTR float futrts_asin32(float x) {
  return asin(x);
}

SCALAR_FUN_ATTR float futrts_atan32(float x) {
  return atan(x);
}

SCALAR_FUN_ATTR float futrts_cosh32(float x) {
  return cosh(x);
}

SCALAR_FUN_ATTR float futrts_sinh32(float x) {
  return sinh(x);
}

SCALAR_FUN_ATTR float futrts_tanh32(float x) {
  return tanh(x);
}

SCALAR_FUN_ATTR float futrts_acosh32(float x) {
  return acosh(x);
}

SCALAR_FUN_ATTR float futrts_asinh32(float x) {
  return asinh(x);
}

SCALAR_FUN_ATTR float futrts_atanh32(float x) {
  return atanh(x);
}

SCALAR_FUN_ATTR float futrts_atan2_32(float x, float y) {
  return atan2(x, y);
}

SCALAR_FUN_ATTR float futrts_hypot32(float x, float y) {
  return hypot(x, y);
}

SCALAR_FUN_ATTR float futrts_gamma32(float x) {
  return tgamma(x);
}

SCALAR_FUN_ATTR float futrts_lgamma32(float x) {
  return lgamma(x);
}

SCALAR_FUN_ATTR float futrts_erf32(float x) {
  return erf(x);
}

SCALAR_FUN_ATTR float futrts_erfc32(float x) {
  return erfc(x);
}

SCALAR_FUN_ATTR float fmod32(float x, float y) {
  return fmod(x, y);
}

SCALAR_FUN_ATTR float futrts_round32(float x) {
  return rint(x);
}

SCALAR_FUN_ATTR float futrts_floor32(float x) {
  return floor(x);
}

SCALAR_FUN_ATTR float futrts_ceil32(float x) {
  return ceil(x);
}

SCALAR_FUN_ATTR float futrts_nextafter32(float x, float y) {
  return nextafter(x, y);
}

SCALAR_FUN_ATTR float futrts_lerp32(float v0, float v1, float t) {
  return mix(v0, v1, t);
}

SCALAR_FUN_ATTR float futrts_ldexp32(float x, int32_t y) {
  return ldexp(x, y);
}

SCALAR_FUN_ATTR float futrts_copysign32(float x, float y) {
  return copysign(x, y);
}

SCALAR_FUN_ATTR float futrts_mad32(float a, float b, float c) {
  return mad(a, b, c);
}

SCALAR_FUN_ATTR float futrts_fma32(float a, float b, float c) {
  return fma(a, b, c);
}

#elif ISPC

SCALAR_FUN_ATTR float futrts_log32(float x) {
  return futrts_isfinite32(x) || (futrts_isinf32(x) && x < 0)? log(x) : x;
}

SCALAR_FUN_ATTR float futrts_log2_32(float x) {
  return futrts_log32(x) / log(2.0f);
}

SCALAR_FUN_ATTR float futrts_log10_32(float x) {
  return futrts_log32(x) / log(10.0f);
}

SCALAR_FUN_ATTR float futrts_log1p_32(float x) {
  if(x == -1.0f || (futrts_isinf32(x) && x > 0.0f)) return x / 0.0f;
  float y = 1.0f + x;
  float z = y - 1.0f;
  return log(y) - (z-x)/y;
}

SCALAR_FUN_ATTR float futrts_sqrt32(float x) {
  return sqrt(x);
}

extern "C" unmasked uniform float cbrtf(uniform float);
SCALAR_FUN_ATTR float futrts_cbrt32(float x) {
  float res;
  foreach_active (i) {
    uniform float r = cbrtf(extract(x, i));
    res = insert(res, i, r);
  }
  return res;
}

SCALAR_FUN_ATTR float futrts_exp32(float x) {
  return exp(x);
}

SCALAR_FUN_ATTR float futrts_cos32(float x) {
  return cos(x);
}

SCALAR_FUN_ATTR float futrts_sin32(float x) {
  return sin(x);
}

SCALAR_FUN_ATTR float futrts_tan32(float x) {
  return tan(x);
}

SCALAR_FUN_ATTR float futrts_acos32(float x) {
  return acos(x);
}

SCALAR_FUN_ATTR float futrts_asin32(float x) {
  return asin(x);
}

SCALAR_FUN_ATTR float futrts_atan32(float x) {
  return atan(x);
}

SCALAR_FUN_ATTR float futrts_cosh32(float x) {
  return (exp(x)+exp(-x)) / 2.0f;
}

SCALAR_FUN_ATTR float futrts_sinh32(float x) {
  return (exp(x)-exp(-x)) / 2.0f;
}

SCALAR_FUN_ATTR float futrts_tanh32(float x) {
  return futrts_sinh32(x)/futrts_cosh32(x);
}

SCALAR_FUN_ATTR float futrts_acosh32(float x) {
  float f = x+sqrt(x*x-1);
  if(futrts_isfinite32(f)) return log(f);
  return f;
}

SCALAR_FUN_ATTR float futrts_asinh32(float x) {
  float f = x+sqrt(x*x+1);
  if(futrts_isfinite32(f)) return log(f);
  return f;

}

SCALAR_FUN_ATTR float futrts_atanh32(float x) {
  float f = (1+x)/(1-x);
  if(futrts_isfinite32(f)) return log(f)/2.0f;
  return f;

}

SCALAR_FUN_ATTR float futrts_atan2_32(float x, float y) {
  return (x == 0.0f && y == 0.0f) ? 0.0f : atan2(x, y);
}

SCALAR_FUN_ATTR float futrts_hypot32(float x, float y) {
  if (futrts_isfinite32(x) && futrts_isfinite32(y)) {
    x = abs(x);
    y = abs(y);
    float a;
    float b;
    if (x >= y){
        a = x;
        b = y;
    } else {
        a = y;
        b = x;
    }
    if(b == 0){
      return a;
    }

    int e;
    float an;
    float bn;
    an = frexp (a, &e);
    bn = ldexp (b, - e);
    float cn;
    cn = sqrt (an * an + bn * bn);
    return ldexp (cn, e);
  } else {
    if (futrts_isinf32(x) || futrts_isinf32(y)) return INFINITY;
    else return x + y;
  }

}

extern "C" unmasked uniform float tgammaf(uniform float x);
SCALAR_FUN_ATTR float futrts_gamma32(float x) {
  float res;
  foreach_active (i) {
    uniform float r = tgammaf(extract(x, i));
    res = insert(res, i, r);
  }
  return res;
}

extern "C" unmasked uniform float lgammaf(uniform float x);
SCALAR_FUN_ATTR float futrts_lgamma32(float x) {
  float res;
  foreach_active (i) {
    uniform float r = lgammaf(extract(x, i));
    res = insert(res, i, r);
  }
  return res;
}

extern "C" unmasked uniform float erff(uniform float x);
SCALAR_FUN_ATTR float futrts_erf32(float x) {
  float res;
  foreach_active (i) {
    uniform float r = erff(extract(x, i));
    res = insert(res, i, r);
  }
  return res;
}

extern "C" unmasked uniform float erfcf(uniform float x);
SCALAR_FUN_ATTR float futrts_erfc32(float x) {
  float res;
  foreach_active (i) {
    uniform float r = erfcf(extract(x, i));
    res = insert(res, i, r);
  }
  return res;
}

SCALAR_FUN_ATTR float fmod32(float x, float y) {
  return x - y * trunc(x/y);
}

SCALAR_FUN_ATTR float futrts_round32(float x) {
  return round(x);
}

SCALAR_FUN_ATTR float futrts_floor32(float x) {
  return floor(x);
}

SCALAR_FUN_ATTR float futrts_ceil32(float x) {
  return ceil(x);
}

extern "C" unmasked uniform float nextafterf(uniform float x, uniform float y);
SCALAR_FUN_ATTR float futrts_nextafter32(float x, float y) {
  float res;
  foreach_active (i) {
    uniform float r = nextafterf(extract(x, i), extract(y, i));
    res = insert(res, i, r);
  }
  return res;
}

SCALAR_FUN_ATTR float futrts_lerp32(float v0, float v1, float t) {
  return v0 + (v1 - v0) * t;
}

SCALAR_FUN_ATTR float futrts_ldexp32(float x, int32_t y) {
  return x * pow((double)2.0, (double)y);
}

SCALAR_FUN_ATTR float futrts_copysign32(float x, float y) {
  int32_t xb = futrts_to_bits32(x);
  int32_t yb = futrts_to_bits32(y);
  return futrts_from_bits32((xb & ~(1<<31)) | (yb & (1<<31)));
}

SCALAR_FUN_ATTR float futrts_mad32(float a, float b, float c) {
  return a * b + c;
}

SCALAR_FUN_ATTR float futrts_fma32(float a, float b, float c) {
  return a * b + c;
}

#else // Not OpenCL or ISPC, but CUDA or plain C.

SCALAR_FUN_ATTR float futrts_log32(float x) {
  return logf(x);
}

SCALAR_FUN_ATTR float futrts_log2_32(float x) {
  return log2f(x);
}

SCALAR_FUN_ATTR float futrts_log10_32(float x) {
  return log10f(x);
}

SCALAR_FUN_ATTR float futrts_log1p_32(float x) {
  return log1pf(x);
}

SCALAR_FUN_ATTR float futrts_sqrt32(float x) {
  return sqrtf(x);
}

SCALAR_FUN_ATTR float futrts_cbrt32(float x) {
  return cbrtf(x);
}

SCALAR_FUN_ATTR float futrts_exp32(float x) {
  return expf(x);
}

SCALAR_FUN_ATTR float futrts_cos32(float x) {
  return cosf(x);
}

SCALAR_FUN_ATTR float futrts_sin32(float x) {
  return sinf(x);
}

SCALAR_FUN_ATTR float futrts_tan32(float x) {
  return tanf(x);
}

SCALAR_FUN_ATTR float futrts_acos32(float x) {
  return acosf(x);
}

SCALAR_FUN_ATTR float futrts_asin32(float x) {
  return asinf(x);
}

SCALAR_FUN_ATTR float futrts_atan32(float x) {
  return atanf(x);
}

SCALAR_FUN_ATTR float futrts_cosh32(float x) {
  return coshf(x);
}

SCALAR_FUN_ATTR float futrts_sinh32(float x) {
  return sinhf(x);
}

SCALAR_FUN_ATTR float futrts_tanh32(float x) {
  return tanhf(x);
}

SCALAR_FUN_ATTR float futrts_acosh32(float x) {
  return acoshf(x);
}

SCALAR_FUN_ATTR float futrts_asinh32(float x) {
  return asinhf(x);
}

SCALAR_FUN_ATTR float futrts_atanh32(float x) {
  return atanhf(x);
}

SCALAR_FUN_ATTR float futrts_atan2_32(float x, float y) {
  return atan2f(x, y);
}

SCALAR_FUN_ATTR float futrts_hypot32(float x, float y) {
  return hypotf(x, y);
}

SCALAR_FUN_ATTR float futrts_gamma32(float x) {
  return tgammaf(x);
}

SCALAR_FUN_ATTR float futrts_lgamma32(float x) {
  return lgammaf(x);
}

SCALAR_FUN_ATTR float futrts_erf32(float x) {
  return erff(x);
}

SCALAR_FUN_ATTR float futrts_erfc32(float x) {
  return erfcf(x);
}

SCALAR_FUN_ATTR float fmod32(float x, float y) {
  return fmodf(x, y);
}

SCALAR_FUN_ATTR float futrts_round32(float x) {
  return rintf(x);
}

SCALAR_FUN_ATTR float futrts_floor32(float x) {
  return floorf(x);
}

SCALAR_FUN_ATTR float futrts_ceil32(float x) {
  return ceilf(x);
}

SCALAR_FUN_ATTR float futrts_nextafter32(float x, float y) {
  return nextafterf(x, y);
}

SCALAR_FUN_ATTR float futrts_lerp32(float v0, float v1, float t) {
  return v0 + (v1 - v0) * t;
}

SCALAR_FUN_ATTR float futrts_ldexp32(float x, int32_t y) {
  return ldexpf(x, y);
}

SCALAR_FUN_ATTR float futrts_copysign32(float x, float y) {
  return copysignf(x, y);
}

SCALAR_FUN_ATTR float futrts_mad32(float a, float b, float c) {
  return a * b + c;
}

SCALAR_FUN_ATTR float futrts_fma32(float a, float b, float c) {
  return fmaf(a, b, c);
}
#endif

#if ISPC
SCALAR_FUN_ATTR int32_t futrts_to_bits32(float x) {
  return intbits(x);
}

SCALAR_FUN_ATTR float futrts_from_bits32(int32_t x) {
  return floatbits(x);
}
#else
SCALAR_FUN_ATTR int32_t futrts_to_bits32(float x) {
  union {
    float f;
    int32_t t;
  } p;

  p.f = x;
  return p.t;
}

SCALAR_FUN_ATTR float futrts_from_bits32(int32_t x) {
  union {
    int32_t f;
    float t;
  } p;

  p.f = x;
  return p.t;
}
#endif

SCALAR_FUN_ATTR float fsignum32(float x) {
  return futrts_isnan32(x) ? x : (x > 0 ? 1 : 0) - (x < 0 ? 1 : 0);
}

#ifdef FUTHARK_F64_ENABLED

SCALAR_FUN_ATTR double futrts_from_bits64(int64_t x);
SCALAR_FUN_ATTR int64_t futrts_to_bits64(double x);

#if ISPC
SCALAR_FUN_ATTR bool futrts_isinf64(float x) {
  return !isnan(x) && isnan(x - x);
}

SCALAR_FUN_ATTR bool futrts_isfinite64(float x) {
  return !isnan(x) && !futrts_isinf64(x);
}

SCALAR_FUN_ATTR double fdiv64(double x, double y) {
  return x / y;
}

SCALAR_FUN_ATTR double fadd64(double x, double y) {
  return x + y;
}

SCALAR_FUN_ATTR double fsub64(double x, double y) {
  return x - y;
}

SCALAR_FUN_ATTR double fmul64(double x, double y) {
  return x * y;
}

SCALAR_FUN_ATTR bool cmplt64(double x, double y) {
  return x < y;
}

SCALAR_FUN_ATTR bool cmple64(double x, double y) {
  return x <= y;
}

SCALAR_FUN_ATTR double sitofp_i8_f64(int8_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double sitofp_i16_f64(int16_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double sitofp_i32_f64(int32_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double sitofp_i64_f64(int64_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double uitofp_i8_f64(uint8_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double uitofp_i16_f64(uint16_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double uitofp_i32_f64(uint32_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double uitofp_i64_f64(uint64_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double fabs64(double x) {
  return abs(x);
}

SCALAR_FUN_ATTR double fmax64(double x, double y) {
  return isnan(x) ? y : isnan(y) ? x : max(x, y);
}

SCALAR_FUN_ATTR double fmin64(double x, double y) {
  return isnan(x) ? y : isnan(y) ? x : min(x, y);
}

SCALAR_FUN_ATTR double fpow64(double a, double b) {
  float ret;
  foreach_active (i) {
      uniform float r = __stdlib_powf(extract(a, i), extract(b, i));
      ret = insert(ret, i, r);
  }
  return ret;
}

SCALAR_FUN_ATTR double futrts_log64(double x) {
  return futrts_isfinite64(x) || (futrts_isinf64(x) && x < 0)? log(x) : x;
}

SCALAR_FUN_ATTR double futrts_log2_64(double x) {
  return futrts_log64(x)/log(2.0d);
}

SCALAR_FUN_ATTR double futrts_log10_64(double x) {
  return futrts_log64(x)/log(10.0d);
}

SCALAR_FUN_ATTR double futrts_log1p_64(double x) {
  if(x == -1.0d || (futrts_isinf64(x) && x > 0.0d)) return x / 0.0d;
  double y = 1.0d + x;
  double z = y - 1.0d;
  return log(y) - (z-x)/y;
}

SCALAR_FUN_ATTR double futrts_sqrt64(double x) {
  return sqrt(x);
}

extern "C" unmasked uniform double cbrt(uniform double);
SCALAR_FUN_ATTR double futrts_cbrt64(double x) {
  double res;
  foreach_active (i) {
    uniform double r = cbrtf(extract(x, i));
    res = insert(res, i, r);
  }
  return res;
}

SCALAR_FUN_ATTR double futrts_exp64(double x) {
  return exp(x);
}

SCALAR_FUN_ATTR double futrts_cos64(double x) {
  return cos(x);
}

SCALAR_FUN_ATTR double futrts_sin64(double x) {
  return sin(x);
}

SCALAR_FUN_ATTR double futrts_tan64(double x) {
  return tan(x);
}

SCALAR_FUN_ATTR double futrts_acos64(double x) {
  return acos(x);
}

SCALAR_FUN_ATTR double futrts_asin64(double x) {
  return asin(x);
}

SCALAR_FUN_ATTR double futrts_atan64(double x) {
  return atan(x);
}

SCALAR_FUN_ATTR double futrts_cosh64(double x) {
  return (exp(x)+exp(-x)) / 2.0d;
}

SCALAR_FUN_ATTR double futrts_sinh64(double x) {
  return (exp(x)-exp(-x)) / 2.0d;
}

SCALAR_FUN_ATTR double futrts_tanh64(double x) {
  return futrts_sinh64(x)/futrts_cosh64(x);
}

SCALAR_FUN_ATTR double futrts_acosh64(double x) {
  double f = x+sqrt(x*x-1.0d);
  if(futrts_isfinite64(f)) return log(f);
  return f;
}

SCALAR_FUN_ATTR double futrts_asinh64(double x) {
  double f = x+sqrt(x*x+1.0d);
  if(futrts_isfinite64(f)) return log(f);
  return f;
}

SCALAR_FUN_ATTR double futrts_atanh64(double x) {
  double f = (1.0d+x)/(1.0d-x);
  if(futrts_isfinite64(f)) return log(f)/2.0d;
  return f;

}

SCALAR_FUN_ATTR double futrts_atan2_64(double x, double y) {
  return atan2(x, y);
}

extern "C" unmasked uniform double hypot(uniform double x, uniform double y);
SCALAR_FUN_ATTR double futrts_hypot64(double x, double y) {
  double res;
  foreach_active (i) {
    uniform double r = hypot(extract(x, i), extract(y, i));
    res = insert(res, i, r);
  }
  return res;
}

extern "C" unmasked uniform double tgamma(uniform double x);
SCALAR_FUN_ATTR double futrts_gamma64(double x) {
  double res;
  foreach_active (i) {
    uniform double r = tgamma(extract(x, i));
    res = insert(res, i, r);
  }
  return res;
}

extern "C" unmasked uniform double lgamma(uniform double x);
SCALAR_FUN_ATTR double futrts_lgamma64(double x) {
  double res;
  foreach_active (i) {
    uniform double r = lgamma(extract(x, i));
    res = insert(res, i, r);
  }
  return res;
}

extern "C" unmasked uniform double erf(uniform double x);
SCALAR_FUN_ATTR double futrts_erf64(double x) {
  double res;
  foreach_active (i) {
    uniform double r = erf(extract(x, i));
    res = insert(res, i, r);
  }
  return res;
}

extern "C" unmasked uniform double erfc(uniform double x);
SCALAR_FUN_ATTR double futrts_erfc64(double x) {
  double res;
  foreach_active (i) {
    uniform double r = erfc(extract(x, i));
    res = insert(res, i, r);
  }
  return res;
}

SCALAR_FUN_ATTR double futrts_fma64(double a, double b, double c) {
  return a * b + c;
}

SCALAR_FUN_ATTR double futrts_round64(double x) {
  return round(x);
}

SCALAR_FUN_ATTR double futrts_ceil64(double x) {
  return ceil(x);
}

extern "C" unmasked uniform double nextafter(uniform float x, uniform double y);
SCALAR_FUN_ATTR float futrts_nextafter64(double x, double y) {
  double res;
  foreach_active (i) {
    uniform double r = nextafter(extract(x, i), extract(y, i));
    res = insert(res, i, r);
  }
  return res;
}

SCALAR_FUN_ATTR double futrts_floor64(double x) {
  return floor(x);
}

SCALAR_FUN_ATTR bool futrts_isnan64(double x) {
  return isnan(x);
}

SCALAR_FUN_ATTR int8_t fptosi_f64_i8(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (int8_t) x;
  }
}

SCALAR_FUN_ATTR int16_t fptosi_f64_i16(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (int16_t) x;
  }
}

SCALAR_FUN_ATTR int32_t fptosi_f64_i32(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (int32_t) x;
  }
}

SCALAR_FUN_ATTR int64_t fptosi_f64_i64(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (int64_t) x;
  }
}

SCALAR_FUN_ATTR uint8_t fptoui_f64_i8(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (uint8_t) (int8_t) x;
  }
}

SCALAR_FUN_ATTR uint16_t fptoui_f64_i16(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (uint16_t) (int16_t) x;
  }
}

SCALAR_FUN_ATTR uint32_t fptoui_f64_i32(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (uint32_t) (int32_t) x;
  }
}

SCALAR_FUN_ATTR uint64_t fptoui_f64_i64(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (uint64_t) (int64_t) x;
  }
}

SCALAR_FUN_ATTR bool ftob_f64_bool(double x) {
  return x != 0.0;
}

SCALAR_FUN_ATTR double btof_bool_f64(bool x) {
  return x ? 1.0 : 0.0;
}

SCALAR_FUN_ATTR int64_t futrts_to_bits64(double x) {
  int64_t res;
  foreach_active (i) {
    uniform double tmp = extract(x, i);
    uniform int64_t r = *((uniform int64_t* uniform)&tmp);
    res = insert(res, i, r);
  }
  return res;
}

SCALAR_FUN_ATTR double futrts_from_bits64(int64_t x) {
  double res;
  foreach_active (i) {
    uniform int64_t tmp = extract(x, i);
    uniform double r = *((uniform double* uniform)&tmp);
    res = insert(res, i, r);
  }
  return res;
}

SCALAR_FUN_ATTR double fmod64(double x, double y) {
  return x - y * trunc(x/y);
}

SCALAR_FUN_ATTR double fsignum64(double x) {
  return futrts_isnan64(x) ? x : (x > 0 ? 1.0d : 0.0d) - (x < 0 ? 1.0d : 0.0d);
}

SCALAR_FUN_ATTR double futrts_lerp64(double v0, double v1, double t) {
  return v0 + (v1 - v0) * t;
}

SCALAR_FUN_ATTR double futrts_ldexp64(double x, int32_t y) {
  return x * pow((double)2.0, (double)y);
}

SCALAR_FUN_ATTR double futrts_copysign64(double x, double y) {
  int64_t xb = futrts_to_bits64(x);
  int64_t yb = futrts_to_bits64(y);
  return futrts_from_bits64((xb & ~(((int64_t)1)<<63)) | (yb & (((int64_t)1)<<63)));
}

SCALAR_FUN_ATTR double futrts_mad64(double a, double b, double c) {
  return a * b + c;
}

SCALAR_FUN_ATTR float fpconv_f32_f32(float x) {
  return (float) x;
}

SCALAR_FUN_ATTR double fpconv_f32_f64(float x) {
  return (double) x;
}

SCALAR_FUN_ATTR float fpconv_f64_f32(double x) {
  return (float) x;
}

SCALAR_FUN_ATTR double fpconv_f64_f64(double x) {
  return (double) x;
}

#else

SCALAR_FUN_ATTR double fdiv64(double x, double y) {
  return x / y;
}

SCALAR_FUN_ATTR double fadd64(double x, double y) {
  return x + y;
}

SCALAR_FUN_ATTR double fsub64(double x, double y) {
  return x - y;
}

SCALAR_FUN_ATTR double fmul64(double x, double y) {
  return x * y;
}

SCALAR_FUN_ATTR bool cmplt64(double x, double y) {
  return x < y;
}

SCALAR_FUN_ATTR bool cmple64(double x, double y) {
  return x <= y;
}

SCALAR_FUN_ATTR double sitofp_i8_f64(int8_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double sitofp_i16_f64(int16_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double sitofp_i32_f64(int32_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double sitofp_i64_f64(int64_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double uitofp_i8_f64(uint8_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double uitofp_i16_f64(uint16_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double uitofp_i32_f64(uint32_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double uitofp_i64_f64(uint64_t x) {
  return (double) x;
}

SCALAR_FUN_ATTR double fabs64(double x) {
  return fabs(x);
}

SCALAR_FUN_ATTR double fmax64(double x, double y) {
  return fmax(x, y);
}

SCALAR_FUN_ATTR double fmin64(double x, double y) {
  return fmin(x, y);
}

SCALAR_FUN_ATTR double fpow64(double x, double y) {
  return pow(x, y);
}

SCALAR_FUN_ATTR double futrts_log64(double x) {
  return log(x);
}

SCALAR_FUN_ATTR double futrts_log2_64(double x) {
  return log2(x);
}

SCALAR_FUN_ATTR double futrts_log10_64(double x) {
  return log10(x);
}

SCALAR_FUN_ATTR double futrts_log1p_64(double x) {
  return log1p(x);
}

SCALAR_FUN_ATTR double futrts_sqrt64(double x) {
  return sqrt(x);
}

SCALAR_FUN_ATTR double futrts_cbrt64(double x) {
  return cbrt(x);
}

SCALAR_FUN_ATTR double futrts_exp64(double x) {
  return exp(x);
}

SCALAR_FUN_ATTR double futrts_cos64(double x) {
  return cos(x);
}

SCALAR_FUN_ATTR double futrts_sin64(double x) {
  return sin(x);
}

SCALAR_FUN_ATTR double futrts_tan64(double x) {
  return tan(x);
}

SCALAR_FUN_ATTR double futrts_acos64(double x) {
  return acos(x);
}

SCALAR_FUN_ATTR double futrts_asin64(double x) {
  return asin(x);
}

SCALAR_FUN_ATTR double futrts_atan64(double x) {
  return atan(x);
}

SCALAR_FUN_ATTR double futrts_cosh64(double x) {
  return cosh(x);
}

SCALAR_FUN_ATTR double futrts_sinh64(double x) {
  return sinh(x);
}

SCALAR_FUN_ATTR double futrts_tanh64(double x) {
  return tanh(x);
}

SCALAR_FUN_ATTR double futrts_acosh64(double x) {
  return acosh(x);
}

SCALAR_FUN_ATTR double futrts_asinh64(double x) {
  return asinh(x);
}

SCALAR_FUN_ATTR double futrts_atanh64(double x) {
  return atanh(x);
}

SCALAR_FUN_ATTR double futrts_atan2_64(double x, double y) {
  return atan2(x, y);
}

SCALAR_FUN_ATTR double futrts_hypot64(double x, double y) {
  return hypot(x, y);
}

SCALAR_FUN_ATTR double futrts_gamma64(double x) {
  return tgamma(x);
}

SCALAR_FUN_ATTR double futrts_lgamma64(double x) {
  return lgamma(x);
}

SCALAR_FUN_ATTR double futrts_erf64(double x) {
  return erf(x);
}

SCALAR_FUN_ATTR double futrts_erfc64(double x) {
  return erfc(x);
}

SCALAR_FUN_ATTR double futrts_fma64(double a, double b, double c) {
  return fma(a, b, c);
}

SCALAR_FUN_ATTR double futrts_round64(double x) {
  return rint(x);
}

SCALAR_FUN_ATTR double futrts_ceil64(double x) {
  return ceil(x);
}

SCALAR_FUN_ATTR float futrts_nextafter64(float x, float y) {
  return nextafter(x, y);
}

SCALAR_FUN_ATTR double futrts_floor64(double x) {
  return floor(x);
}

SCALAR_FUN_ATTR bool futrts_isnan64(double x) {
  return isnan(x);
}

SCALAR_FUN_ATTR bool futrts_isinf64(double x) {
  return isinf(x);
}

SCALAR_FUN_ATTR int8_t fptosi_f64_i8(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (int8_t) x;
  }
}

SCALAR_FUN_ATTR int16_t fptosi_f64_i16(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (int16_t) x;
  }
}

SCALAR_FUN_ATTR int32_t fptosi_f64_i32(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (int32_t) x;
  }
}

SCALAR_FUN_ATTR int64_t fptosi_f64_i64(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (int64_t) x;
  }
}

SCALAR_FUN_ATTR uint8_t fptoui_f64_i8(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (uint8_t) (int8_t) x;
  }
}

SCALAR_FUN_ATTR uint16_t fptoui_f64_i16(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (uint16_t) (int16_t) x;
  }
}

SCALAR_FUN_ATTR uint32_t fptoui_f64_i32(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (uint32_t) (int32_t) x;
  }
}

SCALAR_FUN_ATTR uint64_t fptoui_f64_i64(double x) {
  if (futrts_isnan64(x) || futrts_isinf64(x)) {
    return 0;
  } else {
    return (uint64_t) (int64_t) x;
  }
}

SCALAR_FUN_ATTR bool ftob_f64_bool(double x) {
  return x != 0;
}

SCALAR_FUN_ATTR double btof_bool_f64(bool x) {
  return x ? 1 : 0;
}

SCALAR_FUN_ATTR int64_t futrts_to_bits64(double x) {
  union {
    double f;
    int64_t t;
  } p;

  p.f = x;
  return p.t;
}

SCALAR_FUN_ATTR double futrts_from_bits64(int64_t x) {
  union {
    int64_t f;
    double t;
  } p;

  p.f = x;
  return p.t;
}

SCALAR_FUN_ATTR double fmod64(double x, double y) {
  return fmod(x, y);
}

SCALAR_FUN_ATTR double fsignum64(double x) {
  return futrts_isnan64(x) ? x : (x > 0) - (x < 0);
}

SCALAR_FUN_ATTR double futrts_lerp64(double v0, double v1, double t) {
#ifdef __OPENCL_VERSION__
  return mix(v0, v1, t);
#else
  return v0 + (v1 - v0) * t;
#endif
}

SCALAR_FUN_ATTR double futrts_ldexp64(double x, int32_t y) {
  return ldexp(x, y);
}

SCALAR_FUN_ATTR float futrts_copysign64(double x, double y) {
  return copysign(x, y);
}

SCALAR_FUN_ATTR double futrts_mad64(double a, double b, double c) {
#ifdef __OPENCL_VERSION__
  return mad(a, b, c);
#else
  return a * b + c;
#endif
}

SCALAR_FUN_ATTR float fpconv_f32_f32(float x) {
  return (float) x;
}

SCALAR_FUN_ATTR double fpconv_f32_f64(float x) {
  return (double) x;
}

SCALAR_FUN_ATTR float fpconv_f64_f32(double x) {
  return (float) x;
}

SCALAR_FUN_ATTR double fpconv_f64_f64(double x) {
  return (double) x;
}

#endif

#endif

// End of scalar.h.
// Start of scalar_f16.h.

// Half-precision is emulated if needed (e.g. in straight C) with the
// native type used if possible.  The emulation works by typedef'ing
// 'float' to 'f16', and then implementing all operations on single
// precision.  To cut down on duplication, we use the same code for
// those Futhark functions that require just operators or casts.  The
// in-memory representation for arrays will still be 16 bits even
// under emulation, so the compiler will have to be careful when
// generating reads or writes.

#if !defined(cl_khr_fp16) && !(defined(__CUDA_ARCH__) && __CUDA_ARCH__ >= 600) && !(defined(ISPC))
#define EMULATE_F16
#endif

#if !defined(EMULATE_F16) && defined(__OPENCL_VERSION__)
#pragma OPENCL EXTENSION cl_khr_fp16 : enable
#endif

#ifdef EMULATE_F16

// Note that the half-precision storage format is still 16 bits - the
// compiler will have to be real careful!
typedef float f16;

#elif ISPC
typedef float16 f16;

#else

#ifdef __CUDA_ARCH__
#include <cuda_fp16.h>
#endif

typedef half f16;

#endif

// Some of these functions convert to single precision because half
// precision versions are not available.

SCALAR_FUN_ATTR f16 fadd16(f16 x, f16 y) {
  return x + y;
}

SCALAR_FUN_ATTR f16 fsub16(f16 x, f16 y) {
  return x - y;
}

SCALAR_FUN_ATTR f16 fmul16(f16 x, f16 y) {
  return x * y;
}

SCALAR_FUN_ATTR bool cmplt16(f16 x, f16 y) {
  return x < y;
}

SCALAR_FUN_ATTR bool cmple16(f16 x, f16 y) {
  return x <= y;
}

SCALAR_FUN_ATTR f16 sitofp_i8_f16(int8_t x) {
  return (f16) x;
}

SCALAR_FUN_ATTR f16 sitofp_i16_f16(int16_t x) {
  return (f16) x;
}

SCALAR_FUN_ATTR f16 sitofp_i32_f16(int32_t x) {
  return (f16) x;
}

SCALAR_FUN_ATTR f16 sitofp_i64_f16(int64_t x) {
  return (f16) x;
}

SCALAR_FUN_ATTR f16 uitofp_i8_f16(uint8_t x) {
  return (f16) x;
}

SCALAR_FUN_ATTR f16 uitofp_i16_f16(uint16_t x) {
  return (f16) x;
}

SCALAR_FUN_ATTR f16 uitofp_i32_f16(uint32_t x) {
  return (f16) x;
}

SCALAR_FUN_ATTR f16 uitofp_i64_f16(uint64_t x) {
  return (f16) x;
}

SCALAR_FUN_ATTR int8_t fptosi_f16_i8(f16 x) {
  return (int8_t) (float) x;
}

SCALAR_FUN_ATTR int16_t fptosi_f16_i16(f16 x) {
  return (int16_t) x;
}

SCALAR_FUN_ATTR int32_t fptosi_f16_i32(f16 x) {
  return (int32_t) x;
}

SCALAR_FUN_ATTR int64_t fptosi_f16_i64(f16 x) {
  return (int64_t) x;
}

SCALAR_FUN_ATTR uint8_t fptoui_f16_i8(f16 x) {
  return (uint8_t) (float) x;
}

SCALAR_FUN_ATTR uint16_t fptoui_f16_i16(f16 x) {
  return (uint16_t) x;
}

SCALAR_FUN_ATTR uint32_t fptoui_f16_i32(f16 x) {
  return (uint32_t) x;
}

SCALAR_FUN_ATTR uint64_t fptoui_f16_i64(f16 x) {
  return (uint64_t) x;
}

SCALAR_FUN_ATTR bool ftob_f16_bool(f16 x) {
  return x != (f16)0;
}

SCALAR_FUN_ATTR f16 btof_bool_f16(bool x) {
  return x ? 1 : 0;
}

#ifndef EMULATE_F16
SCALAR_FUN_ATTR bool futrts_isnan16(f16 x) {
  return isnan((float)x);
}

#ifdef __OPENCL_VERSION__

SCALAR_FUN_ATTR f16 fabs16(f16 x) {
  return fabs(x);
}

SCALAR_FUN_ATTR f16 fmax16(f16 x, f16 y) {
  return fmax(x, y);
}

SCALAR_FUN_ATTR f16 fmin16(f16 x, f16 y) {
  return fmin(x, y);
}

SCALAR_FUN_ATTR f16 fpow16(f16 x, f16 y) {
  return pow(x, y);
}

#elif ISPC
SCALAR_FUN_ATTR f16 fabs16(f16 x) {
  return abs(x);
}

SCALAR_FUN_ATTR f16 fmax16(f16 x, f16 y) {
  return futrts_isnan16(x) ? y : futrts_isnan16(y) ? x : max(x, y);
}

SCALAR_FUN_ATTR f16 fmin16(f16 x, f16 y) {
  return futrts_isnan16(x) ? y : futrts_isnan16(y) ? x : min(x, y);
}

SCALAR_FUN_ATTR f16 fpow16(f16 x, f16 y) {
  return pow(x, y);
}

#else // Assuming CUDA.

SCALAR_FUN_ATTR f16 fabs16(f16 x) {
  return fabsf(x);
}

SCALAR_FUN_ATTR f16 fmax16(f16 x, f16 y) {
  return fmaxf(x, y);
}

SCALAR_FUN_ATTR f16 fmin16(f16 x, f16 y) {
  return fminf(x, y);
}

SCALAR_FUN_ATTR f16 fpow16(f16 x, f16 y) {
  return powf(x, y);
}
#endif

#if ISPC
SCALAR_FUN_ATTR bool futrts_isinf16(float x) {
  return !futrts_isnan16(x) && futrts_isnan16(x - x);
}
SCALAR_FUN_ATTR bool futrts_isfinite16(float x) {
  return !futrts_isnan16(x) && !futrts_isinf16(x);
}

#else

SCALAR_FUN_ATTR bool futrts_isinf16(f16 x) {
  return isinf((float)x);
}
#endif

#ifdef __OPENCL_VERSION__
SCALAR_FUN_ATTR f16 futrts_log16(f16 x) {
  return log(x);
}

SCALAR_FUN_ATTR f16 futrts_log2_16(f16 x) {
  return log2(x);
}

SCALAR_FUN_ATTR f16 futrts_log10_16(f16 x) {
  return log10(x);
}

SCALAR_FUN_ATTR f16 futrts_log1p_16(f16 x) {
  return log1p(x);
}

SCALAR_FUN_ATTR f16 futrts_sqrt16(f16 x) {
  return sqrt(x);
}

SCALAR_FUN_ATTR f16 futrts_cbrt16(f16 x) {
  return cbrt(x);
}

SCALAR_FUN_ATTR f16 futrts_exp16(f16 x) {
  return exp(x);
}

SCALAR_FUN_ATTR f16 futrts_cos16(f16 x) {
  return cos(x);
}

SCALAR_FUN_ATTR f16 futrts_sin16(f16 x) {
  return sin(x);
}

SCALAR_FUN_ATTR f16 futrts_tan16(f16 x) {
  return tan(x);
}

SCALAR_FUN_ATTR f16 futrts_acos16(f16 x) {
  return acos(x);
}

SCALAR_FUN_ATTR f16 futrts_asin16(f16 x) {
  return asin(x);
}

SCALAR_FUN_ATTR f16 futrts_atan16(f16 x) {
  return atan(x);
}

SCALAR_FUN_ATTR f16 futrts_cosh16(f16 x) {
  return cosh(x);
}

SCALAR_FUN_ATTR f16 futrts_sinh16(f16 x) {
  return sinh(x);
}

SCALAR_FUN_ATTR f16 futrts_tanh16(f16 x) {
  return tanh(x);
}

SCALAR_FUN_ATTR f16 futrts_acosh16(f16 x) {
  return acosh(x);
}

SCALAR_FUN_ATTR f16 futrts_asinh16(f16 x) {
  return asinh(x);
}

SCALAR_FUN_ATTR f16 futrts_atanh16(f16 x) {
  return atanh(x);
}

SCALAR_FUN_ATTR f16 futrts_atan2_16(f16 x, f16 y) {
  return atan2(x, y);
}

SCALAR_FUN_ATTR f16 futrts_hypot16(f16 x, f16 y) {
  return hypot(x, y);
}

SCALAR_FUN_ATTR f16 futrts_gamma16(f16 x) {
  return tgamma(x);
}

SCALAR_FUN_ATTR f16 futrts_lgamma16(f16 x) {
  return lgamma(x);
}

SCALAR_FUN_ATTR f16 futrts_erf16(f16 x) {
  return erf(x);
}

SCALAR_FUN_ATTR f16 futrts_erfc16(f16 x) {
  return erfc(x);
}

SCALAR_FUN_ATTR f16 fmod16(f16 x, f16 y) {
  return fmod(x, y);
}

SCALAR_FUN_ATTR f16 futrts_round16(f16 x) {
  return rint(x);
}

SCALAR_FUN_ATTR f16 futrts_floor16(f16 x) {
  return floor(x);
}

SCALAR_FUN_ATTR f16 futrts_ceil16(f16 x) {
  return ceil(x);
}

SCALAR_FUN_ATTR f16 futrts_nextafter16(f16 x, f16 y) {
  return nextafter(x, y);
}

SCALAR_FUN_ATTR f16 futrts_lerp16(f16 v0, f16 v1, f16 t) {
  return mix(v0, v1, t);
}

SCALAR_FUN_ATTR f16 futrts_ldexp16(f16 x, int32_t y) {
  return ldexp(x, y);
}

SCALAR_FUN_ATTR f16 futrts_copysign16(f16 x, f16 y) {
  return copysign(x, y);
}

SCALAR_FUN_ATTR f16 futrts_mad16(f16 a, f16 b, f16 c) {
  return mad(a, b, c);
}

SCALAR_FUN_ATTR f16 futrts_fma16(f16 a, f16 b, f16 c) {
  return fma(a, b, c);
}
#elif ISPC

SCALAR_FUN_ATTR f16 futrts_log16(f16 x) {
  return futrts_isfinite16(x) || (futrts_isinf16(x) && x < 0) ? log(x) : x;
}

SCALAR_FUN_ATTR f16 futrts_log2_16(f16 x) {
  return futrts_log16(x) / log(2.0f16);
}

SCALAR_FUN_ATTR f16 futrts_log10_16(f16 x) {
  return futrts_log16(x) / log(10.0f16);
}

SCALAR_FUN_ATTR f16 futrts_log1p_16(f16 x) {
  if(x == -1.0f16 || (futrts_isinf16(x) && x > 0.0f16)) return x / 0.0f16;
  f16 y = 1.0f16 + x;
  f16 z = y - 1.0f16;
  return log(y) - (z-x)/y;
}

SCALAR_FUN_ATTR f16 futrts_sqrt16(f16 x) {
  return (float16)sqrt((float)x);
}

SCALAR_FUN_ATTR f16 futrts_exp16(f16 x) {
  return exp(x);
}

SCALAR_FUN_ATTR f16 futrts_cos16(f16 x) {
  return (float16)cos((float)x);
}

SCALAR_FUN_ATTR f16 futrts_sin16(f16 x) {
  return (float16)sin((float)x);
}

SCALAR_FUN_ATTR f16 futrts_tan16(f16 x) {
  return (float16)tan((float)x);
}

SCALAR_FUN_ATTR f16 futrts_acos16(f16 x) {
  return (float16)acos((float)x);
}

SCALAR_FUN_ATTR f16 futrts_asin16(f16 x) {
  return (float16)asin((float)x);
}

SCALAR_FUN_ATTR f16 futrts_atan16(f16 x) {
  return (float16)atan((float)x);
}

SCALAR_FUN_ATTR f16 futrts_cosh16(f16 x) {
  return (exp(x)+exp(-x)) / 2.0f16;
}

SCALAR_FUN_ATTR f16 futrts_sinh16(f16 x) {
  return (exp(x)-exp(-x)) / 2.0f16;
}

SCALAR_FUN_ATTR f16 futrts_tanh16(f16 x) {
  return futrts_sinh16(x)/futrts_cosh16(x);
}

SCALAR_FUN_ATTR f16 futrts_acosh16(f16 x) {
  float16 f = x+(float16)sqrt((float)(x*x-1));
  if(futrts_isfinite16(f)) return log(f);
  return f;
}

SCALAR_FUN_ATTR f16 futrts_asinh16(f16 x) {
  float16 f = x+(float16)sqrt((float)(x*x+1));
  if(futrts_isfinite16(f)) return log(f);
  return f;
}

SCALAR_FUN_ATTR f16 futrts_atanh16(f16 x) {
  float16 f = (1+x)/(1-x);
  if(futrts_isfinite16(f)) return log(f)/2.0f16;
  return f;
}

SCALAR_FUN_ATTR f16 futrts_atan2_16(f16 x, f16 y) {
  return (float16)atan2((float)x, (float)y);
}

SCALAR_FUN_ATTR f16 futrts_hypot16(f16 x, f16 y) {
  return (float16)futrts_hypot32((float)x, (float)y);
}

extern "C" unmasked uniform float tgammaf(uniform float x);
SCALAR_FUN_ATTR f16 futrts_gamma16(f16 x) {
  f16 res;
  foreach_active (i) {
    uniform f16 r = (f16)tgammaf(extract((float)x, i));
    res = insert(res, i, r);
  }
  return res;
}

extern "C" unmasked uniform float lgammaf(uniform float x);
SCALAR_FUN_ATTR f16 futrts_lgamma16(f16 x) {
  f16 res;
  foreach_active (i) {
    uniform f16 r = (f16)lgammaf(extract((float)x, i));
    res = insert(res, i, r);
  }
  return res;
}

SCALAR_FUN_ATTR f16 futrts_cbrt16(f16 x) {
  f16 res = (f16)futrts_cbrt32((float)x);
  return res;
}

SCALAR_FUN_ATTR f16 futrts_erf16(f16 x) {
  f16 res = (f16)futrts_erf32((float)x);
  return res;
}

SCALAR_FUN_ATTR f16 futrts_erfc16(f16 x) {
  f16 res = (f16)futrts_erfc32((float)x);
  return res;
}

SCALAR_FUN_ATTR f16 fmod16(f16 x, f16 y) {
  return x - y * (float16)trunc((float) (x/y));
}

SCALAR_FUN_ATTR f16 futrts_round16(f16 x) {
  return (float16)round((float)x);
}

SCALAR_FUN_ATTR f16 futrts_floor16(f16 x) {
  return (float16)floor((float)x);
}

SCALAR_FUN_ATTR f16 futrts_ceil16(f16 x) {
  return (float16)ceil((float)x);
}

SCALAR_FUN_ATTR f16 futrts_nextafter16(f16 x, f16 y) {
  return (float16)futrts_nextafter32((float)x, (float) y);
}

SCALAR_FUN_ATTR f16 futrts_lerp16(f16 v0, f16 v1, f16 t) {
  return v0 + (v1 - v0) * t;
}

SCALAR_FUN_ATTR f16 futrts_ldexp16(f16 x, int32_t y) {
  return futrts_ldexp32((float)x, y);
}

SCALAR_FUN_ATTR f16 futrts_copysign16(f16 x, f16 y) {
  return futrts_copysign32((float)x, y);
}

SCALAR_FUN_ATTR f16 futrts_mad16(f16 a, f16 b, f16 c) {
  return a * b + c;
}

SCALAR_FUN_ATTR f16 futrts_fma16(f16 a, f16 b, f16 c) {
  return a * b + c;
}

#else // Assume CUDA.

SCALAR_FUN_ATTR f16 futrts_log16(f16 x) {
  return hlog(x);
}

SCALAR_FUN_ATTR f16 futrts_log2_16(f16 x) {
  return hlog2(x);
}

SCALAR_FUN_ATTR f16 futrts_log10_16(f16 x) {
  return hlog10(x);
}

SCALAR_FUN_ATTR f16 futrts_log1p_16(f16 x) {
  return (f16)log1pf((float)x);
}

SCALAR_FUN_ATTR f16 futrts_sqrt16(f16 x) {
  return hsqrt(x);
}

SCALAR_FUN_ATTR f16 futrts_cbrt16(f16 x) {
  return cbrtf(x);
}

SCALAR_FUN_ATTR f16 futrts_exp16(f16 x) {
  return hexp(x);
}

SCALAR_FUN_ATTR f16 futrts_cos16(f16 x) {
  return hcos(x);
}

SCALAR_FUN_ATTR f16 futrts_sin16(f16 x) {
  return hsin(x);
}

SCALAR_FUN_ATTR f16 futrts_tan16(f16 x) {
  return tanf(x);
}

SCALAR_FUN_ATTR f16 futrts_acos16(f16 x) {
  return acosf(x);
}

SCALAR_FUN_ATTR f16 futrts_asin16(f16 x) {
  return asinf(x);
}

SCALAR_FUN_ATTR f16 futrts_atan16(f16 x) {
  return atanf(x);
}

SCALAR_FUN_ATTR f16 futrts_cosh16(f16 x) {
  return coshf(x);
}

SCALAR_FUN_ATTR f16 futrts_sinh16(f16 x) {
  return sinhf(x);
}

SCALAR_FUN_ATTR f16 futrts_tanh16(f16 x) {
  return tanhf(x);
}

SCALAR_FUN_ATTR f16 futrts_acosh16(f16 x) {
  return acoshf(x);
}

SCALAR_FUN_ATTR f16 futrts_asinh16(f16 x) {
  return asinhf(x);
}

SCALAR_FUN_ATTR f16 futrts_atanh16(f16 x) {
  return atanhf(x);
}

SCALAR_FUN_ATTR f16 futrts_atan2_16(f16 x, f16 y) {
  return atan2f(x, y);
}

SCALAR_FUN_ATTR f16 futrts_hypot16(f16 x, f16 y) {
  return hypotf(x, y);
}

SCALAR_FUN_ATTR f16 futrts_gamma16(f16 x) {
  return tgammaf(x);
}

SCALAR_FUN_ATTR f16 futrts_lgamma16(f16 x) {
  return lgammaf(x);
}

SCALAR_FUN_ATTR f16 futrts_erf16(f16 x) {
  return erff(x);
}

SCALAR_FUN_ATTR f16 futrts_erfc16(f16 x) {
  return erfcf(x);
}

SCALAR_FUN_ATTR f16 fmod16(f16 x, f16 y) {
  return fmodf(x, y);
}

SCALAR_FUN_ATTR f16 futrts_round16(f16 x) {
  return rintf(x);
}

SCALAR_FUN_ATTR f16 futrts_floor16(f16 x) {
  return hfloor(x);
}

SCALAR_FUN_ATTR f16 futrts_ceil16(f16 x) {
  return hceil(x);
}

SCALAR_FUN_ATTR f16 futrts_nextafter16(f16 x, f16 y) {
  return __ushort_as_half(halfbitsnextafter(__half_as_ushort(x), __half_as_ushort(y)));
}

SCALAR_FUN_ATTR f16 futrts_lerp16(f16 v0, f16 v1, f16 t) {
  return v0 + (v1 - v0) * t;
}

SCALAR_FUN_ATTR f16 futrts_ldexp16(f16 x, int32_t y) {
  return futrts_ldexp32((float)x, y);
}

SCALAR_FUN_ATTR f16 futrts_copysign16(f16 x, f16 y) {
  return futrts_copysign32((float)x, y);
}

SCALAR_FUN_ATTR f16 futrts_mad16(f16 a, f16 b, f16 c) {
  return a * b + c;
}

SCALAR_FUN_ATTR f16 futrts_fma16(f16 a, f16 b, f16 c) {
  return fmaf(a, b, c);
}

#endif

// The CUDA __half type cannot be put in unions for some reason, so we
// use bespoke conversion functions instead.
#ifdef __CUDA_ARCH__
SCALAR_FUN_ATTR int16_t futrts_to_bits16(f16 x) {
  return __half_as_ushort(x);
}
SCALAR_FUN_ATTR f16 futrts_from_bits16(int16_t x) {
  return __ushort_as_half(x);
}
#elif ISPC

SCALAR_FUN_ATTR int16_t futrts_to_bits16(f16 x) {
  varying int16_t y = *((varying int16_t * uniform)&x);
  return y;
}

SCALAR_FUN_ATTR f16 futrts_from_bits16(int16_t x) {
  varying f16 y = *((varying f16 * uniform)&x);
  return y;
}
#else
SCALAR_FUN_ATTR int16_t futrts_to_bits16(f16 x) {
  union {
    f16 f;
    int16_t t;
  } p;

  p.f = x;
  return p.t;
}

SCALAR_FUN_ATTR f16 futrts_from_bits16(int16_t x) {
  union {
    int16_t f;
    f16 t;
  } p;

  p.f = x;
  return p.t;
}
#endif

#else // No native f16 - emulate.

SCALAR_FUN_ATTR f16 fabs16(f16 x) {
  return fabs32(x);
}

SCALAR_FUN_ATTR f16 fmax16(f16 x, f16 y) {
  return fmax32(x, y);
}

SCALAR_FUN_ATTR f16 fmin16(f16 x, f16 y) {
  return fmin32(x, y);
}

SCALAR_FUN_ATTR f16 fpow16(f16 x, f16 y) {
  return fpow32(x, y);
}

SCALAR_FUN_ATTR bool futrts_isnan16(f16 x) {
  return futrts_isnan32(x);
}

SCALAR_FUN_ATTR bool futrts_isinf16(f16 x) {
  return futrts_isinf32(x);
}

SCALAR_FUN_ATTR f16 futrts_log16(f16 x) {
  return futrts_log32(x);
}

SCALAR_FUN_ATTR f16 futrts_log2_16(f16 x) {
  return futrts_log2_32(x);
}

SCALAR_FUN_ATTR f16 futrts_log10_16(f16 x) {
  return futrts_log10_32(x);
}

SCALAR_FUN_ATTR f16 futrts_log1p_16(f16 x) {
  return futrts_log1p_32(x);
}

SCALAR_FUN_ATTR f16 futrts_sqrt16(f16 x) {
  return futrts_sqrt32(x);
}

SCALAR_FUN_ATTR f16 futrts_cbrt16(f16 x) {
  return futrts_cbrt32(x);
}

SCALAR_FUN_ATTR f16 futrts_exp16(f16 x) {
  return futrts_exp32(x);
}

SCALAR_FUN_ATTR f16 futrts_cos16(f16 x) {
  return futrts_cos32(x);
}

SCALAR_FUN_ATTR f16 futrts_sin16(f16 x) {
  return futrts_sin32(x);
}

SCALAR_FUN_ATTR f16 futrts_tan16(f16 x) {
  return futrts_tan32(x);
}

SCALAR_FUN_ATTR f16 futrts_acos16(f16 x) {
  return futrts_acos32(x);
}

SCALAR_FUN_ATTR f16 futrts_asin16(f16 x) {
  return futrts_asin32(x);
}

SCALAR_FUN_ATTR f16 futrts_atan16(f16 x) {
  return futrts_atan32(x);
}

SCALAR_FUN_ATTR f16 futrts_cosh16(f16 x) {
  return futrts_cosh32(x);
}

SCALAR_FUN_ATTR f16 futrts_sinh16(f16 x) {
  return futrts_sinh32(x);
}

SCALAR_FUN_ATTR f16 futrts_tanh16(f16 x) {
  return futrts_tanh32(x);
}

SCALAR_FUN_ATTR f16 futrts_acosh16(f16 x) {
  return futrts_acosh32(x);
}

SCALAR_FUN_ATTR f16 futrts_asinh16(f16 x) {
  return futrts_asinh32(x);
}

SCALAR_FUN_ATTR f16 futrts_atanh16(f16 x) {
  return futrts_atanh32(x);
}

SCALAR_FUN_ATTR f16 futrts_atan2_16(f16 x, f16 y) {
  return futrts_atan2_32(x, y);
}

SCALAR_FUN_ATTR f16 futrts_hypot16(f16 x, f16 y) {
  return futrts_hypot32(x, y);
}

SCALAR_FUN_ATTR f16 futrts_gamma16(f16 x) {
  return futrts_gamma32(x);
}

SCALAR_FUN_ATTR f16 futrts_lgamma16(f16 x) {
  return futrts_lgamma32(x);
}

SCALAR_FUN_ATTR f16 futrts_erf16(f16 x) {
  return futrts_erf32(x);
}

SCALAR_FUN_ATTR f16 futrts_erfc16(f16 x) {
  return futrts_erfc32(x);
}

SCALAR_FUN_ATTR f16 fmod16(f16 x, f16 y) {
  return fmod32(x, y);
}

SCALAR_FUN_ATTR f16 futrts_round16(f16 x) {
  return futrts_round32(x);
}

SCALAR_FUN_ATTR f16 futrts_floor16(f16 x) {
  return futrts_floor32(x);
}

SCALAR_FUN_ATTR f16 futrts_ceil16(f16 x) {
  return futrts_ceil32(x);
}

SCALAR_FUN_ATTR f16 futrts_nextafter16(f16 x, f16 y) {
  return halfbits2float(halfbitsnextafter(float2halfbits(x), float2halfbits(y)));
}

SCALAR_FUN_ATTR f16 futrts_lerp16(f16 v0, f16 v1, f16 t) {
  return futrts_lerp32(v0, v1, t);
}

SCALAR_FUN_ATTR f16 futrts_ldexp16(f16 x, int32_t y) {
  return futrts_ldexp32(x, y);
}

SCALAR_FUN_ATTR f16 futrts_copysign16(f16 x, f16 y) {
  return futrts_copysign32((float)x, y);
}

SCALAR_FUN_ATTR f16 futrts_mad16(f16 a, f16 b, f16 c) {
  return futrts_mad32(a, b, c);
}

SCALAR_FUN_ATTR f16 futrts_fma16(f16 a, f16 b, f16 c) {
  return futrts_fma32(a, b, c);
}

// Even when we are using an OpenCL that does not support cl_khr_fp16,
// it must still support vload_half for actually creating a
// half-precision number, which can then be efficiently converted to a
// float.  Similarly for vstore_half.
#ifdef __OPENCL_VERSION__

SCALAR_FUN_ATTR int16_t futrts_to_bits16(f16 x) {
  int16_t y;
  // Violating strict aliasing here.
  vstore_half((float)x, 0, (half*)&y);
  return y;
}

SCALAR_FUN_ATTR f16 futrts_from_bits16(int16_t x) {
  return (f16)vload_half(0, (half*)&x);
}

#else

SCALAR_FUN_ATTR int16_t futrts_to_bits16(f16 x) {
  return (int16_t)float2halfbits(x);
}

SCALAR_FUN_ATTR f16 futrts_from_bits16(int16_t x) {
  return halfbits2float((uint16_t)x);
}

SCALAR_FUN_ATTR f16 fsignum16(f16 x) {
  return futrts_isnan16(x) ? x : (x > 0 ? 1 : 0) - (x < 0 ? 1 : 0);
}

#endif

#endif

SCALAR_FUN_ATTR float fpconv_f16_f16(f16 x) {
  return x;
}

SCALAR_FUN_ATTR float fpconv_f16_f32(f16 x) {
  return x;
}

SCALAR_FUN_ATTR f16 fpconv_f32_f16(float x) {
  return (f16) x;
}

#ifdef FUTHARK_F64_ENABLED

SCALAR_FUN_ATTR double fpconv_f16_f64(f16 x) {
  return (double) x;
}

#if ISPC
SCALAR_FUN_ATTR f16 fpconv_f64_f16(double x) {
  return (f16) ((float)x);
}
#else
SCALAR_FUN_ATTR f16 fpconv_f64_f16(double x) {
  return (f16) x;
}
#endif
#endif


// End of scalar_f16.h.

// Start of context_prototypes.h
//
// Prototypes for the functions in context.h, or that will be called
// from those functions, that need to be available very early.

struct futhark_context_config;
struct futhark_context;

static void set_error(struct futhark_context* ctx, char *error);

// These are called in context/config new/free functions and contain
// shared setup.  They are generated by the compiler itself.
static int init_constants(struct futhark_context*);
static int free_constants(struct futhark_context*);
static void setup_program(struct futhark_context* ctx);
static void teardown_program(struct futhark_context *ctx);

// Allocate host memory.  Must be freed with host_free().
static void host_alloc(struct futhark_context* ctx, size_t size, const char* tag, size_t* size_out, void** mem_out);
// Allocate memory allocated with host_alloc().
static void host_free(struct futhark_context* ctx, size_t size, const char* tag, void* mem);

// Log that a copy has occurred.
static void log_copy(struct futhark_context* ctx,
                     const char *kind, int r,
                     int64_t dst_offset, int64_t dst_strides[r],
                     int64_t src_offset, int64_t src_strides[r],
                     int64_t shape[r]);

static void log_transpose(struct futhark_context* ctx,
                          int64_t k, int64_t m, int64_t n);

static bool lmad_map_tr(int64_t *num_arrays_out, int64_t *n_out, int64_t *m_out,
                        int r,
                        const int64_t dst_strides[r],
                        const int64_t src_strides[r],
                        const int64_t shape[r]);

static bool lmad_contiguous(int r, int64_t strides[r], int64_t shape[r]);

static bool lmad_memcpyable(int r,
                            int64_t dst_strides[r], int64_t src_strides[r], int64_t shape[r]);

static void add_event(struct futhark_context* ctx,
                      const char* name,
                      char* description,
                      void* data,
                      event_report_fn f);

// Functions that must be defined by the backend.
static void backend_context_config_setup(struct futhark_context_config* cfg);
static void backend_context_config_teardown(struct futhark_context_config* cfg);
static int backend_context_setup(struct futhark_context *ctx);
static void backend_context_teardown(struct futhark_context *ctx);

// End of of context_prototypes.h

struct memblock {
    int *references;
    unsigned char *mem;
    int64_t size;
    const char *desc;
};
struct constants {
    int dummy;
};
struct tuning_params {
    int dummy;
};
static const int num_tuning_params = 0;
static const char *tuning_param_names[] = {NULL};
static const char *tuning_param_vars[] = {NULL};
static const char *tuning_param_classes[] = {NULL};
static int64_t tuning_param_defaults[] = {0};
// Start of backends/c.h

struct futhark_context_config {
  int in_use;
  int debugging;
  int profiling;
  int logging;
  char *cache_fname;
  int num_tuning_params;
  int64_t *tuning_params;
  const char** tuning_param_names;
  const char** tuning_param_vars;
  const char** tuning_param_classes;
};

static void backend_context_config_setup(struct futhark_context_config* cfg) {
  (void)cfg;
}

static void backend_context_config_teardown(struct futhark_context_config* cfg) {
  (void)cfg;
}

int futhark_context_config_set_tuning_param(struct futhark_context_config* cfg, const char *param_name, size_t param_value) {
  (void)cfg; (void)param_name; (void)param_value;
  return 1;
}

struct futhark_context {
  struct futhark_context_config* cfg;
  int detail_memory;
  int debugging;
  int profiling;
  int profiling_paused;
  int logging;
  lock_t lock;
  char *error;
  lock_t error_lock;
  FILE *log;
  struct constants *constants;
  struct free_list free_list;
  struct event_list event_list;
  int64_t peak_mem_usage_default;
  int64_t cur_mem_usage_default;
  struct program* program;
  bool program_initialised;
};

int backend_context_setup(struct futhark_context* ctx) {
  (void)ctx;
  return 0;
}

void backend_context_teardown(struct futhark_context* ctx) {
  (void)ctx;
}

int futhark_context_sync(struct futhark_context* ctx) {
  (void)ctx;
  return 0;
}

// End of backends/c.h

struct program {
    int dummy;
};
static void setup_program(struct futhark_context *ctx)
{
    (void) ctx;
    
    int error = 0;
    
    (void) error;
    ctx->program = malloc(sizeof(struct program));
}
static void teardown_program(struct futhark_context *ctx)
{
    (void) ctx;
    
    int error = 0;
    
    (void) error;
    free(ctx->program);
}
static void set_tuning_params(struct futhark_context *ctx)
{
    (void) ctx;
}
int memblock_unref(struct futhark_context *ctx, struct memblock *block, const char *desc)
{
    if (block->references != NULL) {
        *block->references -= 1;
        if (ctx->detail_memory)
            fprintf(ctx->log, "Unreferencing block %s (allocated as %s) in %s: %d references remaining.\n", desc, block->desc, "default space", *block->references);
        if (*block->references == 0) {
            ctx->cur_mem_usage_default -= block->size;
            host_free(ctx, (size_t) block->size, desc, (void *) block->mem);
            free(block->references);
            if (ctx->detail_memory)
                fprintf(ctx->log, "%lld bytes freed (now allocated: %lld bytes)\n", (long long) block->size, (long long) ctx->cur_mem_usage_default);
        }
        block->references = NULL;
    }
    return 0;
}
int memblock_alloc(struct futhark_context *ctx, struct memblock *block, int64_t size, const char *desc)
{
    if (size < 0)
        futhark_panic(1, "Negative allocation of %lld bytes attempted for %s in %s.\n", (long long) size, desc, "default space", ctx->cur_mem_usage_default);
    
    int ret = memblock_unref(ctx, block, desc);
    
    if (ret != FUTHARK_SUCCESS)
        return ret;
    if (ctx->detail_memory)
        fprintf(ctx->log, "Allocating %lld bytes for %s in %s (currently allocated: %lld bytes).\n", (long long) size, desc, "default space", (long long) ctx->cur_mem_usage_default);
    host_alloc(ctx, (size_t) size, desc, (size_t *) &size, (void *) &block->mem);
    if (ctx->error == NULL) {
        block->references = (int *) malloc(sizeof(int));
        *block->references = 1;
        block->size = size;
        block->desc = desc;
        
        long long new_usage = ctx->cur_mem_usage_default + size;
        
        if (ctx->detail_memory)
            fprintf(ctx->log, "Received block of %lld bytes; now allocated: %lld bytes", (long long) block->size, new_usage);
        ctx->cur_mem_usage_default = new_usage;
        if (new_usage > ctx->peak_mem_usage_default) {
            ctx->peak_mem_usage_default = new_usage;
            if (ctx->detail_memory)
                fprintf(ctx->log, " (new peak).\n");
        } else if (ctx->detail_memory)
            fprintf(ctx->log, ".\n");
        return FUTHARK_SUCCESS;
    } else {
        // We are naively assuming that any memory allocation error is due to OOM.
        lock_lock(&ctx->error_lock);
        
        char *old_error = ctx->error;
        
        ctx->error = msgprintf("Failed to allocate memory in %s.\nAttempted allocation: %12lld bytes\nCurrently allocated:  %12lld bytes\n%s", "default space", (long long) size, (long long) ctx->cur_mem_usage_default, old_error);
        free(old_error);
        lock_unlock(&ctx->error_lock);
        return FUTHARK_OUT_OF_MEMORY;
    }
}
int memblock_set(struct futhark_context *ctx, struct memblock *lhs, struct memblock *rhs, const char *lhs_desc)
{
    int ret = memblock_unref(ctx, lhs, lhs_desc);
    
    if (rhs->references != NULL)
        (*rhs->references)++;
    *lhs = *rhs;
    return ret;
}
char *futhark_context_report(struct futhark_context *ctx)
{
    if (futhark_context_sync(ctx) != 0)
        return NULL;
    
    struct str_builder builder;
    
    str_builder_init(&builder);
    str_builder_char(&builder, '{');
    str_builder_str(&builder, "\"memory\":{");
    str_builder(&builder, "\"default space\": %lld", (long long) ctx->peak_mem_usage_default);
    str_builder_str(&builder, "},\"events\":[");
    if (report_events_in_list(&ctx->event_list, &builder) != 0) {
        free(builder.str);
        return NULL;
    } else {
        str_builder_str(&builder, "]}");
        return builder.str;
    }
}
int futhark_context_clear_caches(struct futhark_context *ctx)
{
    lock_lock(&ctx->lock);
    ctx->peak_mem_usage_default = 0;
    lock_unlock(&ctx->lock);
    return ctx->error != NULL;
}

// Start of context.h

// Internal functions.

static void set_error(struct futhark_context* ctx, char *error) {
  lock_lock(&ctx->error_lock);
  if (ctx->error == NULL) {
    ctx->error = error;
  } else {
    free(error);
  }
  lock_unlock(&ctx->error_lock);
}

// XXX: should be static, but used in ispc_util.h
void lexical_realloc_error(struct futhark_context* ctx, size_t new_size) {
  set_error(ctx,
            msgprintf("Failed to allocate memory.\nAttempted allocation: %12lld bytes\n",
                      (long long) new_size));
}

static int lexical_realloc(struct futhark_context *ctx,
                           unsigned char **ptr,
                           int64_t *old_size,
                           int64_t new_size) {
  unsigned char *new = realloc(*ptr, (size_t)new_size);
  if (new == NULL) {
    lexical_realloc_error(ctx, new_size);
    return FUTHARK_OUT_OF_MEMORY;
  } else {
    *ptr = new;
    *old_size = new_size;
    return FUTHARK_SUCCESS;
  }
}

static void free_all_in_free_list(struct futhark_context* ctx) {
  fl_mem mem;
  free_list_pack(&ctx->free_list);
  while (free_list_first(&ctx->free_list, (fl_mem*)&mem) == 0) {
    free((void*)mem);
  }
}

static int is_small_alloc(size_t size) {
  return size < 1024*1024;
}

static void host_alloc(struct futhark_context* ctx,
                       size_t size, const char* tag, size_t* size_out, void** mem_out) {
  if (is_small_alloc(size) || free_list_find(&ctx->free_list, size, tag, size_out, (fl_mem*)mem_out) != 0) {
    *size_out = size;
    *mem_out = malloc(size);
  }
}

static void host_free(struct futhark_context* ctx,
                      size_t size, const char* tag, void* mem) {
  // Small allocations are handled by malloc()s own free list.  The
  // threshold here is kind of arbitrary, but seems to work OK.
  // Larger allocations are mmap()ed/munmapped() every time, which is
  // very slow, and Futhark programs tend to use a few very large
  // allocations.
  if (is_small_alloc(size)) {
    free(mem);
  } else {
    free_list_insert(&ctx->free_list, size, (fl_mem)mem, tag);
  }
}

static void add_event(struct futhark_context* ctx,
                      const char* name,
                      char* description,
                      void* data,
                      event_report_fn f) {
  if (ctx->logging) {
    fprintf(ctx->log, "Event: %s\n%s\n", name, description);
  }
  add_event_to_list(&ctx->event_list, name, description, data, f);
}

char *futhark_context_get_error(struct futhark_context *ctx) {
  char *error = ctx->error;
  ctx->error = NULL;
  return error;
}

void futhark_context_config_set_debugging(struct futhark_context_config *cfg, int flag) {
    cfg->profiling = cfg->logging = cfg->debugging = flag;
}

void futhark_context_config_set_profiling(struct futhark_context_config *cfg, int flag) {
    cfg->profiling = flag;
}

void futhark_context_config_set_logging(struct futhark_context_config *cfg, int flag) {
    cfg->logging = flag;
}

void futhark_context_config_set_cache_file(struct futhark_context_config *cfg, const char *f) {
  cfg->cache_fname = strdup(f);
}

int futhark_get_tuning_param_count(void) {
  return num_tuning_params;
}

const char *futhark_get_tuning_param_name(int i) {
  return tuning_param_names[i];
}

const char *futhark_get_tuning_param_class(int i) {
    return tuning_param_classes[i];
}

void futhark_context_set_logging_file(struct futhark_context *ctx, FILE *f){
  ctx->log = f;
}

void futhark_context_pause_profiling(struct futhark_context *ctx) {
  ctx->profiling_paused = 1;
}

void futhark_context_unpause_profiling(struct futhark_context *ctx) {
  ctx->profiling_paused = 0;
}

struct futhark_context_config* futhark_context_config_new(void) {
  struct futhark_context_config* cfg = malloc(sizeof(struct futhark_context_config));
  if (cfg == NULL) {
    return NULL;
  }
  cfg->in_use = 0;
  cfg->debugging = 0;
  cfg->profiling = 0;
  cfg->logging = 0;
  cfg->cache_fname = NULL;
  cfg->num_tuning_params = num_tuning_params;
  cfg->tuning_params = malloc(cfg->num_tuning_params * sizeof(int64_t));
  memcpy(cfg->tuning_params, tuning_param_defaults,
         cfg->num_tuning_params * sizeof(int64_t));
  cfg->tuning_param_names = tuning_param_names;
  cfg->tuning_param_vars = tuning_param_vars;
  cfg->tuning_param_classes = tuning_param_classes;
  backend_context_config_setup(cfg);
  return cfg;
}

void futhark_context_config_free(struct futhark_context_config* cfg) {
  assert(!cfg->in_use);
  backend_context_config_teardown(cfg);
  free(cfg->cache_fname);
  free(cfg->tuning_params);
  free(cfg);
}

struct futhark_context* futhark_context_new(struct futhark_context_config* cfg) {
  struct futhark_context* ctx = malloc(sizeof(struct futhark_context));
  if (ctx == NULL) {
    return NULL;
  }
  assert(!cfg->in_use);
  ctx->cfg = cfg;
  ctx->cfg->in_use = 1;
  ctx->program_initialised = false;
  create_lock(&ctx->error_lock);
  create_lock(&ctx->lock);
  free_list_init(&ctx->free_list);
  event_list_init(&ctx->event_list);
  ctx->peak_mem_usage_default = 0;
  ctx->cur_mem_usage_default = 0;
  ctx->constants = malloc(sizeof(struct constants));
  ctx->debugging = cfg->debugging;
  ctx->logging = cfg->logging;
  ctx->detail_memory = cfg->logging;
  ctx->profiling = cfg->profiling;
  ctx->profiling_paused = 0;
  ctx->error = NULL;
  ctx->log = stderr;
  set_tuning_params(ctx);
  if (backend_context_setup(ctx) == 0) {
    setup_program(ctx);
    init_constants(ctx);
    ctx->program_initialised = true;
    (void)futhark_context_clear_caches(ctx);
    (void)futhark_context_sync(ctx);
  }
  return ctx;
}

void futhark_context_free(struct futhark_context* ctx) {
  if (ctx->program_initialised) {
    free_constants(ctx);
    teardown_program(ctx);
  }
  backend_context_teardown(ctx);
  free_all_in_free_list(ctx);
  free_list_destroy(&ctx->free_list);
  event_list_free(&ctx->event_list);
  free(ctx->constants);
  free(ctx->error);
  free_lock(&ctx->lock);
  free_lock(&ctx->error_lock);
  ctx->cfg->in_use = 0;
  free(ctx);
}

// End of context.h

// Start of copy.h

// Cache-oblivious map-transpose function.
#define GEN_MAP_TRANSPOSE(NAME, ELEM_TYPE)                              \
  static void map_transpose_##NAME                                      \
  (ELEM_TYPE* dst, ELEM_TYPE* src,                                      \
   int64_t k, int64_t m, int64_t n,                                     \
   int64_t cb, int64_t ce, int64_t rb, int64_t re)                      \
  {                                                                     \
  int32_t r = re - rb;                                                  \
  int32_t c = ce - cb;                                                  \
  if (k == 1) {                                                         \
    if (r <= 64 && c <= 64) {                                           \
      for (int64_t j = 0; j < c; j++) {                                 \
        for (int64_t i = 0; i < r; i++) {                               \
          dst[(j + cb) * n + (i + rb)] = src[(i + rb) * m + (j + cb)];  \
        }                                                               \
      }                                                                 \
    } else if (c <= r) {                                                \
      map_transpose_##NAME(dst, src, k, m, n, cb, ce, rb, rb + r/2);    \
      map_transpose_##NAME(dst, src, k, m, n, cb, ce, rb + r/2, re);    \
    } else {                                                            \
      map_transpose_##NAME(dst, src, k, m, n, cb, cb + c/2, rb, re);    \
      map_transpose_##NAME(dst, src, k, m, n, cb + c/2, ce, rb, re);    \
    }                                                                   \
  } else {                                                              \
  for (int64_t i = 0; i < k; i++) {                                     \
    map_transpose_##NAME(dst + i * m * n, src + i * m * n, 1, m, n, cb, ce, rb, re); \
  }\
} \
}

// Straightforward LMAD copy function.
#define GEN_LMAD_COPY_ELEMENTS(NAME, ELEM_TYPE)                         \
  static void lmad_copy_elements_##NAME(int r,                          \
                                        ELEM_TYPE* dst, int64_t dst_strides[r], \
                                        ELEM_TYPE *src, int64_t src_strides[r], \
                                        int64_t shape[r]) {             \
    if (r == 1) {                                                       \
      for (int i = 0; i < shape[0]; i++) {                              \
        dst[i*dst_strides[0]] = src[i*src_strides[0]];                  \
      }                                                                 \
    } else if (r > 1) {                                                 \
      for (int i = 0; i < shape[0]; i++) {                              \
        lmad_copy_elements_##NAME(r-1,                                  \
                                  dst+i*dst_strides[0], dst_strides+1,  \
                                  src+i*src_strides[0], src_strides+1,  \
                                  shape+1);                             \
      }                                                                 \
    }                                                                   \
  }                                                                     \

// Check whether this LMAD can be seen as a transposed 2D array.  This
// is done by checking every possible splitting point.
static bool lmad_is_tr(int64_t *n_out, int64_t *m_out,
                       int r,
                       const int64_t strides[r],
                       const int64_t shape[r]) {
  for (int i = 1; i < r; i++) {
    int n = 1, m = 1;
    bool ok = true;
    int64_t expected = 1;
    // Check strides before 'i'.
    for (int j = i-1; j >= 0; j--) {
      ok = ok && strides[j] == expected;
      expected *= shape[j];
      n *= shape[j];
    }
    // Check strides after 'i'.
    for (int j = r-1; j >= i; j--) {
      ok = ok && strides[j] == expected;
      expected *= shape[j];
      m *= shape[j];
    }
    if (ok) {
      *n_out = n;
      *m_out = m;
      return true;
    }
  }
  return false;
}

// This function determines whether the a 'dst' LMAD is row-major and
// 'src' LMAD is column-major.  Both LMADs are for arrays of the same
// shape.  Both LMADs are allowed to have additional dimensions "on
// top".  Essentially, this function determines whether a copy from
// 'src' to 'dst' is a "map(transpose)" that we know how to implement
// efficiently.  The LMADs can have arbitrary rank, and the main
// challenge here is checking whether the src LMAD actually
// corresponds to a 2D column-major layout by morally collapsing
// dimensions.  There is a lot of looping here, but the actual trip
// count is going to be very low in practice.
//
// Returns true if this is indeed a map(transpose), and writes the
// number of arrays, and moral array size to appropriate output
// parameters.
static bool lmad_map_tr(int64_t *num_arrays_out, int64_t *n_out, int64_t *m_out,
                        int r,
                        const int64_t dst_strides[r],
                        const int64_t src_strides[r],
                        const int64_t shape[r]) {
  int64_t rowmajor_strides[r];
  rowmajor_strides[r-1] = 1;

  for (int i = r-2; i >= 0; i--) {
    rowmajor_strides[i] = rowmajor_strides[i+1] * shape[i+1];
  }

  // map_r will be the number of mapped dimensions on top.
  int map_r = 0;
  int64_t num_arrays = 1;
  for (int i = 0; i < r; i++) {
    if (dst_strides[i] != rowmajor_strides[i] ||
        src_strides[i] != rowmajor_strides[i]) {
      break;
    } else {
      num_arrays *= shape[i];
      map_r++;
    }
  }

  *num_arrays_out = num_arrays;

  if (r==map_r) {
    return false;
  }

  if (memcmp(&rowmajor_strides[map_r],
             &dst_strides[map_r],
             sizeof(int64_t)*(r-map_r)) == 0) {
    return lmad_is_tr(n_out, m_out, r-map_r, src_strides+map_r, shape+map_r);
  } else if (memcmp(&rowmajor_strides[map_r],
                    &src_strides[map_r],
                    sizeof(int64_t)*(r-map_r)) == 0) {
    return lmad_is_tr(m_out, n_out, r-map_r, dst_strides+map_r, shape+map_r);
  }
  return false;
}

// Check if the strides correspond to row-major strides of *any*
// permutation of the shape.  This is done by recursive search with
// backtracking.  This is worst-case exponential, but hopefully the
// arrays we encounter do not have that many dimensions.
static bool lmad_contiguous_search(int checked, int64_t expected,
                                   int r,
                                   int64_t strides[r], int64_t shape[r], bool used[r]) {
  for (int i = 0; i < r; i++) {
    for (int j = 0; j < r; j++) {
      if (!used[j] && strides[j] == expected && strides[j] >= 0) {
        used[j] = true;
        if (checked+1 == r ||
            lmad_contiguous_search(checked+1, expected * shape[j], r, strides, shape, used)) {
          return true;
        }
        used[j] = false;
      }
    }
  }
  return false;
}

// Does this LMAD correspond to an array with positive strides and no
// holes?
static bool lmad_contiguous(int r, int64_t strides[r], int64_t shape[r]) {
  bool used[r];
  for (int i = 0; i < r; i++) {
    used[i] = false;
  }
  return lmad_contiguous_search(0, 1, r, strides, shape, used);
}

// Does this copy correspond to something that could be done with a
// memcpy()-like operation?  I.e. do the LMADs actually represent the
// same in-memory layout and are they contiguous?
static bool lmad_memcpyable(int r,
                            int64_t dst_strides[r], int64_t src_strides[r], int64_t shape[r]) {
  if (!lmad_contiguous(r, dst_strides, shape)) {
    return false;
  }
  for (int i = 0; i < r; i++) {
    if (dst_strides[i] != src_strides[i] && shape[i] != 1) {
      return false;
    }
  }
  return true;
}


static void log_copy(struct futhark_context* ctx,
                     const char *kind, int r,
                     int64_t dst_offset, int64_t dst_strides[r],
                     int64_t src_offset, int64_t src_strides[r],
                     int64_t shape[r]) {
  if (ctx->logging) {
    fprintf(ctx->log, "\n# Copy %s\n", kind);
    fprintf(ctx->log, "Shape: ");
    for (int i = 0; i < r; i++) { fprintf(ctx->log, "[%ld]", (long int)shape[i]); }
    fprintf(ctx->log, "\n");
    fprintf(ctx->log, "Dst offset: %ld\n", (long int)dst_offset);
    fprintf(ctx->log, "Dst strides:");
    for (int i = 0; i < r; i++) { fprintf(ctx->log, " %ld", (long int)dst_strides[i]); }
    fprintf(ctx->log, "\n");
    fprintf(ctx->log, "Src offset: %ld\n", (long int)src_offset);
    fprintf(ctx->log, "Src strides:");
    for (int i = 0; i < r; i++) { fprintf(ctx->log, " %ld", (long int)src_strides[i]); }
    fprintf(ctx->log, "\n");
  }
}

static void log_transpose(struct futhark_context* ctx,
                          int64_t k, int64_t n, int64_t m) {
  if (ctx->logging) {
    fprintf(ctx->log, "## Transpose\n");
    fprintf(ctx->log, "Arrays     : %ld\n", (long int)k);
    fprintf(ctx->log, "X elements : %ld\n", (long int)m);
    fprintf(ctx->log, "Y elements : %ld\n", (long int)n);
    fprintf(ctx->log, "\n");
  }
}

#define GEN_LMAD_COPY(NAME, ELEM_TYPE)                                  \
  static void lmad_copy_##NAME                                          \
  (struct futhark_context *ctx, int r,                                  \
   ELEM_TYPE* dst, int64_t dst_offset, int64_t dst_strides[r],          \
   ELEM_TYPE *src, int64_t src_offset, int64_t src_strides[r],          \
   int64_t shape[r]) {                                                  \
    log_copy(ctx, "CPU to CPU", r, dst_offset, dst_strides,             \
             src_offset, src_strides, shape);                           \
    int64_t size = 1;                                                   \
    for (int i = 0; i < r; i++) { size *= shape[i]; }                   \
    if (size == 0) { return; }                                          \
    int64_t k, n, m;                                                    \
    if (lmad_map_tr(&k, &n, &m,                                         \
                    r, dst_strides, src_strides, shape)) {              \
      log_transpose(ctx, k, n, m);                                      \
      map_transpose_##NAME                                              \
        (dst+dst_offset, src+src_offset, k, n, m, 0, n, 0, m);          \
    } else if (lmad_memcpyable(r, dst_strides, src_strides, shape)) {   \
      if (ctx->logging) {fprintf(ctx->log, "## Flat copy\n\n");}          \
      memcpy(dst+dst_offset, src+src_offset, size*sizeof(*dst));        \
    } else {                                                            \
      if (ctx->logging) {fprintf(ctx->log, "## General copy\n\n");}       \
      lmad_copy_elements_##NAME                                         \
        (r,                                                             \
         dst+dst_offset, dst_strides,                                   \
         src+src_offset, src_strides, shape);                           \
    }                                                                   \
  }

GEN_MAP_TRANSPOSE(1b, uint8_t)
GEN_MAP_TRANSPOSE(2b, uint16_t)
GEN_MAP_TRANSPOSE(4b, uint32_t)
GEN_MAP_TRANSPOSE(8b, uint64_t)

GEN_LMAD_COPY_ELEMENTS(1b, uint8_t)
GEN_LMAD_COPY_ELEMENTS(2b, uint16_t)
GEN_LMAD_COPY_ELEMENTS(4b, uint32_t)
GEN_LMAD_COPY_ELEMENTS(8b, uint64_t)

GEN_LMAD_COPY(1b, uint8_t)
GEN_LMAD_COPY(2b, uint16_t)
GEN_LMAD_COPY(4b, uint32_t)
GEN_LMAD_COPY(8b, uint64_t)

// End of copy.h

#define FUTHARK_FUN_ATTR static

FUTHARK_FUN_ATTR int futrts_entry_ugw_armijo(struct futhark_context *ctx, struct memblock *mem_out_p_109759, struct memblock A_mem_107604, struct memblock mu_mem_107605, struct memblock B_mem_107606, struct memblock nu_mem_107607, int64_t mz2081Uz2084U_33563, double rho1_33564, double rho2_33565, double eps_33566, double exp_absorb_cutoff_33571, double safe_for_exp_33572, double tol_sinkhorn_33573, double tol_outerloop_33574);
FUTHARK_FUN_ATTR int futrts_entry_ugw_armijo_euclidean(struct futhark_context *ctx, struct memblock *mem_out_p_109760, int64_t *out_prim_out_109761, struct memblock pt_clouds_mem_107604, int64_t k_34109, int64_t m_34110, int64_t d_34111, double rho1_34112, double rho2_34113, double eps_34114, double exp_absorb_cutoff_34116, double safe_for_exp_34117, double tol_sinkhorn_34118, double tol_outerloop_34119);
FUTHARK_FUN_ATTR int futrts_entry_ugw_armijo_pairwise(struct futhark_context *ctx, struct memblock *mem_out_p_109763, int64_t *out_prim_out_109764, struct memblock A_mem_107604, struct memblock distrs_mem_107605, int64_t k_33497, int64_t m_33498, double rho1_33499, double rho2_33500, double eps_33501, double exp_absorb_cutoff_33504, double safe_for_exp_33505, double tol_sinkhorn_33506, double tol_outerloop_33507);
FUTHARK_FUN_ATTR int futrts_entry_ugw_armijo_pairwise_unif(struct futhark_context *ctx, struct memblock *mem_out_p_109765, int64_t *out_prim_out_109766, struct memblock A_mem_107604, int64_t k_33767, int64_t m_33768, double rho1_33769, double rho2_33770, double eps_33771, double exp_absorb_cutoff_33773, double safe_for_exp_33774, double tol_sinkhorn_33775, double tol_outerloop_33776);
FUTHARK_FUN_ATTR int futrts_ugw_armijo_pairwise_13790(struct futhark_context *ctx, struct memblock *mem_out_p_109767, int64_t *out_prim_out_109768, struct memblock A_mem_107604, struct memblock distrs_mem_107605, int64_t k_33387, int64_t m_33388, double rho1_33389, double rho2_33390, double eps_33391, double exp_absorb_cutoff_33394, double safe_for_exp_33395, double tol_sinkhorn_33396, double tol_outerloop_33397);

static int init_constants(struct futhark_context *ctx)
{
    (void) ctx;
    
    int err = 0;
    
    
  cleanup:
    return err;
}
static int free_constants(struct futhark_context *ctx)
{
    (void) ctx;
    return 0;
}
struct futhark_f64_1d {
    struct memblock mem;
    int64_t shape[1];
};
struct futhark_f64_1d *futhark_new_f64_1d(struct futhark_context *ctx, const double *data, int64_t dim0)
{
    int err = 0;
    struct futhark_f64_1d *bad = NULL;
    struct futhark_f64_1d *arr = (struct futhark_f64_1d *) malloc(sizeof(struct futhark_f64_1d));
    
    if (arr == NULL)
        return bad;
    lock_lock(&ctx->lock);
    arr->mem.references = NULL;
    if (memblock_alloc(ctx, &arr->mem, dim0 * 8, "arr->mem"))
        err = 1;
    arr->shape[0] = dim0;
    if ((size_t) dim0 * 8 > 0)
        memmove(arr->mem.mem + 0, (const unsigned char *) data + 0, (size_t) dim0 * 8);
    lock_unlock(&ctx->lock);
    if (err != 0) {
        free(arr);
        return bad;
    }
    return arr;
}
struct futhark_f64_1d *futhark_new_raw_f64_1d(struct futhark_context *ctx, unsigned char *data, int64_t dim0)
{
    int err = 0;
    struct futhark_f64_1d *bad = NULL;
    struct futhark_f64_1d *arr = (struct futhark_f64_1d *) malloc(sizeof(struct futhark_f64_1d));
    
    if (arr == NULL)
        return bad;
    lock_lock(&ctx->lock);
    arr->mem.references = NULL;
    arr->mem.mem = data;
    arr->shape[0] = dim0;
    lock_unlock(&ctx->lock);
    return arr;
}
int futhark_free_f64_1d(struct futhark_context *ctx, struct futhark_f64_1d *arr)
{
    lock_lock(&ctx->lock);
    if (memblock_unref(ctx, &arr->mem, "arr->mem") != 0)
        return 1;
    lock_unlock(&ctx->lock);
    free(arr);
    return 0;
}
int futhark_values_f64_1d(struct futhark_context *ctx, struct futhark_f64_1d *arr, double *data)
{
    int err = 0;
    
    lock_lock(&ctx->lock);
    if ((size_t) arr->shape[0] * 8 > 0)
        memmove((unsigned char *) data + 0, arr->mem.mem + 0, (size_t) arr->shape[0] * 8);
    lock_unlock(&ctx->lock);
    return err;
}
int futhark_index_f64_1d(struct futhark_context *ctx, double *out, struct futhark_f64_1d *arr, int64_t i0)
{
    int err = 0;
    
    if (i0 >= 0 && i0 < arr->shape[0]) {
        lock_lock(&ctx->lock);
        if (8 > 0)
            memmove((unsigned char *) out + 0, arr->mem.mem + 8 * (i0 * 1), 8);
        lock_unlock(&ctx->lock);
    } else {
        err = 1;
        set_error(ctx, strdup("Index out of bounds."));
    }
    return err;
}
unsigned char *futhark_values_raw_f64_1d(struct futhark_context *ctx, struct futhark_f64_1d *arr)
{
    (void) ctx;
    return arr->mem.mem;
}
const int64_t *futhark_shape_f64_1d(struct futhark_context *ctx, struct futhark_f64_1d *arr)
{
    (void) ctx;
    return arr->shape;
}
struct futhark_f64_2d {
    struct memblock mem;
    int64_t shape[2];
};
struct futhark_f64_2d *futhark_new_f64_2d(struct futhark_context *ctx, const double *data, int64_t dim0, int64_t dim1)
{
    int err = 0;
    struct futhark_f64_2d *bad = NULL;
    struct futhark_f64_2d *arr = (struct futhark_f64_2d *) malloc(sizeof(struct futhark_f64_2d));
    
    if (arr == NULL)
        return bad;
    lock_lock(&ctx->lock);
    arr->mem.references = NULL;
    if (memblock_alloc(ctx, &arr->mem, dim0 * dim1 * 8, "arr->mem"))
        err = 1;
    arr->shape[0] = dim0;
    arr->shape[1] = dim1;
    if ((size_t) (dim0 * dim1) * 8 > 0)
        memmove(arr->mem.mem + 0, (const unsigned char *) data + 0, (size_t) (dim0 * dim1) * 8);
    lock_unlock(&ctx->lock);
    if (err != 0) {
        free(arr);
        return bad;
    }
    return arr;
}
struct futhark_f64_2d *futhark_new_raw_f64_2d(struct futhark_context *ctx, unsigned char *data, int64_t dim0, int64_t dim1)
{
    int err = 0;
    struct futhark_f64_2d *bad = NULL;
    struct futhark_f64_2d *arr = (struct futhark_f64_2d *) malloc(sizeof(struct futhark_f64_2d));
    
    if (arr == NULL)
        return bad;
    lock_lock(&ctx->lock);
    arr->mem.references = NULL;
    arr->mem.mem = data;
    arr->shape[0] = dim0;
    arr->shape[1] = dim1;
    lock_unlock(&ctx->lock);
    return arr;
}
int futhark_free_f64_2d(struct futhark_context *ctx, struct futhark_f64_2d *arr)
{
    lock_lock(&ctx->lock);
    if (memblock_unref(ctx, &arr->mem, "arr->mem") != 0)
        return 1;
    lock_unlock(&ctx->lock);
    free(arr);
    return 0;
}
int futhark_values_f64_2d(struct futhark_context *ctx, struct futhark_f64_2d *arr, double *data)
{
    int err = 0;
    
    lock_lock(&ctx->lock);
    if ((size_t) (arr->shape[0] * arr->shape[1]) * 8 > 0)
        memmove((unsigned char *) data + 0, arr->mem.mem + 0, (size_t) (arr->shape[0] * arr->shape[1]) * 8);
    lock_unlock(&ctx->lock);
    return err;
}
int futhark_index_f64_2d(struct futhark_context *ctx, double *out, struct futhark_f64_2d *arr, int64_t i0, int64_t i1)
{
    int err = 0;
    
    if ((i0 >= 0 && i0 < arr->shape[0]) && (i1 >= 0 && i1 < arr->shape[1])) {
        lock_lock(&ctx->lock);
        if (8 > 0)
            memmove((unsigned char *) out + 0, arr->mem.mem + 8 * (i0 * arr->shape[1] + i1 * 1), 8);
        lock_unlock(&ctx->lock);
    } else {
        err = 1;
        set_error(ctx, strdup("Index out of bounds."));
    }
    return err;
}
unsigned char *futhark_values_raw_f64_2d(struct futhark_context *ctx, struct futhark_f64_2d *arr)
{
    (void) ctx;
    return arr->mem.mem;
}
const int64_t *futhark_shape_f64_2d(struct futhark_context *ctx, struct futhark_f64_2d *arr)
{
    (void) ctx;
    return arr->shape;
}
struct futhark_f64_3d {
    struct memblock mem;
    int64_t shape[3];
};
struct futhark_f64_3d *futhark_new_f64_3d(struct futhark_context *ctx, const double *data, int64_t dim0, int64_t dim1, int64_t dim2)
{
    int err = 0;
    struct futhark_f64_3d *bad = NULL;
    struct futhark_f64_3d *arr = (struct futhark_f64_3d *) malloc(sizeof(struct futhark_f64_3d));
    
    if (arr == NULL)
        return bad;
    lock_lock(&ctx->lock);
    arr->mem.references = NULL;
    if (memblock_alloc(ctx, &arr->mem, dim0 * dim1 * dim2 * 8, "arr->mem"))
        err = 1;
    arr->shape[0] = dim0;
    arr->shape[1] = dim1;
    arr->shape[2] = dim2;
    if ((size_t) (dim0 * dim1 * dim2) * 8 > 0)
        memmove(arr->mem.mem + 0, (const unsigned char *) data + 0, (size_t) (dim0 * dim1 * dim2) * 8);
    lock_unlock(&ctx->lock);
    if (err != 0) {
        free(arr);
        return bad;
    }
    return arr;
}
struct futhark_f64_3d *futhark_new_raw_f64_3d(struct futhark_context *ctx, unsigned char *data, int64_t dim0, int64_t dim1, int64_t dim2)
{
    int err = 0;
    struct futhark_f64_3d *bad = NULL;
    struct futhark_f64_3d *arr = (struct futhark_f64_3d *) malloc(sizeof(struct futhark_f64_3d));
    
    if (arr == NULL)
        return bad;
    lock_lock(&ctx->lock);
    arr->mem.references = NULL;
    arr->mem.mem = data;
    arr->shape[0] = dim0;
    arr->shape[1] = dim1;
    arr->shape[2] = dim2;
    lock_unlock(&ctx->lock);
    return arr;
}
int futhark_free_f64_3d(struct futhark_context *ctx, struct futhark_f64_3d *arr)
{
    lock_lock(&ctx->lock);
    if (memblock_unref(ctx, &arr->mem, "arr->mem") != 0)
        return 1;
    lock_unlock(&ctx->lock);
    free(arr);
    return 0;
}
int futhark_values_f64_3d(struct futhark_context *ctx, struct futhark_f64_3d *arr, double *data)
{
    int err = 0;
    
    lock_lock(&ctx->lock);
    if ((size_t) (arr->shape[0] * arr->shape[1] * arr->shape[2]) * 8 > 0)
        memmove((unsigned char *) data + 0, arr->mem.mem + 0, (size_t) (arr->shape[0] * arr->shape[1] * arr->shape[2]) * 8);
    lock_unlock(&ctx->lock);
    return err;
}
int futhark_index_f64_3d(struct futhark_context *ctx, double *out, struct futhark_f64_3d *arr, int64_t i0, int64_t i1, int64_t i2)
{
    int err = 0;
    
    if ((i0 >= 0 && i0 < arr->shape[0]) && ((i1 >= 0 && i1 < arr->shape[1]) && (i2 >= 0 && i2 < arr->shape[2]))) {
        lock_lock(&ctx->lock);
        if (8 > 0)
            memmove((unsigned char *) out + 0, arr->mem.mem + 8 * (i0 * (arr->shape[1] * arr->shape[2]) + i1 * arr->shape[2] + i2 * 1), 8);
        lock_unlock(&ctx->lock);
    } else {
        err = 1;
        set_error(ctx, strdup("Index out of bounds."));
    }
    return err;
}
unsigned char *futhark_values_raw_f64_3d(struct futhark_context *ctx, struct futhark_f64_3d *arr)
{
    (void) ctx;
    return arr->mem.mem;
}
const int64_t *futhark_shape_f64_3d(struct futhark_context *ctx, struct futhark_f64_3d *arr)
{
    (void) ctx;
    return arr->shape;
}

FUTHARK_FUN_ATTR int futrts_entry_ugw_armijo(struct futhark_context *ctx, struct memblock *mem_out_p_109759, struct memblock A_mem_107604, struct memblock mu_mem_107605, struct memblock B_mem_107606, struct memblock nu_mem_107607, int64_t mz2081Uz2084U_33563, double rho1_33564, double rho2_33565, double eps_33566, double exp_absorb_cutoff_33571, double safe_for_exp_33572, double tol_sinkhorn_33573, double tol_outerloop_33574)
{
    (void) ctx;
    
    int err = 0;
    struct memblock ext_mem_107613;
    
    ext_mem_107613.references = NULL;
    
    struct memblock mem_107612;
    
    mem_107612.references = NULL;
    
    struct memblock mem_107609;
    
    mem_107609.references = NULL;
    
    struct memblock mem_out_109343;
    
    mem_out_109343.references = NULL;
    
    int64_t bytes_107608 = (int64_t) 16 * mz2081Uz2084U_33563;
    
    if (memblock_alloc(ctx, &mem_107609, bytes_107608, "mem_107609")) {
        err = 1;
        goto cleanup;
    }
    lmad_copy_8b(ctx, 1, (uint64_t *) mem_107609.mem, (int64_t) 0, (int64_t []) {(int64_t) 1}, (uint64_t *) mu_mem_107605.mem, (int64_t) 0, (int64_t []) {(int64_t) 1}, (int64_t []) {mz2081Uz2084U_33563});
    lmad_copy_8b(ctx, 1, (uint64_t *) mem_107609.mem, mz2081Uz2084U_33563, (int64_t []) {(int64_t) 1}, (uint64_t *) nu_mem_107607.mem, (int64_t) 0, (int64_t []) {(int64_t) 1}, (int64_t []) {mz2081Uz2084U_33563});
    
    int64_t bytes_107611 = mz2081Uz2084U_33563 * bytes_107608;
    
    if (memblock_alloc(ctx, &mem_107612, bytes_107611, "mem_107612")) {
        err = 1;
        goto cleanup;
    }
    lmad_copy_8b(ctx, 2, (uint64_t *) mem_107612.mem, (int64_t) 0, (int64_t []) {mz2081Uz2084U_33563, (int64_t) 1}, (uint64_t *) A_mem_107604.mem, (int64_t) 0, (int64_t []) {mz2081Uz2084U_33563, (int64_t) 1}, (int64_t []) {mz2081Uz2084U_33563, mz2081Uz2084U_33563});
    lmad_copy_8b(ctx, 2, (uint64_t *) mem_107612.mem, mz2081Uz2084U_33563 * mz2081Uz2084U_33563, (int64_t []) {mz2081Uz2084U_33563, (int64_t) 1}, (uint64_t *) B_mem_107606.mem, (int64_t) 0, (int64_t []) {mz2081Uz2084U_33563, (int64_t) 1}, (int64_t []) {mz2081Uz2084U_33563, mz2081Uz2084U_33563});
    
    int64_t zbzg_lhs_34527;
    
    if (futrts_ugw_armijo_pairwise_13790(ctx, &ext_mem_107613, &zbzg_lhs_34527, mem_107612, mem_107609, (int64_t) 2, mz2081Uz2084U_33563, rho1_33564, rho2_33565, eps_33566, exp_absorb_cutoff_33571, safe_for_exp_33572, tol_sinkhorn_33573, tol_outerloop_33574) != 0) {
        err = 1;
        goto cleanup;
    }
    if (memblock_unref(ctx, &mem_107609, "mem_107609") != 0)
        return 1;
    if (memblock_unref(ctx, &mem_107612, "mem_107612") != 0)
        return 1;
    
    bool y_34529 = slt64((int64_t) 0, zbzg_lhs_34527);
    bool index_certs_34530;
    
    if (!y_34529) {
        set_error(ctx, msgprintf("Error: %s%lld%s%lld%s\n\nBacktrace:\n%s", "Index [", (long long) (int64_t) 0, "] out of bounds for array of shape [", (long long) zbzg_lhs_34527, "].", "-> #0  unbalanced_gw.fut:165:33-37\n   #1  /prelude/functional.fut:9:44-45\n   #2  unbalanced_gw.fut:165:27-37\n   #3  unbalanced_gw.fut:162:1-165:38\n"));
        err = FUTHARK_PROGRAM_ERROR;
        goto cleanup;
    }
    if (memblock_set(ctx, &mem_out_109343, &ext_mem_107613, "ext_mem_107613") != 0)
        return 1;
    if (memblock_set(ctx, &*mem_out_p_109759, &mem_out_109343, "mem_out_109343") != 0)
        return 1;
    
  cleanup:
    {
        if (memblock_unref(ctx, &ext_mem_107613, "ext_mem_107613") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107612, "mem_107612") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107609, "mem_107609") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_out_109343, "mem_out_109343") != 0)
            return 1;
    }
    return err;
}
FUTHARK_FUN_ATTR int futrts_entry_ugw_armijo_euclidean(struct futhark_context *ctx, struct memblock *mem_out_p_109760, int64_t *out_prim_out_109761, struct memblock pt_clouds_mem_107604, int64_t k_34109, int64_t m_34110, int64_t d_34111, double rho1_34112, double rho2_34113, double eps_34114, double exp_absorb_cutoff_34116, double safe_for_exp_34117, double tol_sinkhorn_34118, double tol_outerloop_34119)
{
    (void) ctx;
    
    int err = 0;
    int64_t mem_107608_cached_sizze_109762 = 0;
    unsigned char *mem_107608 = NULL;
    struct memblock ext_mem_107647;
    
    ext_mem_107647.references = NULL;
    
    struct memblock mem_107645;
    
    mem_107645.references = NULL;
    
    struct memblock mem_107641;
    
    mem_107641.references = NULL;
    
    struct memblock mem_out_109343;
    
    mem_out_109343.references = NULL;
    
    int64_t prim_out_109344;
    int64_t binop_x_107605 = (int64_t) 8 * k_34109;
    int64_t binop_x_107606 = m_34110 * binop_x_107605;
    int64_t bytes_107607 = m_34110 * binop_x_107606;
    
    if (mem_107608_cached_sizze_109762 < bytes_107607) {
        err = lexical_realloc(ctx, &mem_107608, &mem_107608_cached_sizze_109762, bytes_107607);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    
    int64_t lmad_arg_107614 = m_34110 * m_34110;
    
    for (int64_t i_103784 = 0; i_103784 < k_34109; i_103784++) {
        for (int64_t i_103780 = 0; i_103780 < m_34110; i_103780++) {
            for (int64_t i_103776 = 0; i_103776 < m_34110; i_103776++) {
                double defunc_0_reduce_res_47661;
                double redout_103772 = 0.0;
                
                for (int64_t i_103773 = 0; i_103773 < d_34111; i_103773++) {
                    double eta_p_47648 = ((double *) pt_clouds_mem_107604.mem)[i_103784 * (d_34111 * m_34110) + i_103780 * d_34111 + i_103773];
                    double eta_p_47649 = ((double *) pt_clouds_mem_107604.mem)[i_103784 * (d_34111 * m_34110) + i_103776 * d_34111 + i_103773];
                    double zm_res_47650 = eta_p_47648 - eta_p_47649;
                    double zt_res_47653 = zm_res_47650 * zm_res_47650;
                    double zp_res_47638 = zt_res_47653 + redout_103772;
                    double redout_tmp_109348 = zp_res_47638;
                    
                    redout_103772 = redout_tmp_109348;
                }
                defunc_0_reduce_res_47661 = redout_103772;
                
                double sqrt_res_47641 = futrts_sqrt64(defunc_0_reduce_res_47661);
                
                ((double *) mem_107608)[i_103784 * lmad_arg_107614 + i_103780 * m_34110 + i_103776] = sqrt_res_47641;
            }
        }
    }
    
    double i64_res_44789 = sitofp_i64_f64(m_34110);
    double replicate_arg1_44790 = 1.0 / i64_res_44789;
    
    if (memblock_alloc(ctx, &mem_107641, binop_x_107606, "mem_107641")) {
        err = 1;
        goto cleanup;
    }
    for (int64_t nest_i_109349 = 0; nest_i_109349 < k_34109; nest_i_109349++) {
        for (int64_t nest_i_109350 = 0; nest_i_109350 < m_34110; nest_i_109350++) {
            ((double *) mem_107641.mem)[nest_i_109349 * m_34110 + nest_i_109350] = replicate_arg1_44790;
        }
    }
    if (memblock_alloc(ctx, &mem_107645, bytes_107607, "mem_107645")) {
        err = 1;
        goto cleanup;
    }
    lmad_copy_8b(ctx, 3, (uint64_t *) mem_107645.mem, (int64_t) 0, (int64_t []) {m_34110 * m_34110, m_34110, (int64_t) 1}, (uint64_t *) mem_107608, (int64_t) 0, (int64_t []) {lmad_arg_107614, m_34110, (int64_t) 1}, (int64_t []) {k_34109, m_34110, m_34110});
    
    int64_t defunc_res_44792;
    
    if (futrts_ugw_armijo_pairwise_13790(ctx, &ext_mem_107647, &defunc_res_44792, mem_107645, mem_107641, k_34109, m_34110, rho1_34112, rho2_34113, eps_34114, exp_absorb_cutoff_34116, safe_for_exp_34117, tol_sinkhorn_34118, tol_outerloop_34119) != 0) {
        err = 1;
        goto cleanup;
    }
    if (memblock_unref(ctx, &mem_107641, "mem_107641") != 0)
        return 1;
    if (memblock_unref(ctx, &mem_107645, "mem_107645") != 0)
        return 1;
    if (memblock_set(ctx, &mem_out_109343, &ext_mem_107647, "ext_mem_107647") != 0)
        return 1;
    prim_out_109344 = defunc_res_44792;
    if (memblock_set(ctx, &*mem_out_p_109760, &mem_out_109343, "mem_out_109343") != 0)
        return 1;
    *out_prim_out_109761 = prim_out_109344;
    
  cleanup:
    {
        free(mem_107608);
        if (memblock_unref(ctx, &ext_mem_107647, "ext_mem_107647") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107645, "mem_107645") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107641, "mem_107641") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_out_109343, "mem_out_109343") != 0)
            return 1;
    }
    return err;
}
FUTHARK_FUN_ATTR int futrts_entry_ugw_armijo_pairwise(struct futhark_context *ctx, struct memblock *mem_out_p_109763, int64_t *out_prim_out_109764, struct memblock A_mem_107604, struct memblock distrs_mem_107605, int64_t k_33497, int64_t m_33498, double rho1_33499, double rho2_33500, double eps_33501, double exp_absorb_cutoff_33504, double safe_for_exp_33505, double tol_sinkhorn_33506, double tol_outerloop_33507)
{
    (void) ctx;
    
    int err = 0;
    struct memblock ext_mem_107606;
    
    ext_mem_107606.references = NULL;
    
    struct memblock mem_out_109343;
    
    mem_out_109343.references = NULL;
    
    int64_t prim_out_109344;
    int64_t entry_result_33508;
    
    if (futrts_ugw_armijo_pairwise_13790(ctx, &ext_mem_107606, &entry_result_33508, A_mem_107604, distrs_mem_107605, k_33497, m_33498, rho1_33499, rho2_33500, eps_33501, exp_absorb_cutoff_33504, safe_for_exp_33505, tol_sinkhorn_33506, tol_outerloop_33507) != 0) {
        err = 1;
        goto cleanup;
    }
    if (memblock_set(ctx, &mem_out_109343, &ext_mem_107606, "ext_mem_107606") != 0)
        return 1;
    prim_out_109344 = entry_result_33508;
    if (memblock_set(ctx, &*mem_out_p_109763, &mem_out_109343, "mem_out_109343") != 0)
        return 1;
    *out_prim_out_109764 = prim_out_109344;
    
  cleanup:
    {
        if (memblock_unref(ctx, &ext_mem_107606, "ext_mem_107606") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_out_109343, "mem_out_109343") != 0)
            return 1;
    }
    return err;
}
FUTHARK_FUN_ATTR int futrts_entry_ugw_armijo_pairwise_unif(struct futhark_context *ctx, struct memblock *mem_out_p_109765, int64_t *out_prim_out_109766, struct memblock A_mem_107604, int64_t k_33767, int64_t m_33768, double rho1_33769, double rho2_33770, double eps_33771, double exp_absorb_cutoff_33773, double safe_for_exp_33774, double tol_sinkhorn_33775, double tol_outerloop_33776)
{
    (void) ctx;
    
    int err = 0;
    struct memblock ext_mem_107608;
    
    ext_mem_107608.references = NULL;
    
    struct memblock mem_107607;
    
    mem_107607.references = NULL;
    
    struct memblock mem_out_109343;
    
    mem_out_109343.references = NULL;
    
    int64_t prim_out_109344;
    int64_t binop_x_107605 = (int64_t) 8 * k_33767;
    int64_t bytes_107606 = m_33768 * binop_x_107605;
    double i64_res_44789 = sitofp_i64_f64(m_33768);
    double replicate_arg1_44790 = 1.0 / i64_res_44789;
    
    if (memblock_alloc(ctx, &mem_107607, bytes_107606, "mem_107607")) {
        err = 1;
        goto cleanup;
    }
    for (int64_t nest_i_109345 = 0; nest_i_109345 < k_33767; nest_i_109345++) {
        for (int64_t nest_i_109346 = 0; nest_i_109346 < m_33768; nest_i_109346++) {
            ((double *) mem_107607.mem)[nest_i_109345 * m_33768 + nest_i_109346] = replicate_arg1_44790;
        }
    }
    
    int64_t defunc_res_44792;
    
    if (futrts_ugw_armijo_pairwise_13790(ctx, &ext_mem_107608, &defunc_res_44792, A_mem_107604, mem_107607, k_33767, m_33768, rho1_33769, rho2_33770, eps_33771, exp_absorb_cutoff_33773, safe_for_exp_33774, tol_sinkhorn_33775, tol_outerloop_33776) != 0) {
        err = 1;
        goto cleanup;
    }
    if (memblock_unref(ctx, &mem_107607, "mem_107607") != 0)
        return 1;
    if (memblock_set(ctx, &mem_out_109343, &ext_mem_107608, "ext_mem_107608") != 0)
        return 1;
    prim_out_109344 = defunc_res_44792;
    if (memblock_set(ctx, &*mem_out_p_109765, &mem_out_109343, "mem_out_109343") != 0)
        return 1;
    *out_prim_out_109766 = prim_out_109344;
    
  cleanup:
    {
        if (memblock_unref(ctx, &ext_mem_107608, "ext_mem_107608") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107607, "mem_107607") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_out_109343, "mem_out_109343") != 0)
            return 1;
    }
    return err;
}
FUTHARK_FUN_ATTR int futrts_ugw_armijo_pairwise_13790(struct futhark_context *ctx, struct memblock *mem_out_p_109767, int64_t *out_prim_out_109768, struct memblock A_mem_107604, struct memblock distrs_mem_107605, int64_t k_33387, int64_t m_33388, double rho1_33389, double rho2_33390, double eps_33391, double exp_absorb_cutoff_33394, double safe_for_exp_33395, double tol_sinkhorn_33396, double tol_outerloop_33397)
{
    (void) ctx;
    
    int err = 0;
    int64_t mem_107607_cached_sizze_109769 = 0;
    unsigned char *mem_107607 = NULL;
    int64_t mem_107615_cached_sizze_109770 = 0;
    unsigned char *mem_107615 = NULL;
    int64_t mem_107632_cached_sizze_109771 = 0;
    unsigned char *mem_107632 = NULL;
    int64_t mem_107634_cached_sizze_109772 = 0;
    unsigned char *mem_107634 = NULL;
    int64_t mem_107637_cached_sizze_109773 = 0;
    unsigned char *mem_107637 = NULL;
    int64_t mem_107667_cached_sizze_109774 = 0;
    unsigned char *mem_107667 = NULL;
    int64_t mem_107669_cached_sizze_109775 = 0;
    unsigned char *mem_107669 = NULL;
    int64_t mem_107671_cached_sizze_109776 = 0;
    unsigned char *mem_107671 = NULL;
    int64_t mem_107691_cached_sizze_109777 = 0;
    unsigned char *mem_107691 = NULL;
    int64_t mem_107700_cached_sizze_109778 = 0;
    unsigned char *mem_107700 = NULL;
    int64_t mem_107711_cached_sizze_109779 = 0;
    unsigned char *mem_107711 = NULL;
    int64_t mem_107713_cached_sizze_109780 = 0;
    unsigned char *mem_107713 = NULL;
    int64_t mem_107727_cached_sizze_109781 = 0;
    unsigned char *mem_107727 = NULL;
    int64_t mem_107758_cached_sizze_109782 = 0;
    unsigned char *mem_107758 = NULL;
    int64_t mem_108050_cached_sizze_109783 = 0;
    unsigned char *mem_108050 = NULL;
    int64_t mem_108097_cached_sizze_109784 = 0;
    unsigned char *mem_108097 = NULL;
    int64_t mem_108105_cached_sizze_109785 = 0;
    unsigned char *mem_108105 = NULL;
    int64_t mem_108107_cached_sizze_109786 = 0;
    unsigned char *mem_108107 = NULL;
    int64_t mem_108121_cached_sizze_109787 = 0;
    unsigned char *mem_108121 = NULL;
    int64_t mem_108130_cached_sizze_109788 = 0;
    unsigned char *mem_108130 = NULL;
    int64_t mem_108132_cached_sizze_109789 = 0;
    unsigned char *mem_108132 = NULL;
    int64_t mem_108141_cached_sizze_109790 = 0;
    unsigned char *mem_108141 = NULL;
    int64_t mem_108149_cached_sizze_109791 = 0;
    unsigned char *mem_108149 = NULL;
    int64_t mem_108780_cached_sizze_109792 = 0;
    unsigned char *mem_108780 = NULL;
    int64_t mem_108817_cached_sizze_109793 = 0;
    unsigned char *mem_108817 = NULL;
    int64_t mem_108819_cached_sizze_109794 = 0;
    unsigned char *mem_108819 = NULL;
    int64_t mem_108821_cached_sizze_109795 = 0;
    unsigned char *mem_108821 = NULL;
    int64_t mem_108842_cached_sizze_109796 = 0;
    unsigned char *mem_108842 = NULL;
    int64_t mem_108854_cached_sizze_109797 = 0;
    unsigned char *mem_108854 = NULL;
    int64_t mem_108856_cached_sizze_109798 = 0;
    unsigned char *mem_108856 = NULL;
    int64_t mem_108870_cached_sizze_109799 = 0;
    unsigned char *mem_108870 = NULL;
    int64_t mem_108878_cached_sizze_109800 = 0;
    unsigned char *mem_108878 = NULL;
    int64_t mem_108881_cached_sizze_109801 = 0;
    unsigned char *mem_108881 = NULL;
    int64_t mem_108897_cached_sizze_109802 = 0;
    unsigned char *mem_108897 = NULL;
    int64_t mem_108932_cached_sizze_109803 = 0;
    unsigned char *mem_108932 = NULL;
    int64_t mem_108940_cached_sizze_109804 = 0;
    unsigned char *mem_108940 = NULL;
    int64_t mem_108952_cached_sizze_109805 = 0;
    unsigned char *mem_108952 = NULL;
    int64_t mem_108955_cached_sizze_109806 = 0;
    unsigned char *mem_108955 = NULL;
    int64_t mem_108998_cached_sizze_109807 = 0;
    unsigned char *mem_108998 = NULL;
    int64_t mem_109006_cached_sizze_109808 = 0;
    unsigned char *mem_109006 = NULL;
    int64_t mem_109057_cached_sizze_109809 = 0;
    unsigned char *mem_109057 = NULL;
    int64_t mem_109059_cached_sizze_109810 = 0;
    unsigned char *mem_109059 = NULL;
    int64_t mem_109061_cached_sizze_109811 = 0;
    unsigned char *mem_109061 = NULL;
    int64_t mem_109072_cached_sizze_109812 = 0;
    unsigned char *mem_109072 = NULL;
    int64_t mem_109089_cached_sizze_109813 = 0;
    unsigned char *mem_109089 = NULL;
    int64_t mem_109091_cached_sizze_109814 = 0;
    unsigned char *mem_109091 = NULL;
    int64_t mem_109093_cached_sizze_109815 = 0;
    unsigned char *mem_109093 = NULL;
    int64_t mem_109112_cached_sizze_109816 = 0;
    unsigned char *mem_109112 = NULL;
    struct memblock mem_param_tmp_109472;
    
    mem_param_tmp_109472.references = NULL;
    
    struct memblock mem_param_tmp_109471;
    
    mem_param_tmp_109471.references = NULL;
    
    struct memblock mem_param_tmp_109470;
    
    mem_param_tmp_109470.references = NULL;
    
    struct memblock mem_108815;
    
    mem_108815.references = NULL;
    
    struct memblock mem_108812;
    
    mem_108812.references = NULL;
    
    struct memblock mem_109019;
    
    mem_109019.references = NULL;
    
    struct memblock mem_param_tmp_109684;
    
    mem_param_tmp_109684.references = NULL;
    
    struct memblock mem_108958;
    
    mem_108958.references = NULL;
    
    struct memblock mem_param_108950;
    
    mem_param_108950.references = NULL;
    
    struct memblock ext_mem_109016;
    
    ext_mem_109016.references = NULL;
    
    struct memblock mem_108884;
    
    mem_108884.references = NULL;
    
    struct memblock ext_mem_109039;
    
    ext_mem_109039.references = NULL;
    
    struct memblock ext_mem_109042;
    
    ext_mem_109042.references = NULL;
    
    struct memblock ext_mem_109045;
    
    ext_mem_109045.references = NULL;
    
    struct memblock mem_108782;
    
    mem_108782.references = NULL;
    
    struct memblock mem_108777;
    
    mem_108777.references = NULL;
    
    struct memblock mem_param_tmp_109593;
    
    mem_param_tmp_109593.references = NULL;
    
    struct memblock mem_param_tmp_109592;
    
    mem_param_tmp_109592.references = NULL;
    
    struct memblock mem_param_tmp_109591;
    
    mem_param_tmp_109591.references = NULL;
    
    struct memblock mem_param_tmp_109590;
    
    mem_param_tmp_109590.references = NULL;
    
    struct memblock mem_param_tmp_109589;
    
    mem_param_tmp_109589.references = NULL;
    
    struct memblock mem_108712;
    
    mem_108712.references = NULL;
    
    struct memblock ext_mem_108723;
    
    ext_mem_108723.references = NULL;
    
    struct memblock mem_108700;
    
    mem_108700.references = NULL;
    
    struct memblock mem_108697;
    
    mem_108697.references = NULL;
    
    struct memblock mem_108695;
    
    mem_108695.references = NULL;
    
    struct memblock ext_mem_108737;
    
    ext_mem_108737.references = NULL;
    
    struct memblock ext_mem_108740;
    
    ext_mem_108740.references = NULL;
    
    struct memblock ext_mem_108743;
    
    ext_mem_108743.references = NULL;
    
    struct memblock mem_108662;
    
    mem_108662.references = NULL;
    
    struct memblock ext_mem_108673;
    
    ext_mem_108673.references = NULL;
    
    struct memblock mem_108650;
    
    mem_108650.references = NULL;
    
    struct memblock mem_108647;
    
    mem_108647.references = NULL;
    
    struct memblock mem_108645;
    
    mem_108645.references = NULL;
    
    struct memblock ext_mem_108687;
    
    ext_mem_108687.references = NULL;
    
    struct memblock ext_mem_108690;
    
    ext_mem_108690.references = NULL;
    
    struct memblock ext_mem_108693;
    
    ext_mem_108693.references = NULL;
    
    struct memblock mem_108637;
    
    mem_108637.references = NULL;
    
    struct memblock mem_108629;
    
    mem_108629.references = NULL;
    
    struct memblock mem_param_108627;
    
    mem_param_108627.references = NULL;
    
    struct memblock mem_param_108624;
    
    mem_param_108624.references = NULL;
    
    struct memblock mem_param_108621;
    
    mem_param_108621.references = NULL;
    
    struct memblock mem_param_108618;
    
    mem_param_108618.references = NULL;
    
    struct memblock mem_param_108615;
    
    mem_param_108615.references = NULL;
    
    struct memblock ext_mem_108755;
    
    ext_mem_108755.references = NULL;
    
    struct memblock ext_mem_108756;
    
    ext_mem_108756.references = NULL;
    
    struct memblock ext_mem_108757;
    
    ext_mem_108757.references = NULL;
    
    struct memblock ext_mem_108758;
    
    ext_mem_108758.references = NULL;
    
    struct memblock ext_mem_108759;
    
    ext_mem_108759.references = NULL;
    
    struct memblock mem_108580;
    
    mem_108580.references = NULL;
    
    struct memblock ext_mem_108591;
    
    ext_mem_108591.references = NULL;
    
    struct memblock mem_108568;
    
    mem_108568.references = NULL;
    
    struct memblock mem_108565;
    
    mem_108565.references = NULL;
    
    struct memblock mem_108563;
    
    mem_108563.references = NULL;
    
    struct memblock ext_mem_108605;
    
    ext_mem_108605.references = NULL;
    
    struct memblock ext_mem_108608;
    
    ext_mem_108608.references = NULL;
    
    struct memblock ext_mem_108611;
    
    ext_mem_108611.references = NULL;
    
    struct memblock mem_108530;
    
    mem_108530.references = NULL;
    
    struct memblock ext_mem_108541;
    
    ext_mem_108541.references = NULL;
    
    struct memblock mem_108518;
    
    mem_108518.references = NULL;
    
    struct memblock mem_108515;
    
    mem_108515.references = NULL;
    
    struct memblock mem_108513;
    
    mem_108513.references = NULL;
    
    struct memblock ext_mem_108555;
    
    ext_mem_108555.references = NULL;
    
    struct memblock ext_mem_108558;
    
    ext_mem_108558.references = NULL;
    
    struct memblock ext_mem_108561;
    
    ext_mem_108561.references = NULL;
    
    struct memblock mem_108505;
    
    mem_108505.references = NULL;
    
    struct memblock mem_108497;
    
    mem_108497.references = NULL;
    
    struct memblock ext_mem_108762;
    
    ext_mem_108762.references = NULL;
    
    struct memblock ext_mem_108765;
    
    ext_mem_108765.references = NULL;
    
    struct memblock ext_mem_108768;
    
    ext_mem_108768.references = NULL;
    
    struct memblock ext_mem_108771;
    
    ext_mem_108771.references = NULL;
    
    struct memblock ext_mem_108775;
    
    ext_mem_108775.references = NULL;
    
    struct memblock mem_param_tmp_109535;
    
    mem_param_tmp_109535.references = NULL;
    
    struct memblock mem_param_tmp_109534;
    
    mem_param_tmp_109534.references = NULL;
    
    struct memblock mem_param_tmp_109533;
    
    mem_param_tmp_109533.references = NULL;
    
    struct memblock mem_param_tmp_109532;
    
    mem_param_tmp_109532.references = NULL;
    
    struct memblock mem_param_tmp_109531;
    
    mem_param_tmp_109531.references = NULL;
    
    struct memblock mem_param_tmp_109530;
    
    mem_param_tmp_109530.references = NULL;
    
    struct memblock mem_param_tmp_109529;
    
    mem_param_tmp_109529.references = NULL;
    
    struct memblock mem_param_tmp_109528;
    
    mem_param_tmp_109528.references = NULL;
    
    struct memblock mem_param_tmp_109527;
    
    mem_param_tmp_109527.references = NULL;
    
    struct memblock mem_108435;
    
    mem_108435.references = NULL;
    
    struct memblock ext_mem_108446;
    
    ext_mem_108446.references = NULL;
    
    struct memblock mem_108423;
    
    mem_108423.references = NULL;
    
    struct memblock mem_108420;
    
    mem_108420.references = NULL;
    
    struct memblock mem_108418;
    
    mem_108418.references = NULL;
    
    struct memblock ext_mem_108460;
    
    ext_mem_108460.references = NULL;
    
    struct memblock ext_mem_108463;
    
    ext_mem_108463.references = NULL;
    
    struct memblock ext_mem_108466;
    
    ext_mem_108466.references = NULL;
    
    struct memblock mem_108385;
    
    mem_108385.references = NULL;
    
    struct memblock ext_mem_108396;
    
    ext_mem_108396.references = NULL;
    
    struct memblock mem_108373;
    
    mem_108373.references = NULL;
    
    struct memblock mem_108370;
    
    mem_108370.references = NULL;
    
    struct memblock mem_108368;
    
    mem_108368.references = NULL;
    
    struct memblock ext_mem_108410;
    
    ext_mem_108410.references = NULL;
    
    struct memblock ext_mem_108413;
    
    ext_mem_108413.references = NULL;
    
    struct memblock ext_mem_108416;
    
    ext_mem_108416.references = NULL;
    
    struct memblock mem_108360;
    
    mem_108360.references = NULL;
    
    struct memblock mem_108352;
    
    mem_108352.references = NULL;
    
    struct memblock mem_param_108350;
    
    mem_param_108350.references = NULL;
    
    struct memblock mem_param_108347;
    
    mem_param_108347.references = NULL;
    
    struct memblock mem_param_108344;
    
    mem_param_108344.references = NULL;
    
    struct memblock mem_param_108341;
    
    mem_param_108341.references = NULL;
    
    struct memblock mem_param_108338;
    
    mem_param_108338.references = NULL;
    
    struct memblock mem_param_108334;
    
    mem_param_108334.references = NULL;
    
    struct memblock mem_param_108331;
    
    mem_param_108331.references = NULL;
    
    struct memblock mem_param_108328;
    
    mem_param_108328.references = NULL;
    
    struct memblock mem_param_108325;
    
    mem_param_108325.references = NULL;
    
    struct memblock ext_mem_108487;
    
    ext_mem_108487.references = NULL;
    
    struct memblock ext_mem_108488;
    
    ext_mem_108488.references = NULL;
    
    struct memblock ext_mem_108489;
    
    ext_mem_108489.references = NULL;
    
    struct memblock ext_mem_108490;
    
    ext_mem_108490.references = NULL;
    
    struct memblock ext_mem_108491;
    
    ext_mem_108491.references = NULL;
    
    struct memblock ext_mem_108492;
    
    ext_mem_108492.references = NULL;
    
    struct memblock ext_mem_108493;
    
    ext_mem_108493.references = NULL;
    
    struct memblock ext_mem_108494;
    
    ext_mem_108494.references = NULL;
    
    struct memblock ext_mem_108495;
    
    ext_mem_108495.references = NULL;
    
    struct memblock mem_108290;
    
    mem_108290.references = NULL;
    
    struct memblock ext_mem_108301;
    
    ext_mem_108301.references = NULL;
    
    struct memblock mem_108278;
    
    mem_108278.references = NULL;
    
    struct memblock mem_108275;
    
    mem_108275.references = NULL;
    
    struct memblock mem_108273;
    
    mem_108273.references = NULL;
    
    struct memblock ext_mem_108315;
    
    ext_mem_108315.references = NULL;
    
    struct memblock ext_mem_108318;
    
    ext_mem_108318.references = NULL;
    
    struct memblock ext_mem_108321;
    
    ext_mem_108321.references = NULL;
    
    struct memblock mem_108240;
    
    mem_108240.references = NULL;
    
    struct memblock ext_mem_108251;
    
    ext_mem_108251.references = NULL;
    
    struct memblock mem_108228;
    
    mem_108228.references = NULL;
    
    struct memblock mem_108225;
    
    mem_108225.references = NULL;
    
    struct memblock mem_108223;
    
    mem_108223.references = NULL;
    
    struct memblock ext_mem_108265;
    
    ext_mem_108265.references = NULL;
    
    struct memblock ext_mem_108268;
    
    ext_mem_108268.references = NULL;
    
    struct memblock ext_mem_108271;
    
    ext_mem_108271.references = NULL;
    
    struct memblock mem_param_108095;
    
    mem_param_108095.references = NULL;
    
    struct memblock mem_param_108091;
    
    mem_param_108091.references = NULL;
    
    struct memblock mem_param_108088;
    
    mem_param_108088.references = NULL;
    
    struct memblock ext_mem_109053;
    
    ext_mem_109053.references = NULL;
    
    struct memblock ext_mem_109054;
    
    ext_mem_109054.references = NULL;
    
    struct memblock ext_mem_109055;
    
    ext_mem_109055.references = NULL;
    
    struct memblock mem_param_tmp_109433;
    
    mem_param_tmp_109433.references = NULL;
    
    struct memblock mem_param_tmp_109432;
    
    mem_param_tmp_109432.references = NULL;
    
    struct memblock mem_param_tmp_109431;
    
    mem_param_tmp_109431.references = NULL;
    
    struct memblock mem_param_tmp_109430;
    
    mem_param_tmp_109430.references = NULL;
    
    struct memblock mem_param_tmp_109429;
    
    mem_param_tmp_109429.references = NULL;
    
    struct memblock mem_108000;
    
    mem_108000.references = NULL;
    
    struct memblock ext_mem_108011;
    
    ext_mem_108011.references = NULL;
    
    struct memblock mem_107988;
    
    mem_107988.references = NULL;
    
    struct memblock mem_107985;
    
    mem_107985.references = NULL;
    
    struct memblock mem_107983;
    
    mem_107983.references = NULL;
    
    struct memblock ext_mem_108025;
    
    ext_mem_108025.references = NULL;
    
    struct memblock ext_mem_108028;
    
    ext_mem_108028.references = NULL;
    
    struct memblock ext_mem_108031;
    
    ext_mem_108031.references = NULL;
    
    struct memblock mem_107950;
    
    mem_107950.references = NULL;
    
    struct memblock ext_mem_107961;
    
    ext_mem_107961.references = NULL;
    
    struct memblock mem_107938;
    
    mem_107938.references = NULL;
    
    struct memblock mem_107935;
    
    mem_107935.references = NULL;
    
    struct memblock mem_107933;
    
    mem_107933.references = NULL;
    
    struct memblock ext_mem_107975;
    
    ext_mem_107975.references = NULL;
    
    struct memblock ext_mem_107978;
    
    ext_mem_107978.references = NULL;
    
    struct memblock ext_mem_107981;
    
    ext_mem_107981.references = NULL;
    
    struct memblock mem_107925;
    
    mem_107925.references = NULL;
    
    struct memblock mem_107917;
    
    mem_107917.references = NULL;
    
    struct memblock mem_param_107915;
    
    mem_param_107915.references = NULL;
    
    struct memblock mem_param_107912;
    
    mem_param_107912.references = NULL;
    
    struct memblock mem_param_107909;
    
    mem_param_107909.references = NULL;
    
    struct memblock mem_param_107906;
    
    mem_param_107906.references = NULL;
    
    struct memblock mem_param_107903;
    
    mem_param_107903.references = NULL;
    
    struct memblock ext_mem_108043;
    
    ext_mem_108043.references = NULL;
    
    struct memblock ext_mem_108044;
    
    ext_mem_108044.references = NULL;
    
    struct memblock ext_mem_108045;
    
    ext_mem_108045.references = NULL;
    
    struct memblock ext_mem_108046;
    
    ext_mem_108046.references = NULL;
    
    struct memblock ext_mem_108047;
    
    ext_mem_108047.references = NULL;
    
    struct memblock mem_107868;
    
    mem_107868.references = NULL;
    
    struct memblock ext_mem_107879;
    
    ext_mem_107879.references = NULL;
    
    struct memblock mem_107856;
    
    mem_107856.references = NULL;
    
    struct memblock mem_107853;
    
    mem_107853.references = NULL;
    
    struct memblock mem_107851;
    
    mem_107851.references = NULL;
    
    struct memblock ext_mem_107893;
    
    ext_mem_107893.references = NULL;
    
    struct memblock ext_mem_107896;
    
    ext_mem_107896.references = NULL;
    
    struct memblock ext_mem_107899;
    
    ext_mem_107899.references = NULL;
    
    struct memblock mem_107818;
    
    mem_107818.references = NULL;
    
    struct memblock ext_mem_107829;
    
    ext_mem_107829.references = NULL;
    
    struct memblock mem_107806;
    
    mem_107806.references = NULL;
    
    struct memblock mem_107803;
    
    mem_107803.references = NULL;
    
    struct memblock mem_107801;
    
    mem_107801.references = NULL;
    
    struct memblock ext_mem_107843;
    
    ext_mem_107843.references = NULL;
    
    struct memblock ext_mem_107846;
    
    ext_mem_107846.references = NULL;
    
    struct memblock ext_mem_107849;
    
    ext_mem_107849.references = NULL;
    
    struct memblock mem_108209;
    
    mem_108209.references = NULL;
    
    struct memblock mem_108207;
    
    mem_108207.references = NULL;
    
    struct memblock mem_108177;
    
    mem_108177.references = NULL;
    
    struct memblock mem_108174;
    
    mem_108174.references = NULL;
    
    struct memblock mem_108172;
    
    mem_108172.references = NULL;
    
    struct memblock mem_108069;
    
    mem_108069.references = NULL;
    
    struct memblock mem_107793;
    
    mem_107793.references = NULL;
    
    struct memblock mem_107785;
    
    mem_107785.references = NULL;
    
    struct memblock mem_107761;
    
    mem_107761.references = NULL;
    
    struct memblock mem_107750;
    
    mem_107750.references = NULL;
    
    struct memblock mem_107702;
    
    mem_107702.references = NULL;
    
    struct memblock mem_107626;
    
    mem_107626.references = NULL;
    
    struct memblock mem_107623;
    
    mem_107623.references = NULL;
    
    struct memblock mem_out_109343;
    
    mem_out_109343.references = NULL;
    
    int64_t prim_out_109344;
    int64_t zm_lhs_34592 = sub64(k_33387, (int64_t) 1);
    int64_t bytes_107606 = (int64_t) 8 * k_33387;
    
    if (mem_107607_cached_sizze_109769 < bytes_107606) {
        err = lexical_realloc(ctx, &mem_107607, &mem_107607_cached_sizze_109769, bytes_107606);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    
    int64_t discard_103778;
    int64_t defunc_0_reduce_res_103765;
    int64_t scanacc_103773;
    int64_t redout_103775;
    
    scanacc_103773 = (int64_t) 0;
    redout_103775 = (int64_t) 0;
    for (int64_t i_103776 = 0; i_103776 < k_33387; i_103776++) {
        int64_t lifted_lambda_res_66902 = sub64(zm_lhs_34592, i_103776);
        int64_t defunc_0_op_res_34604 = add64(lifted_lambda_res_66902, scanacc_103773);
        int64_t defunc_0_op_res_34599 = add64(lifted_lambda_res_66902, redout_103775);
        
        ((int64_t *) mem_107607)[i_103776] = defunc_0_op_res_34604;
        
        int64_t scanacc_tmp_109345 = defunc_0_op_res_34604;
        int64_t redout_tmp_109347 = defunc_0_op_res_34599;
        
        scanacc_103773 = scanacc_tmp_109345;
        redout_103775 = redout_tmp_109347;
    }
    discard_103778 = scanacc_103773;
    defunc_0_reduce_res_103765 = redout_103775;
    
    int64_t bytes_107614 = (int64_t) 8 * defunc_0_reduce_res_103765;
    int64_t bytes_107622 = (int64_t) 8 * m_33388;
    int64_t bytes_107625 = (int64_t) 40 * defunc_0_reduce_res_103765;
    int64_t bytes_107636 = m_33388 * bytes_107622;
    
    if (mem_107615_cached_sizze_109770 < bytes_107614) {
        err = lexical_realloc(ctx, &mem_107615, &mem_107615_cached_sizze_109770, bytes_107614);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    for (int64_t nest_i_109348 = 0; nest_i_109348 < defunc_0_reduce_res_103765; nest_i_109348++) {
        ((int64_t *) mem_107615)[nest_i_109348] = (int64_t) 0;
    }
    for (int64_t write_iter_103779 = 0; write_iter_103779 < k_33387; write_iter_103779++) {
        bool cond_66886 = write_iter_103779 == (int64_t) 0;
        int64_t lifted_lambda_res_66887;
        
        if (cond_66886) {
            lifted_lambda_res_66887 = (int64_t) 0;
        } else {
            int64_t tmp_66888 = sub64(write_iter_103779, (int64_t) 1);
            bool x_66889 = sle64((int64_t) 0, tmp_66888);
            bool y_66890 = slt64(tmp_66888, k_33387);
            bool bounds_check_66891 = x_66889 && y_66890;
            bool index_certs_66892;
            
            if (!bounds_check_66891) {
                set_error(ctx, msgprintf("Error: %s%lld%s%lld%s\n\nBacktrace:\n%s", "Index [", (long long) tmp_66888, "] out of bounds for array of shape [", (long long) k_33387, "].", "-> #0  unbalanced_gw.fut:13:45-52\n   #1  unbalanced_gw.fut:13:55-61\n   #2  unbalanced_gw.fut:151:3-16\n"));
                err = FUTHARK_PROGRAM_ERROR;
                goto cleanup;
            }
            
            int64_t lifted_lambda_res_f_res_66893 = ((int64_t *) mem_107607)[tmp_66888];
            
            lifted_lambda_res_66887 = lifted_lambda_res_f_res_66893;
        }
        if (sle64((int64_t) 0, lifted_lambda_res_66887) && slt64(lifted_lambda_res_66887, defunc_0_reduce_res_103765)) {
            ((int64_t *) mem_107615)[lifted_lambda_res_66887] = write_iter_103779;
        }
    }
    if (memblock_alloc(ctx, &mem_107623, bytes_107622, "mem_107623")) {
        err = 1;
        goto cleanup;
    }
    for (int64_t nest_i_109350 = 0; nest_i_109350 < m_33388; nest_i_109350++) {
        ((double *) mem_107623.mem)[nest_i_109350] = 1.0;
    }
    
    double zp_res_44841 = rho1_33389 + eps_33391;
    double zp_res_46827 = rho2_33390 + zp_res_44841;
    double zp_res_44882 = rho2_33390 + eps_33391;
    double neg_res_43882 = -eps_33391;
    double zs_res_44885 = neg_res_43882 / zp_res_44882;
    double neg_res_44881 = -rho2_33390;
    double zs_res_44883 = neg_res_44881 / zp_res_44882;
    double zs_res_44844 = neg_res_43882 / zp_res_44841;
    double neg_res_44840 = -rho1_33389;
    double zs_res_44842 = neg_res_44840 / zp_res_44841;
    double zp_res_43884 = 1.0 + tol_outerloop_33397;
    
    if (memblock_alloc(ctx, &mem_107626, bytes_107625, "mem_107626")) {
        err = 1;
        goto cleanup;
    }
    
    double zs_res_105098 = 1.0 / exp_absorb_cutoff_33394;
    double zp_res_105898 = 1.0 + tol_sinkhorn_33396;
    
    if (mem_107632_cached_sizze_109771 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_107632, &mem_107632_cached_sizze_109771, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_107634_cached_sizze_109772 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_107634, &mem_107634_cached_sizze_109772, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_107637_cached_sizze_109773 < bytes_107636) {
        err = lexical_realloc(ctx, &mem_107637, &mem_107637_cached_sizze_109773, bytes_107636);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_107667_cached_sizze_109774 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_107667, &mem_107667_cached_sizze_109774, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_107669_cached_sizze_109775 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_107669, &mem_107669_cached_sizze_109775, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_107671_cached_sizze_109776 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_107671, &mem_107671_cached_sizze_109776, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_107691_cached_sizze_109777 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_107691, &mem_107691_cached_sizze_109777, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_107700_cached_sizze_109778 < bytes_107636) {
        err = lexical_realloc(ctx, &mem_107700, &mem_107700_cached_sizze_109778, bytes_107636);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (memblock_alloc(ctx, &mem_107702, bytes_107622, "mem_107702")) {
        err = 1;
        goto cleanup;
    }
    if (mem_107711_cached_sizze_109779 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_107711, &mem_107711_cached_sizze_109779, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_107713_cached_sizze_109780 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_107713, &mem_107713_cached_sizze_109780, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_107727_cached_sizze_109781 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_107727, &mem_107727_cached_sizze_109781, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (memblock_alloc(ctx, &mem_107750, bytes_107622, "mem_107750")) {
        err = 1;
        goto cleanup;
    }
    if (mem_107758_cached_sizze_109782 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_107758, &mem_107758_cached_sizze_109782, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (memblock_alloc(ctx, &mem_107761, bytes_107636, "mem_107761")) {
        err = 1;
        goto cleanup;
    }
    if (memblock_alloc(ctx, &mem_107785, bytes_107622, "mem_107785")) {
        err = 1;
        goto cleanup;
    }
    if (memblock_alloc(ctx, &mem_107793, bytes_107622, "mem_107793")) {
        err = 1;
        goto cleanup;
    }
    if (mem_108050_cached_sizze_109783 < bytes_107636) {
        err = lexical_realloc(ctx, &mem_108050, &mem_108050_cached_sizze_109783, bytes_107636);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (memblock_alloc(ctx, &mem_108069, bytes_107636, "mem_108069")) {
        err = 1;
        goto cleanup;
    }
    if (mem_108097_cached_sizze_109784 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_108097, &mem_108097_cached_sizze_109784, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_108105_cached_sizze_109785 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_108105, &mem_108105_cached_sizze_109785, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_108107_cached_sizze_109786 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_108107, &mem_108107_cached_sizze_109786, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_108121_cached_sizze_109787 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_108121, &mem_108121_cached_sizze_109787, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_108130_cached_sizze_109788 < bytes_107636) {
        err = lexical_realloc(ctx, &mem_108130, &mem_108130_cached_sizze_109788, bytes_107636);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_108132_cached_sizze_109789 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_108132, &mem_108132_cached_sizze_109789, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_108141_cached_sizze_109790 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_108141, &mem_108141_cached_sizze_109790, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_108149_cached_sizze_109791 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_108149, &mem_108149_cached_sizze_109791, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (memblock_alloc(ctx, &mem_108172, bytes_107622, "mem_108172")) {
        err = 1;
        goto cleanup;
    }
    if (memblock_alloc(ctx, &mem_108174, bytes_107622, "mem_108174")) {
        err = 1;
        goto cleanup;
    }
    if (memblock_alloc(ctx, &mem_108177, bytes_107636, "mem_108177")) {
        err = 1;
        goto cleanup;
    }
    if (memblock_alloc(ctx, &mem_108207, bytes_107622, "mem_108207")) {
        err = 1;
        goto cleanup;
    }
    if (memblock_alloc(ctx, &mem_108209, bytes_107622, "mem_108209")) {
        err = 1;
        goto cleanup;
    }
    if (mem_108780_cached_sizze_109792 < bytes_107636) {
        err = lexical_realloc(ctx, &mem_108780, &mem_108780_cached_sizze_109792, bytes_107636);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_109057_cached_sizze_109809 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_109057, &mem_109057_cached_sizze_109809, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_109059_cached_sizze_109810 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_109059, &mem_109059_cached_sizze_109810, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_109061_cached_sizze_109811 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_109061, &mem_109061_cached_sizze_109811, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_109072_cached_sizze_109812 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_109072, &mem_109072_cached_sizze_109812, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_109089_cached_sizze_109813 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_109089, &mem_109089_cached_sizze_109813, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_109091_cached_sizze_109814 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_109091, &mem_109091_cached_sizze_109814, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_109093_cached_sizze_109815 < bytes_107622) {
        err = lexical_realloc(ctx, &mem_109093, &mem_109093_cached_sizze_109815, bytes_107622);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    if (mem_109112_cached_sizze_109816 < (int64_t) 40) {
        err = lexical_realloc(ctx, &mem_109112, &mem_109112_cached_sizze_109816, (int64_t) 40);
        if (err != FUTHARK_SUCCESS)
            goto cleanup;
    }
    
    int64_t inpacc_103768;
    int64_t inpacc_103770;
    int64_t inpacc_63637;
    int64_t inpacc_63639;
    
    inpacc_63637 = (int64_t) 0;
    inpacc_63639 = (int64_t) 0;
    for (int64_t i_104577 = 0; i_104577 < defunc_0_reduce_res_103765; i_104577++) {
        int64_t eta_p_104585 = ((int64_t *) mem_107615)[i_104577];
        bool lifted_lambda_res_104587 = slt64((int64_t) 0, eta_p_104585);
        int64_t defunc_0_op_res_104621 = add64(inpacc_63637, eta_p_104585);
        int64_t tmp_104620;
        
        if (lifted_lambda_res_104587) {
            tmp_104620 = eta_p_104585;
        } else {
            tmp_104620 = defunc_0_op_res_104621;
        }
        
        int64_t defunc_0_op_res_104623 = add64((int64_t) 1, inpacc_63639);
        int64_t tmp_104622;
        
        if (lifted_lambda_res_104587) {
            tmp_104622 = (int64_t) 1;
        } else {
            tmp_104622 = defunc_0_op_res_104623;
        }
        
        int64_t lifted_lambda_res_104624 = sub64(tmp_104622, (int64_t) 1);
        int64_t zp_lhs_104625 = add64(tmp_104620, lifted_lambda_res_104624);
        int64_t lifted_lambda_res_104626 = add64((int64_t) 1, zp_lhs_104625);
        bool x_104627 = sle64((int64_t) 0, lifted_lambda_res_104626);
        bool y_104628 = slt64(lifted_lambda_res_104626, k_33387);
        bool bounds_check_104629 = x_104627 && y_104628;
        bool index_certs_104630;
        
        if (!bounds_check_104629) {
            set_error(ctx, msgprintf("Error: %s%lld%s%lld%s\n\nBacktrace:\n%s", "Index [", (long long) lifted_lambda_res_104626, "] out of bounds for array of shape [", (long long) k_33387, "].", "-> #0  unbalanced_gw.fut:155:43-52\n   #1  /prelude/functional.fut:9:44-45\n   #2  unbalanced_gw.fut:152:6-156:84\n"));
            err = FUTHARK_PROGRAM_ERROR;
            goto cleanup;
        }
        
        bool x_104633 = sle64((int64_t) 0, tmp_104620);
        bool y_104634 = slt64(tmp_104620, k_33387);
        bool bounds_check_104635 = x_104633 && y_104634;
        bool index_certs_104636;
        
        if (!bounds_check_104635) {
            set_error(ctx, msgprintf("Error: %s%lld%s%lld%s\n\nBacktrace:\n%s", "Index [", (long long) tmp_104620, "] out of bounds for array of shape [", (long long) k_33387, "].", "-> #0  unbalanced_gw.fut:155:28-37\n   #1  /prelude/functional.fut:9:44-45\n   #2  unbalanced_gw.fut:152:6-156:84\n"));
            err = FUTHARK_PROGRAM_ERROR;
            goto cleanup;
        }
        
        double defunc_res_104642;
        double defunc_res_104643;
        double defunc_res_104644;
        double defunc_res_104645;
        double defunc_res_104646;
        double defunc_res_104647;
        double defunc_res_104648;
        double defunc_res_104649;
        double defunc_res_104650;
        double redout_104655;
        double redout_104656;
        double redout_104657;
        double redout_104658;
        double redout_104659;
        double redout_104660;
        double redout_104661;
        double redout_104662;
        double redout_104663;
        
        redout_104655 = 0.0;
        redout_104656 = 0.0;
        redout_104657 = 0.0;
        redout_104658 = 0.0;
        redout_104659 = 0.0;
        redout_104660 = 0.0;
        redout_104661 = 0.0;
        redout_104662 = 0.0;
        redout_104663 = 0.0;
        for (int64_t i_104654 = 0; i_104654 < m_33388; i_104654++) {
            double x_104667 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_104654];
            double defunc_res_104669;
            double defunc_res_104670;
            double defunc_res_104671;
            double defunc_res_104672;
            double defunc_res_104673;
            double defunc_res_104674;
            double defunc_res_104675;
            double defunc_res_104676;
            double redout_104679;
            double redout_104680;
            double redout_104681;
            double redout_104682;
            double redout_104683;
            double redout_104684;
            double redout_104685;
            double redout_104686;
            
            redout_104679 = 0.0;
            redout_104680 = 0.0;
            redout_104681 = 0.0;
            redout_104682 = 0.0;
            redout_104683 = 0.0;
            redout_104684 = 0.0;
            redout_104685 = 0.0;
            redout_104686 = 0.0;
            for (int64_t i_104678 = 0; i_104678 < m_33388; i_104678++) {
                double eta_p_104688 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_104678];
                double zt_res_104689 = x_104667 * eta_p_104688;
                bool zeze_res_104690 = zt_res_104689 == 0.0;
                double klu_res_104691;
                
                if (zeze_res_104690) {
                    klu_res_104691 = 0.0;
                } else {
                    double zs_res_104692 = zt_res_104689 / zt_res_104689;
                    double log_res_104693 = futrts_log64(zs_res_104692);
                    double zt_res_104694 = zt_res_104689 * log_res_104693;
                    
                    klu_res_104691 = zt_res_104694;
                }
                
                double klu_res_104695;
                
                if (zeze_res_104690) {
                    klu_res_104695 = 0.0;
                } else {
                    double zs_res_104696 = zt_res_104689 / zt_res_104689;
                    double log_res_104697 = futrts_log64(zs_res_104696);
                    double zt_res_104698 = zt_res_104689 * log_res_104697;
                    
                    klu_res_104695 = zt_res_104698;
                }
                
                double zp_res_104715 = redout_104679 + klu_res_104691;
                double zp_res_104716 = redout_104680 + klu_res_104695;
                double zp_res_104717 = redout_104681 + zt_res_104689;
                double zp_res_104718 = redout_104682 + zt_res_104689;
                double zp_res_104719 = redout_104683 + zt_res_104689;
                double zp_res_104720 = redout_104684 + zt_res_104689;
                double zp_res_104721 = redout_104685 + zt_res_104689;
                double zp_res_104722 = redout_104686 + zt_res_104689;
                
                ((double *) mem_107637)[i_104654 * m_33388 + i_104678] = zt_res_104689;
                
                double redout_tmp_109366 = zp_res_104715;
                double redout_tmp_109367 = zp_res_104716;
                double redout_tmp_109368 = zp_res_104717;
                double redout_tmp_109369 = zp_res_104718;
                double redout_tmp_109370 = zp_res_104719;
                double redout_tmp_109371 = zp_res_104720;
                double redout_tmp_109372 = zp_res_104721;
                double redout_tmp_109373 = zp_res_104722;
                
                redout_104679 = redout_tmp_109366;
                redout_104680 = redout_tmp_109367;
                redout_104681 = redout_tmp_109368;
                redout_104682 = redout_tmp_109369;
                redout_104683 = redout_tmp_109370;
                redout_104684 = redout_tmp_109371;
                redout_104685 = redout_tmp_109372;
                redout_104686 = redout_tmp_109373;
            }
            defunc_res_104669 = redout_104679;
            defunc_res_104670 = redout_104680;
            defunc_res_104671 = redout_104681;
            defunc_res_104672 = redout_104682;
            defunc_res_104673 = redout_104683;
            defunc_res_104674 = redout_104684;
            defunc_res_104675 = redout_104685;
            defunc_res_104676 = redout_104686;
            
            bool zeze_res_104724 = defunc_res_104675 == 0.0;
            double klu_res_104725;
            
            if (zeze_res_104724) {
                klu_res_104725 = 0.0;
            } else {
                double zs_res_104726 = defunc_res_104675 / x_104667;
                double log_res_104727 = futrts_log64(zs_res_104726);
                double zt_res_104728 = defunc_res_104675 * log_res_104727;
                
                klu_res_104725 = zt_res_104728;
            }
            
            bool zeze_res_104729 = defunc_res_104673 == 0.0;
            double klu_res_104730;
            
            if (zeze_res_104729) {
                klu_res_104730 = 0.0;
            } else {
                double zs_res_104731 = defunc_res_104673 / x_104667;
                double log_res_104732 = futrts_log64(zs_res_104731);
                double zt_res_104733 = defunc_res_104673 * log_res_104732;
                
                klu_res_104730 = zt_res_104733;
            }
            
            double zp_res_104752 = redout_104655 + defunc_res_104676;
            double zp_res_104753 = redout_104656 + klu_res_104725;
            double zp_res_104754 = redout_104657 + defunc_res_104669;
            double zp_res_104755 = redout_104658 + defunc_res_104674;
            double zp_res_104756 = redout_104659 + klu_res_104730;
            double zp_res_104757 = redout_104660 + defunc_res_104673;
            double zp_res_104758 = redout_104661 + defunc_res_104670;
            double zp_res_104759 = redout_104662 + x_104667;
            double zp_res_104760 = redout_104663 + x_104667;
            
            ((double *) mem_107632)[i_104654] = defunc_res_104671;
            ((double *) mem_107634)[i_104654] = defunc_res_104672;
            
            double redout_tmp_109354 = zp_res_104752;
            double redout_tmp_109355 = zp_res_104753;
            double redout_tmp_109356 = zp_res_104754;
            double redout_tmp_109357 = zp_res_104755;
            double redout_tmp_109358 = zp_res_104756;
            double redout_tmp_109359 = zp_res_104757;
            double redout_tmp_109360 = zp_res_104758;
            double redout_tmp_109361 = zp_res_104759;
            double redout_tmp_109362 = zp_res_104760;
            
            redout_104655 = redout_tmp_109354;
            redout_104656 = redout_tmp_109355;
            redout_104657 = redout_tmp_109356;
            redout_104658 = redout_tmp_109357;
            redout_104659 = redout_tmp_109358;
            redout_104660 = redout_tmp_109359;
            redout_104661 = redout_tmp_109360;
            redout_104662 = redout_tmp_109361;
            redout_104663 = redout_tmp_109362;
        }
        defunc_res_104642 = redout_104655;
        defunc_res_104643 = redout_104656;
        defunc_res_104644 = redout_104657;
        defunc_res_104645 = redout_104658;
        defunc_res_104646 = redout_104659;
        defunc_res_104647 = redout_104660;
        defunc_res_104648 = redout_104661;
        defunc_res_104649 = redout_104662;
        defunc_res_104650 = redout_104663;
        
        double zt_res_104765 = eps_33391 * defunc_res_104642;
        double defunc_res_104769;
        double defunc_res_104770;
        double defunc_res_104771;
        double defunc_res_104772;
        double redout_104777;
        double redout_104778;
        double redout_104779;
        double redout_104780;
        
        redout_104777 = 0.0;
        redout_104778 = 0.0;
        redout_104779 = 0.0;
        redout_104780 = 0.0;
        for (int64_t i_104776 = 0; i_104776 < m_33388; i_104776++) {
            double x_104784 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_104776];
            double log_res_104786 = futrts_log64(x_104784);
            double zt_res_104787 = zt_res_104765 * log_res_104786;
            double defunc_res_104788;
            double defunc_res_104789;
            double defunc_res_104790;
            double defunc_res_104791;
            double redout_104793;
            double redout_104794;
            double redout_104795;
            double redout_104796;
            
            redout_104793 = 0.0;
            redout_104794 = 0.0;
            redout_104795 = 0.0;
            redout_104796 = 0.0;
            for (int64_t i_104792 = 0; i_104792 < m_33388; i_104792++) {
                double x_104797 = ((double *) mem_107637)[i_104792 * m_33388 + i_104776];
                double zp_res_104806 = redout_104793 + x_104797;
                double zp_res_104807 = redout_104794 + x_104797;
                double zp_res_104808 = redout_104795 + x_104797;
                double zp_res_104809 = redout_104796 + x_104797;
                double redout_tmp_109382 = zp_res_104806;
                double redout_tmp_109383 = zp_res_104807;
                double redout_tmp_109384 = zp_res_104808;
                double redout_tmp_109385 = zp_res_104809;
                
                redout_104793 = redout_tmp_109382;
                redout_104794 = redout_tmp_109383;
                redout_104795 = redout_tmp_109384;
                redout_104796 = redout_tmp_109385;
            }
            defunc_res_104788 = redout_104793;
            defunc_res_104789 = redout_104794;
            defunc_res_104790 = redout_104795;
            defunc_res_104791 = redout_104796;
            
            bool zeze_res_104810 = defunc_res_104788 == 0.0;
            double klu_res_104811;
            
            if (zeze_res_104810) {
                klu_res_104811 = 0.0;
            } else {
                double zs_res_104812 = defunc_res_104788 / x_104784;
                double log_res_104813 = futrts_log64(zs_res_104812);
                double zt_res_104814 = defunc_res_104788 * log_res_104813;
                
                klu_res_104811 = zt_res_104814;
            }
            
            bool zeze_res_104815 = defunc_res_104789 == 0.0;
            double klu_res_104816;
            
            if (zeze_res_104815) {
                klu_res_104816 = 0.0;
            } else {
                double zs_res_104817 = defunc_res_104789 / x_104784;
                double log_res_104818 = futrts_log64(zs_res_104817);
                double zt_res_104819 = defunc_res_104789 * log_res_104818;
                
                klu_res_104816 = zt_res_104819;
            }
            
            double zp_res_104828 = redout_104777 + klu_res_104811;
            double zp_res_104829 = redout_104778 + klu_res_104816;
            double zp_res_104830 = redout_104779 + x_104784;
            double zp_res_104831 = redout_104780 + x_104784;
            
            ((double *) mem_107667)[i_104776] = defunc_res_104791;
            ((double *) mem_107669)[i_104776] = defunc_res_104790;
            ((double *) mem_107671)[i_104776] = zt_res_104787;
            
            double redout_tmp_109375 = zp_res_104828;
            double redout_tmp_109376 = zp_res_104829;
            double redout_tmp_109377 = zp_res_104830;
            double redout_tmp_109378 = zp_res_104831;
            
            redout_104777 = redout_tmp_109375;
            redout_104778 = redout_tmp_109376;
            redout_104779 = redout_tmp_109377;
            redout_104780 = redout_tmp_109378;
        }
        defunc_res_104769 = redout_104777;
        defunc_res_104770 = redout_104778;
        defunc_res_104771 = redout_104779;
        defunc_res_104772 = redout_104780;
        
        double zt_res_104835 = rho2_33390 * defunc_res_104769;
        double zt_res_104836 = rho1_33389 * defunc_res_104643;
        double zp_res_104837 = zt_res_104835 + zt_res_104836;
        double zt_res_104838 = eps_33391 * defunc_res_104644;
        double zp_res_104839 = zp_res_104837 + zt_res_104838;
        double defunc_0_reduce_res_104842;
        double redout_104845 = 0.0;
        
        for (int64_t i_104844 = 0; i_104844 < m_33388; i_104844++) {
            double eta_p_104848 = ((double *) mem_107667)[i_104844];
            double defunc_0_reduce_res_104849;
            double defunc_0_reduce_res_104850;
            double redout_104852;
            double redout_104853;
            
            redout_104852 = 0.0;
            redout_104853 = 0.0;
            for (int64_t i_104851 = 0; i_104851 < m_33388; i_104851++) {
                double eta_p_104854 = ((double *) A_mem_107604.mem)[lifted_lambda_res_104626 * (m_33388 * m_33388) + i_104844 * m_33388 + i_104851];
                double eta_p_104855 = ((double *) mem_107667)[i_104851];
                double eta_p_104856 = ((double *) mem_107669)[i_104851];
                double zt_res_104857 = eta_p_104854 * eta_p_104854;
                double zt_res_104858 = eta_p_104856 * zt_res_104857;
                double zt_res_104859 = eta_p_104855 * zt_res_104857;
                double zp_res_104864 = redout_104852 + zt_res_104858;
                double zp_res_104865 = redout_104853 + zt_res_104859;
                double redout_tmp_109388 = zp_res_104864;
                double redout_tmp_109389 = zp_res_104865;
                
                redout_104852 = redout_tmp_109388;
                redout_104853 = redout_tmp_109389;
            }
            defunc_0_reduce_res_104849 = redout_104852;
            defunc_0_reduce_res_104850 = redout_104853;
            
            double zt_res_104866 = eta_p_104848 * defunc_0_reduce_res_104850;
            double zp_res_104869 = redout_104845 + zt_res_104866;
            
            ((double *) mem_107691)[i_104844] = defunc_0_reduce_res_104849;
            
            double redout_tmp_109386 = zp_res_104869;
            
            redout_104845 = redout_tmp_109386;
        }
        defunc_0_reduce_res_104842 = redout_104845;
        
        double defunc_0_reduce_res_104875;
        double defunc_res_104876;
        double redout_104880;
        double redout_104881;
        
        redout_104880 = 0.0;
        redout_104881 = 0.0;
        for (int64_t i_104879 = 0; i_104879 < m_33388; i_104879++) {
            double eta_p_104886 = ((double *) mem_107634)[i_104879];
            double eta_p_104887 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_104879];
            double log_res_104890 = futrts_log64(eta_p_104887);
            double zt_res_104891 = zt_res_104765 * log_res_104890;
            double defunc_0_reduce_res_104892;
            double defunc_0_reduce_res_104893;
            double redout_104895;
            double redout_104896;
            
            redout_104895 = 0.0;
            redout_104896 = 0.0;
            for (int64_t i_104894 = 0; i_104894 < m_33388; i_104894++) {
                double eta_p_104897 = ((double *) A_mem_107604.mem)[tmp_104620 * (m_33388 * m_33388) + i_104879 * m_33388 + i_104894];
                double eta_p_104898 = ((double *) mem_107634)[i_104894];
                double eta_p_104899 = ((double *) mem_107632)[i_104894];
                double zt_res_104900 = eta_p_104897 * eta_p_104897;
                double zt_res_104901 = eta_p_104899 * zt_res_104900;
                double zt_res_104902 = eta_p_104898 * zt_res_104900;
                double zp_res_104907 = redout_104895 + zt_res_104901;
                double zp_res_104908 = redout_104896 + zt_res_104902;
                double redout_tmp_109394 = zp_res_104907;
                double redout_tmp_109395 = zp_res_104908;
                
                redout_104895 = redout_tmp_109394;
                redout_104896 = redout_tmp_109395;
            }
            defunc_0_reduce_res_104892 = redout_104895;
            defunc_0_reduce_res_104893 = redout_104896;
            for (int64_t i_104913 = 0; i_104913 < m_33388; i_104913++) {
                double defunc_0_reduce_res_104917;
                double defunc_0_reduce_res_104918;
                double redout_104920;
                double redout_104921;
                
                redout_104920 = 0.0;
                redout_104921 = 0.0;
                for (int64_t i_104919 = 0; i_104919 < m_33388; i_104919++) {
                    double eta_p_104922 = ((double *) A_mem_107604.mem)[tmp_104620 * (m_33388 * m_33388) + i_104879 * m_33388 + i_104919];
                    double eta_p_104923 = ((double *) mem_107637)[i_104919 * m_33388 + i_104913];
                    double zt_res_104924 = eta_p_104922 * eta_p_104923;
                    double zp_res_104929 = redout_104920 + zt_res_104924;
                    double zp_res_104930 = redout_104921 + zt_res_104924;
                    double redout_tmp_109398 = zp_res_104929;
                    double redout_tmp_109399 = zp_res_104930;
                    
                    redout_104920 = redout_tmp_109398;
                    redout_104921 = redout_tmp_109399;
                }
                defunc_0_reduce_res_104917 = redout_104920;
                defunc_0_reduce_res_104918 = redout_104921;
                ((double *) mem_107711)[i_104913] = defunc_0_reduce_res_104918;
                ((double *) mem_107713)[i_104913] = defunc_0_reduce_res_104917;
            }
            
            double defunc_0_reduce_res_104934;
            double defunc_0_reduce_res_104935;
            double redout_104938;
            double redout_104939;
            
            redout_104938 = INFINITY;
            redout_104939 = 0.0;
            for (int64_t i_104937 = 0; i_104937 < m_33388; i_104937++) {
                double eta_p_104942 = ((double *) mem_107637)[i_104879 * m_33388 + i_104937];
                double eta_p_wasfree_104943 = ((double *) mem_107691)[i_104937];
                double eta_p_wasfree_104944 = ((double *) mem_107671)[i_104937];
                double defunc_0_reduce_res_104945;
                double defunc_0_reduce_res_104946;
                double redout_104948;
                double redout_104949;
                
                redout_104948 = 0.0;
                redout_104949 = 0.0;
                for (int64_t i_104947 = 0; i_104947 < m_33388; i_104947++) {
                    double eta_p_104950 = ((double *) mem_107711)[i_104947];
                    double eta_p_104951 = ((double *) A_mem_107604.mem)[lifted_lambda_res_104626 * (m_33388 * m_33388) + i_104947 * m_33388 + i_104937];
                    double eta_p_104952 = ((double *) mem_107713)[i_104947];
                    double zt_res_104953 = eta_p_104951 * eta_p_104952;
                    double zt_res_104954 = eta_p_104950 * eta_p_104951;
                    double zp_res_104959 = redout_104948 + zt_res_104953;
                    double zp_res_104960 = redout_104949 + zt_res_104954;
                    double redout_tmp_109403 = zp_res_104959;
                    double redout_tmp_109404 = zp_res_104960;
                    
                    redout_104948 = redout_tmp_109403;
                    redout_104949 = redout_tmp_109404;
                }
                defunc_0_reduce_res_104945 = redout_104948;
                defunc_0_reduce_res_104946 = redout_104949;
                
                double zt_res_104961 = -2.0 * defunc_0_reduce_res_104945;
                double zp_res_104962 = defunc_0_reduce_res_104892 + zt_res_104961;
                double zp_res_104963 = eta_p_wasfree_104943 + zp_res_104962;
                double zp_res_104964 = zp_res_104839 + zp_res_104963;
                double zm_res_104965 = zp_res_104964 - zt_res_104891;
                double zm_res_104966 = zm_res_104965 - eta_p_wasfree_104944;
                double zs_res_104967 = zm_res_104966 / defunc_res_104645;
                double zs_res_104968 = zs_res_104967 / neg_res_43882;
                double zm_res_104969 = safe_for_exp_33395 - zs_res_104968;
                double zt_res_104970 = eta_p_104942 * defunc_0_reduce_res_104946;
                double min_res_104975 = fmin64(redout_104938, zm_res_104969);
                double zp_res_104976 = redout_104939 + zt_res_104970;
                
                ((double *) mem_107727)[i_104937] = zs_res_104968;
                
                double redout_tmp_109400 = min_res_104975;
                double redout_tmp_109401 = zp_res_104976;
                
                redout_104938 = redout_tmp_109400;
                redout_104939 = redout_tmp_109401;
            }
            defunc_0_reduce_res_104934 = redout_104938;
            defunc_0_reduce_res_104935 = redout_104939;
            for (int64_t i_104980 = 0; i_104980 < m_33388; i_104980++) {
                double eta_p_104982 = ((double *) mem_107727)[i_104980];
                double zp_res_104983 = defunc_0_reduce_res_104934 + eta_p_104982;
                
                ((double *) mem_107700)[i_104879 * m_33388 + i_104980] = zp_res_104983;
            }
            
            double zt_res_104985 = eta_p_104886 * defunc_0_reduce_res_104893;
            double zp_res_104990 = redout_104880 + zt_res_104985;
            double zp_res_104991 = redout_104881 + defunc_0_reduce_res_104935;
            
            ((double *) mem_107702.mem)[i_104879] = defunc_0_reduce_res_104934;
            
            double redout_tmp_109390 = zp_res_104990;
            double redout_tmp_109391 = zp_res_104991;
            
            redout_104880 = redout_tmp_109390;
            redout_104881 = redout_tmp_109391;
        }
        defunc_0_reduce_res_104875 = redout_104880;
        defunc_res_104876 = redout_104881;
        for (int64_t i_104997 = 0; i_104997 < m_33388; i_104997++) {
            double defunc_0_reduce_res_105000;
            double redout_105002 = INFINITY;
            
            for (int64_t i_105001 = 0; i_105001 < m_33388; i_105001++) {
                double eta_p_105003 = ((double *) mem_107700)[i_105001 * m_33388 + i_104997];
                double zm_res_105004 = safe_for_exp_33395 - eta_p_105003;
                double min_res_105007 = fmin64(redout_105002, zm_res_105004);
                double redout_tmp_109407 = min_res_105007;
                
                redout_105002 = redout_tmp_109407;
            }
            defunc_0_reduce_res_105000 = redout_105002;
            ((double *) mem_107750.mem)[i_104997] = defunc_0_reduce_res_105000;
        }
        for (int64_t i_105013 = 0; i_105013 < m_33388; i_105013++) {
            double eta_p_105016 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_105013];
            double eta_p_105017 = ((double *) mem_107702.mem)[i_105013];
            double defunc_0_reduce_res_105020;
            double redout_105023 = 0.0;
            
            for (int64_t i_105022 = 0; i_105022 < m_33388; i_105022++) {
                double eta_p_105025 = ((double *) mem_107700)[i_105013 * m_33388 + i_105022];
                double eta_p_wasfree_105026 = ((double *) mem_107750.mem)[i_105022];
                double zp_res_105027 = eta_p_105025 + eta_p_wasfree_105026;
                double exp_res_105028 = futrts_exp64(zp_res_105027);
                double zp_res_105031 = redout_105023 + exp_res_105028;
                
                ((double *) mem_107761.mem)[i_105013 * m_33388 + i_105022] = exp_res_105028;
                
                double redout_tmp_109410 = zp_res_105031;
                
                redout_105023 = redout_tmp_109410;
            }
            defunc_0_reduce_res_105020 = redout_105023;
            
            double zs_res_105033 = defunc_0_reduce_res_105020 / eta_p_105016;
            double ztzt_res_105034 = fpow64(zs_res_105033, zs_res_44842);
            double zt_res_105035 = zs_res_44844 * eta_p_105017;
            double exp_res_105036 = futrts_exp64(zt_res_105035);
            double zt_res_105037 = ztzt_res_105034 * exp_res_105036;
            
            ((double *) mem_107758)[i_105013] = zt_res_105037;
        }
        
        bool defunc_0_reduce_res_105042;
        bool redout_105045 = 0;
        
        for (int64_t i_105044 = 0; i_105044 < m_33388; i_105044++) {
            double eta_p_105048 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_105044];
            double eta_p_105049 = ((double *) mem_107750.mem)[i_105044];
            double defunc_0_reduce_res_105050;
            double redout_105052 = 0.0;
            
            for (int64_t i_105051 = 0; i_105051 < m_33388; i_105051++) {
                double eta_p_105053 = ((double *) mem_107758)[i_105051];
                double eta_p_105054 = ((double *) mem_107761.mem)[i_105051 * m_33388 + i_105044];
                double zt_res_105055 = eta_p_105053 * eta_p_105054;
                double zp_res_105058 = redout_105052 + zt_res_105055;
                double redout_tmp_109414 = zp_res_105058;
                
                redout_105052 = redout_tmp_109414;
            }
            defunc_0_reduce_res_105050 = redout_105052;
            
            double zs_res_105059 = defunc_0_reduce_res_105050 / eta_p_105048;
            double ztzt_res_105060 = fpow64(zs_res_105059, zs_res_44883);
            double zt_res_105061 = zs_res_44885 * eta_p_105049;
            double exp_res_105062 = futrts_exp64(zt_res_105061);
            double zt_res_105063 = ztzt_res_105060 * exp_res_105062;
            bool zgze_res_105064 = exp_absorb_cutoff_33394 <= zt_res_105063;
            bool defunc_0_op_res_105067 = redout_105045 || zgze_res_105064;
            
            ((double *) mem_107785.mem)[i_105044] = zt_res_105063;
            
            bool redout_tmp_109412 = defunc_0_op_res_105067;
            
            redout_105045 = redout_tmp_109412;
        }
        defunc_0_reduce_res_105042 = redout_105045;
        
        bool defunc_0_reduce_res_105070;
        bool redout_105073 = 0;
        
        for (int64_t i_105072 = 0; i_105072 < m_33388; i_105072++) {
            double eta_p_105076 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_105072];
            double eta_p_105077 = ((double *) mem_107702.mem)[i_105072];
            double defunc_0_reduce_res_105078;
            double redout_105080 = 0.0;
            
            for (int64_t i_105079 = 0; i_105079 < m_33388; i_105079++) {
                double eta_p_105081 = ((double *) mem_107785.mem)[i_105079];
                double eta_p_105082 = ((double *) mem_107761.mem)[i_105072 * m_33388 + i_105079];
                double zt_res_105083 = eta_p_105081 * eta_p_105082;
                double zp_res_105086 = redout_105080 + zt_res_105083;
                double redout_tmp_109417 = zp_res_105086;
                
                redout_105080 = redout_tmp_109417;
            }
            defunc_0_reduce_res_105078 = redout_105080;
            
            double zs_res_105087 = defunc_0_reduce_res_105078 / eta_p_105076;
            double ztzt_res_105088 = fpow64(zs_res_105087, zs_res_44842);
            double zt_res_105089 = zs_res_44844 * eta_p_105077;
            double exp_res_105090 = futrts_exp64(zt_res_105089);
            double zt_res_105091 = ztzt_res_105088 * exp_res_105090;
            bool zgze_res_105092 = exp_absorb_cutoff_33394 <= zt_res_105091;
            bool defunc_0_op_res_105095 = redout_105073 || zgze_res_105092;
            
            ((double *) mem_107793.mem)[i_105072] = zt_res_105091;
            
            bool redout_tmp_109415 = defunc_0_op_res_105095;
            
            redout_105073 = redout_tmp_109415;
        }
        defunc_0_reduce_res_105070 = redout_105073;
        
        bool x_109232 = !defunc_0_reduce_res_105070;
        bool defunc_0_reduce_res_105099;
        
        if (x_109232) {
            bool x_109234;
            bool redout_105101 = 0;
            
            for (int64_t i_105100 = 0; i_105100 < m_33388; i_105100++) {
                double eta_p_105102 = ((double *) mem_107793.mem)[i_105100];
                bool zlze_res_105103 = eta_p_105102 <= zs_res_105098;
                bool defunc_0_op_res_105106 = redout_105101 || zlze_res_105103;
                bool redout_tmp_109418 = defunc_0_op_res_105106;
                
                redout_105101 = redout_tmp_109418;
            }
            x_109234 = redout_105101;
            defunc_0_reduce_res_105099 = x_109234;
        } else {
            defunc_0_reduce_res_105099 = 0;
        }
        
        bool cond_105097 = defunc_0_reduce_res_105070 || defunc_0_reduce_res_105099;
        
        if (cond_105097) {
            if (memblock_alloc(ctx, &mem_107801, bytes_107622, "mem_107801")) {
                err = 1;
                goto cleanup;
            }
            if (memblock_alloc(ctx, &mem_107803, bytes_107622, "mem_107803")) {
                err = 1;
                goto cleanup;
            }
            if (memblock_alloc(ctx, &mem_107806, bytes_107636, "mem_107806")) {
                err = 1;
                goto cleanup;
            }
            for (int64_t i_105117 = 0; i_105117 < m_33388; i_105117++) {
                double eta_p_105121 = ((double *) mem_107793.mem)[i_105117];
                double eta_p_105122 = ((double *) mem_107702.mem)[i_105117];
                bool zgze_res_105124 = exp_absorb_cutoff_33394 <= eta_p_105121;
                bool zl_res_105125 = eta_p_105121 < zs_res_105098;
                bool x_105126 = !zgze_res_105124;
                bool y_105127 = zl_res_105125 && x_105126;
                bool cond_105128 = zgze_res_105124 || y_105127;
                int64_t binop_y_107825 = m_33388 * i_105117;
                int64_t ext_107828;
                
                if (cond_105128) {
                    ext_107828 = (int64_t) 0;
                } else {
                    ext_107828 = binop_y_107825;
                }
                
                double rescale_res_105129;
                double rescale_res_105130;
                
                if (cond_105128) {
                    double log_res_105132 = futrts_log64(eta_p_105121);
                    double sqrt_res_105133 = futrts_sqrt64(eta_p_105121);
                    double zs_res_105134 = log_res_105132 / 2.0;
                    double zp_res_105135 = eta_p_105122 + zs_res_105134;
                    
                    if (memblock_alloc(ctx, &mem_107818, bytes_107622, "mem_107818")) {
                        err = 1;
                        goto cleanup;
                    }
                    for (int64_t i_105138 = 0; i_105138 < m_33388; i_105138++) {
                        double eta_p_105140 = ((double *) mem_107761.mem)[i_105117 * m_33388 + i_105138];
                        double zt_res_105141 = sqrt_res_105133 * eta_p_105140;
                        
                        ((double *) mem_107818.mem)[i_105138] = zt_res_105141;
                    }
                    if (memblock_set(ctx, &ext_mem_107829, &mem_107818, "mem_107818") != 0)
                        return 1;
                    rescale_res_105129 = sqrt_res_105133;
                    rescale_res_105130 = zp_res_105135;
                } else {
                    if (memblock_set(ctx, &ext_mem_107829, &mem_107761, "mem_107761") != 0)
                        return 1;
                    rescale_res_105129 = eta_p_105121;
                    rescale_res_105130 = eta_p_105122;
                }
                ((double *) mem_107801.mem)[i_105117] = rescale_res_105129;
                ((double *) mem_107803.mem)[i_105117] = rescale_res_105130;
                lmad_copy_8b(ctx, 1, (uint64_t *) mem_107806.mem, i_105117 * m_33388, (int64_t []) {(int64_t) 1}, (uint64_t *) ext_mem_107829.mem, ext_107828, (int64_t []) {(int64_t) 1}, (int64_t []) {m_33388});
                if (memblock_unref(ctx, &ext_mem_107829, "ext_mem_107829") != 0)
                    return 1;
            }
            if (memblock_set(ctx, &ext_mem_107849, &mem_107801, "mem_107801") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_107846, &mem_107803, "mem_107803") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_107843, &mem_107806, "mem_107806") != 0)
                return 1;
        } else {
            if (memblock_set(ctx, &ext_mem_107849, &mem_107793, "mem_107793") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_107846, &mem_107702, "mem_107702") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_107843, &mem_107761, "mem_107761") != 0)
                return 1;
        }
        
        bool x_109228 = !defunc_0_reduce_res_105042;
        bool defunc_0_reduce_res_105148;
        
        if (x_109228) {
            bool x_109230;
            bool redout_105150 = 0;
            
            for (int64_t i_105149 = 0; i_105149 < m_33388; i_105149++) {
                double eta_p_105151 = ((double *) mem_107785.mem)[i_105149];
                bool zlze_res_105152 = eta_p_105151 <= zs_res_105098;
                bool defunc_0_op_res_105155 = redout_105150 || zlze_res_105152;
                bool redout_tmp_109423 = defunc_0_op_res_105155;
                
                redout_105150 = redout_tmp_109423;
            }
            x_109230 = redout_105150;
            defunc_0_reduce_res_105148 = x_109230;
        } else {
            defunc_0_reduce_res_105148 = 0;
        }
        
        bool cond_105146 = defunc_0_reduce_res_105042 || defunc_0_reduce_res_105148;
        int64_t ext_107891;
        
        if (cond_105146) {
            ext_107891 = (int64_t) 1;
        } else {
            ext_107891 = m_33388;
        }
        
        int64_t ext_107890;
        
        if (cond_105146) {
            ext_107890 = m_33388;
        } else {
            ext_107890 = (int64_t) 1;
        }
        if (cond_105146) {
            if (memblock_alloc(ctx, &mem_107851, bytes_107622, "mem_107851")) {
                err = 1;
                goto cleanup;
            }
            if (memblock_alloc(ctx, &mem_107853, bytes_107622, "mem_107853")) {
                err = 1;
                goto cleanup;
            }
            if (memblock_alloc(ctx, &mem_107856, bytes_107636, "mem_107856")) {
                err = 1;
                goto cleanup;
            }
            for (int64_t i_105167 = 0; i_105167 < m_33388; i_105167++) {
                double eta_p_105171 = ((double *) mem_107785.mem)[i_105167];
                double eta_p_105172 = ((double *) mem_107750.mem)[i_105167];
                bool zgze_res_105174 = exp_absorb_cutoff_33394 <= eta_p_105171;
                bool zl_res_105175 = eta_p_105171 < zs_res_105098;
                bool x_105176 = !zgze_res_105174;
                bool y_105177 = zl_res_105175 && x_105176;
                bool cond_105178 = zgze_res_105174 || y_105177;
                int64_t ext_107878;
                
                if (cond_105178) {
                    ext_107878 = (int64_t) 0;
                } else {
                    ext_107878 = i_105167;
                }
                
                int64_t ext_107877;
                
                if (cond_105178) {
                    ext_107877 = (int64_t) 1;
                } else {
                    ext_107877 = m_33388;
                }
                
                double rescale_res_105179;
                double rescale_res_105180;
                
                if (cond_105178) {
                    double log_res_105182 = futrts_log64(eta_p_105171);
                    double sqrt_res_105183 = futrts_sqrt64(eta_p_105171);
                    double zs_res_105184 = log_res_105182 / 2.0;
                    double zp_res_105185 = eta_p_105172 + zs_res_105184;
                    
                    if (memblock_alloc(ctx, &mem_107868, bytes_107622, "mem_107868")) {
                        err = 1;
                        goto cleanup;
                    }
                    for (int64_t i_105188 = 0; i_105188 < m_33388; i_105188++) {
                        double eta_p_105190 = ((double *) ext_mem_107843.mem)[i_105188 * m_33388 + i_105167];
                        double zt_res_105191 = sqrt_res_105183 * eta_p_105190;
                        
                        ((double *) mem_107868.mem)[i_105188] = zt_res_105191;
                    }
                    if (memblock_set(ctx, &ext_mem_107879, &mem_107868, "mem_107868") != 0)
                        return 1;
                    rescale_res_105179 = sqrt_res_105183;
                    rescale_res_105180 = zp_res_105185;
                } else {
                    if (memblock_set(ctx, &ext_mem_107879, &ext_mem_107843, "ext_mem_107843") != 0)
                        return 1;
                    rescale_res_105179 = eta_p_105171;
                    rescale_res_105180 = eta_p_105172;
                }
                ((double *) mem_107851.mem)[i_105167] = rescale_res_105179;
                ((double *) mem_107853.mem)[i_105167] = rescale_res_105180;
                lmad_copy_8b(ctx, 1, (uint64_t *) mem_107856.mem, i_105167 * m_33388, (int64_t []) {(int64_t) 1}, (uint64_t *) ext_mem_107879.mem, ext_107878, (int64_t []) {ext_107877}, (int64_t []) {m_33388});
                if (memblock_unref(ctx, &ext_mem_107879, "ext_mem_107879") != 0)
                    return 1;
            }
            if (memblock_set(ctx, &ext_mem_107899, &mem_107851, "mem_107851") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_107896, &mem_107853, "mem_107853") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_107893, &mem_107856, "mem_107856") != 0)
                return 1;
        } else {
            if (memblock_set(ctx, &ext_mem_107899, &mem_107785, "mem_107785") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_107896, &mem_107750, "mem_107750") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_107893, &ext_mem_107843, "ext_mem_107843") != 0)
                return 1;
        }
        if (memblock_unref(ctx, &ext_mem_107843, "ext_mem_107843") != 0)
            return 1;
        
        double defunc_0_reduce_res_105197;
        double redout_105199 = 0.0;
        
        for (int64_t i_105198 = 0; i_105198 < m_33388; i_105198++) {
            double eta_p_105200 = ((double *) mem_107758)[i_105198];
            double eta_p_105201 = ((double *) ext_mem_107849.mem)[i_105198];
            double zs_res_105202 = eta_p_105200 / eta_p_105201;
            double zm_res_105203 = zs_res_105202 - 1.0;
            double abs_res_105204 = fabs64(zm_res_105203);
            double max_res_105207 = fmax64(redout_105199, abs_res_105204);
            double redout_tmp_109428 = max_res_105207;
            
            redout_105199 = redout_tmp_109428;
        }
        defunc_0_reduce_res_105197 = redout_105199;
        
        bool zgze_res_105208 = tol_sinkhorn_33396 <= defunc_0_reduce_res_105197;
        int64_t ext_108042;
        int64_t ext_108041;
        int64_t ext_108040;
        bool algo3_core_loop_res_105209;
        bool loop_while_105215;
        int64_t ctx_param_ext_107900;
        int64_t ctx_param_ext_107901;
        int64_t ctx_param_ext_107902;
        
        if (memblock_set(ctx, &mem_param_107903, &ext_mem_107893, "ext_mem_107893") != 0)
            return 1;
        if (memblock_set(ctx, &mem_param_107906, &ext_mem_107849, "ext_mem_107849") != 0)
            return 1;
        if (memblock_set(ctx, &mem_param_107909, &ext_mem_107899, "ext_mem_107899") != 0)
            return 1;
        if (memblock_set(ctx, &mem_param_107912, &ext_mem_107846, "ext_mem_107846") != 0)
            return 1;
        if (memblock_set(ctx, &mem_param_107915, &ext_mem_107896, "ext_mem_107896") != 0)
            return 1;
        ctx_param_ext_107900 = (int64_t) 0;
        ctx_param_ext_107901 = ext_107891;
        ctx_param_ext_107902 = ext_107890;
        loop_while_105215 = zgze_res_105208;
        while (loop_while_105215) {
            if (memblock_alloc(ctx, &mem_107917, bytes_107622, "mem_107917")) {
                err = 1;
                goto cleanup;
            }
            
            bool defunc_0_reduce_res_105223;
            bool redout_105226 = 0;
            
            for (int64_t i_105225 = 0; i_105225 < m_33388; i_105225++) {
                double eta_p_105229 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_105225];
                double eta_p_105230 = ((double *) mem_param_107915.mem)[i_105225];
                double defunc_0_reduce_res_105231;
                double redout_105233 = 0.0;
                
                for (int64_t i_105232 = 0; i_105232 < m_33388; i_105232++) {
                    double eta_p_105234 = ((double *) mem_param_107906.mem)[i_105232];
                    double eta_p_105235 = ((double *) mem_param_107903.mem)[ctx_param_ext_107900 + (i_105232 * ctx_param_ext_107901 + i_105225 * ctx_param_ext_107902)];
                    double zt_res_105236 = eta_p_105234 * eta_p_105235;
                    double zp_res_105239 = redout_105233 + zt_res_105236;
                    double redout_tmp_109445 = zp_res_105239;
                    
                    redout_105233 = redout_tmp_109445;
                }
                defunc_0_reduce_res_105231 = redout_105233;
                
                double zs_res_105240 = defunc_0_reduce_res_105231 / eta_p_105229;
                double ztzt_res_105241 = fpow64(zs_res_105240, zs_res_44883);
                double zt_res_105242 = zs_res_44885 * eta_p_105230;
                double exp_res_105243 = futrts_exp64(zt_res_105242);
                double zt_res_105244 = ztzt_res_105241 * exp_res_105243;
                bool zgze_res_105245 = exp_absorb_cutoff_33394 <= zt_res_105244;
                bool defunc_0_op_res_105248 = redout_105226 || zgze_res_105245;
                
                ((double *) mem_107917.mem)[i_105225] = zt_res_105244;
                
                bool redout_tmp_109443 = defunc_0_op_res_105248;
                
                redout_105226 = redout_tmp_109443;
            }
            defunc_0_reduce_res_105223 = redout_105226;
            if (memblock_alloc(ctx, &mem_107925, bytes_107622, "mem_107925")) {
                err = 1;
                goto cleanup;
            }
            
            bool defunc_0_reduce_res_105251;
            bool redout_105254 = 0;
            
            for (int64_t i_105253 = 0; i_105253 < m_33388; i_105253++) {
                double eta_p_105257 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_105253];
                double eta_p_105258 = ((double *) mem_param_107912.mem)[i_105253];
                double defunc_0_reduce_res_105259;
                double redout_105261 = 0.0;
                
                for (int64_t i_105260 = 0; i_105260 < m_33388; i_105260++) {
                    double eta_p_105262 = ((double *) mem_107917.mem)[i_105260];
                    double eta_p_105263 = ((double *) mem_param_107903.mem)[ctx_param_ext_107900 + (i_105253 * ctx_param_ext_107901 + i_105260 * ctx_param_ext_107902)];
                    double zt_res_105264 = eta_p_105262 * eta_p_105263;
                    double zp_res_105267 = redout_105261 + zt_res_105264;
                    double redout_tmp_109448 = zp_res_105267;
                    
                    redout_105261 = redout_tmp_109448;
                }
                defunc_0_reduce_res_105259 = redout_105261;
                
                double zs_res_105268 = defunc_0_reduce_res_105259 / eta_p_105257;
                double ztzt_res_105269 = fpow64(zs_res_105268, zs_res_44842);
                double zt_res_105270 = zs_res_44844 * eta_p_105258;
                double exp_res_105271 = futrts_exp64(zt_res_105270);
                double zt_res_105272 = ztzt_res_105269 * exp_res_105271;
                bool zgze_res_105273 = exp_absorb_cutoff_33394 <= zt_res_105272;
                bool defunc_0_op_res_105276 = redout_105254 || zgze_res_105273;
                
                ((double *) mem_107925.mem)[i_105253] = zt_res_105272;
                
                bool redout_tmp_109446 = defunc_0_op_res_105276;
                
                redout_105254 = redout_tmp_109446;
            }
            defunc_0_reduce_res_105251 = redout_105254;
            
            bool x_109224 = !defunc_0_reduce_res_105251;
            bool defunc_0_reduce_res_105280;
            
            if (x_109224) {
                bool x_109226;
                bool redout_105282 = 0;
                
                for (int64_t i_105281 = 0; i_105281 < m_33388; i_105281++) {
                    double eta_p_105283 = ((double *) mem_107925.mem)[i_105281];
                    bool zlze_res_105284 = eta_p_105283 <= zs_res_105098;
                    bool defunc_0_op_res_105287 = redout_105282 || zlze_res_105284;
                    bool redout_tmp_109449 = defunc_0_op_res_105287;
                    
                    redout_105282 = redout_tmp_109449;
                }
                x_109226 = redout_105282;
                defunc_0_reduce_res_105280 = x_109226;
            } else {
                defunc_0_reduce_res_105280 = 0;
            }
            
            bool cond_105278 = defunc_0_reduce_res_105251 || defunc_0_reduce_res_105280;
            int64_t ext_107974;
            
            if (cond_105278) {
                ext_107974 = (int64_t) 0;
            } else {
                ext_107974 = ctx_param_ext_107900;
            }
            
            int64_t ext_107973;
            
            if (cond_105278) {
                ext_107973 = m_33388;
            } else {
                ext_107973 = ctx_param_ext_107901;
            }
            
            int64_t ext_107972;
            
            if (cond_105278) {
                ext_107972 = (int64_t) 1;
            } else {
                ext_107972 = ctx_param_ext_107902;
            }
            if (cond_105278) {
                if (memblock_alloc(ctx, &mem_107933, bytes_107622, "mem_107933")) {
                    err = 1;
                    goto cleanup;
                }
                if (memblock_alloc(ctx, &mem_107935, bytes_107622, "mem_107935")) {
                    err = 1;
                    goto cleanup;
                }
                if (memblock_alloc(ctx, &mem_107938, bytes_107636, "mem_107938")) {
                    err = 1;
                    goto cleanup;
                }
                for (int64_t i_105298 = 0; i_105298 < m_33388; i_105298++) {
                    double eta_p_105302 = ((double *) mem_107925.mem)[i_105298];
                    double eta_p_105303 = ((double *) mem_param_107912.mem)[i_105298];
                    bool zgze_res_105305 = exp_absorb_cutoff_33394 <= eta_p_105302;
                    bool zl_res_105306 = eta_p_105302 < zs_res_105098;
                    bool x_105307 = !zgze_res_105305;
                    bool y_105308 = zl_res_105306 && x_105307;
                    bool cond_105309 = zgze_res_105305 || y_105308;
                    int64_t binop_y_107957 = i_105298 * ctx_param_ext_107901;
                    int64_t lmad_ext_107958 = ctx_param_ext_107900 + binop_y_107957;
                    int64_t ext_107960;
                    
                    if (cond_105309) {
                        ext_107960 = (int64_t) 0;
                    } else {
                        ext_107960 = lmad_ext_107958;
                    }
                    
                    int64_t ext_107959;
                    
                    if (cond_105309) {
                        ext_107959 = (int64_t) 1;
                    } else {
                        ext_107959 = ctx_param_ext_107902;
                    }
                    
                    double rescale_res_105310;
                    double rescale_res_105311;
                    
                    if (cond_105309) {
                        double log_res_105313 = futrts_log64(eta_p_105302);
                        double sqrt_res_105314 = futrts_sqrt64(eta_p_105302);
                        double zs_res_105315 = log_res_105313 / 2.0;
                        double zp_res_105316 = eta_p_105303 + zs_res_105315;
                        
                        if (memblock_alloc(ctx, &mem_107950, bytes_107622, "mem_107950")) {
                            err = 1;
                            goto cleanup;
                        }
                        for (int64_t i_105319 = 0; i_105319 < m_33388; i_105319++) {
                            double eta_p_105321 = ((double *) mem_param_107903.mem)[ctx_param_ext_107900 + (i_105298 * ctx_param_ext_107901 + i_105319 * ctx_param_ext_107902)];
                            double zt_res_105322 = sqrt_res_105314 * eta_p_105321;
                            
                            ((double *) mem_107950.mem)[i_105319] = zt_res_105322;
                        }
                        if (memblock_set(ctx, &ext_mem_107961, &mem_107950, "mem_107950") != 0)
                            return 1;
                        rescale_res_105310 = sqrt_res_105314;
                        rescale_res_105311 = zp_res_105316;
                    } else {
                        if (memblock_set(ctx, &ext_mem_107961, &mem_param_107903, "mem_param_107903") != 0)
                            return 1;
                        rescale_res_105310 = eta_p_105302;
                        rescale_res_105311 = eta_p_105303;
                    }
                    ((double *) mem_107933.mem)[i_105298] = rescale_res_105310;
                    ((double *) mem_107935.mem)[i_105298] = rescale_res_105311;
                    lmad_copy_8b(ctx, 1, (uint64_t *) mem_107938.mem, i_105298 * m_33388, (int64_t []) {(int64_t) 1}, (uint64_t *) ext_mem_107961.mem, ext_107960, (int64_t []) {ext_107959}, (int64_t []) {m_33388});
                    if (memblock_unref(ctx, &ext_mem_107961, "ext_mem_107961") != 0)
                        return 1;
                }
                if (memblock_set(ctx, &ext_mem_107981, &mem_107933, "mem_107933") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_107978, &mem_107935, "mem_107935") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_107975, &mem_107938, "mem_107938") != 0)
                    return 1;
            } else {
                if (memblock_set(ctx, &ext_mem_107981, &mem_107925, "mem_107925") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_107978, &mem_param_107912, "mem_param_107912") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_107975, &mem_param_107903, "mem_param_107903") != 0)
                    return 1;
            }
            if (memblock_unref(ctx, &mem_107925, "mem_107925") != 0)
                return 1;
            
            bool x_109305 = !defunc_0_reduce_res_105223;
            bool defunc_0_reduce_res_105329;
            
            if (x_109305) {
                bool x_109307;
                bool redout_105331 = 0;
                
                for (int64_t i_105330 = 0; i_105330 < m_33388; i_105330++) {
                    double eta_p_105332 = ((double *) mem_107917.mem)[i_105330];
                    bool zlze_res_105333 = eta_p_105332 <= zs_res_105098;
                    bool defunc_0_op_res_105336 = redout_105331 || zlze_res_105333;
                    bool redout_tmp_109454 = defunc_0_op_res_105336;
                    
                    redout_105331 = redout_tmp_109454;
                }
                x_109307 = redout_105331;
                defunc_0_reduce_res_105329 = x_109307;
            } else {
                defunc_0_reduce_res_105329 = 0;
            }
            
            bool cond_105327 = defunc_0_reduce_res_105223 || defunc_0_reduce_res_105329;
            int64_t ext_108024;
            
            if (cond_105327) {
                ext_108024 = (int64_t) 0;
            } else {
                ext_108024 = ext_107974;
            }
            
            int64_t ext_108023;
            
            if (cond_105327) {
                ext_108023 = (int64_t) 1;
            } else {
                ext_108023 = ext_107973;
            }
            
            int64_t ext_108022;
            
            if (cond_105327) {
                ext_108022 = m_33388;
            } else {
                ext_108022 = ext_107972;
            }
            if (cond_105327) {
                if (memblock_alloc(ctx, &mem_107983, bytes_107622, "mem_107983")) {
                    err = 1;
                    goto cleanup;
                }
                if (memblock_alloc(ctx, &mem_107985, bytes_107622, "mem_107985")) {
                    err = 1;
                    goto cleanup;
                }
                if (memblock_alloc(ctx, &mem_107988, bytes_107636, "mem_107988")) {
                    err = 1;
                    goto cleanup;
                }
                for (int64_t i_105348 = 0; i_105348 < m_33388; i_105348++) {
                    double eta_p_105352 = ((double *) mem_107917.mem)[i_105348];
                    double eta_p_105353 = ((double *) mem_param_107915.mem)[i_105348];
                    bool zgze_res_105355 = exp_absorb_cutoff_33394 <= eta_p_105352;
                    bool zl_res_105356 = eta_p_105352 < zs_res_105098;
                    bool x_105357 = !zgze_res_105355;
                    bool y_105358 = zl_res_105356 && x_105357;
                    bool cond_105359 = zgze_res_105355 || y_105358;
                    int64_t binop_y_108007 = i_105348 * ext_107972;
                    int64_t lmad_ext_108008 = ext_107974 + binop_y_108007;
                    int64_t ext_108010;
                    
                    if (cond_105359) {
                        ext_108010 = (int64_t) 0;
                    } else {
                        ext_108010 = lmad_ext_108008;
                    }
                    
                    int64_t ext_108009;
                    
                    if (cond_105359) {
                        ext_108009 = (int64_t) 1;
                    } else {
                        ext_108009 = ext_107973;
                    }
                    
                    double rescale_res_105360;
                    double rescale_res_105361;
                    
                    if (cond_105359) {
                        double log_res_105363 = futrts_log64(eta_p_105352);
                        double sqrt_res_105364 = futrts_sqrt64(eta_p_105352);
                        double zs_res_105365 = log_res_105363 / 2.0;
                        double zp_res_105366 = eta_p_105353 + zs_res_105365;
                        
                        if (memblock_alloc(ctx, &mem_108000, bytes_107622, "mem_108000")) {
                            err = 1;
                            goto cleanup;
                        }
                        for (int64_t i_105369 = 0; i_105369 < m_33388; i_105369++) {
                            double eta_p_105371 = ((double *) ext_mem_107975.mem)[ext_107974 + (i_105369 * ext_107973 + i_105348 * ext_107972)];
                            double zt_res_105372 = sqrt_res_105364 * eta_p_105371;
                            
                            ((double *) mem_108000.mem)[i_105369] = zt_res_105372;
                        }
                        if (memblock_set(ctx, &ext_mem_108011, &mem_108000, "mem_108000") != 0)
                            return 1;
                        rescale_res_105360 = sqrt_res_105364;
                        rescale_res_105361 = zp_res_105366;
                    } else {
                        if (memblock_set(ctx, &ext_mem_108011, &ext_mem_107975, "ext_mem_107975") != 0)
                            return 1;
                        rescale_res_105360 = eta_p_105352;
                        rescale_res_105361 = eta_p_105353;
                    }
                    ((double *) mem_107983.mem)[i_105348] = rescale_res_105360;
                    ((double *) mem_107985.mem)[i_105348] = rescale_res_105361;
                    lmad_copy_8b(ctx, 1, (uint64_t *) mem_107988.mem, i_105348 * m_33388, (int64_t []) {(int64_t) 1}, (uint64_t *) ext_mem_108011.mem, ext_108010, (int64_t []) {ext_108009}, (int64_t []) {m_33388});
                    if (memblock_unref(ctx, &ext_mem_108011, "ext_mem_108011") != 0)
                        return 1;
                }
                if (memblock_set(ctx, &ext_mem_108031, &mem_107983, "mem_107983") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108028, &mem_107985, "mem_107985") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108025, &mem_107988, "mem_107988") != 0)
                    return 1;
            } else {
                if (memblock_set(ctx, &ext_mem_108031, &mem_107917, "mem_107917") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108028, &mem_param_107915, "mem_param_107915") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108025, &ext_mem_107975, "ext_mem_107975") != 0)
                    return 1;
            }
            if (memblock_unref(ctx, &mem_107917, "mem_107917") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_107975, "ext_mem_107975") != 0)
                return 1;
            
            double defunc_0_reduce_res_105378;
            double redout_105380 = 0.0;
            
            for (int64_t i_105379 = 0; i_105379 < m_33388; i_105379++) {
                double eta_p_105381 = ((double *) mem_param_107906.mem)[i_105379];
                double eta_p_105382 = ((double *) ext_mem_107981.mem)[i_105379];
                double zs_res_105383 = eta_p_105381 / eta_p_105382;
                double zm_res_105384 = zs_res_105383 - 1.0;
                double abs_res_105385 = fabs64(zm_res_105384);
                double max_res_105388 = fmax64(redout_105380, abs_res_105385);
                double redout_tmp_109459 = max_res_105388;
                
                redout_105380 = redout_tmp_109459;
            }
            defunc_0_reduce_res_105378 = redout_105380;
            
            bool zgze_res_105389 = tol_sinkhorn_33396 <= defunc_0_reduce_res_105378;
            
            if (memblock_set(ctx, &mem_param_tmp_109429, &ext_mem_108025, "ext_mem_108025") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_tmp_109430, &ext_mem_107981, "ext_mem_107981") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_tmp_109431, &ext_mem_108031, "ext_mem_108031") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_tmp_109432, &ext_mem_107978, "ext_mem_107978") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_tmp_109433, &ext_mem_108028, "ext_mem_108028") != 0)
                return 1;
            
            int64_t ctx_param_ext_tmp_109434 = ext_108024;
            int64_t ctx_param_ext_tmp_109435 = ext_108023;
            int64_t ctx_param_ext_tmp_109436 = ext_108022;
            bool loop_while_tmp_109437 = zgze_res_105389;
            
            if (memblock_set(ctx, &mem_param_107903, &mem_param_tmp_109429, "mem_param_tmp_109429") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_107906, &mem_param_tmp_109430, "mem_param_tmp_109430") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_107909, &mem_param_tmp_109431, "mem_param_tmp_109431") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_107912, &mem_param_tmp_109432, "mem_param_tmp_109432") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_107915, &mem_param_tmp_109433, "mem_param_tmp_109433") != 0)
                return 1;
            ctx_param_ext_107900 = ctx_param_ext_tmp_109434;
            ctx_param_ext_107901 = ctx_param_ext_tmp_109435;
            ctx_param_ext_107902 = ctx_param_ext_tmp_109436;
            loop_while_105215 = loop_while_tmp_109437;
        }
        if (memblock_set(ctx, &ext_mem_108047, &mem_param_107903, "mem_param_107903") != 0)
            return 1;
        if (memblock_set(ctx, &ext_mem_108046, &mem_param_107906, "mem_param_107906") != 0)
            return 1;
        if (memblock_set(ctx, &ext_mem_108045, &mem_param_107909, "mem_param_107909") != 0)
            return 1;
        if (memblock_set(ctx, &ext_mem_108044, &mem_param_107912, "mem_param_107912") != 0)
            return 1;
        if (memblock_set(ctx, &ext_mem_108043, &mem_param_107915, "mem_param_107915") != 0)
            return 1;
        ext_108042 = ctx_param_ext_107900;
        ext_108041 = ctx_param_ext_107901;
        ext_108040 = ctx_param_ext_107902;
        algo3_core_loop_res_105209 = loop_while_105215;
        if (memblock_unref(ctx, &ext_mem_107846, "ext_mem_107846") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107849, "ext_mem_107849") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107893, "ext_mem_107893") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107896, "ext_mem_107896") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107899, "ext_mem_107899") != 0)
            return 1;
        
        double defunc_res_105391;
        double redout_105394 = 0.0;
        
        for (int64_t i_105393 = 0; i_105393 < m_33388; i_105393++) {
            double eta_p_105397 = ((double *) ext_mem_108046.mem)[i_105393];
            double defunc_res_105399;
            double redout_105402 = 0.0;
            
            for (int64_t i_105401 = 0; i_105401 < m_33388; i_105401++) {
                double eta_p_105404 = ((double *) ext_mem_108047.mem)[ext_108042 + (i_105393 * ext_108041 + i_105401 * ext_108040)];
                double eta_p_wasfree_105405 = ((double *) ext_mem_108045.mem)[i_105401];
                double zt_res_105406 = eta_p_105397 * eta_p_105404;
                double zt_res_105407 = eta_p_wasfree_105405 * zt_res_105406;
                double zp_res_105410 = redout_105402 + zt_res_105407;
                
                ((double *) mem_108050)[i_105393 * m_33388 + i_105401] = zt_res_105407;
                
                double redout_tmp_109462 = zp_res_105410;
                
                redout_105402 = redout_tmp_109462;
            }
            defunc_res_105399 = redout_105402;
            
            double zp_res_105414 = redout_105394 + defunc_res_105399;
            double redout_tmp_109460 = zp_res_105414;
            
            redout_105394 = redout_tmp_109460;
        }
        defunc_res_105391 = redout_105394;
        if (memblock_unref(ctx, &ext_mem_108045, "ext_mem_108045") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108046, "ext_mem_108046") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108047, "ext_mem_108047") != 0)
            return 1;
        
        double zs_res_105416 = defunc_res_104645 / defunc_res_105391;
        double sqrt_res_105417 = futrts_sqrt64(zs_res_105416);
        bool defunc_0_reduce_comm_res_105419;
        bool redout_105422 = 0;
        
        for (int64_t i_105421 = 0; i_105421 < m_33388; i_105421++) {
            bool defunc_0_reduce_comm_res_105427;
            bool redout_105430 = 0;
            
            for (int64_t i_105429 = 0; i_105429 < m_33388; i_105429++) {
                double eta_p_105432 = ((double *) mem_108050)[i_105421 * m_33388 + i_105429];
                double eta_p_105433 = ((double *) mem_107637)[i_105421 * m_33388 + i_105429];
                double zt_res_105434 = sqrt_res_105417 * eta_p_105432;
                double zt_res_105435 = zp_res_43884 * eta_p_105433;
                bool zgze_res_105436 = zt_res_105434 <= zt_res_105435;
                double zt_res_105437 = zp_res_43884 * zt_res_105434;
                bool zgze_res_105438 = eta_p_105433 <= zt_res_105437;
                bool x_105439 = zgze_res_105436 && zgze_res_105438;
                bool not_res_105440 = !x_105439;
                bool defunc_0_op_res_105443 = redout_105430 || not_res_105440;
                
                ((double *) mem_108069.mem)[i_105421 * m_33388 + i_105429] = zt_res_105434;
                
                bool redout_tmp_109466 = defunc_0_op_res_105443;
                
                redout_105430 = redout_tmp_109466;
            }
            defunc_0_reduce_comm_res_105427 = redout_105430;
            
            bool defunc_0_op_res_105447 = redout_105422 || defunc_0_reduce_comm_res_105427;
            bool redout_tmp_109464 = defunc_0_op_res_105447;
            
            redout_105422 = redout_tmp_109464;
        }
        defunc_0_reduce_comm_res_105419 = redout_105422;
        
        double zt_res_105449 = -2.0 * defunc_res_104876;
        double zp_res_105450 = defunc_0_reduce_res_104875 + zt_res_105449;
        double zp_res_105451 = defunc_0_reduce_res_104842 + zp_res_105450;
        double zt_res_105452 = eps_33391 * defunc_res_104648;
        double zt_res_105453 = rho1_33389 * defunc_res_104646;
        double zt_res_105454 = rho2_33390 * defunc_res_104770;
        double zp_res_105455 = zt_res_105452 + zt_res_105453;
        double zp_res_105456 = zt_res_105454 + zp_res_105455;
        double zt_res_105457 = 2.0 * zp_res_105456;
        double zt_res_105458 = defunc_res_104647 * zt_res_105457;
        double zp_res_105459 = zp_res_105451 + zt_res_105458;
        double zt_res_105460 = defunc_res_104647 * defunc_res_104647;
        double zt_res_105461 = zp_res_46827 * zt_res_105460;
        double zm_res_105462 = zp_res_105459 - zt_res_105461;
        double zt_res_105463 = defunc_res_104649 * defunc_res_104771;
        double zt_res_105464 = rho1_33389 * defunc_res_104649;
        double zt_res_105465 = defunc_res_104649 * zt_res_105464;
        double zt_res_105466 = rho2_33390 * defunc_res_104771;
        double zt_res_105467 = defunc_res_104771 * zt_res_105466;
        double zp_res_105468 = zt_res_105465 + zt_res_105467;
        double zt_res_105469 = eps_33391 * zt_res_105463;
        double zt_res_105470 = zt_res_105463 * zt_res_105469;
        double zp_res_105471 = zp_res_105468 + zt_res_105470;
        double zp_res_105472 = zm_res_105462 + zp_res_105471;
        bool defunc_0_reduce_res_105474;
        
        if (defunc_0_reduce_comm_res_105419) {
            bool x_109218;
            bool redout_105476 = 0;
            
            for (int64_t i_105475 = 0; i_105475 < m_33388; i_105475++) {
                bool defunc_0_reduce_res_105478;
                bool redout_105480 = 0;
                
                for (int64_t i_105479 = 0; i_105479 < m_33388; i_105479++) {
                    double eta_p_105481 = ((double *) mem_108069.mem)[i_105475 * m_33388 + i_105479];
                    bool zg_res_105482 = 0.0 < eta_p_105481;
                    bool defunc_0_op_res_105485 = redout_105480 || zg_res_105482;
                    bool redout_tmp_109469 = defunc_0_op_res_105485;
                    
                    redout_105480 = redout_tmp_109469;
                }
                defunc_0_reduce_res_105478 = redout_105480;
                
                bool defunc_0_op_res_105488 = redout_105476 || defunc_0_reduce_res_105478;
                bool redout_tmp_109468 = defunc_0_op_res_105488;
                
                redout_105476 = redout_tmp_109468;
            }
            x_109218 = redout_105476;
            defunc_0_reduce_res_105474 = x_109218;
        } else {
            defunc_0_reduce_res_105474 = 0;
        }
        
        bool x_109288 = defunc_0_reduce_comm_res_105419 && defunc_0_reduce_res_105474;
        bool final_plan_105489;
        double final_plan_105493;
        bool loop_while_105494;
        double loss_105498;
        
        if (memblock_set(ctx, &mem_param_108088, &ext_mem_108044, "ext_mem_108044") != 0)
            return 1;
        if (memblock_set(ctx, &mem_param_108091, &ext_mem_108043, "ext_mem_108043") != 0)
            return 1;
        if (memblock_set(ctx, &mem_param_108095, &mem_108069, "mem_108069") != 0)
            return 1;
        loop_while_105494 = x_109288;
        loss_105498 = zp_res_105472;
        while (loop_while_105494) {
            double defunc_res_105500;
            double defunc_res_105501;
            double defunc_res_105502;
            double defunc_res_105503;
            double redout_105506;
            double redout_105507;
            double redout_105508;
            double redout_105509;
            
            redout_105506 = 0.0;
            redout_105507 = 0.0;
            redout_105508 = 0.0;
            redout_105509 = 0.0;
            for (int64_t i_105505 = 0; i_105505 < m_33388; i_105505++) {
                double eta_p_105512 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_105505];
                double defunc_res_105513;
                double defunc_res_105514;
                double defunc_res_105515;
                double defunc_res_105516;
                double defunc_res_105517;
                double redout_105519;
                double redout_105520;
                double redout_105521;
                double redout_105522;
                double redout_105523;
                
                redout_105519 = 0.0;
                redout_105520 = 0.0;
                redout_105521 = 0.0;
                redout_105522 = 0.0;
                redout_105523 = 0.0;
                for (int64_t i_105518 = 0; i_105518 < m_33388; i_105518++) {
                    double x_105524 = ((double *) mem_param_108095.mem)[i_105505 * m_33388 + i_105518];
                    double eta_p_105525 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_105518];
                    double zt_res_105526 = eta_p_105512 * eta_p_105525;
                    bool zeze_res_105527 = x_105524 == 0.0;
                    double klu_res_105528;
                    
                    if (zeze_res_105527) {
                        klu_res_105528 = 0.0;
                    } else {
                        double zs_res_105529 = x_105524 / zt_res_105526;
                        double log_res_105530 = futrts_log64(zs_res_105529);
                        double zt_res_105531 = x_105524 * log_res_105530;
                        
                        klu_res_105528 = zt_res_105531;
                    }
                    
                    double zp_res_105542 = redout_105519 + x_105524;
                    double zp_res_105543 = redout_105520 + x_105524;
                    double zp_res_105544 = redout_105521 + x_105524;
                    double zp_res_105545 = redout_105522 + klu_res_105528;
                    double zp_res_105546 = redout_105523 + x_105524;
                    double redout_tmp_109483 = zp_res_105542;
                    double redout_tmp_109484 = zp_res_105543;
                    double redout_tmp_109485 = zp_res_105544;
                    double redout_tmp_109486 = zp_res_105545;
                    double redout_tmp_109487 = zp_res_105546;
                    
                    redout_105519 = redout_tmp_109483;
                    redout_105520 = redout_tmp_109484;
                    redout_105521 = redout_tmp_109485;
                    redout_105522 = redout_tmp_109486;
                    redout_105523 = redout_tmp_109487;
                }
                defunc_res_105513 = redout_105519;
                defunc_res_105514 = redout_105520;
                defunc_res_105515 = redout_105521;
                defunc_res_105516 = redout_105522;
                defunc_res_105517 = redout_105523;
                
                bool zeze_res_105547 = defunc_res_105515 == 0.0;
                double klu_res_105548;
                
                if (zeze_res_105547) {
                    klu_res_105548 = 0.0;
                } else {
                    double zs_res_105549 = defunc_res_105515 / eta_p_105512;
                    double log_res_105550 = futrts_log64(zs_res_105549);
                    double zt_res_105551 = defunc_res_105515 * log_res_105550;
                    
                    klu_res_105548 = zt_res_105551;
                }
                
                double zp_res_105560 = redout_105506 + defunc_res_105513;
                double zp_res_105561 = redout_105507 + klu_res_105548;
                double zp_res_105562 = redout_105508 + defunc_res_105516;
                double zp_res_105563 = redout_105509 + defunc_res_105517;
                
                ((double *) mem_108097)[i_105505] = defunc_res_105514;
                
                double redout_tmp_109478 = zp_res_105560;
                double redout_tmp_109479 = zp_res_105561;
                double redout_tmp_109480 = zp_res_105562;
                double redout_tmp_109481 = zp_res_105563;
                
                redout_105506 = redout_tmp_109478;
                redout_105507 = redout_tmp_109479;
                redout_105508 = redout_tmp_109480;
                redout_105509 = redout_tmp_109481;
            }
            defunc_res_105500 = redout_105506;
            defunc_res_105501 = redout_105507;
            defunc_res_105502 = redout_105508;
            defunc_res_105503 = redout_105509;
            
            double zt_res_105566 = eps_33391 * defunc_res_105500;
            double defunc_res_105569;
            double redout_105573 = 0.0;
            
            for (int64_t i_105572 = 0; i_105572 < m_33388; i_105572++) {
                double eta_p_105577 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_105572];
                double log_res_105578 = futrts_log64(eta_p_105577);
                double zt_res_105579 = zt_res_105566 * log_res_105578;
                double defunc_res_105580;
                double defunc_res_105581;
                double redout_105583;
                double redout_105584;
                
                redout_105583 = 0.0;
                redout_105584 = 0.0;
                for (int64_t i_105582 = 0; i_105582 < m_33388; i_105582++) {
                    double x_105585 = ((double *) mem_param_108095.mem)[i_105582 * m_33388 + i_105572];
                    double zp_res_105590 = redout_105583 + x_105585;
                    double zp_res_105591 = redout_105584 + x_105585;
                    double redout_tmp_109491 = zp_res_105590;
                    double redout_tmp_109492 = zp_res_105591;
                    
                    redout_105583 = redout_tmp_109491;
                    redout_105584 = redout_tmp_109492;
                }
                defunc_res_105580 = redout_105583;
                defunc_res_105581 = redout_105584;
                
                bool zeze_res_105592 = defunc_res_105580 == 0.0;
                double klu_res_105593;
                
                if (zeze_res_105592) {
                    klu_res_105593 = 0.0;
                } else {
                    double zs_res_105594 = defunc_res_105580 / eta_p_105577;
                    double log_res_105595 = futrts_log64(zs_res_105594);
                    double zt_res_105596 = defunc_res_105580 * log_res_105595;
                    
                    klu_res_105593 = zt_res_105596;
                }
                
                double zp_res_105599 = redout_105573 + klu_res_105593;
                
                ((double *) mem_108105)[i_105572] = defunc_res_105581;
                ((double *) mem_108107)[i_105572] = zt_res_105579;
                
                double redout_tmp_109488 = zp_res_105599;
                
                redout_105573 = redout_tmp_109488;
            }
            defunc_res_105569 = redout_105573;
            
            double zt_res_105602 = rho2_33390 * defunc_res_105569;
            double zt_res_105603 = rho1_33389 * defunc_res_105501;
            double zp_res_105604 = zt_res_105602 + zt_res_105603;
            double zt_res_105605 = eps_33391 * defunc_res_105502;
            double zp_res_105606 = zp_res_105604 + zt_res_105605;
            
            for (int64_t i_105609 = 0; i_105609 < m_33388; i_105609++) {
                double defunc_0_reduce_res_105612;
                double redout_105614 = 0.0;
                
                for (int64_t i_105613 = 0; i_105613 < m_33388; i_105613++) {
                    double eta_p_105615 = ((double *) A_mem_107604.mem)[lifted_lambda_res_104626 * (m_33388 * m_33388) + i_105609 * m_33388 + i_105613];
                    double eta_p_105616 = ((double *) mem_108105)[i_105613];
                    double zt_res_105617 = eta_p_105615 * eta_p_105615;
                    double zt_res_105618 = eta_p_105616 * zt_res_105617;
                    double zp_res_105621 = redout_105614 + zt_res_105618;
                    double redout_tmp_109494 = zp_res_105621;
                    
                    redout_105614 = redout_tmp_109494;
                }
                defunc_0_reduce_res_105612 = redout_105614;
                ((double *) mem_108121)[i_105609] = defunc_0_reduce_res_105612;
            }
            for (int64_t i_105627 = 0; i_105627 < m_33388; i_105627++) {
                double eta_p_105630 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_105627];
                double eta_p_105632 = ((double *) mem_param_108088.mem)[i_105627];
                double log_res_105633 = futrts_log64(eta_p_105630);
                double zt_res_105634 = zt_res_105566 * log_res_105633;
                double defunc_0_reduce_res_105635;
                double redout_105637 = 0.0;
                
                for (int64_t i_105636 = 0; i_105636 < m_33388; i_105636++) {
                    double eta_p_105638 = ((double *) A_mem_107604.mem)[tmp_104620 * (m_33388 * m_33388) + i_105627 * m_33388 + i_105636];
                    double eta_p_105639 = ((double *) mem_108097)[i_105636];
                    double zt_res_105640 = eta_p_105638 * eta_p_105638;
                    double zt_res_105641 = eta_p_105639 * zt_res_105640;
                    double zp_res_105644 = redout_105637 + zt_res_105641;
                    double redout_tmp_109497 = zp_res_105644;
                    
                    redout_105637 = redout_tmp_109497;
                }
                defunc_0_reduce_res_105635 = redout_105637;
                for (int64_t i_105647 = 0; i_105647 < m_33388; i_105647++) {
                    double defunc_0_reduce_res_105650;
                    double redout_105652 = 0.0;
                    
                    for (int64_t i_105651 = 0; i_105651 < m_33388; i_105651++) {
                        double eta_p_105653 = ((double *) A_mem_107604.mem)[tmp_104620 * (m_33388 * m_33388) + i_105627 * m_33388 + i_105651];
                        double eta_p_105654 = ((double *) mem_param_108095.mem)[i_105651 * m_33388 + i_105647];
                        double zt_res_105655 = eta_p_105653 * eta_p_105654;
                        double zp_res_105658 = redout_105652 + zt_res_105655;
                        double redout_tmp_109499 = zp_res_105658;
                        
                        redout_105652 = redout_tmp_109499;
                    }
                    defunc_0_reduce_res_105650 = redout_105652;
                    ((double *) mem_108141)[i_105647] = defunc_0_reduce_res_105650;
                }
                
                double defunc_0_reduce_res_105661;
                double redout_105664 = INFINITY;
                
                for (int64_t i_105663 = 0; i_105663 < m_33388; i_105663++) {
                    double eta_p_wasfree_105667 = ((double *) mem_108121)[i_105663];
                    double eta_p_wasfree_105668 = ((double *) mem_108107)[i_105663];
                    double eta_p_wasfree_105669 = ((double *) mem_param_108091.mem)[i_105663];
                    double defunc_0_reduce_res_105670;
                    double redout_105672 = 0.0;
                    
                    for (int64_t i_105671 = 0; i_105671 < m_33388; i_105671++) {
                        double eta_p_105673 = ((double *) mem_108141)[i_105671];
                        double eta_p_105674 = ((double *) A_mem_107604.mem)[lifted_lambda_res_104626 * (m_33388 * m_33388) + i_105671 * m_33388 + i_105663];
                        double zt_res_105675 = eta_p_105673 * eta_p_105674;
                        double zp_res_105678 = redout_105672 + zt_res_105675;
                        double redout_tmp_109502 = zp_res_105678;
                        
                        redout_105672 = redout_tmp_109502;
                    }
                    defunc_0_reduce_res_105670 = redout_105672;
                    
                    double zt_res_105679 = -2.0 * defunc_0_reduce_res_105670;
                    double zp_res_105680 = defunc_0_reduce_res_105635 + zt_res_105679;
                    double zp_res_105681 = eta_p_wasfree_105667 + zp_res_105680;
                    double zp_res_105682 = zp_res_105606 + zp_res_105681;
                    double zm_res_105683 = zp_res_105682 - zt_res_105634;
                    double zm_res_105684 = zm_res_105683 - eta_p_wasfree_105668;
                    double zs_res_105685 = zm_res_105684 / defunc_res_105503;
                    double zs_res_105686 = zs_res_105685 / neg_res_43882;
                    double zp_res_105687 = eta_p_105632 + zs_res_105686;
                    double zp_res_105688 = eta_p_wasfree_105669 + zp_res_105687;
                    double zm_res_105689 = 30.0 - zp_res_105688;
                    double min_res_105692 = fmin64(redout_105664, zm_res_105689);
                    
                    ((double *) mem_108149)[i_105663] = zp_res_105688;
                    
                    double redout_tmp_109500 = min_res_105692;
                    
                    redout_105664 = redout_tmp_109500;
                }
                defunc_0_reduce_res_105661 = redout_105664;
                for (int64_t i_105696 = 0; i_105696 < m_33388; i_105696++) {
                    double eta_p_105698 = ((double *) mem_108149)[i_105696];
                    double zp_res_105699 = defunc_0_reduce_res_105661 + eta_p_105698;
                    
                    ((double *) mem_108130)[i_105627 * m_33388 + i_105696] = zp_res_105699;
                }
                ((double *) mem_108132)[i_105627] = defunc_0_reduce_res_105661;
            }
            
            bool defunc_0_reduce_res_105707;
            bool redout_105712 = 0;
            
            for (int64_t i_105711 = 0; i_105711 < m_33388; i_105711++) {
                double eta_p_105717 = ((double *) mem_param_108091.mem)[i_105711];
                double eta_p_105718 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_105711];
                double defunc_0_reduce_res_105719;
                double redout_105721 = INFINITY;
                
                for (int64_t i_105720 = 0; i_105720 < m_33388; i_105720++) {
                    double eta_p_105722 = ((double *) mem_108130)[i_105720 * m_33388 + i_105711];
                    double zm_res_105723 = 30.0 - eta_p_105722;
                    double min_res_105726 = fmin64(redout_105721, zm_res_105723);
                    double redout_tmp_109508 = min_res_105726;
                    
                    redout_105721 = redout_tmp_109508;
                }
                defunc_0_reduce_res_105719 = redout_105721;
                
                double defunc_0_reduce_res_105728;
                double redout_105731 = 0.0;
                
                for (int64_t i_105730 = 0; i_105730 < m_33388; i_105730++) {
                    double eta_p_105733 = ((double *) mem_108130)[i_105730 * m_33388 + i_105711];
                    double zp_res_105734 = defunc_0_reduce_res_105719 + eta_p_105733;
                    double exp_res_105735 = futrts_exp64(zp_res_105734);
                    double zp_res_105738 = redout_105731 + exp_res_105735;
                    
                    ((double *) mem_108177.mem)[i_105711 * m_33388 + i_105730] = exp_res_105735;
                    
                    double redout_tmp_109509 = zp_res_105738;
                    
                    redout_105731 = redout_tmp_109509;
                }
                defunc_0_reduce_res_105728 = redout_105731;
                
                double zp_res_105740 = eta_p_105717 + defunc_0_reduce_res_105719;
                double zs_res_105741 = defunc_0_reduce_res_105728 / eta_p_105718;
                double ztzt_res_105742 = fpow64(zs_res_105741, zs_res_44883);
                double zt_res_105743 = zs_res_44885 * zp_res_105740;
                double exp_res_105744 = futrts_exp64(zt_res_105743);
                double zt_res_105745 = ztzt_res_105742 * exp_res_105744;
                bool zgze_res_105746 = exp_absorb_cutoff_33394 <= zt_res_105745;
                bool defunc_0_op_res_105749 = redout_105712 || zgze_res_105746;
                
                ((double *) mem_108172.mem)[i_105711] = zt_res_105745;
                ((double *) mem_108174.mem)[i_105711] = zp_res_105740;
                
                bool redout_tmp_109504 = defunc_0_op_res_105749;
                
                redout_105712 = redout_tmp_109504;
            }
            defunc_0_reduce_res_105707 = redout_105712;
            
            bool defunc_0_reduce_res_105756;
            bool redout_105760 = 0;
            
            for (int64_t i_105759 = 0; i_105759 < m_33388; i_105759++) {
                double eta_p_105763 = ((double *) mem_param_108088.mem)[i_105759];
                double eta_p_105764 = ((double *) mem_108132)[i_105759];
                double eta_p_105766 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_105759];
                double zp_res_105767 = eta_p_105763 + eta_p_105764;
                double defunc_0_reduce_res_105768;
                double redout_105770 = 0.0;
                
                for (int64_t i_105769 = 0; i_105769 < m_33388; i_105769++) {
                    double eta_p_105771 = ((double *) mem_108172.mem)[i_105769];
                    double eta_p_105772 = ((double *) mem_108177.mem)[i_105769 * m_33388 + i_105759];
                    double zt_res_105773 = eta_p_105771 * eta_p_105772;
                    double zp_res_105776 = redout_105770 + zt_res_105773;
                    double redout_tmp_109514 = zp_res_105776;
                    
                    redout_105770 = redout_tmp_109514;
                }
                defunc_0_reduce_res_105768 = redout_105770;
                
                double zs_res_105777 = defunc_0_reduce_res_105768 / eta_p_105766;
                double ztzt_res_105778 = fpow64(zs_res_105777, zs_res_44842);
                double zt_res_105779 = zs_res_44844 * zp_res_105767;
                double exp_res_105780 = futrts_exp64(zt_res_105779);
                double zt_res_105781 = ztzt_res_105778 * exp_res_105780;
                bool zgze_res_105782 = exp_absorb_cutoff_33394 <= zt_res_105781;
                bool defunc_0_op_res_105785 = redout_105760 || zgze_res_105782;
                
                ((double *) mem_108207.mem)[i_105759] = zt_res_105781;
                ((double *) mem_108209.mem)[i_105759] = zp_res_105767;
                
                bool redout_tmp_109511 = defunc_0_op_res_105785;
                
                redout_105760 = redout_tmp_109511;
            }
            defunc_0_reduce_res_105756 = redout_105760;
            
            bool x_109178 = !defunc_0_reduce_res_105756;
            bool defunc_0_reduce_res_105790;
            
            if (x_109178) {
                bool x_109180;
                bool redout_105792 = 0;
                
                for (int64_t i_105791 = 0; i_105791 < m_33388; i_105791++) {
                    double eta_p_105793 = ((double *) mem_108207.mem)[i_105791];
                    bool zlze_res_105794 = eta_p_105793 <= zs_res_105098;
                    bool defunc_0_op_res_105797 = redout_105792 || zlze_res_105794;
                    bool redout_tmp_109515 = defunc_0_op_res_105797;
                    
                    redout_105792 = redout_tmp_109515;
                }
                x_109180 = redout_105792;
                defunc_0_reduce_res_105790 = x_109180;
            } else {
                defunc_0_reduce_res_105790 = 0;
            }
            
            bool cond_105788 = defunc_0_reduce_res_105756 || defunc_0_reduce_res_105790;
            int64_t ext_108263;
            
            if (cond_105788) {
                ext_108263 = m_33388;
            } else {
                ext_108263 = (int64_t) 1;
            }
            
            int64_t ext_108262;
            
            if (cond_105788) {
                ext_108262 = (int64_t) 1;
            } else {
                ext_108262 = m_33388;
            }
            if (cond_105788) {
                if (memblock_alloc(ctx, &mem_108223, bytes_107622, "mem_108223")) {
                    err = 1;
                    goto cleanup;
                }
                if (memblock_alloc(ctx, &mem_108225, bytes_107622, "mem_108225")) {
                    err = 1;
                    goto cleanup;
                }
                if (memblock_alloc(ctx, &mem_108228, bytes_107636, "mem_108228")) {
                    err = 1;
                    goto cleanup;
                }
                for (int64_t i_105808 = 0; i_105808 < m_33388; i_105808++) {
                    double eta_p_105812 = ((double *) mem_108207.mem)[i_105808];
                    double eta_p_105813 = ((double *) mem_108209.mem)[i_105808];
                    bool zgze_res_105815 = exp_absorb_cutoff_33394 <= eta_p_105812;
                    bool zl_res_105816 = eta_p_105812 < zs_res_105098;
                    bool x_105817 = !zgze_res_105815;
                    bool y_105818 = zl_res_105816 && x_105817;
                    bool cond_105819 = zgze_res_105815 || y_105818;
                    int64_t ext_108250;
                    
                    if (cond_105819) {
                        ext_108250 = (int64_t) 0;
                    } else {
                        ext_108250 = i_105808;
                    }
                    
                    int64_t ext_108249;
                    
                    if (cond_105819) {
                        ext_108249 = (int64_t) 1;
                    } else {
                        ext_108249 = m_33388;
                    }
                    
                    double rescale_res_105820;
                    double rescale_res_105821;
                    
                    if (cond_105819) {
                        double log_res_105823 = futrts_log64(eta_p_105812);
                        double sqrt_res_105824 = futrts_sqrt64(eta_p_105812);
                        double zs_res_105825 = log_res_105823 / 2.0;
                        double zp_res_105826 = eta_p_105813 + zs_res_105825;
                        
                        if (memblock_alloc(ctx, &mem_108240, bytes_107622, "mem_108240")) {
                            err = 1;
                            goto cleanup;
                        }
                        for (int64_t i_105829 = 0; i_105829 < m_33388; i_105829++) {
                            double eta_p_105831 = ((double *) mem_108177.mem)[i_105829 * m_33388 + i_105808];
                            double zt_res_105832 = sqrt_res_105824 * eta_p_105831;
                            
                            ((double *) mem_108240.mem)[i_105829] = zt_res_105832;
                        }
                        if (memblock_set(ctx, &ext_mem_108251, &mem_108240, "mem_108240") != 0)
                            return 1;
                        rescale_res_105820 = sqrt_res_105824;
                        rescale_res_105821 = zp_res_105826;
                    } else {
                        if (memblock_set(ctx, &ext_mem_108251, &mem_108177, "mem_108177") != 0)
                            return 1;
                        rescale_res_105820 = eta_p_105812;
                        rescale_res_105821 = eta_p_105813;
                    }
                    ((double *) mem_108223.mem)[i_105808] = rescale_res_105820;
                    ((double *) mem_108225.mem)[i_105808] = rescale_res_105821;
                    lmad_copy_8b(ctx, 1, (uint64_t *) mem_108228.mem, i_105808 * m_33388, (int64_t []) {(int64_t) 1}, (uint64_t *) ext_mem_108251.mem, ext_108250, (int64_t []) {ext_108249}, (int64_t []) {m_33388});
                    if (memblock_unref(ctx, &ext_mem_108251, "ext_mem_108251") != 0)
                        return 1;
                }
                if (memblock_set(ctx, &ext_mem_108271, &mem_108223, "mem_108223") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108268, &mem_108225, "mem_108225") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108265, &mem_108228, "mem_108228") != 0)
                    return 1;
            } else {
                if (memblock_set(ctx, &ext_mem_108271, &mem_108207, "mem_108207") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108268, &mem_108209, "mem_108209") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108265, &mem_108177, "mem_108177") != 0)
                    return 1;
            }
            
            bool x_109174 = !defunc_0_reduce_res_105707;
            bool defunc_0_reduce_res_105839;
            
            if (x_109174) {
                bool x_109176;
                bool redout_105841 = 0;
                
                for (int64_t i_105840 = 0; i_105840 < m_33388; i_105840++) {
                    double eta_p_105842 = ((double *) mem_108172.mem)[i_105840];
                    bool zlze_res_105843 = eta_p_105842 <= zs_res_105098;
                    bool defunc_0_op_res_105846 = redout_105841 || zlze_res_105843;
                    bool redout_tmp_109520 = defunc_0_op_res_105846;
                    
                    redout_105841 = redout_tmp_109520;
                }
                x_109176 = redout_105841;
                defunc_0_reduce_res_105839 = x_109176;
            } else {
                defunc_0_reduce_res_105839 = 0;
            }
            
            bool cond_105837 = defunc_0_reduce_res_105707 || defunc_0_reduce_res_105839;
            int64_t ext_108313;
            
            if (cond_105837) {
                ext_108313 = (int64_t) 1;
            } else {
                ext_108313 = ext_108263;
            }
            
            int64_t ext_108312;
            
            if (cond_105837) {
                ext_108312 = m_33388;
            } else {
                ext_108312 = ext_108262;
            }
            if (cond_105837) {
                if (memblock_alloc(ctx, &mem_108273, bytes_107622, "mem_108273")) {
                    err = 1;
                    goto cleanup;
                }
                if (memblock_alloc(ctx, &mem_108275, bytes_107622, "mem_108275")) {
                    err = 1;
                    goto cleanup;
                }
                if (memblock_alloc(ctx, &mem_108278, bytes_107636, "mem_108278")) {
                    err = 1;
                    goto cleanup;
                }
                for (int64_t i_105858 = 0; i_105858 < m_33388; i_105858++) {
                    double eta_p_105862 = ((double *) mem_108172.mem)[i_105858];
                    double eta_p_105863 = ((double *) mem_108174.mem)[i_105858];
                    bool zgze_res_105865 = exp_absorb_cutoff_33394 <= eta_p_105862;
                    bool zl_res_105866 = eta_p_105862 < zs_res_105098;
                    bool x_105867 = !zgze_res_105865;
                    bool y_105868 = zl_res_105866 && x_105867;
                    bool cond_105869 = zgze_res_105865 || y_105868;
                    int64_t binop_y_108297 = i_105858 * ext_108262;
                    int64_t ext_108300;
                    
                    if (cond_105869) {
                        ext_108300 = (int64_t) 0;
                    } else {
                        ext_108300 = binop_y_108297;
                    }
                    
                    int64_t ext_108299;
                    
                    if (cond_105869) {
                        ext_108299 = (int64_t) 1;
                    } else {
                        ext_108299 = ext_108263;
                    }
                    
                    double rescale_res_105870;
                    double rescale_res_105871;
                    
                    if (cond_105869) {
                        double log_res_105873 = futrts_log64(eta_p_105862);
                        double sqrt_res_105874 = futrts_sqrt64(eta_p_105862);
                        double zs_res_105875 = log_res_105873 / 2.0;
                        double zp_res_105876 = eta_p_105863 + zs_res_105875;
                        
                        if (memblock_alloc(ctx, &mem_108290, bytes_107622, "mem_108290")) {
                            err = 1;
                            goto cleanup;
                        }
                        for (int64_t i_105879 = 0; i_105879 < m_33388; i_105879++) {
                            double eta_p_105881 = ((double *) ext_mem_108265.mem)[i_105879 * ext_108263 + i_105858 * ext_108262];
                            double zt_res_105882 = sqrt_res_105874 * eta_p_105881;
                            
                            ((double *) mem_108290.mem)[i_105879] = zt_res_105882;
                        }
                        if (memblock_set(ctx, &ext_mem_108301, &mem_108290, "mem_108290") != 0)
                            return 1;
                        rescale_res_105870 = sqrt_res_105874;
                        rescale_res_105871 = zp_res_105876;
                    } else {
                        if (memblock_set(ctx, &ext_mem_108301, &ext_mem_108265, "ext_mem_108265") != 0)
                            return 1;
                        rescale_res_105870 = eta_p_105862;
                        rescale_res_105871 = eta_p_105863;
                    }
                    ((double *) mem_108273.mem)[i_105858] = rescale_res_105870;
                    ((double *) mem_108275.mem)[i_105858] = rescale_res_105871;
                    lmad_copy_8b(ctx, 1, (uint64_t *) mem_108278.mem, i_105858 * m_33388, (int64_t []) {(int64_t) 1}, (uint64_t *) ext_mem_108301.mem, ext_108300, (int64_t []) {ext_108299}, (int64_t []) {m_33388});
                    if (memblock_unref(ctx, &ext_mem_108301, "ext_mem_108301") != 0)
                        return 1;
                }
                if (memblock_set(ctx, &ext_mem_108321, &mem_108273, "mem_108273") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108318, &mem_108275, "mem_108275") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108315, &mem_108278, "mem_108278") != 0)
                    return 1;
            } else {
                if (memblock_set(ctx, &ext_mem_108321, &mem_108172, "mem_108172") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108318, &mem_108174, "mem_108174") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108315, &ext_mem_108265, "ext_mem_108265") != 0)
                    return 1;
            }
            if (memblock_unref(ctx, &ext_mem_108265, "ext_mem_108265") != 0)
                return 1;
            
            bool defunc_0_reduce_res_105888;
            bool redout_105890 = 1;
            
            for (int64_t i_105889 = 0; i_105889 < m_33388; i_105889++) {
                double eta_p_105891 = ((double *) ext_mem_108271.mem)[i_105889];
                bool isnan_res_105892 = futrts_isnan64(eta_p_105891);
                bool not_res_105893 = !isnan_res_105892;
                bool x_105896 = redout_105890 && not_res_105893;
                bool redout_tmp_109525 = x_105896;
                
                redout_105890 = redout_tmp_109525;
            }
            defunc_0_reduce_res_105888 = redout_105890;
            
            bool defunc_0_reduce_comm_res_105899;
            
            if (defunc_0_reduce_res_105888) {
                bool x_109172;
                bool redout_105901 = 0;
                
                for (int64_t i_105900 = 0; i_105900 < m_33388; i_105900++) {
                    double eta_p_105902 = ((double *) ext_mem_108271.mem)[i_105900];
                    double zt_res_105903 = zp_res_105898 * eta_p_105902;
                    bool zgze_res_105904 = 1.0 <= zt_res_105903;
                    bool zgze_res_105905 = eta_p_105902 <= zp_res_105898;
                    bool x_105906 = zgze_res_105904 && zgze_res_105905;
                    bool not_res_105907 = !x_105906;
                    bool defunc_0_op_res_105910 = redout_105901 || not_res_105907;
                    bool redout_tmp_109526 = defunc_0_op_res_105910;
                    
                    redout_105901 = redout_tmp_109526;
                }
                x_109172 = redout_105901;
                defunc_0_reduce_comm_res_105899 = x_109172;
            } else {
                defunc_0_reduce_comm_res_105899 = 0;
            }
            
            bool x_109291 = defunc_0_reduce_res_105888 && defunc_0_reduce_comm_res_105899;
            int64_t ext_108486;
            int64_t ext_108485;
            int64_t ext_108484;
            int64_t ext_108477;
            int64_t ext_108476;
            int64_t ext_108475;
            bool algo5_core_loop_res_105911;
            bool loop_while_105921;
            int64_t ctx_param_ext_108322;
            int64_t ctx_param_ext_108323;
            int64_t ctx_param_ext_108324;
            int64_t ctx_param_ext_108335;
            int64_t ctx_param_ext_108336;
            int64_t ctx_param_ext_108337;
            
            if (memblock_set(ctx, &mem_param_108325, &mem_108177, "mem_108177") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_108328, &mem_107623, "mem_107623") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_108331, &mem_108209, "mem_108209") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_108334, &mem_108174, "mem_108174") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_108338, &ext_mem_108315, "ext_mem_108315") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_108341, &ext_mem_108271, "ext_mem_108271") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_108344, &ext_mem_108321, "ext_mem_108321") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_108347, &ext_mem_108268, "ext_mem_108268") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_108350, &ext_mem_108318, "ext_mem_108318") != 0)
                return 1;
            ctx_param_ext_108322 = (int64_t) 0;
            ctx_param_ext_108323 = (int64_t) 1;
            ctx_param_ext_108324 = m_33388;
            ctx_param_ext_108335 = (int64_t) 0;
            ctx_param_ext_108336 = ext_108313;
            ctx_param_ext_108337 = ext_108312;
            loop_while_105921 = x_109291;
            while (loop_while_105921) {
                if (memblock_alloc(ctx, &mem_108352, bytes_107622, "mem_108352")) {
                    err = 1;
                    goto cleanup;
                }
                
                bool defunc_0_reduce_res_105933;
                bool redout_105936 = 0;
                
                for (int64_t i_105935 = 0; i_105935 < m_33388; i_105935++) {
                    double eta_p_105939 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_105935];
                    double eta_p_105940 = ((double *) mem_param_108350.mem)[i_105935];
                    double defunc_0_reduce_res_105941;
                    double redout_105943 = 0.0;
                    
                    for (int64_t i_105942 = 0; i_105942 < m_33388; i_105942++) {
                        double eta_p_105944 = ((double *) mem_param_108341.mem)[i_105942];
                        double eta_p_105945 = ((double *) mem_param_108338.mem)[ctx_param_ext_108335 + (i_105942 * ctx_param_ext_108336 + i_105935 * ctx_param_ext_108337)];
                        double zt_res_105946 = eta_p_105944 * eta_p_105945;
                        double zp_res_105949 = redout_105943 + zt_res_105946;
                        double redout_tmp_109554 = zp_res_105949;
                        
                        redout_105943 = redout_tmp_109554;
                    }
                    defunc_0_reduce_res_105941 = redout_105943;
                    
                    double zs_res_105950 = defunc_0_reduce_res_105941 / eta_p_105939;
                    double ztzt_res_105951 = fpow64(zs_res_105950, zs_res_44883);
                    double zt_res_105952 = zs_res_44885 * eta_p_105940;
                    double exp_res_105953 = futrts_exp64(zt_res_105952);
                    double zt_res_105954 = ztzt_res_105951 * exp_res_105953;
                    bool zgze_res_105955 = exp_absorb_cutoff_33394 <= zt_res_105954;
                    bool defunc_0_op_res_105958 = redout_105936 || zgze_res_105955;
                    
                    ((double *) mem_108352.mem)[i_105935] = zt_res_105954;
                    
                    bool redout_tmp_109552 = defunc_0_op_res_105958;
                    
                    redout_105936 = redout_tmp_109552;
                }
                defunc_0_reduce_res_105933 = redout_105936;
                if (memblock_alloc(ctx, &mem_108360, bytes_107622, "mem_108360")) {
                    err = 1;
                    goto cleanup;
                }
                
                bool defunc_0_reduce_res_105961;
                bool redout_105964 = 0;
                
                for (int64_t i_105963 = 0; i_105963 < m_33388; i_105963++) {
                    double eta_p_105967 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_105963];
                    double eta_p_105968 = ((double *) mem_param_108347.mem)[i_105963];
                    double defunc_0_reduce_res_105969;
                    double redout_105971 = 0.0;
                    
                    for (int64_t i_105970 = 0; i_105970 < m_33388; i_105970++) {
                        double eta_p_105972 = ((double *) mem_108352.mem)[i_105970];
                        double eta_p_105973 = ((double *) mem_param_108338.mem)[ctx_param_ext_108335 + (i_105963 * ctx_param_ext_108336 + i_105970 * ctx_param_ext_108337)];
                        double zt_res_105974 = eta_p_105972 * eta_p_105973;
                        double zp_res_105977 = redout_105971 + zt_res_105974;
                        double redout_tmp_109557 = zp_res_105977;
                        
                        redout_105971 = redout_tmp_109557;
                    }
                    defunc_0_reduce_res_105969 = redout_105971;
                    
                    double zs_res_105978 = defunc_0_reduce_res_105969 / eta_p_105967;
                    double ztzt_res_105979 = fpow64(zs_res_105978, zs_res_44842);
                    double zt_res_105980 = zs_res_44844 * eta_p_105968;
                    double exp_res_105981 = futrts_exp64(zt_res_105980);
                    double zt_res_105982 = ztzt_res_105979 * exp_res_105981;
                    bool zgze_res_105983 = exp_absorb_cutoff_33394 <= zt_res_105982;
                    bool defunc_0_op_res_105986 = redout_105964 || zgze_res_105983;
                    
                    ((double *) mem_108360.mem)[i_105963] = zt_res_105982;
                    
                    bool redout_tmp_109555 = defunc_0_op_res_105986;
                    
                    redout_105964 = redout_tmp_109555;
                }
                defunc_0_reduce_res_105961 = redout_105964;
                
                bool x_109166 = !defunc_0_reduce_res_105961;
                bool defunc_0_reduce_res_105990;
                
                if (x_109166) {
                    bool x_109168;
                    bool redout_105992 = 0;
                    
                    for (int64_t i_105991 = 0; i_105991 < m_33388; i_105991++) {
                        double eta_p_105993 = ((double *) mem_108360.mem)[i_105991];
                        bool zlze_res_105994 = eta_p_105993 <= zs_res_105098;
                        bool defunc_0_op_res_105997 = redout_105992 || zlze_res_105994;
                        bool redout_tmp_109558 = defunc_0_op_res_105997;
                        
                        redout_105992 = redout_tmp_109558;
                    }
                    x_109168 = redout_105992;
                    defunc_0_reduce_res_105990 = x_109168;
                } else {
                    defunc_0_reduce_res_105990 = 0;
                }
                
                bool cond_105988 = defunc_0_reduce_res_105961 || defunc_0_reduce_res_105990;
                int64_t ext_108409;
                
                if (cond_105988) {
                    ext_108409 = (int64_t) 0;
                } else {
                    ext_108409 = ctx_param_ext_108335;
                }
                
                int64_t ext_108408;
                
                if (cond_105988) {
                    ext_108408 = m_33388;
                } else {
                    ext_108408 = ctx_param_ext_108336;
                }
                
                int64_t ext_108407;
                
                if (cond_105988) {
                    ext_108407 = (int64_t) 1;
                } else {
                    ext_108407 = ctx_param_ext_108337;
                }
                if (cond_105988) {
                    if (memblock_alloc(ctx, &mem_108368, bytes_107622, "mem_108368")) {
                        err = 1;
                        goto cleanup;
                    }
                    if (memblock_alloc(ctx, &mem_108370, bytes_107622, "mem_108370")) {
                        err = 1;
                        goto cleanup;
                    }
                    if (memblock_alloc(ctx, &mem_108373, bytes_107636, "mem_108373")) {
                        err = 1;
                        goto cleanup;
                    }
                    for (int64_t i_106008 = 0; i_106008 < m_33388; i_106008++) {
                        double eta_p_106012 = ((double *) mem_108360.mem)[i_106008];
                        double eta_p_106013 = ((double *) mem_param_108347.mem)[i_106008];
                        bool zgze_res_106015 = exp_absorb_cutoff_33394 <= eta_p_106012;
                        bool zl_res_106016 = eta_p_106012 < zs_res_105098;
                        bool x_106017 = !zgze_res_106015;
                        bool y_106018 = zl_res_106016 && x_106017;
                        bool cond_106019 = zgze_res_106015 || y_106018;
                        int64_t binop_y_108392 = i_106008 * ctx_param_ext_108336;
                        int64_t lmad_ext_108393 = ctx_param_ext_108335 + binop_y_108392;
                        int64_t ext_108395;
                        
                        if (cond_106019) {
                            ext_108395 = (int64_t) 0;
                        } else {
                            ext_108395 = lmad_ext_108393;
                        }
                        
                        int64_t ext_108394;
                        
                        if (cond_106019) {
                            ext_108394 = (int64_t) 1;
                        } else {
                            ext_108394 = ctx_param_ext_108337;
                        }
                        
                        double rescale_res_106020;
                        double rescale_res_106021;
                        
                        if (cond_106019) {
                            double log_res_106023 = futrts_log64(eta_p_106012);
                            double sqrt_res_106024 = futrts_sqrt64(eta_p_106012);
                            double zs_res_106025 = log_res_106023 / 2.0;
                            double zp_res_106026 = eta_p_106013 + zs_res_106025;
                            
                            if (memblock_alloc(ctx, &mem_108385, bytes_107622, "mem_108385")) {
                                err = 1;
                                goto cleanup;
                            }
                            for (int64_t i_106029 = 0; i_106029 < m_33388; i_106029++) {
                                double eta_p_106031 = ((double *) mem_param_108338.mem)[ctx_param_ext_108335 + (i_106008 * ctx_param_ext_108336 + i_106029 * ctx_param_ext_108337)];
                                double zt_res_106032 = sqrt_res_106024 * eta_p_106031;
                                
                                ((double *) mem_108385.mem)[i_106029] = zt_res_106032;
                            }
                            if (memblock_set(ctx, &ext_mem_108396, &mem_108385, "mem_108385") != 0)
                                return 1;
                            rescale_res_106020 = sqrt_res_106024;
                            rescale_res_106021 = zp_res_106026;
                        } else {
                            if (memblock_set(ctx, &ext_mem_108396, &mem_param_108338, "mem_param_108338") != 0)
                                return 1;
                            rescale_res_106020 = eta_p_106012;
                            rescale_res_106021 = eta_p_106013;
                        }
                        ((double *) mem_108368.mem)[i_106008] = rescale_res_106020;
                        ((double *) mem_108370.mem)[i_106008] = rescale_res_106021;
                        lmad_copy_8b(ctx, 1, (uint64_t *) mem_108373.mem, i_106008 * m_33388, (int64_t []) {(int64_t) 1}, (uint64_t *) ext_mem_108396.mem, ext_108395, (int64_t []) {ext_108394}, (int64_t []) {m_33388});
                        if (memblock_unref(ctx, &ext_mem_108396, "ext_mem_108396") != 0)
                            return 1;
                    }
                    if (memblock_set(ctx, &ext_mem_108416, &mem_108368, "mem_108368") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108413, &mem_108370, "mem_108370") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108410, &mem_108373, "mem_108373") != 0)
                        return 1;
                } else {
                    if (memblock_set(ctx, &ext_mem_108416, &mem_108360, "mem_108360") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108413, &mem_param_108347, "mem_param_108347") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108410, &mem_param_108338, "mem_param_108338") != 0)
                        return 1;
                }
                if (memblock_unref(ctx, &mem_108360, "mem_108360") != 0)
                    return 1;
                
                bool x_109301 = !defunc_0_reduce_res_105933;
                bool defunc_0_reduce_res_106039;
                
                if (x_109301) {
                    bool x_109303;
                    bool redout_106041 = 0;
                    
                    for (int64_t i_106040 = 0; i_106040 < m_33388; i_106040++) {
                        double eta_p_106042 = ((double *) mem_108352.mem)[i_106040];
                        bool zlze_res_106043 = eta_p_106042 <= zs_res_105098;
                        bool defunc_0_op_res_106046 = redout_106041 || zlze_res_106043;
                        bool redout_tmp_109563 = defunc_0_op_res_106046;
                        
                        redout_106041 = redout_tmp_109563;
                    }
                    x_109303 = redout_106041;
                    defunc_0_reduce_res_106039 = x_109303;
                } else {
                    defunc_0_reduce_res_106039 = 0;
                }
                
                bool cond_106037 = defunc_0_reduce_res_105933 || defunc_0_reduce_res_106039;
                int64_t ext_108459;
                
                if (cond_106037) {
                    ext_108459 = (int64_t) 0;
                } else {
                    ext_108459 = ext_108409;
                }
                
                int64_t ext_108458;
                
                if (cond_106037) {
                    ext_108458 = (int64_t) 1;
                } else {
                    ext_108458 = ext_108408;
                }
                
                int64_t ext_108457;
                
                if (cond_106037) {
                    ext_108457 = m_33388;
                } else {
                    ext_108457 = ext_108407;
                }
                if (cond_106037) {
                    if (memblock_alloc(ctx, &mem_108418, bytes_107622, "mem_108418")) {
                        err = 1;
                        goto cleanup;
                    }
                    if (memblock_alloc(ctx, &mem_108420, bytes_107622, "mem_108420")) {
                        err = 1;
                        goto cleanup;
                    }
                    if (memblock_alloc(ctx, &mem_108423, bytes_107636, "mem_108423")) {
                        err = 1;
                        goto cleanup;
                    }
                    for (int64_t i_106058 = 0; i_106058 < m_33388; i_106058++) {
                        double eta_p_106062 = ((double *) mem_108352.mem)[i_106058];
                        double eta_p_106063 = ((double *) mem_param_108350.mem)[i_106058];
                        bool zgze_res_106065 = exp_absorb_cutoff_33394 <= eta_p_106062;
                        bool zl_res_106066 = eta_p_106062 < zs_res_105098;
                        bool x_106067 = !zgze_res_106065;
                        bool y_106068 = zl_res_106066 && x_106067;
                        bool cond_106069 = zgze_res_106065 || y_106068;
                        int64_t binop_y_108442 = i_106058 * ext_108407;
                        int64_t lmad_ext_108443 = ext_108409 + binop_y_108442;
                        int64_t ext_108445;
                        
                        if (cond_106069) {
                            ext_108445 = (int64_t) 0;
                        } else {
                            ext_108445 = lmad_ext_108443;
                        }
                        
                        int64_t ext_108444;
                        
                        if (cond_106069) {
                            ext_108444 = (int64_t) 1;
                        } else {
                            ext_108444 = ext_108408;
                        }
                        
                        double rescale_res_106070;
                        double rescale_res_106071;
                        
                        if (cond_106069) {
                            double log_res_106073 = futrts_log64(eta_p_106062);
                            double sqrt_res_106074 = futrts_sqrt64(eta_p_106062);
                            double zs_res_106075 = log_res_106073 / 2.0;
                            double zp_res_106076 = eta_p_106063 + zs_res_106075;
                            
                            if (memblock_alloc(ctx, &mem_108435, bytes_107622, "mem_108435")) {
                                err = 1;
                                goto cleanup;
                            }
                            for (int64_t i_106079 = 0; i_106079 < m_33388; i_106079++) {
                                double eta_p_106081 = ((double *) ext_mem_108410.mem)[ext_108409 + (i_106079 * ext_108408 + i_106058 * ext_108407)];
                                double zt_res_106082 = sqrt_res_106074 * eta_p_106081;
                                
                                ((double *) mem_108435.mem)[i_106079] = zt_res_106082;
                            }
                            if (memblock_set(ctx, &ext_mem_108446, &mem_108435, "mem_108435") != 0)
                                return 1;
                            rescale_res_106070 = sqrt_res_106074;
                            rescale_res_106071 = zp_res_106076;
                        } else {
                            if (memblock_set(ctx, &ext_mem_108446, &ext_mem_108410, "ext_mem_108410") != 0)
                                return 1;
                            rescale_res_106070 = eta_p_106062;
                            rescale_res_106071 = eta_p_106063;
                        }
                        ((double *) mem_108418.mem)[i_106058] = rescale_res_106070;
                        ((double *) mem_108420.mem)[i_106058] = rescale_res_106071;
                        lmad_copy_8b(ctx, 1, (uint64_t *) mem_108423.mem, i_106058 * m_33388, (int64_t []) {(int64_t) 1}, (uint64_t *) ext_mem_108446.mem, ext_108445, (int64_t []) {ext_108444}, (int64_t []) {m_33388});
                        if (memblock_unref(ctx, &ext_mem_108446, "ext_mem_108446") != 0)
                            return 1;
                    }
                    if (memblock_set(ctx, &ext_mem_108466, &mem_108418, "mem_108418") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108463, &mem_108420, "mem_108420") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108460, &mem_108423, "mem_108423") != 0)
                        return 1;
                } else {
                    if (memblock_set(ctx, &ext_mem_108466, &mem_108352, "mem_108352") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108463, &mem_param_108350, "mem_param_108350") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108460, &ext_mem_108410, "ext_mem_108410") != 0)
                        return 1;
                }
                if (memblock_unref(ctx, &mem_108352, "mem_108352") != 0)
                    return 1;
                if (memblock_unref(ctx, &ext_mem_108410, "ext_mem_108410") != 0)
                    return 1;
                
                bool defunc_0_reduce_res_106088;
                bool redout_106090 = 1;
                
                for (int64_t i_106089 = 0; i_106089 < m_33388; i_106089++) {
                    double eta_p_106091 = ((double *) ext_mem_108416.mem)[i_106089];
                    bool isnan_res_106092 = futrts_isnan64(eta_p_106091);
                    bool not_res_106093 = !isnan_res_106092;
                    bool x_106096 = redout_106090 && not_res_106093;
                    bool redout_tmp_109568 = x_106096;
                    
                    redout_106090 = redout_tmp_109568;
                }
                defunc_0_reduce_res_106088 = redout_106090;
                
                bool loop_cond_106097;
                
                if (defunc_0_reduce_res_106088) {
                    bool defunc_0_reduce_comm_res_106099;
                    bool redout_106101 = 0;
                    
                    for (int64_t i_106100 = 0; i_106100 < m_33388; i_106100++) {
                        double eta_p_106102 = ((double *) ext_mem_108416.mem)[i_106100];
                        double eta_p_106103 = ((double *) mem_param_108341.mem)[i_106100];
                        double zt_res_106104 = zp_res_105898 * eta_p_106102;
                        bool zgze_res_106105 = eta_p_106103 <= zt_res_106104;
                        double zt_res_106106 = zp_res_105898 * eta_p_106103;
                        bool zgze_res_106107 = eta_p_106102 <= zt_res_106106;
                        bool x_106108 = zgze_res_106105 && zgze_res_106107;
                        bool not_res_106109 = !x_106108;
                        bool defunc_0_op_res_106112 = redout_106101 || not_res_106109;
                        bool redout_tmp_109569 = defunc_0_op_res_106112;
                        
                        redout_106101 = redout_tmp_109569;
                    }
                    defunc_0_reduce_comm_res_106099 = redout_106101;
                    loop_cond_106097 = defunc_0_reduce_comm_res_106099;
                } else {
                    loop_cond_106097 = 0;
                }
                if (memblock_set(ctx, &mem_param_tmp_109527, &mem_param_108338, "mem_param_108338") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_tmp_109528, &mem_param_108341, "mem_param_108341") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_tmp_109529, &mem_param_108347, "mem_param_108347") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_tmp_109530, &mem_param_108350, "mem_param_108350") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_tmp_109531, &ext_mem_108460, "ext_mem_108460") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_tmp_109532, &ext_mem_108416, "ext_mem_108416") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_tmp_109533, &ext_mem_108466, "ext_mem_108466") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_tmp_109534, &ext_mem_108413, "ext_mem_108413") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_tmp_109535, &ext_mem_108463, "ext_mem_108463") != 0)
                    return 1;
                
                int64_t ctx_param_ext_tmp_109536 = ctx_param_ext_108335;
                int64_t ctx_param_ext_tmp_109537 = ctx_param_ext_108336;
                int64_t ctx_param_ext_tmp_109538 = ctx_param_ext_108337;
                int64_t ctx_param_ext_tmp_109539 = ext_108459;
                int64_t ctx_param_ext_tmp_109540 = ext_108458;
                int64_t ctx_param_ext_tmp_109541 = ext_108457;
                bool loop_while_tmp_109542 = loop_cond_106097;
                
                if (memblock_set(ctx, &mem_param_108325, &mem_param_tmp_109527, "mem_param_tmp_109527") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_108328, &mem_param_tmp_109528, "mem_param_tmp_109528") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_108331, &mem_param_tmp_109529, "mem_param_tmp_109529") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_108334, &mem_param_tmp_109530, "mem_param_tmp_109530") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_108338, &mem_param_tmp_109531, "mem_param_tmp_109531") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_108341, &mem_param_tmp_109532, "mem_param_tmp_109532") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_108344, &mem_param_tmp_109533, "mem_param_tmp_109533") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_108347, &mem_param_tmp_109534, "mem_param_tmp_109534") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_108350, &mem_param_tmp_109535, "mem_param_tmp_109535") != 0)
                    return 1;
                ctx_param_ext_108322 = ctx_param_ext_tmp_109536;
                ctx_param_ext_108323 = ctx_param_ext_tmp_109537;
                ctx_param_ext_108324 = ctx_param_ext_tmp_109538;
                ctx_param_ext_108335 = ctx_param_ext_tmp_109539;
                ctx_param_ext_108336 = ctx_param_ext_tmp_109540;
                ctx_param_ext_108337 = ctx_param_ext_tmp_109541;
                loop_while_105921 = loop_while_tmp_109542;
            }
            if (memblock_set(ctx, &ext_mem_108495, &mem_param_108325, "mem_param_108325") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_108494, &mem_param_108328, "mem_param_108328") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_108493, &mem_param_108331, "mem_param_108331") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_108492, &mem_param_108334, "mem_param_108334") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_108491, &mem_param_108338, "mem_param_108338") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_108490, &mem_param_108341, "mem_param_108341") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_108489, &mem_param_108344, "mem_param_108344") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_108488, &mem_param_108347, "mem_param_108347") != 0)
                return 1;
            if (memblock_set(ctx, &ext_mem_108487, &mem_param_108350, "mem_param_108350") != 0)
                return 1;
            ext_108486 = ctx_param_ext_108322;
            ext_108485 = ctx_param_ext_108323;
            ext_108484 = ctx_param_ext_108324;
            ext_108477 = ctx_param_ext_108335;
            ext_108476 = ctx_param_ext_108336;
            ext_108475 = ctx_param_ext_108337;
            algo5_core_loop_res_105911 = loop_while_105921;
            if (memblock_unref(ctx, &ext_mem_108268, "ext_mem_108268") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108271, "ext_mem_108271") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108315, "ext_mem_108315") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108318, "ext_mem_108318") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108321, "ext_mem_108321") != 0)
                return 1;
            
            bool defunc_0_reduce_res_106113;
            bool redout_106115 = 1;
            
            for (int64_t i_106114 = 0; i_106114 < m_33388; i_106114++) {
                double eta_p_106116 = ((double *) ext_mem_108490.mem)[i_106114];
                bool isnan_res_106117 = futrts_isnan64(eta_p_106116);
                bool not_res_106118 = !isnan_res_106117;
                bool x_106121 = redout_106115 && not_res_106118;
                bool redout_tmp_109570 = x_106121;
                
                redout_106115 = redout_tmp_109570;
            }
            defunc_0_reduce_res_106113 = redout_106115;
            
            int64_t ext_108774;
            int64_t ext_108773;
            int64_t ext_108772;
            
            if (defunc_0_reduce_res_106113) {
                if (memblock_set(ctx, &ext_mem_108775, &ext_mem_108491, "ext_mem_108491") != 0)
                    return 1;
                ext_108774 = ext_108477;
                ext_108773 = ext_108476;
                ext_108772 = ext_108475;
                if (memblock_set(ctx, &ext_mem_108771, &ext_mem_108490, "ext_mem_108490") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108768, &ext_mem_108489, "ext_mem_108489") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108765, &ext_mem_108488, "ext_mem_108488") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108762, &ext_mem_108487, "ext_mem_108487") != 0)
                    return 1;
            } else {
                if (memblock_alloc(ctx, &mem_108497, bytes_107622, "mem_108497")) {
                    err = 1;
                    goto cleanup;
                }
                
                bool defunc_0_reduce_res_106134;
                bool redout_106137 = 0;
                
                for (int64_t i_106136 = 0; i_106136 < m_33388; i_106136++) {
                    double eta_p_106140 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_106136];
                    double eta_p_106141 = ((double *) ext_mem_108492.mem)[i_106136];
                    double defunc_0_reduce_res_106142;
                    double redout_106144 = 0.0;
                    
                    for (int64_t i_106143 = 0; i_106143 < m_33388; i_106143++) {
                        double eta_p_106145 = ((double *) ext_mem_108494.mem)[i_106143];
                        double eta_p_106146 = ((double *) ext_mem_108495.mem)[ext_108486 + (i_106143 * ext_108485 + i_106136 * ext_108484)];
                        double zt_res_106147 = eta_p_106145 * eta_p_106146;
                        double zp_res_106150 = redout_106144 + zt_res_106147;
                        double redout_tmp_109573 = zp_res_106150;
                        
                        redout_106144 = redout_tmp_109573;
                    }
                    defunc_0_reduce_res_106142 = redout_106144;
                    
                    double zs_res_106151 = defunc_0_reduce_res_106142 / eta_p_106140;
                    double ztzt_res_106152 = fpow64(zs_res_106151, zs_res_44883);
                    double zt_res_106153 = zs_res_44885 * eta_p_106141;
                    double exp_res_106154 = futrts_exp64(zt_res_106153);
                    double zt_res_106155 = ztzt_res_106152 * exp_res_106154;
                    bool zgze_res_106156 = exp_absorb_cutoff_33394 <= zt_res_106155;
                    bool defunc_0_op_res_106159 = redout_106137 || zgze_res_106156;
                    
                    ((double *) mem_108497.mem)[i_106136] = zt_res_106155;
                    
                    bool redout_tmp_109571 = defunc_0_op_res_106159;
                    
                    redout_106137 = redout_tmp_109571;
                }
                defunc_0_reduce_res_106134 = redout_106137;
                if (memblock_alloc(ctx, &mem_108505, bytes_107622, "mem_108505")) {
                    err = 1;
                    goto cleanup;
                }
                
                bool defunc_0_reduce_res_106166;
                bool redout_106169 = 0;
                
                for (int64_t i_106168 = 0; i_106168 < m_33388; i_106168++) {
                    double eta_p_106172 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_106168];
                    double eta_p_106173 = ((double *) ext_mem_108493.mem)[i_106168];
                    double defunc_0_reduce_res_106174;
                    double redout_106176 = 0.0;
                    
                    for (int64_t i_106175 = 0; i_106175 < m_33388; i_106175++) {
                        double eta_p_106177 = ((double *) mem_108497.mem)[i_106175];
                        double eta_p_106178 = ((double *) ext_mem_108495.mem)[ext_108486 + (i_106168 * ext_108485 + i_106175 * ext_108484)];
                        double zt_res_106179 = eta_p_106177 * eta_p_106178;
                        double zp_res_106182 = redout_106176 + zt_res_106179;
                        double redout_tmp_109576 = zp_res_106182;
                        
                        redout_106176 = redout_tmp_109576;
                    }
                    defunc_0_reduce_res_106174 = redout_106176;
                    
                    double zs_res_106183 = defunc_0_reduce_res_106174 / eta_p_106172;
                    double ztzt_res_106184 = fpow64(zs_res_106183, zs_res_44842);
                    double zt_res_106185 = zs_res_44844 * eta_p_106173;
                    double exp_res_106186 = futrts_exp64(zt_res_106185);
                    double zt_res_106187 = ztzt_res_106184 * exp_res_106186;
                    bool zgze_res_106188 = exp_absorb_cutoff_33394 <= zt_res_106187;
                    bool defunc_0_op_res_106191 = redout_106169 || zgze_res_106188;
                    
                    ((double *) mem_108505.mem)[i_106168] = zt_res_106187;
                    
                    bool redout_tmp_109574 = defunc_0_op_res_106191;
                    
                    redout_106169 = redout_tmp_109574;
                }
                defunc_0_reduce_res_106166 = redout_106169;
                
                bool x_109162 = !defunc_0_reduce_res_106166;
                bool defunc_0_reduce_res_106195;
                
                if (x_109162) {
                    bool x_109164;
                    bool redout_106197 = 0;
                    
                    for (int64_t i_106196 = 0; i_106196 < m_33388; i_106196++) {
                        double eta_p_106198 = ((double *) mem_108505.mem)[i_106196];
                        bool zlze_res_106199 = eta_p_106198 <= zs_res_105098;
                        bool defunc_0_op_res_106202 = redout_106197 || zlze_res_106199;
                        bool redout_tmp_109577 = defunc_0_op_res_106202;
                        
                        redout_106197 = redout_tmp_109577;
                    }
                    x_109164 = redout_106197;
                    defunc_0_reduce_res_106195 = x_109164;
                } else {
                    defunc_0_reduce_res_106195 = 0;
                }
                
                bool cond_106193 = defunc_0_reduce_res_106166 || defunc_0_reduce_res_106195;
                int64_t ext_108554;
                
                if (cond_106193) {
                    ext_108554 = (int64_t) 0;
                } else {
                    ext_108554 = ext_108486;
                }
                
                int64_t ext_108553;
                
                if (cond_106193) {
                    ext_108553 = m_33388;
                } else {
                    ext_108553 = ext_108485;
                }
                
                int64_t ext_108552;
                
                if (cond_106193) {
                    ext_108552 = (int64_t) 1;
                } else {
                    ext_108552 = ext_108484;
                }
                if (cond_106193) {
                    if (memblock_alloc(ctx, &mem_108513, bytes_107622, "mem_108513")) {
                        err = 1;
                        goto cleanup;
                    }
                    if (memblock_alloc(ctx, &mem_108515, bytes_107622, "mem_108515")) {
                        err = 1;
                        goto cleanup;
                    }
                    if (memblock_alloc(ctx, &mem_108518, bytes_107636, "mem_108518")) {
                        err = 1;
                        goto cleanup;
                    }
                    for (int64_t i_106213 = 0; i_106213 < m_33388; i_106213++) {
                        double eta_p_106217 = ((double *) mem_108505.mem)[i_106213];
                        double eta_p_106218 = ((double *) ext_mem_108493.mem)[i_106213];
                        bool zgze_res_106220 = exp_absorb_cutoff_33394 <= eta_p_106217;
                        bool zl_res_106221 = eta_p_106217 < zs_res_105098;
                        bool x_106222 = !zgze_res_106220;
                        bool y_106223 = zl_res_106221 && x_106222;
                        bool cond_106224 = zgze_res_106220 || y_106223;
                        int64_t binop_y_108537 = i_106213 * ext_108485;
                        int64_t lmad_ext_108538 = ext_108486 + binop_y_108537;
                        int64_t ext_108540;
                        
                        if (cond_106224) {
                            ext_108540 = (int64_t) 0;
                        } else {
                            ext_108540 = lmad_ext_108538;
                        }
                        
                        int64_t ext_108539;
                        
                        if (cond_106224) {
                            ext_108539 = (int64_t) 1;
                        } else {
                            ext_108539 = ext_108484;
                        }
                        
                        double rescale_res_106225;
                        double rescale_res_106226;
                        
                        if (cond_106224) {
                            double log_res_106228 = futrts_log64(eta_p_106217);
                            double sqrt_res_106229 = futrts_sqrt64(eta_p_106217);
                            double zs_res_106230 = log_res_106228 / 2.0;
                            double zp_res_106231 = eta_p_106218 + zs_res_106230;
                            
                            if (memblock_alloc(ctx, &mem_108530, bytes_107622, "mem_108530")) {
                                err = 1;
                                goto cleanup;
                            }
                            for (int64_t i_106234 = 0; i_106234 < m_33388; i_106234++) {
                                double eta_p_106236 = ((double *) ext_mem_108495.mem)[ext_108486 + (i_106213 * ext_108485 + i_106234 * ext_108484)];
                                double zt_res_106237 = sqrt_res_106229 * eta_p_106236;
                                
                                ((double *) mem_108530.mem)[i_106234] = zt_res_106237;
                            }
                            if (memblock_set(ctx, &ext_mem_108541, &mem_108530, "mem_108530") != 0)
                                return 1;
                            rescale_res_106225 = sqrt_res_106229;
                            rescale_res_106226 = zp_res_106231;
                        } else {
                            if (memblock_set(ctx, &ext_mem_108541, &ext_mem_108495, "ext_mem_108495") != 0)
                                return 1;
                            rescale_res_106225 = eta_p_106217;
                            rescale_res_106226 = eta_p_106218;
                        }
                        ((double *) mem_108513.mem)[i_106213] = rescale_res_106225;
                        ((double *) mem_108515.mem)[i_106213] = rescale_res_106226;
                        lmad_copy_8b(ctx, 1, (uint64_t *) mem_108518.mem, i_106213 * m_33388, (int64_t []) {(int64_t) 1}, (uint64_t *) ext_mem_108541.mem, ext_108540, (int64_t []) {ext_108539}, (int64_t []) {m_33388});
                        if (memblock_unref(ctx, &ext_mem_108541, "ext_mem_108541") != 0)
                            return 1;
                    }
                    if (memblock_set(ctx, &ext_mem_108561, &mem_108513, "mem_108513") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108558, &mem_108515, "mem_108515") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108555, &mem_108518, "mem_108518") != 0)
                        return 1;
                } else {
                    if (memblock_set(ctx, &ext_mem_108561, &mem_108505, "mem_108505") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108558, &ext_mem_108493, "ext_mem_108493") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108555, &ext_mem_108495, "ext_mem_108495") != 0)
                        return 1;
                }
                if (memblock_unref(ctx, &mem_108505, "mem_108505") != 0)
                    return 1;
                
                bool x_109158 = !defunc_0_reduce_res_106134;
                bool defunc_0_reduce_res_106244;
                
                if (x_109158) {
                    bool x_109160;
                    bool redout_106246 = 0;
                    
                    for (int64_t i_106245 = 0; i_106245 < m_33388; i_106245++) {
                        double eta_p_106247 = ((double *) mem_108497.mem)[i_106245];
                        bool zlze_res_106248 = eta_p_106247 <= zs_res_105098;
                        bool defunc_0_op_res_106251 = redout_106246 || zlze_res_106248;
                        bool redout_tmp_109582 = defunc_0_op_res_106251;
                        
                        redout_106246 = redout_tmp_109582;
                    }
                    x_109160 = redout_106246;
                    defunc_0_reduce_res_106244 = x_109160;
                } else {
                    defunc_0_reduce_res_106244 = 0;
                }
                
                bool cond_106242 = defunc_0_reduce_res_106134 || defunc_0_reduce_res_106244;
                int64_t ext_108604;
                
                if (cond_106242) {
                    ext_108604 = (int64_t) 0;
                } else {
                    ext_108604 = ext_108554;
                }
                
                int64_t ext_108603;
                
                if (cond_106242) {
                    ext_108603 = (int64_t) 1;
                } else {
                    ext_108603 = ext_108553;
                }
                
                int64_t ext_108602;
                
                if (cond_106242) {
                    ext_108602 = m_33388;
                } else {
                    ext_108602 = ext_108552;
                }
                if (cond_106242) {
                    if (memblock_alloc(ctx, &mem_108563, bytes_107622, "mem_108563")) {
                        err = 1;
                        goto cleanup;
                    }
                    if (memblock_alloc(ctx, &mem_108565, bytes_107622, "mem_108565")) {
                        err = 1;
                        goto cleanup;
                    }
                    if (memblock_alloc(ctx, &mem_108568, bytes_107636, "mem_108568")) {
                        err = 1;
                        goto cleanup;
                    }
                    for (int64_t i_106263 = 0; i_106263 < m_33388; i_106263++) {
                        double eta_p_106267 = ((double *) mem_108497.mem)[i_106263];
                        double eta_p_106268 = ((double *) ext_mem_108492.mem)[i_106263];
                        bool zgze_res_106270 = exp_absorb_cutoff_33394 <= eta_p_106267;
                        bool zl_res_106271 = eta_p_106267 < zs_res_105098;
                        bool x_106272 = !zgze_res_106270;
                        bool y_106273 = zl_res_106271 && x_106272;
                        bool cond_106274 = zgze_res_106270 || y_106273;
                        int64_t binop_y_108587 = i_106263 * ext_108552;
                        int64_t lmad_ext_108588 = ext_108554 + binop_y_108587;
                        int64_t ext_108590;
                        
                        if (cond_106274) {
                            ext_108590 = (int64_t) 0;
                        } else {
                            ext_108590 = lmad_ext_108588;
                        }
                        
                        int64_t ext_108589;
                        
                        if (cond_106274) {
                            ext_108589 = (int64_t) 1;
                        } else {
                            ext_108589 = ext_108553;
                        }
                        
                        double rescale_res_106275;
                        double rescale_res_106276;
                        
                        if (cond_106274) {
                            double log_res_106278 = futrts_log64(eta_p_106267);
                            double sqrt_res_106279 = futrts_sqrt64(eta_p_106267);
                            double zs_res_106280 = log_res_106278 / 2.0;
                            double zp_res_106281 = eta_p_106268 + zs_res_106280;
                            
                            if (memblock_alloc(ctx, &mem_108580, bytes_107622, "mem_108580")) {
                                err = 1;
                                goto cleanup;
                            }
                            for (int64_t i_106284 = 0; i_106284 < m_33388; i_106284++) {
                                double eta_p_106286 = ((double *) ext_mem_108555.mem)[ext_108554 + (i_106284 * ext_108553 + i_106263 * ext_108552)];
                                double zt_res_106287 = sqrt_res_106279 * eta_p_106286;
                                
                                ((double *) mem_108580.mem)[i_106284] = zt_res_106287;
                            }
                            if (memblock_set(ctx, &ext_mem_108591, &mem_108580, "mem_108580") != 0)
                                return 1;
                            rescale_res_106275 = sqrt_res_106279;
                            rescale_res_106276 = zp_res_106281;
                        } else {
                            if (memblock_set(ctx, &ext_mem_108591, &ext_mem_108555, "ext_mem_108555") != 0)
                                return 1;
                            rescale_res_106275 = eta_p_106267;
                            rescale_res_106276 = eta_p_106268;
                        }
                        ((double *) mem_108563.mem)[i_106263] = rescale_res_106275;
                        ((double *) mem_108565.mem)[i_106263] = rescale_res_106276;
                        lmad_copy_8b(ctx, 1, (uint64_t *) mem_108568.mem, i_106263 * m_33388, (int64_t []) {(int64_t) 1}, (uint64_t *) ext_mem_108591.mem, ext_108590, (int64_t []) {ext_108589}, (int64_t []) {m_33388});
                        if (memblock_unref(ctx, &ext_mem_108591, "ext_mem_108591") != 0)
                            return 1;
                    }
                    if (memblock_set(ctx, &ext_mem_108611, &mem_108563, "mem_108563") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108608, &mem_108565, "mem_108565") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108605, &mem_108568, "mem_108568") != 0)
                        return 1;
                } else {
                    if (memblock_set(ctx, &ext_mem_108611, &mem_108497, "mem_108497") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108608, &ext_mem_108492, "ext_mem_108492") != 0)
                        return 1;
                    if (memblock_set(ctx, &ext_mem_108605, &ext_mem_108555, "ext_mem_108555") != 0)
                        return 1;
                }
                if (memblock_unref(ctx, &mem_108497, "mem_108497") != 0)
                    return 1;
                if (memblock_unref(ctx, &ext_mem_108555, "ext_mem_108555") != 0)
                    return 1;
                
                bool defunc_0_reduce_res_106293;
                bool redout_106295 = 1;
                
                for (int64_t i_106294 = 0; i_106294 < m_33388; i_106294++) {
                    double eta_p_106296 = ((double *) ext_mem_108561.mem)[i_106294];
                    bool isnan_res_106297 = futrts_isnan64(eta_p_106296);
                    bool not_res_106298 = !isnan_res_106297;
                    bool x_106301 = redout_106295 && not_res_106298;
                    bool redout_tmp_109587 = x_106301;
                    
                    redout_106295 = redout_tmp_109587;
                }
                defunc_0_reduce_res_106293 = redout_106295;
                
                bool defunc_0_reduce_comm_res_106304;
                
                if (defunc_0_reduce_res_106293) {
                    bool x_109156;
                    bool redout_106306 = 0;
                    
                    for (int64_t i_106305 = 0; i_106305 < m_33388; i_106305++) {
                        double eta_p_106307 = ((double *) ext_mem_108561.mem)[i_106305];
                        double eta_p_106308 = ((double *) ext_mem_108494.mem)[i_106305];
                        double zt_res_106309 = zp_res_105898 * eta_p_106307;
                        bool zgze_res_106310 = eta_p_106308 <= zt_res_106309;
                        double zt_res_106311 = zp_res_105898 * eta_p_106308;
                        bool zgze_res_106312 = eta_p_106307 <= zt_res_106311;
                        bool x_106313 = zgze_res_106310 && zgze_res_106312;
                        bool not_res_106314 = !x_106313;
                        bool defunc_0_op_res_106317 = redout_106306 || not_res_106314;
                        bool redout_tmp_109588 = defunc_0_op_res_106317;
                        
                        redout_106306 = redout_tmp_109588;
                    }
                    x_109156 = redout_106306;
                    defunc_0_reduce_comm_res_106304 = x_109156;
                } else {
                    defunc_0_reduce_comm_res_106304 = 0;
                }
                
                bool x_109294 = defunc_0_reduce_res_106293 && defunc_0_reduce_comm_res_106304;
                int64_t ext_108754;
                int64_t ext_108753;
                int64_t ext_108752;
                bool algo5_core_loop_res_f_res_106318;
                bool loop_while_106324;
                int64_t ctx_param_ext_108612;
                int64_t ctx_param_ext_108613;
                int64_t ctx_param_ext_108614;
                
                if (memblock_set(ctx, &mem_param_108615, &ext_mem_108605, "ext_mem_108605") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_108618, &ext_mem_108561, "ext_mem_108561") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_108621, &ext_mem_108611, "ext_mem_108611") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_108624, &ext_mem_108558, "ext_mem_108558") != 0)
                    return 1;
                if (memblock_set(ctx, &mem_param_108627, &ext_mem_108608, "ext_mem_108608") != 0)
                    return 1;
                ctx_param_ext_108612 = ext_108604;
                ctx_param_ext_108613 = ext_108603;
                ctx_param_ext_108614 = ext_108602;
                loop_while_106324 = x_109294;
                while (loop_while_106324) {
                    if (memblock_alloc(ctx, &mem_108629, bytes_107622, "mem_108629")) {
                        err = 1;
                        goto cleanup;
                    }
                    
                    bool defunc_0_reduce_res_106332;
                    bool redout_106335 = 0;
                    
                    for (int64_t i_106334 = 0; i_106334 < m_33388; i_106334++) {
                        double eta_p_106338 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_106334];
                        double eta_p_106339 = ((double *) mem_param_108627.mem)[i_106334];
                        double defunc_0_reduce_res_106340;
                        double redout_106342 = 0.0;
                        
                        for (int64_t i_106341 = 0; i_106341 < m_33388; i_106341++) {
                            double eta_p_106343 = ((double *) mem_param_108618.mem)[i_106341];
                            double eta_p_106344 = ((double *) mem_param_108615.mem)[ctx_param_ext_108612 + (i_106341 * ctx_param_ext_108613 + i_106334 * ctx_param_ext_108614)];
                            double zt_res_106345 = eta_p_106343 * eta_p_106344;
                            double zp_res_106348 = redout_106342 + zt_res_106345;
                            double redout_tmp_109605 = zp_res_106348;
                            
                            redout_106342 = redout_tmp_109605;
                        }
                        defunc_0_reduce_res_106340 = redout_106342;
                        
                        double zs_res_106349 = defunc_0_reduce_res_106340 / eta_p_106338;
                        double ztzt_res_106350 = fpow64(zs_res_106349, zs_res_44883);
                        double zt_res_106351 = zs_res_44885 * eta_p_106339;
                        double exp_res_106352 = futrts_exp64(zt_res_106351);
                        double zt_res_106353 = ztzt_res_106350 * exp_res_106352;
                        bool zgze_res_106354 = exp_absorb_cutoff_33394 <= zt_res_106353;
                        bool defunc_0_op_res_106357 = redout_106335 || zgze_res_106354;
                        
                        ((double *) mem_108629.mem)[i_106334] = zt_res_106353;
                        
                        bool redout_tmp_109603 = defunc_0_op_res_106357;
                        
                        redout_106335 = redout_tmp_109603;
                    }
                    defunc_0_reduce_res_106332 = redout_106335;
                    if (memblock_alloc(ctx, &mem_108637, bytes_107622, "mem_108637")) {
                        err = 1;
                        goto cleanup;
                    }
                    
                    bool defunc_0_reduce_res_106360;
                    bool redout_106363 = 0;
                    
                    for (int64_t i_106362 = 0; i_106362 < m_33388; i_106362++) {
                        double eta_p_106366 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_106362];
                        double eta_p_106367 = ((double *) mem_param_108624.mem)[i_106362];
                        double defunc_0_reduce_res_106368;
                        double redout_106370 = 0.0;
                        
                        for (int64_t i_106369 = 0; i_106369 < m_33388; i_106369++) {
                            double eta_p_106371 = ((double *) mem_108629.mem)[i_106369];
                            double eta_p_106372 = ((double *) mem_param_108615.mem)[ctx_param_ext_108612 + (i_106362 * ctx_param_ext_108613 + i_106369 * ctx_param_ext_108614)];
                            double zt_res_106373 = eta_p_106371 * eta_p_106372;
                            double zp_res_106376 = redout_106370 + zt_res_106373;
                            double redout_tmp_109608 = zp_res_106376;
                            
                            redout_106370 = redout_tmp_109608;
                        }
                        defunc_0_reduce_res_106368 = redout_106370;
                        
                        double zs_res_106377 = defunc_0_reduce_res_106368 / eta_p_106366;
                        double ztzt_res_106378 = fpow64(zs_res_106377, zs_res_44842);
                        double zt_res_106379 = zs_res_44844 * eta_p_106367;
                        double exp_res_106380 = futrts_exp64(zt_res_106379);
                        double zt_res_106381 = ztzt_res_106378 * exp_res_106380;
                        bool zgze_res_106382 = exp_absorb_cutoff_33394 <= zt_res_106381;
                        bool defunc_0_op_res_106385 = redout_106363 || zgze_res_106382;
                        
                        ((double *) mem_108637.mem)[i_106362] = zt_res_106381;
                        
                        bool redout_tmp_109606 = defunc_0_op_res_106385;
                        
                        redout_106363 = redout_tmp_109606;
                    }
                    defunc_0_reduce_res_106360 = redout_106363;
                    
                    bool x_109150 = !defunc_0_reduce_res_106360;
                    bool defunc_0_reduce_res_106389;
                    
                    if (x_109150) {
                        bool x_109152;
                        bool redout_106391 = 0;
                        
                        for (int64_t i_106390 = 0; i_106390 < m_33388; i_106390++) {
                            double eta_p_106392 = ((double *) mem_108637.mem)[i_106390];
                            bool zlze_res_106393 = eta_p_106392 <= zs_res_105098;
                            bool defunc_0_op_res_106396 = redout_106391 || zlze_res_106393;
                            bool redout_tmp_109609 = defunc_0_op_res_106396;
                            
                            redout_106391 = redout_tmp_109609;
                        }
                        x_109152 = redout_106391;
                        defunc_0_reduce_res_106389 = x_109152;
                    } else {
                        defunc_0_reduce_res_106389 = 0;
                    }
                    
                    bool cond_106387 = defunc_0_reduce_res_106360 || defunc_0_reduce_res_106389;
                    int64_t ext_108686;
                    
                    if (cond_106387) {
                        ext_108686 = (int64_t) 0;
                    } else {
                        ext_108686 = ctx_param_ext_108612;
                    }
                    
                    int64_t ext_108685;
                    
                    if (cond_106387) {
                        ext_108685 = m_33388;
                    } else {
                        ext_108685 = ctx_param_ext_108613;
                    }
                    
                    int64_t ext_108684;
                    
                    if (cond_106387) {
                        ext_108684 = (int64_t) 1;
                    } else {
                        ext_108684 = ctx_param_ext_108614;
                    }
                    if (cond_106387) {
                        if (memblock_alloc(ctx, &mem_108645, bytes_107622, "mem_108645")) {
                            err = 1;
                            goto cleanup;
                        }
                        if (memblock_alloc(ctx, &mem_108647, bytes_107622, "mem_108647")) {
                            err = 1;
                            goto cleanup;
                        }
                        if (memblock_alloc(ctx, &mem_108650, bytes_107636, "mem_108650")) {
                            err = 1;
                            goto cleanup;
                        }
                        for (int64_t i_106407 = 0; i_106407 < m_33388; i_106407++) {
                            double eta_p_106411 = ((double *) mem_108637.mem)[i_106407];
                            double eta_p_106412 = ((double *) mem_param_108624.mem)[i_106407];
                            bool zgze_res_106414 = exp_absorb_cutoff_33394 <= eta_p_106411;
                            bool zl_res_106415 = eta_p_106411 < zs_res_105098;
                            bool x_106416 = !zgze_res_106414;
                            bool y_106417 = zl_res_106415 && x_106416;
                            bool cond_106418 = zgze_res_106414 || y_106417;
                            int64_t binop_y_108669 = i_106407 * ctx_param_ext_108613;
                            int64_t lmad_ext_108670 = ctx_param_ext_108612 + binop_y_108669;
                            int64_t ext_108672;
                            
                            if (cond_106418) {
                                ext_108672 = (int64_t) 0;
                            } else {
                                ext_108672 = lmad_ext_108670;
                            }
                            
                            int64_t ext_108671;
                            
                            if (cond_106418) {
                                ext_108671 = (int64_t) 1;
                            } else {
                                ext_108671 = ctx_param_ext_108614;
                            }
                            
                            double rescale_res_106419;
                            double rescale_res_106420;
                            
                            if (cond_106418) {
                                double log_res_106422 = futrts_log64(eta_p_106411);
                                double sqrt_res_106423 = futrts_sqrt64(eta_p_106411);
                                double zs_res_106424 = log_res_106422 / 2.0;
                                double zp_res_106425 = eta_p_106412 + zs_res_106424;
                                
                                if (memblock_alloc(ctx, &mem_108662, bytes_107622, "mem_108662")) {
                                    err = 1;
                                    goto cleanup;
                                }
                                for (int64_t i_106428 = 0; i_106428 < m_33388; i_106428++) {
                                    double eta_p_106430 = ((double *) mem_param_108615.mem)[ctx_param_ext_108612 + (i_106407 * ctx_param_ext_108613 + i_106428 * ctx_param_ext_108614)];
                                    double zt_res_106431 = sqrt_res_106423 * eta_p_106430;
                                    
                                    ((double *) mem_108662.mem)[i_106428] = zt_res_106431;
                                }
                                if (memblock_set(ctx, &ext_mem_108673, &mem_108662, "mem_108662") != 0)
                                    return 1;
                                rescale_res_106419 = sqrt_res_106423;
                                rescale_res_106420 = zp_res_106425;
                            } else {
                                if (memblock_set(ctx, &ext_mem_108673, &mem_param_108615, "mem_param_108615") != 0)
                                    return 1;
                                rescale_res_106419 = eta_p_106411;
                                rescale_res_106420 = eta_p_106412;
                            }
                            ((double *) mem_108645.mem)[i_106407] = rescale_res_106419;
                            ((double *) mem_108647.mem)[i_106407] = rescale_res_106420;
                            lmad_copy_8b(ctx, 1, (uint64_t *) mem_108650.mem, i_106407 * m_33388, (int64_t []) {(int64_t) 1}, (uint64_t *) ext_mem_108673.mem, ext_108672, (int64_t []) {ext_108671}, (int64_t []) {m_33388});
                            if (memblock_unref(ctx, &ext_mem_108673, "ext_mem_108673") != 0)
                                return 1;
                        }
                        if (memblock_set(ctx, &ext_mem_108693, &mem_108645, "mem_108645") != 0)
                            return 1;
                        if (memblock_set(ctx, &ext_mem_108690, &mem_108647, "mem_108647") != 0)
                            return 1;
                        if (memblock_set(ctx, &ext_mem_108687, &mem_108650, "mem_108650") != 0)
                            return 1;
                    } else {
                        if (memblock_set(ctx, &ext_mem_108693, &mem_108637, "mem_108637") != 0)
                            return 1;
                        if (memblock_set(ctx, &ext_mem_108690, &mem_param_108624, "mem_param_108624") != 0)
                            return 1;
                        if (memblock_set(ctx, &ext_mem_108687, &mem_param_108615, "mem_param_108615") != 0)
                            return 1;
                    }
                    if (memblock_unref(ctx, &mem_108637, "mem_108637") != 0)
                        return 1;
                    
                    bool x_109297 = !defunc_0_reduce_res_106332;
                    bool defunc_0_reduce_res_106438;
                    
                    if (x_109297) {
                        bool x_109299;
                        bool redout_106440 = 0;
                        
                        for (int64_t i_106439 = 0; i_106439 < m_33388; i_106439++) {
                            double eta_p_106441 = ((double *) mem_108629.mem)[i_106439];
                            bool zlze_res_106442 = eta_p_106441 <= zs_res_105098;
                            bool defunc_0_op_res_106445 = redout_106440 || zlze_res_106442;
                            bool redout_tmp_109614 = defunc_0_op_res_106445;
                            
                            redout_106440 = redout_tmp_109614;
                        }
                        x_109299 = redout_106440;
                        defunc_0_reduce_res_106438 = x_109299;
                    } else {
                        defunc_0_reduce_res_106438 = 0;
                    }
                    
                    bool cond_106436 = defunc_0_reduce_res_106332 || defunc_0_reduce_res_106438;
                    int64_t ext_108736;
                    
                    if (cond_106436) {
                        ext_108736 = (int64_t) 0;
                    } else {
                        ext_108736 = ext_108686;
                    }
                    
                    int64_t ext_108735;
                    
                    if (cond_106436) {
                        ext_108735 = (int64_t) 1;
                    } else {
                        ext_108735 = ext_108685;
                    }
                    
                    int64_t ext_108734;
                    
                    if (cond_106436) {
                        ext_108734 = m_33388;
                    } else {
                        ext_108734 = ext_108684;
                    }
                    if (cond_106436) {
                        if (memblock_alloc(ctx, &mem_108695, bytes_107622, "mem_108695")) {
                            err = 1;
                            goto cleanup;
                        }
                        if (memblock_alloc(ctx, &mem_108697, bytes_107622, "mem_108697")) {
                            err = 1;
                            goto cleanup;
                        }
                        if (memblock_alloc(ctx, &mem_108700, bytes_107636, "mem_108700")) {
                            err = 1;
                            goto cleanup;
                        }
                        for (int64_t i_106457 = 0; i_106457 < m_33388; i_106457++) {
                            double eta_p_106461 = ((double *) mem_108629.mem)[i_106457];
                            double eta_p_106462 = ((double *) mem_param_108627.mem)[i_106457];
                            bool zgze_res_106464 = exp_absorb_cutoff_33394 <= eta_p_106461;
                            bool zl_res_106465 = eta_p_106461 < zs_res_105098;
                            bool x_106466 = !zgze_res_106464;
                            bool y_106467 = zl_res_106465 && x_106466;
                            bool cond_106468 = zgze_res_106464 || y_106467;
                            int64_t binop_y_108719 = i_106457 * ext_108684;
                            int64_t lmad_ext_108720 = ext_108686 + binop_y_108719;
                            int64_t ext_108722;
                            
                            if (cond_106468) {
                                ext_108722 = (int64_t) 0;
                            } else {
                                ext_108722 = lmad_ext_108720;
                            }
                            
                            int64_t ext_108721;
                            
                            if (cond_106468) {
                                ext_108721 = (int64_t) 1;
                            } else {
                                ext_108721 = ext_108685;
                            }
                            
                            double rescale_res_106469;
                            double rescale_res_106470;
                            
                            if (cond_106468) {
                                double log_res_106472 = futrts_log64(eta_p_106461);
                                double sqrt_res_106473 = futrts_sqrt64(eta_p_106461);
                                double zs_res_106474 = log_res_106472 / 2.0;
                                double zp_res_106475 = eta_p_106462 + zs_res_106474;
                                
                                if (memblock_alloc(ctx, &mem_108712, bytes_107622, "mem_108712")) {
                                    err = 1;
                                    goto cleanup;
                                }
                                for (int64_t i_106478 = 0; i_106478 < m_33388; i_106478++) {
                                    double eta_p_106480 = ((double *) ext_mem_108687.mem)[ext_108686 + (i_106478 * ext_108685 + i_106457 * ext_108684)];
                                    double zt_res_106481 = sqrt_res_106473 * eta_p_106480;
                                    
                                    ((double *) mem_108712.mem)[i_106478] = zt_res_106481;
                                }
                                if (memblock_set(ctx, &ext_mem_108723, &mem_108712, "mem_108712") != 0)
                                    return 1;
                                rescale_res_106469 = sqrt_res_106473;
                                rescale_res_106470 = zp_res_106475;
                            } else {
                                if (memblock_set(ctx, &ext_mem_108723, &ext_mem_108687, "ext_mem_108687") != 0)
                                    return 1;
                                rescale_res_106469 = eta_p_106461;
                                rescale_res_106470 = eta_p_106462;
                            }
                            ((double *) mem_108695.mem)[i_106457] = rescale_res_106469;
                            ((double *) mem_108697.mem)[i_106457] = rescale_res_106470;
                            lmad_copy_8b(ctx, 1, (uint64_t *) mem_108700.mem, i_106457 * m_33388, (int64_t []) {(int64_t) 1}, (uint64_t *) ext_mem_108723.mem, ext_108722, (int64_t []) {ext_108721}, (int64_t []) {m_33388});
                            if (memblock_unref(ctx, &ext_mem_108723, "ext_mem_108723") != 0)
                                return 1;
                        }
                        if (memblock_set(ctx, &ext_mem_108743, &mem_108695, "mem_108695") != 0)
                            return 1;
                        if (memblock_set(ctx, &ext_mem_108740, &mem_108697, "mem_108697") != 0)
                            return 1;
                        if (memblock_set(ctx, &ext_mem_108737, &mem_108700, "mem_108700") != 0)
                            return 1;
                    } else {
                        if (memblock_set(ctx, &ext_mem_108743, &mem_108629, "mem_108629") != 0)
                            return 1;
                        if (memblock_set(ctx, &ext_mem_108740, &mem_param_108627, "mem_param_108627") != 0)
                            return 1;
                        if (memblock_set(ctx, &ext_mem_108737, &ext_mem_108687, "ext_mem_108687") != 0)
                            return 1;
                    }
                    if (memblock_unref(ctx, &mem_108629, "mem_108629") != 0)
                        return 1;
                    if (memblock_unref(ctx, &ext_mem_108687, "ext_mem_108687") != 0)
                        return 1;
                    
                    bool defunc_0_reduce_res_106487;
                    bool redout_106489 = 1;
                    
                    for (int64_t i_106488 = 0; i_106488 < m_33388; i_106488++) {
                        double eta_p_106490 = ((double *) ext_mem_108693.mem)[i_106488];
                        bool isnan_res_106491 = futrts_isnan64(eta_p_106490);
                        bool not_res_106492 = !isnan_res_106491;
                        bool x_106495 = redout_106489 && not_res_106492;
                        bool redout_tmp_109619 = x_106495;
                        
                        redout_106489 = redout_tmp_109619;
                    }
                    defunc_0_reduce_res_106487 = redout_106489;
                    
                    bool loop_cond_106496;
                    
                    if (defunc_0_reduce_res_106487) {
                        bool defunc_0_reduce_comm_res_106498;
                        bool redout_106500 = 0;
                        
                        for (int64_t i_106499 = 0; i_106499 < m_33388; i_106499++) {
                            double eta_p_106501 = ((double *) ext_mem_108693.mem)[i_106499];
                            double eta_p_106502 = ((double *) mem_param_108618.mem)[i_106499];
                            double zt_res_106503 = zp_res_105898 * eta_p_106501;
                            bool zgze_res_106504 = eta_p_106502 <= zt_res_106503;
                            double zt_res_106505 = zp_res_105898 * eta_p_106502;
                            bool zgze_res_106506 = eta_p_106501 <= zt_res_106505;
                            bool x_106507 = zgze_res_106504 && zgze_res_106506;
                            bool not_res_106508 = !x_106507;
                            bool defunc_0_op_res_106511 = redout_106500 || not_res_106508;
                            bool redout_tmp_109620 = defunc_0_op_res_106511;
                            
                            redout_106500 = redout_tmp_109620;
                        }
                        defunc_0_reduce_comm_res_106498 = redout_106500;
                        loop_cond_106496 = defunc_0_reduce_comm_res_106498;
                    } else {
                        loop_cond_106496 = 0;
                    }
                    if (memblock_set(ctx, &mem_param_tmp_109589, &ext_mem_108737, "ext_mem_108737") != 0)
                        return 1;
                    if (memblock_set(ctx, &mem_param_tmp_109590, &ext_mem_108693, "ext_mem_108693") != 0)
                        return 1;
                    if (memblock_set(ctx, &mem_param_tmp_109591, &ext_mem_108743, "ext_mem_108743") != 0)
                        return 1;
                    if (memblock_set(ctx, &mem_param_tmp_109592, &ext_mem_108690, "ext_mem_108690") != 0)
                        return 1;
                    if (memblock_set(ctx, &mem_param_tmp_109593, &ext_mem_108740, "ext_mem_108740") != 0)
                        return 1;
                    
                    int64_t ctx_param_ext_tmp_109594 = ext_108736;
                    int64_t ctx_param_ext_tmp_109595 = ext_108735;
                    int64_t ctx_param_ext_tmp_109596 = ext_108734;
                    bool loop_while_tmp_109597 = loop_cond_106496;
                    
                    if (memblock_set(ctx, &mem_param_108615, &mem_param_tmp_109589, "mem_param_tmp_109589") != 0)
                        return 1;
                    if (memblock_set(ctx, &mem_param_108618, &mem_param_tmp_109590, "mem_param_tmp_109590") != 0)
                        return 1;
                    if (memblock_set(ctx, &mem_param_108621, &mem_param_tmp_109591, "mem_param_tmp_109591") != 0)
                        return 1;
                    if (memblock_set(ctx, &mem_param_108624, &mem_param_tmp_109592, "mem_param_tmp_109592") != 0)
                        return 1;
                    if (memblock_set(ctx, &mem_param_108627, &mem_param_tmp_109593, "mem_param_tmp_109593") != 0)
                        return 1;
                    ctx_param_ext_108612 = ctx_param_ext_tmp_109594;
                    ctx_param_ext_108613 = ctx_param_ext_tmp_109595;
                    ctx_param_ext_108614 = ctx_param_ext_tmp_109596;
                    loop_while_106324 = loop_while_tmp_109597;
                }
                if (memblock_set(ctx, &ext_mem_108759, &mem_param_108615, "mem_param_108615") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108758, &mem_param_108618, "mem_param_108618") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108757, &mem_param_108621, "mem_param_108621") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108756, &mem_param_108624, "mem_param_108624") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108755, &mem_param_108627, "mem_param_108627") != 0)
                    return 1;
                ext_108754 = ctx_param_ext_108612;
                ext_108753 = ctx_param_ext_108613;
                ext_108752 = ctx_param_ext_108614;
                algo5_core_loop_res_f_res_106318 = loop_while_106324;
                if (memblock_unref(ctx, &ext_mem_108558, "ext_mem_108558") != 0)
                    return 1;
                if (memblock_unref(ctx, &ext_mem_108561, "ext_mem_108561") != 0)
                    return 1;
                if (memblock_unref(ctx, &ext_mem_108605, "ext_mem_108605") != 0)
                    return 1;
                if (memblock_unref(ctx, &ext_mem_108608, "ext_mem_108608") != 0)
                    return 1;
                if (memblock_unref(ctx, &ext_mem_108611, "ext_mem_108611") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108775, &ext_mem_108759, "ext_mem_108759") != 0)
                    return 1;
                ext_108774 = ext_108754;
                ext_108773 = ext_108753;
                ext_108772 = ext_108752;
                if (memblock_set(ctx, &ext_mem_108771, &ext_mem_108758, "ext_mem_108758") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108768, &ext_mem_108757, "ext_mem_108757") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108765, &ext_mem_108756, "ext_mem_108756") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_108762, &ext_mem_108755, "ext_mem_108755") != 0)
                    return 1;
            }
            if (memblock_unref(ctx, &ext_mem_108487, "ext_mem_108487") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108488, "ext_mem_108488") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108489, "ext_mem_108489") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108490, "ext_mem_108490") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108491, "ext_mem_108491") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108492, "ext_mem_108492") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108493, "ext_mem_108493") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108494, "ext_mem_108494") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108495, "ext_mem_108495") != 0)
                return 1;
            if (memblock_alloc(ctx, &mem_108777, bytes_107622, "mem_108777")) {
                err = 1;
                goto cleanup;
            }
            if (memblock_alloc(ctx, &mem_108782, bytes_107622, "mem_108782")) {
                err = 1;
                goto cleanup;
            }
            
            double defunc_res_106515;
            double redout_106520 = 0.0;
            
            for (int64_t i_106519 = 0; i_106519 < m_33388; i_106519++) {
                double eta_p_106524 = ((double *) ext_mem_108768.mem)[i_106519];
                double eta_p_106525 = ((double *) ext_mem_108762.mem)[i_106519];
                double eta_p_106527 = ((double *) ext_mem_108771.mem)[i_106519];
                double eta_p_106528 = ((double *) ext_mem_108765.mem)[i_106519];
                double log_res_106529 = futrts_log64(eta_p_106527);
                double zp_res_106530 = eta_p_106528 + log_res_106529;
                double defunc_res_106532;
                double redout_106535 = 0.0;
                
                for (int64_t i_106534 = 0; i_106534 < m_33388; i_106534++) {
                    double eta_p_106537 = ((double *) ext_mem_108775.mem)[ext_108774 + (i_106519 * ext_108773 + i_106534 * ext_108772)];
                    double eta_p_wasfree_106538 = ((double *) ext_mem_108768.mem)[i_106534];
                    double zt_res_106539 = eta_p_106527 * eta_p_106537;
                    double zt_res_106540 = eta_p_wasfree_106538 * zt_res_106539;
                    double zp_res_106543 = redout_106535 + zt_res_106540;
                    
                    ((double *) mem_108780)[i_106519 * m_33388 + i_106534] = zt_res_106540;
                    
                    double redout_tmp_109625 = zp_res_106543;
                    
                    redout_106535 = redout_tmp_109625;
                }
                defunc_res_106532 = redout_106535;
                
                double log_res_106545 = futrts_log64(eta_p_106524);
                double zp_res_106546 = eta_p_106525 + log_res_106545;
                double zp_res_106549 = redout_106520 + defunc_res_106532;
                
                ((double *) mem_108777.mem)[i_106519] = zp_res_106546;
                ((double *) mem_108782.mem)[i_106519] = zp_res_106530;
                
                double redout_tmp_109621 = zp_res_106549;
                
                redout_106520 = redout_tmp_109621;
            }
            defunc_res_106515 = redout_106520;
            if (memblock_unref(ctx, &ext_mem_108762, "ext_mem_108762") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108765, "ext_mem_108765") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108768, "ext_mem_108768") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108771, "ext_mem_108771") != 0)
                return 1;
            if (memblock_unref(ctx, &ext_mem_108775, "ext_mem_108775") != 0)
                return 1;
            
            bool zg_res_106553 = 0.0 < defunc_res_106515;
            double zs_res_106554 = defunc_res_105503 / defunc_res_106515;
            double sqrt_res_106555 = futrts_sqrt64(zs_res_106554);
            double descent_res_106559;
            
            if (zg_res_106553) {
                if (mem_108817_cached_sizze_109793 < bytes_107622) {
                    err = lexical_realloc(ctx, &mem_108817, &mem_108817_cached_sizze_109793, bytes_107622);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                if (mem_108819_cached_sizze_109794 < bytes_107622) {
                    err = lexical_realloc(ctx, &mem_108819, &mem_108819_cached_sizze_109794, bytes_107622);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                if (mem_108821_cached_sizze_109795 < bytes_107622) {
                    err = lexical_realloc(ctx, &mem_108821, &mem_108821_cached_sizze_109795, bytes_107622);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                
                double defunc_res_106563;
                double defunc_res_106564;
                double defunc_res_106565;
                double redout_106570;
                double redout_106571;
                double redout_106572;
                
                redout_106570 = 0.0;
                redout_106571 = 0.0;
                redout_106572 = 0.0;
                for (int64_t i_106569 = 0; i_106569 < m_33388; i_106569++) {
                    double x_106576 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_106569];
                    double log_res_106578 = futrts_log64(x_106576);
                    double defunc_res_106579;
                    double defunc_res_106580;
                    double defunc_res_106581;
                    double redout_106583;
                    double redout_106584;
                    double redout_106585;
                    
                    redout_106583 = 0.0;
                    redout_106584 = 0.0;
                    redout_106585 = 0.0;
                    for (int64_t i_106582 = 0; i_106582 < m_33388; i_106582++) {
                        double x_106586 = ((double *) mem_param_108095.mem)[i_106582 * m_33388 + i_106569];
                        double zp_res_106593 = redout_106583 + x_106586;
                        double zp_res_106594 = redout_106584 + x_106586;
                        double zp_res_106595 = redout_106585 + x_106586;
                        double redout_tmp_109633 = zp_res_106593;
                        double redout_tmp_109634 = zp_res_106594;
                        double redout_tmp_109635 = zp_res_106595;
                        
                        redout_106583 = redout_tmp_109633;
                        redout_106584 = redout_tmp_109634;
                        redout_106585 = redout_tmp_109635;
                    }
                    defunc_res_106579 = redout_106583;
                    defunc_res_106580 = redout_106584;
                    defunc_res_106581 = redout_106585;
                    
                    bool zeze_res_106596 = defunc_res_106579 == 0.0;
                    double klu_res_106597;
                    
                    if (zeze_res_106596) {
                        klu_res_106597 = 0.0;
                    } else {
                        double zs_res_106598 = defunc_res_106579 / x_106576;
                        double log_res_106599 = futrts_log64(zs_res_106598);
                        double zt_res_106600 = defunc_res_106579 * log_res_106599;
                        
                        klu_res_106597 = zt_res_106600;
                    }
                    
                    double zp_res_106607 = redout_106570 + klu_res_106597;
                    double zp_res_106608 = redout_106571 + x_106576;
                    double zp_res_106609 = redout_106572 + defunc_res_106581;
                    
                    ((double *) mem_108817)[i_106569] = defunc_res_106580;
                    ((double *) mem_108819)[i_106569] = defunc_res_106579;
                    ((double *) mem_108821)[i_106569] = log_res_106578;
                    
                    double redout_tmp_109627 = zp_res_106607;
                    double redout_tmp_109628 = zp_res_106608;
                    double redout_tmp_109629 = zp_res_106609;
                    
                    redout_106570 = redout_tmp_109627;
                    redout_106571 = redout_tmp_109628;
                    redout_106572 = redout_tmp_109629;
                }
                defunc_res_106563 = redout_106570;
                defunc_res_106564 = redout_106571;
                defunc_res_106565 = redout_106572;
                
                double zm_res_106613 = defunc_res_106563 - defunc_res_106565;
                double zt_res_106614 = 2.0 * zm_res_106613;
                double zt_res_106615 = 2.0 * defunc_res_106565;
                
                if (mem_108842_cached_sizze_109796 < bytes_107636) {
                    err = lexical_realloc(ctx, &mem_108842, &mem_108842_cached_sizze_109796, bytes_107636);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                for (int64_t i_106618 = 0; i_106618 < m_33388; i_106618++) {
                    double eta_p_106620 = ((double *) mem_108819)[i_106618];
                    double eta_p_106621 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_106618];
                    double log_res_106622 = futrts_log64(eta_p_106620);
                    double log_res_106623 = futrts_log64(eta_p_106621);
                    double zm_res_106624 = log_res_106622 - log_res_106623;
                    double zp_res_106625 = 1.0 + zm_res_106624;
                    double fma_res_106626 = futrts_fma64(zt_res_106615, zp_res_106625, zt_res_106614);
                    
                    for (int64_t nest_i_109637 = 0; nest_i_109637 < m_33388; nest_i_109637++) {
                        ((double *) mem_108842)[i_106618 * m_33388 + nest_i_109637] = fma_res_106626;
                    }
                }
                if (mem_108854_cached_sizze_109797 < bytes_107622) {
                    err = lexical_realloc(ctx, &mem_108854, &mem_108854_cached_sizze_109797, bytes_107622);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                if (mem_108856_cached_sizze_109798 < bytes_107622) {
                    err = lexical_realloc(ctx, &mem_108856, &mem_108856_cached_sizze_109798, bytes_107622);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                
                double defunc_res_106631;
                double defunc_res_106632;
                double defunc_res_106633;
                double defunc_res_106634;
                double redout_106638;
                double redout_106639;
                double redout_106640;
                double redout_106641;
                
                redout_106638 = 0.0;
                redout_106639 = 0.0;
                redout_106640 = 0.0;
                redout_106641 = 0.0;
                for (int64_t i_106637 = 0; i_106637 < m_33388; i_106637++) {
                    double eta_p_106645 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_106637];
                    double defunc_res_106646;
                    double defunc_res_106647;
                    double defunc_res_106648;
                    double defunc_res_106649;
                    double defunc_res_106650;
                    double redout_106652;
                    double redout_106653;
                    double redout_106654;
                    double redout_106655;
                    double redout_106656;
                    
                    redout_106652 = 0.0;
                    redout_106653 = 0.0;
                    redout_106654 = 0.0;
                    redout_106655 = 0.0;
                    redout_106656 = 0.0;
                    for (int64_t i_106651 = 0; i_106651 < m_33388; i_106651++) {
                        double x_106657 = ((double *) mem_param_108095.mem)[i_106637 * m_33388 + i_106651];
                        double eta_p_106658 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_106651];
                        double zt_res_106659 = eta_p_106645 * eta_p_106658;
                        bool zeze_res_106660 = x_106657 == 0.0;
                        double klu_res_106661;
                        
                        if (zeze_res_106660) {
                            klu_res_106661 = 0.0;
                        } else {
                            double zs_res_106662 = x_106657 / zt_res_106659;
                            double log_res_106663 = futrts_log64(zs_res_106662);
                            double zt_res_106664 = x_106657 * log_res_106663;
                            
                            klu_res_106661 = zt_res_106664;
                        }
                        
                        double zp_res_106675 = redout_106652 + x_106657;
                        double zp_res_106676 = redout_106653 + klu_res_106661;
                        double zp_res_106677 = redout_106654 + x_106657;
                        double zp_res_106678 = redout_106655 + x_106657;
                        double zp_res_106679 = redout_106656 + x_106657;
                        double redout_tmp_109644 = zp_res_106675;
                        double redout_tmp_109645 = zp_res_106676;
                        double redout_tmp_109646 = zp_res_106677;
                        double redout_tmp_109647 = zp_res_106678;
                        double redout_tmp_109648 = zp_res_106679;
                        
                        redout_106652 = redout_tmp_109644;
                        redout_106653 = redout_tmp_109645;
                        redout_106654 = redout_tmp_109646;
                        redout_106655 = redout_tmp_109647;
                        redout_106656 = redout_tmp_109648;
                    }
                    defunc_res_106646 = redout_106652;
                    defunc_res_106647 = redout_106653;
                    defunc_res_106648 = redout_106654;
                    defunc_res_106649 = redout_106655;
                    defunc_res_106650 = redout_106656;
                    
                    bool zeze_res_106680 = defunc_res_106650 == 0.0;
                    double klu_res_106681;
                    
                    if (zeze_res_106680) {
                        klu_res_106681 = 0.0;
                    } else {
                        double zs_res_106682 = defunc_res_106650 / eta_p_106645;
                        double log_res_106683 = futrts_log64(zs_res_106682);
                        double zt_res_106684 = defunc_res_106650 * log_res_106683;
                        
                        klu_res_106681 = zt_res_106684;
                    }
                    
                    double zp_res_106693 = redout_106638 + defunc_res_106646;
                    double zp_res_106694 = redout_106639 + defunc_res_106647;
                    double zp_res_106695 = redout_106640 + defunc_res_106649;
                    double zp_res_106696 = redout_106641 + klu_res_106681;
                    
                    ((double *) mem_108854)[i_106637] = defunc_res_106650;
                    ((double *) mem_108856)[i_106637] = defunc_res_106648;
                    
                    double redout_tmp_109638 = zp_res_106693;
                    double redout_tmp_109639 = zp_res_106694;
                    double redout_tmp_109640 = zp_res_106695;
                    double redout_tmp_109641 = zp_res_106696;
                    
                    redout_106638 = redout_tmp_109638;
                    redout_106639 = redout_tmp_109639;
                    redout_106640 = redout_tmp_109640;
                    redout_106641 = redout_tmp_109641;
                }
                defunc_res_106631 = redout_106638;
                defunc_res_106632 = redout_106639;
                defunc_res_106633 = redout_106640;
                defunc_res_106634 = redout_106641;
                
                double zm_res_106699 = defunc_res_106634 - defunc_res_106633;
                double zt_res_106700 = 2.0 * zm_res_106699;
                double zt_res_106701 = 2.0 * defunc_res_106633;
                
                if (mem_108870_cached_sizze_109799 < bytes_107622) {
                    err = lexical_realloc(ctx, &mem_108870, &mem_108870_cached_sizze_109799, bytes_107622);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                for (int64_t i_106704 = 0; i_106704 < m_33388; i_106704++) {
                    double defunc_0_reduce_res_106707;
                    double redout_106709 = 0.0;
                    
                    for (int64_t i_106708 = 0; i_106708 < m_33388; i_106708++) {
                        double eta_p_106710 = ((double *) A_mem_107604.mem)[lifted_lambda_res_104626 * (m_33388 * m_33388) + i_106704 * m_33388 + i_106708];
                        double eta_p_106711 = ((double *) mem_108817)[i_106708];
                        double zt_res_106712 = eta_p_106710 * eta_p_106710;
                        double zt_res_106713 = eta_p_106711 * zt_res_106712;
                        double zp_res_106716 = redout_106709 + zt_res_106713;
                        double redout_tmp_109650 = zp_res_106716;
                        
                        redout_106709 = redout_tmp_109650;
                    }
                    defunc_0_reduce_res_106707 = redout_106709;
                    ((double *) mem_108870)[i_106704] = defunc_0_reduce_res_106707;
                }
                
                double zt_res_106718 = 2.0 * defunc_res_106631;
                double zt_res_106719 = 2.0 * defunc_res_106632;
                
                if (mem_108878_cached_sizze_109800 < bytes_107622) {
                    err = lexical_realloc(ctx, &mem_108878, &mem_108878_cached_sizze_109800, bytes_107622);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                if (mem_108881_cached_sizze_109801 < bytes_107636) {
                    err = lexical_realloc(ctx, &mem_108881, &mem_108881_cached_sizze_109801, bytes_107636);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                if (memblock_alloc(ctx, &mem_108884, bytes_107636, "mem_108884")) {
                    err = 1;
                    goto cleanup;
                }
                if (mem_108897_cached_sizze_109802 < bytes_107622) {
                    err = lexical_realloc(ctx, &mem_108897, &mem_108897_cached_sizze_109802, bytes_107622);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                
                double defunc_res_106726;
                double defunc_res_106727;
                double defunc_res_106728;
                double defunc_res_106729;
                double defunc_res_106730;
                double redout_106735;
                double redout_106736;
                double redout_106737;
                double redout_106738;
                double redout_106739;
                
                redout_106735 = 0.0;
                redout_106736 = 0.0;
                redout_106737 = 0.0;
                redout_106738 = 0.0;
                redout_106739 = 0.0;
                for (int64_t i_106734 = 0; i_106734 < m_33388; i_106734++) {
                    double x_106743 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_106734];
                    double eta_p_106747 = ((double *) mem_108854)[i_106734];
                    double log_res_106751 = futrts_log64(x_106743);
                    double log_res_106752 = futrts_log64(eta_p_106747);
                    double zm_res_106753 = log_res_106752 - log_res_106751;
                    double zp_res_106754 = 1.0 + zm_res_106753;
                    double fma_res_106755 = futrts_fma64(zt_res_106701, zp_res_106754, zt_res_106700);
                    
                    for (int64_t i_106758 = 0; i_106758 < m_33388; i_106758++) {
                        double defunc_0_reduce_res_106761;
                        double redout_106763 = 0.0;
                        
                        for (int64_t i_106762 = 0; i_106762 < m_33388; i_106762++) {
                            double eta_p_106764 = ((double *) A_mem_107604.mem)[tmp_104620 * (m_33388 * m_33388) + i_106734 * m_33388 + i_106762];
                            double eta_p_106765 = ((double *) mem_param_108095.mem)[i_106762 * m_33388 + i_106758];
                            double zt_res_106766 = eta_p_106764 * eta_p_106765;
                            double zp_res_106769 = redout_106763 + zt_res_106766;
                            double redout_tmp_109660 = zp_res_106769;
                            
                            redout_106763 = redout_tmp_109660;
                        }
                        defunc_0_reduce_res_106761 = redout_106763;
                        ((double *) mem_108897)[i_106758] = defunc_0_reduce_res_106761;
                    }
                    
                    double defunc_0_reduce_res_106771;
                    double redout_106773 = 0.0;
                    
                    for (int64_t i_106772 = 0; i_106772 < m_33388; i_106772++) {
                        double eta_p_106774 = ((double *) A_mem_107604.mem)[tmp_104620 * (m_33388 * m_33388) + i_106734 * m_33388 + i_106772];
                        double eta_p_106775 = ((double *) mem_108856)[i_106772];
                        double zt_res_106776 = eta_p_106774 * eta_p_106774;
                        double zt_res_106777 = eta_p_106775 * zt_res_106776;
                        double zp_res_106780 = redout_106773 + zt_res_106777;
                        double redout_tmp_109661 = zp_res_106780;
                        
                        redout_106773 = redout_tmp_109661;
                    }
                    defunc_0_reduce_res_106771 = redout_106773;
                    
                    double defunc_0_reduce_res_106783;
                    double defunc_res_106784;
                    double defunc_res_106785;
                    double defunc_res_106786;
                    double redout_106790;
                    double redout_106791;
                    double redout_106792;
                    double redout_106793;
                    
                    redout_106790 = 0.0;
                    redout_106791 = 0.0;
                    redout_106792 = 0.0;
                    redout_106793 = 0.0;
                    for (int64_t i_106789 = 0; i_106789 < m_33388; i_106789++) {
                        double eta_p_106796 = ((double *) mem_108780)[i_106734 * m_33388 + i_106789];
                        double eta_p_106797 = ((double *) mem_param_108095.mem)[i_106734 * m_33388 + i_106789];
                        double eta_p_106798 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_106789];
                        double eta_p_wasfree_106799 = ((double *) mem_108821)[i_106789];
                        double eta_p_wasfree_106801 = ((double *) mem_108870)[i_106789];
                        double eta_p_106802 = ((double *) mem_108842)[i_106789 * m_33388 + i_106734];
                        double zt_res_106803 = sqrt_res_106555 * eta_p_106796;
                        double zm_res_106804 = zt_res_106803 - eta_p_106797;
                        double log_res_106805 = futrts_log64(eta_p_106797);
                        double zm_res_106806 = log_res_106805 - eta_p_wasfree_106799;
                        double zm_res_106807 = zm_res_106806 - log_res_106751;
                        double fma_res_106808 = futrts_fma64(zt_res_106718, zm_res_106807, zt_res_106719);
                        double defunc_0_reduce_res_106809;
                        double redout_106811 = 0.0;
                        
                        for (int64_t i_106810 = 0; i_106810 < m_33388; i_106810++) {
                            double eta_p_106812 = ((double *) mem_108897)[i_106810];
                            double eta_p_106813 = ((double *) A_mem_107604.mem)[lifted_lambda_res_104626 * (m_33388 * m_33388) + i_106810 * m_33388 + i_106789];
                            double zt_res_106814 = eta_p_106812 * eta_p_106813;
                            double zp_res_106817 = redout_106811 + zt_res_106814;
                            double redout_tmp_109668 = zp_res_106817;
                            
                            redout_106811 = redout_tmp_109668;
                        }
                        defunc_0_reduce_res_106809 = redout_106811;
                        
                        double zt_res_106818 = -2.0 * defunc_0_reduce_res_106809;
                        double zp_res_106819 = defunc_0_reduce_res_106771 + zt_res_106818;
                        double zp_res_106820 = eta_p_wasfree_106801 + zp_res_106819;
                        double zt_res_106821 = 2.0 * zp_res_106820;
                        double fma_res_106822 = futrts_fma64(fma_res_106755, rho1_33389, zt_res_106821);
                        double fma_res_106823 = futrts_fma64(eta_p_106802, rho2_33390, fma_res_106822);
                        double fma_res_106824 = futrts_fma64(fma_res_106808, eps_33391, fma_res_106823);
                        double max_res_106825 = fmax64(-1.0e100, fma_res_106824);
                        double zt_res_106826 = zm_res_106804 * max_res_106825;
                        double zp_res_106827 = eta_p_106797 + zm_res_106804;
                        double zt_res_106828 = x_106743 * eta_p_106798;
                        bool zeze_res_106829 = zp_res_106827 == 0.0;
                        double klu_res_106830;
                        
                        if (zeze_res_106829) {
                            klu_res_106830 = 0.0;
                        } else {
                            double zs_res_106831 = zp_res_106827 / zt_res_106828;
                            double log_res_106832 = futrts_log64(zs_res_106831);
                            double zt_res_106833 = zp_res_106827 * log_res_106832;
                            
                            klu_res_106830 = zt_res_106833;
                        }
                        
                        double zp_res_106842 = redout_106790 + zt_res_106826;
                        double zp_res_106843 = redout_106791 + klu_res_106830;
                        double zp_res_106844 = redout_106792 + zp_res_106827;
                        double zp_res_106845 = redout_106793 + zp_res_106827;
                        
                        ((double *) mem_108881)[i_106734 * m_33388 + i_106789] = zp_res_106827;
                        ((double *) mem_108884.mem)[i_106734 * m_33388 + i_106789] = zm_res_106804;
                        
                        double redout_tmp_109662 = zp_res_106842;
                        double redout_tmp_109663 = zp_res_106843;
                        double redout_tmp_109664 = zp_res_106844;
                        double redout_tmp_109665 = zp_res_106845;
                        
                        redout_106790 = redout_tmp_109662;
                        redout_106791 = redout_tmp_109663;
                        redout_106792 = redout_tmp_109664;
                        redout_106793 = redout_tmp_109665;
                    }
                    defunc_0_reduce_res_106783 = redout_106790;
                    defunc_res_106784 = redout_106791;
                    defunc_res_106785 = redout_106792;
                    defunc_res_106786 = redout_106793;
                    
                    bool zeze_res_106848 = defunc_res_106786 == 0.0;
                    double klu_res_106849;
                    
                    if (zeze_res_106848) {
                        klu_res_106849 = 0.0;
                    } else {
                        double zs_res_106850 = defunc_res_106786 / x_106743;
                        double log_res_106851 = futrts_log64(zs_res_106850);
                        double zt_res_106852 = defunc_res_106786 * log_res_106851;
                        
                        klu_res_106849 = zt_res_106852;
                    }
                    
                    double zp_res_106863 = redout_106735 + defunc_0_reduce_res_106783;
                    double zp_res_106864 = redout_106736 + klu_res_106849;
                    double zp_res_106865 = redout_106737 + defunc_res_106786;
                    double zp_res_106866 = redout_106738 + defunc_res_106784;
                    double zp_res_106867 = redout_106739 + x_106743;
                    
                    ((double *) mem_108878)[i_106734] = defunc_res_106785;
                    
                    double redout_tmp_109651 = zp_res_106863;
                    double redout_tmp_109652 = zp_res_106864;
                    double redout_tmp_109653 = zp_res_106865;
                    double redout_tmp_109654 = zp_res_106866;
                    double redout_tmp_109655 = zp_res_106867;
                    
                    redout_106735 = redout_tmp_109651;
                    redout_106736 = redout_tmp_109652;
                    redout_106737 = redout_tmp_109653;
                    redout_106738 = redout_tmp_109654;
                    redout_106739 = redout_tmp_109655;
                }
                defunc_res_106726 = redout_106735;
                defunc_res_106727 = redout_106736;
                defunc_res_106728 = redout_106737;
                defunc_res_106729 = redout_106738;
                defunc_res_106730 = redout_106739;
                
                bool zl_res_106871 = defunc_res_106726 < 0.0;
                bool assert_c_106872;
                
                if (!zl_res_106871) {
                    set_error(ctx, msgprintf("Error: %s\n\nBacktrace:\n%s", "Assertion is false: M.((gradient) M.< zero)", "-> #0  common.fut:220:7-221:22\n   #1  unbalanced_gw_core.fut:393:15-78\n   #2  unbalanced_gw_core.fut:402:7-11\n   #3  unbalanced_gw.fut:154:9-156:83\n   #4  /prelude/functional.fut:9:44-45\n   #5  unbalanced_gw.fut:152:6-156:84\n"));
                    err = FUTHARK_PROGRAM_ERROR;
                    goto cleanup;
                }
                if (mem_108932_cached_sizze_109803 < bytes_107622) {
                    err = lexical_realloc(ctx, &mem_108932, &mem_108932_cached_sizze_109803, bytes_107622);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                
                double defunc_res_106875;
                double redout_106878 = 0.0;
                
                for (int64_t i_106877 = 0; i_106877 < m_33388; i_106877++) {
                    double eta_p_106881 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_106877];
                    double defunc_res_106882;
                    double defunc_res_106883;
                    double redout_106885;
                    double redout_106886;
                    
                    redout_106885 = 0.0;
                    redout_106886 = 0.0;
                    for (int64_t i_106884 = 0; i_106884 < m_33388; i_106884++) {
                        double x_106887 = ((double *) mem_108881)[i_106884 * m_33388 + i_106877];
                        double zp_res_106892 = redout_106885 + x_106887;
                        double zp_res_106893 = redout_106886 + x_106887;
                        double redout_tmp_109671 = zp_res_106892;
                        double redout_tmp_109672 = zp_res_106893;
                        
                        redout_106885 = redout_tmp_109671;
                        redout_106886 = redout_tmp_109672;
                    }
                    defunc_res_106882 = redout_106885;
                    defunc_res_106883 = redout_106886;
                    
                    bool zeze_res_106894 = defunc_res_106883 == 0.0;
                    double klu_res_106895;
                    
                    if (zeze_res_106894) {
                        klu_res_106895 = 0.0;
                    } else {
                        double zs_res_106896 = defunc_res_106883 / eta_p_106881;
                        double log_res_106897 = futrts_log64(zs_res_106896);
                        double zt_res_106898 = defunc_res_106883 * log_res_106897;
                        
                        klu_res_106895 = zt_res_106898;
                    }
                    
                    double zp_res_106901 = redout_106878 + klu_res_106895;
                    
                    ((double *) mem_108932)[i_106877] = defunc_res_106882;
                    
                    double redout_tmp_109669 = zp_res_106901;
                    
                    redout_106878 = redout_tmp_109669;
                }
                defunc_res_106875 = redout_106878;
                if (mem_108940_cached_sizze_109804 < bytes_107622) {
                    err = lexical_realloc(ctx, &mem_108940, &mem_108940_cached_sizze_109804, bytes_107622);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                
                double defunc_0_reduce_res_106903;
                double defunc_res_106904;
                double redout_106906;
                double redout_106907;
                
                redout_106906 = 0.0;
                redout_106907 = 0.0;
                for (int64_t i_106905 = 0; i_106905 < m_33388; i_106905++) {
                    double eta_p_106910 = ((double *) mem_108878)[i_106905];
                    double defunc_0_reduce_res_106911;
                    double redout_106913 = 0.0;
                    
                    for (int64_t i_106912 = 0; i_106912 < m_33388; i_106912++) {
                        double eta_p_106914 = ((double *) A_mem_107604.mem)[tmp_104620 * (m_33388 * m_33388) + i_106905 * m_33388 + i_106912];
                        double eta_p_106915 = ((double *) mem_108878)[i_106912];
                        double zt_res_106916 = eta_p_106914 * eta_p_106914;
                        double zt_res_106917 = eta_p_106915 * zt_res_106916;
                        double zp_res_106920 = redout_106913 + zt_res_106917;
                        double redout_tmp_109675 = zp_res_106920;
                        
                        redout_106913 = redout_tmp_109675;
                    }
                    defunc_0_reduce_res_106911 = redout_106913;
                    
                    double zt_res_106921 = eta_p_106910 * defunc_0_reduce_res_106911;
                    
                    for (int64_t i_106924 = 0; i_106924 < m_33388; i_106924++) {
                        double defunc_0_reduce_res_106927;
                        double redout_106929 = 0.0;
                        
                        for (int64_t i_106928 = 0; i_106928 < m_33388; i_106928++) {
                            double eta_p_106930 = ((double *) A_mem_107604.mem)[tmp_104620 * (m_33388 * m_33388) + i_106905 * m_33388 + i_106928];
                            double eta_p_106931 = ((double *) mem_108881)[i_106928 * m_33388 + i_106924];
                            double zt_res_106932 = eta_p_106930 * eta_p_106931;
                            double zp_res_106935 = redout_106929 + zt_res_106932;
                            double redout_tmp_109677 = zp_res_106935;
                            
                            redout_106929 = redout_tmp_109677;
                        }
                        defunc_0_reduce_res_106927 = redout_106929;
                        ((double *) mem_108940)[i_106924] = defunc_0_reduce_res_106927;
                    }
                    
                    double defunc_0_reduce_res_106937;
                    double redout_106939 = 0.0;
                    
                    for (int64_t i_106938 = 0; i_106938 < m_33388; i_106938++) {
                        double eta_p_106941 = ((double *) mem_108881)[i_106905 * m_33388 + i_106938];
                        double defunc_0_reduce_res_106942;
                        double redout_106944 = 0.0;
                        
                        for (int64_t i_106943 = 0; i_106943 < m_33388; i_106943++) {
                            double eta_p_106945 = ((double *) mem_108940)[i_106943];
                            double eta_p_106946 = ((double *) A_mem_107604.mem)[lifted_lambda_res_104626 * (m_33388 * m_33388) + i_106943 * m_33388 + i_106938];
                            double zt_res_106947 = eta_p_106945 * eta_p_106946;
                            double zp_res_106950 = redout_106944 + zt_res_106947;
                            double redout_tmp_109679 = zp_res_106950;
                            
                            redout_106944 = redout_tmp_109679;
                        }
                        defunc_0_reduce_res_106942 = redout_106944;
                        
                        double zt_res_106951 = eta_p_106941 * defunc_0_reduce_res_106942;
                        double zp_res_106954 = redout_106939 + zt_res_106951;
                        double redout_tmp_109678 = zp_res_106954;
                        
                        redout_106939 = redout_tmp_109678;
                    }
                    defunc_0_reduce_res_106937 = redout_106939;
                    
                    double zp_res_106959 = redout_106906 + zt_res_106921;
                    double zp_res_106960 = redout_106907 + defunc_0_reduce_res_106937;
                    double redout_tmp_109673 = zp_res_106959;
                    double redout_tmp_109674 = zp_res_106960;
                    
                    redout_106906 = redout_tmp_109673;
                    redout_106907 = redout_tmp_109674;
                }
                defunc_0_reduce_res_106903 = redout_106906;
                defunc_res_106904 = redout_106907;
                
                double defunc_0_reduce_res_106961;
                double redout_106963 = 0.0;
                
                for (int64_t i_106962 = 0; i_106962 < m_33388; i_106962++) {
                    double eta_p_106965 = ((double *) mem_108932)[i_106962];
                    double defunc_0_reduce_res_106966;
                    double redout_106968 = 0.0;
                    
                    for (int64_t i_106967 = 0; i_106967 < m_33388; i_106967++) {
                        double eta_p_106969 = ((double *) A_mem_107604.mem)[lifted_lambda_res_104626 * (m_33388 * m_33388) + i_106962 * m_33388 + i_106967];
                        double eta_p_106970 = ((double *) mem_108932)[i_106967];
                        double zt_res_106971 = eta_p_106969 * eta_p_106969;
                        double zt_res_106972 = eta_p_106970 * zt_res_106971;
                        double zp_res_106975 = redout_106968 + zt_res_106972;
                        double redout_tmp_109681 = zp_res_106975;
                        
                        redout_106968 = redout_tmp_109681;
                    }
                    defunc_0_reduce_res_106966 = redout_106968;
                    
                    double zt_res_106976 = eta_p_106965 * defunc_0_reduce_res_106966;
                    double zp_res_106979 = redout_106963 + zt_res_106976;
                    double redout_tmp_109680 = zp_res_106979;
                    
                    redout_106963 = redout_tmp_109680;
                }
                defunc_0_reduce_res_106961 = redout_106963;
                
                double zt_res_106980 = -2.0 * defunc_res_106904;
                double zp_res_106981 = defunc_0_reduce_res_106903 + zt_res_106980;
                double zp_res_106982 = defunc_0_reduce_res_106961 + zp_res_106981;
                double zt_res_106983 = eps_33391 * defunc_res_106729;
                double zt_res_106984 = rho1_33389 * defunc_res_106727;
                double zt_res_106985 = rho2_33390 * defunc_res_106875;
                double zp_res_106986 = zt_res_106983 + zt_res_106984;
                double zp_res_106987 = zt_res_106985 + zp_res_106986;
                double zt_res_106988 = 2.0 * zp_res_106987;
                double zt_res_106989 = defunc_res_106728 * zt_res_106988;
                double zp_res_106990 = zp_res_106982 + zt_res_106989;
                double zt_res_106991 = defunc_res_106728 * defunc_res_106728;
                double zt_res_106994 = zp_res_46827 * zt_res_106991;
                double zm_res_106995 = zp_res_106990 - zt_res_106994;
                double zt_res_106996 = defunc_res_106564 * defunc_res_106730;
                double zt_res_106997 = rho1_33389 * defunc_res_106730;
                double zt_res_106998 = defunc_res_106730 * zt_res_106997;
                double zt_res_106999 = rho2_33390 * defunc_res_106564;
                double zt_res_107000 = defunc_res_106564 * zt_res_106999;
                double zp_res_107001 = zt_res_106998 + zt_res_107000;
                double zt_res_107002 = eps_33391 * zt_res_106996;
                double zt_res_107003 = zt_res_106996 * zt_res_107002;
                double zp_res_107004 = zp_res_107001 + zt_res_107003;
                double zp_res_107005 = zm_res_106995 + zp_res_107004;
                double zm_res_107006 = zp_res_107005 - loss_105498;
                bool zgze_res_107007 = -1.0 <= zm_res_107006;
                double zs_res_107008 = zm_res_107006 / defunc_res_106726;
                bool zlze_res_107009 = zs_res_107008 <= 0.5;
                bool x_107010 = zgze_res_107007 && zlze_res_107009;
                double defunc_res_107011;
                
                if (x_107010) {
                    double x_107012;
                    double redout_107014 = 0.0;
                    
                    for (int64_t i_107013 = 0; i_107013 < m_33388; i_107013++) {
                        double x_107015 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_107013];
                        double zp_res_107018 = redout_107014 + x_107015;
                        double redout_tmp_109682 = zp_res_107018;
                        
                        redout_107014 = redout_tmp_109682;
                    }
                    x_107012 = redout_107014;
                    defunc_res_107011 = x_107012;
                } else {
                    defunc_res_107011 = 0.0;
                }
                
                double defunc_res_107019;
                
                if (x_107010) {
                    double x_107020;
                    double redout_107022 = 0.0;
                    
                    for (int64_t i_107021 = 0; i_107021 < m_33388; i_107021++) {
                        double x_107023 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_107021];
                        double zp_res_107026 = redout_107022 + x_107023;
                        double redout_tmp_109683 = zp_res_107026;
                        
                        redout_107022 = redout_tmp_109683;
                    }
                    x_107020 = redout_107022;
                    defunc_res_107019 = x_107020;
                } else {
                    defunc_res_107019 = 0.0;
                }
                
                double zt_res_107027 = defunc_res_107011 * defunc_res_107019;
                double zt_res_107028 = rho1_33389 * defunc_res_107011;
                double zt_res_107029 = defunc_res_107011 * zt_res_107028;
                double zt_res_107030 = rho2_33390 * defunc_res_107019;
                double zt_res_107031 = defunc_res_107019 * zt_res_107030;
                double zp_res_107032 = zt_res_107029 + zt_res_107031;
                double zt_res_107033 = eps_33391 * zt_res_107027;
                double zt_res_107034 = zt_res_107027 * zt_res_107033;
                double zp_res_107035 = zp_res_107032 + zt_res_107034;
                
                if (mem_108952_cached_sizze_109805 < bytes_107622) {
                    err = lexical_realloc(ctx, &mem_108952, &mem_108952_cached_sizze_109805, bytes_107622);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                if (mem_108955_cached_sizze_109806 < bytes_107636) {
                    err = lexical_realloc(ctx, &mem_108955, &mem_108955_cached_sizze_109806, bytes_107636);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                if (mem_108998_cached_sizze_109807 < bytes_107622) {
                    err = lexical_realloc(ctx, &mem_108998, &mem_108998_cached_sizze_109807, bytes_107622);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                if (mem_109006_cached_sizze_109808 < bytes_107622) {
                    err = lexical_realloc(ctx, &mem_109006, &mem_109006_cached_sizze_109808, bytes_107622);
                    if (err != FUTHARK_SUCCESS)
                        goto cleanup;
                }
                
                bool defunc_0_armijo_line_search_res_107036;
                double defunc_0_armijo_line_search_res_107038;
                double defunc_0_armijo_line_search_res_107039;
                bool loop_while_107040;
                double current_loss_107042;
                double alpha_107043;
                
                if (memblock_set(ctx, &mem_param_108950, &mem_108884, "mem_108884") != 0)
                    return 1;
                loop_while_107040 = x_107010;
                current_loss_107042 = zp_res_107005;
                alpha_107043 = 1.0;
                while (loop_while_107040) {
                    double zt_res_107044 = 0.5 * alpha_107043;
                    
                    if (memblock_alloc(ctx, &mem_108958, bytes_107636, "mem_108958")) {
                        err = 1;
                        goto cleanup;
                    }
                    
                    double defunc_res_107048;
                    double defunc_res_107049;
                    double defunc_res_107050;
                    double redout_107055;
                    double redout_107056;
                    double redout_107057;
                    
                    redout_107055 = 0.0;
                    redout_107056 = 0.0;
                    redout_107057 = 0.0;
                    for (int64_t i_107054 = 0; i_107054 < m_33388; i_107054++) {
                        double eta_p_107062 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_107054];
                        double defunc_res_107066;
                        double defunc_res_107067;
                        double defunc_res_107068;
                        double redout_107072;
                        double redout_107073;
                        double redout_107074;
                        
                        redout_107072 = 0.0;
                        redout_107073 = 0.0;
                        redout_107074 = 0.0;
                        for (int64_t i_107071 = 0; i_107071 < m_33388; i_107071++) {
                            double eta_p_107077 = ((double *) mem_param_108950.mem)[i_107054 * m_33388 + i_107071];
                            double eta_p_107078 = ((double *) mem_param_108095.mem)[i_107054 * m_33388 + i_107071];
                            double eta_p_107079 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_107071];
                            double zt_res_107080 = 0.5 * eta_p_107077;
                            double zp_res_107081 = eta_p_107078 + zt_res_107080;
                            double zt_res_107082 = eta_p_107062 * eta_p_107079;
                            bool zeze_res_107083 = zp_res_107081 == 0.0;
                            double klu_res_107084;
                            
                            if (zeze_res_107083) {
                                klu_res_107084 = 0.0;
                            } else {
                                double zs_res_107085 = zp_res_107081 / zt_res_107082;
                                double log_res_107086 = futrts_log64(zs_res_107085);
                                double zt_res_107087 = zp_res_107081 * log_res_107086;
                                
                                klu_res_107084 = zt_res_107087;
                            }
                            
                            double zp_res_107094 = redout_107072 + klu_res_107084;
                            double zp_res_107095 = redout_107073 + zp_res_107081;
                            double zp_res_107096 = redout_107074 + zp_res_107081;
                            
                            ((double *) mem_108955)[i_107054 * m_33388 + i_107071] = zp_res_107081;
                            ((double *) mem_108958.mem)[i_107054 * m_33388 + i_107071] = zt_res_107080;
                            
                            double redout_tmp_109695 = zp_res_107094;
                            double redout_tmp_109696 = zp_res_107095;
                            double redout_tmp_109697 = zp_res_107096;
                            
                            redout_107072 = redout_tmp_109695;
                            redout_107073 = redout_tmp_109696;
                            redout_107074 = redout_tmp_109697;
                        }
                        defunc_res_107066 = redout_107072;
                        defunc_res_107067 = redout_107073;
                        defunc_res_107068 = redout_107074;
                        
                        bool zeze_res_107099 = defunc_res_107068 == 0.0;
                        double klu_res_107100;
                        
                        if (zeze_res_107099) {
                            klu_res_107100 = 0.0;
                        } else {
                            double zs_res_107101 = defunc_res_107068 / eta_p_107062;
                            double log_res_107102 = futrts_log64(zs_res_107101);
                            double zt_res_107103 = defunc_res_107068 * log_res_107102;
                            
                            klu_res_107100 = zt_res_107103;
                        }
                        
                        double zp_res_107110 = redout_107055 + klu_res_107100;
                        double zp_res_107111 = redout_107056 + defunc_res_107068;
                        double zp_res_107112 = redout_107057 + defunc_res_107066;
                        
                        ((double *) mem_108952)[i_107054] = defunc_res_107067;
                        
                        double redout_tmp_109689 = zp_res_107110;
                        double redout_tmp_109690 = zp_res_107111;
                        double redout_tmp_109691 = zp_res_107112;
                        
                        redout_107055 = redout_tmp_109689;
                        redout_107056 = redout_tmp_109690;
                        redout_107057 = redout_tmp_109691;
                    }
                    defunc_res_107048 = redout_107055;
                    defunc_res_107049 = redout_107056;
                    defunc_res_107050 = redout_107057;
                    
                    double defunc_res_107118;
                    double redout_107121 = 0.0;
                    
                    for (int64_t i_107120 = 0; i_107120 < m_33388; i_107120++) {
                        double eta_p_107124 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_107120];
                        double defunc_res_107125;
                        double defunc_res_107126;
                        double redout_107128;
                        double redout_107129;
                        
                        redout_107128 = 0.0;
                        redout_107129 = 0.0;
                        for (int64_t i_107127 = 0; i_107127 < m_33388; i_107127++) {
                            double x_107130 = ((double *) mem_108955)[i_107127 * m_33388 + i_107120];
                            double zp_res_107135 = redout_107128 + x_107130;
                            double zp_res_107136 = redout_107129 + x_107130;
                            double redout_tmp_109702 = zp_res_107135;
                            double redout_tmp_109703 = zp_res_107136;
                            
                            redout_107128 = redout_tmp_109702;
                            redout_107129 = redout_tmp_109703;
                        }
                        defunc_res_107125 = redout_107128;
                        defunc_res_107126 = redout_107129;
                        
                        bool zeze_res_107137 = defunc_res_107126 == 0.0;
                        double klu_res_107138;
                        
                        if (zeze_res_107137) {
                            klu_res_107138 = 0.0;
                        } else {
                            double zs_res_107139 = defunc_res_107126 / eta_p_107124;
                            double log_res_107140 = futrts_log64(zs_res_107139);
                            double zt_res_107141 = defunc_res_107126 * log_res_107140;
                            
                            klu_res_107138 = zt_res_107141;
                        }
                        
                        double zp_res_107144 = redout_107121 + klu_res_107138;
                        
                        ((double *) mem_108998)[i_107120] = defunc_res_107125;
                        
                        double redout_tmp_109700 = zp_res_107144;
                        
                        redout_107121 = redout_tmp_109700;
                    }
                    defunc_res_107118 = redout_107121;
                    
                    double defunc_0_reduce_res_107146;
                    double defunc_res_107147;
                    double redout_107149;
                    double redout_107150;
                    
                    redout_107149 = 0.0;
                    redout_107150 = 0.0;
                    for (int64_t i_107148 = 0; i_107148 < m_33388; i_107148++) {
                        double eta_p_107153 = ((double *) mem_108952)[i_107148];
                        double defunc_0_reduce_res_107154;
                        double redout_107156 = 0.0;
                        
                        for (int64_t i_107155 = 0; i_107155 < m_33388; i_107155++) {
                            double eta_p_107157 = ((double *) A_mem_107604.mem)[tmp_104620 * (m_33388 * m_33388) + i_107148 * m_33388 + i_107155];
                            double eta_p_107158 = ((double *) mem_108952)[i_107155];
                            double zt_res_107159 = eta_p_107157 * eta_p_107157;
                            double zt_res_107160 = eta_p_107158 * zt_res_107159;
                            double zp_res_107163 = redout_107156 + zt_res_107160;
                            double redout_tmp_109706 = zp_res_107163;
                            
                            redout_107156 = redout_tmp_109706;
                        }
                        defunc_0_reduce_res_107154 = redout_107156;
                        
                        double zt_res_107164 = eta_p_107153 * defunc_0_reduce_res_107154;
                        
                        for (int64_t i_107167 = 0; i_107167 < m_33388; i_107167++) {
                            double defunc_0_reduce_res_107170;
                            double redout_107172 = 0.0;
                            
                            for (int64_t i_107171 = 0; i_107171 < m_33388; i_107171++) {
                                double eta_p_107173 = ((double *) A_mem_107604.mem)[tmp_104620 * (m_33388 * m_33388) + i_107148 * m_33388 + i_107171];
                                double eta_p_107174 = ((double *) mem_108955)[i_107171 * m_33388 + i_107167];
                                double zt_res_107175 = eta_p_107173 * eta_p_107174;
                                double zp_res_107178 = redout_107172 + zt_res_107175;
                                double redout_tmp_109708 = zp_res_107178;
                                
                                redout_107172 = redout_tmp_109708;
                            }
                            defunc_0_reduce_res_107170 = redout_107172;
                            ((double *) mem_109006)[i_107167] = defunc_0_reduce_res_107170;
                        }
                        
                        double defunc_0_reduce_res_107180;
                        double redout_107182 = 0.0;
                        
                        for (int64_t i_107181 = 0; i_107181 < m_33388; i_107181++) {
                            double eta_p_107184 = ((double *) mem_108955)[i_107148 * m_33388 + i_107181];
                            double defunc_0_reduce_res_107185;
                            double redout_107187 = 0.0;
                            
                            for (int64_t i_107186 = 0; i_107186 < m_33388; i_107186++) {
                                double eta_p_107188 = ((double *) mem_109006)[i_107186];
                                double eta_p_107189 = ((double *) A_mem_107604.mem)[lifted_lambda_res_104626 * (m_33388 * m_33388) + i_107186 * m_33388 + i_107181];
                                double zt_res_107190 = eta_p_107188 * eta_p_107189;
                                double zp_res_107193 = redout_107187 + zt_res_107190;
                                double redout_tmp_109710 = zp_res_107193;
                                
                                redout_107187 = redout_tmp_109710;
                            }
                            defunc_0_reduce_res_107185 = redout_107187;
                            
                            double zt_res_107194 = eta_p_107184 * defunc_0_reduce_res_107185;
                            double zp_res_107197 = redout_107182 + zt_res_107194;
                            double redout_tmp_109709 = zp_res_107197;
                            
                            redout_107182 = redout_tmp_109709;
                        }
                        defunc_0_reduce_res_107180 = redout_107182;
                        
                        double zp_res_107202 = redout_107149 + zt_res_107164;
                        double zp_res_107203 = redout_107150 + defunc_0_reduce_res_107180;
                        double redout_tmp_109704 = zp_res_107202;
                        double redout_tmp_109705 = zp_res_107203;
                        
                        redout_107149 = redout_tmp_109704;
                        redout_107150 = redout_tmp_109705;
                    }
                    defunc_0_reduce_res_107146 = redout_107149;
                    defunc_res_107147 = redout_107150;
                    
                    double defunc_0_reduce_res_107204;
                    double redout_107206 = 0.0;
                    
                    for (int64_t i_107205 = 0; i_107205 < m_33388; i_107205++) {
                        double eta_p_107208 = ((double *) mem_108998)[i_107205];
                        double defunc_0_reduce_res_107209;
                        double redout_107211 = 0.0;
                        
                        for (int64_t i_107210 = 0; i_107210 < m_33388; i_107210++) {
                            double eta_p_107212 = ((double *) A_mem_107604.mem)[lifted_lambda_res_104626 * (m_33388 * m_33388) + i_107205 * m_33388 + i_107210];
                            double eta_p_107213 = ((double *) mem_108998)[i_107210];
                            double zt_res_107214 = eta_p_107212 * eta_p_107212;
                            double zt_res_107215 = eta_p_107213 * zt_res_107214;
                            double zp_res_107218 = redout_107211 + zt_res_107215;
                            double redout_tmp_109712 = zp_res_107218;
                            
                            redout_107211 = redout_tmp_109712;
                        }
                        defunc_0_reduce_res_107209 = redout_107211;
                        
                        double zt_res_107219 = eta_p_107208 * defunc_0_reduce_res_107209;
                        double zp_res_107222 = redout_107206 + zt_res_107219;
                        double redout_tmp_109711 = zp_res_107222;
                        
                        redout_107206 = redout_tmp_109711;
                    }
                    defunc_0_reduce_res_107204 = redout_107206;
                    
                    double zt_res_107223 = -2.0 * defunc_res_107147;
                    double zp_res_107224 = defunc_0_reduce_res_107146 + zt_res_107223;
                    double zp_res_107225 = defunc_0_reduce_res_107204 + zp_res_107224;
                    double zt_res_107226 = eps_33391 * defunc_res_107050;
                    double zt_res_107227 = rho1_33389 * defunc_res_107048;
                    double zt_res_107228 = rho2_33390 * defunc_res_107118;
                    double zp_res_107229 = zt_res_107226 + zt_res_107227;
                    double zp_res_107230 = zt_res_107228 + zp_res_107229;
                    double zt_res_107231 = 2.0 * zp_res_107230;
                    double zt_res_107232 = defunc_res_107049 * zt_res_107231;
                    double zp_res_107233 = zp_res_107225 + zt_res_107232;
                    double zt_res_107234 = defunc_res_107049 * defunc_res_107049;
                    double zt_res_107235 = zp_res_46827 * zt_res_107234;
                    double zm_res_107236 = zp_res_107233 - zt_res_107235;
                    double zp_res_107237 = zp_res_107035 + zm_res_107236;
                    double zm_res_107238 = zp_res_107237 - loss_105498;
                    bool zgze_res_107239 = -1.0 <= zm_res_107238;
                    double zt_res_107240 = defunc_res_106726 * zt_res_107044;
                    double zs_res_107241 = zm_res_107238 / zt_res_107240;
                    bool zlze_res_107242 = zs_res_107241 <= 0.5;
                    bool zg_res_107243 = 1.0e-50 < zt_res_107044;
                    bool x_107244 = zlze_res_107242 && zg_res_107243;
                    bool x_107245 = zgze_res_107239 && x_107244;
                    
                    if (memblock_set(ctx, &mem_param_tmp_109684, &mem_108958, "mem_108958") != 0)
                        return 1;
                    
                    bool loop_while_tmp_109685 = x_107245;
                    double current_loss_tmp_109687 = zp_res_107237;
                    double alpha_tmp_109688 = zt_res_107044;
                    
                    if (memblock_set(ctx, &mem_param_108950, &mem_param_tmp_109684, "mem_param_tmp_109684") != 0)
                        return 1;
                    loop_while_107040 = loop_while_tmp_109685;
                    current_loss_107042 = current_loss_tmp_109687;
                    alpha_107043 = alpha_tmp_109688;
                }
                if (memblock_set(ctx, &ext_mem_109016, &mem_param_108950, "mem_param_108950") != 0)
                    return 1;
                defunc_0_armijo_line_search_res_107036 = loop_while_107040;
                defunc_0_armijo_line_search_res_107038 = current_loss_107042;
                defunc_0_armijo_line_search_res_107039 = alpha_107043;
                if (memblock_unref(ctx, &mem_108884, "mem_108884") != 0)
                    return 1;
                if (memblock_alloc(ctx, &mem_109019, bytes_107636, "mem_109019")) {
                    err = 1;
                    goto cleanup;
                }
                for (int64_t i_107248 = 0; i_107248 < m_33388; i_107248++) {
                    for (int64_t i_107254 = 0; i_107254 < m_33388; i_107254++) {
                        double eta_p_107256 = ((double *) mem_param_108095.mem)[i_107248 * m_33388 + i_107254];
                        double eta_p_107257 = ((double *) ext_mem_109016.mem)[i_107248 * m_33388 + i_107254];
                        double zp_res_107258 = eta_p_107256 + eta_p_107257;
                        
                        ((double *) mem_109019.mem)[i_107248 * m_33388 + i_107254] = zp_res_107258;
                    }
                }
                if (memblock_unref(ctx, &ext_mem_109016, "ext_mem_109016") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_109045, &mem_108782, "mem_108782") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_109042, &mem_108777, "mem_108777") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_109039, &mem_109019, "mem_109019") != 0)
                    return 1;
                descent_res_106559 = defunc_0_armijo_line_search_res_107038;
            } else {
                if (memblock_alloc(ctx, &mem_108812, bytes_107622, "mem_108812")) {
                    err = 1;
                    goto cleanup;
                }
                for (int64_t nest_i_109715 = 0; nest_i_109715 < m_33388; nest_i_109715++) {
                    ((double *) mem_108812.mem)[nest_i_109715] = 0.0;
                }
                if (memblock_alloc(ctx, &mem_108815, bytes_107636, "mem_108815")) {
                    err = 1;
                    goto cleanup;
                }
                for (int64_t nest_i_109716 = 0; nest_i_109716 < m_33388; nest_i_109716++) {
                    for (int64_t nest_i_109717 = 0; nest_i_109717 < m_33388; nest_i_109717++) {
                        ((double *) mem_108815.mem)[nest_i_109716 * m_33388 + nest_i_109717] = 0.0;
                    }
                }
                if (memblock_set(ctx, &ext_mem_109045, &mem_108812, "mem_108812") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_109042, &mem_108812, "mem_108812") != 0)
                    return 1;
                if (memblock_set(ctx, &ext_mem_109039, &mem_108815, "mem_108815") != 0)
                    return 1;
                descent_res_106559 = 0.0;
            }
            if (memblock_unref(ctx, &mem_108777, "mem_108777") != 0)
                return 1;
            if (memblock_unref(ctx, &mem_108782, "mem_108782") != 0)
                return 1;
            
            bool defunc_0_reduce_comm_res_107263;
            bool redout_107265 = 0;
            
            for (int64_t i_107264 = 0; i_107264 < m_33388; i_107264++) {
                bool defunc_0_reduce_comm_res_107268;
                bool redout_107270 = 0;
                
                for (int64_t i_107269 = 0; i_107269 < m_33388; i_107269++) {
                    double eta_p_107271 = ((double *) mem_param_108095.mem)[i_107264 * m_33388 + i_107269];
                    double eta_p_107272 = ((double *) ext_mem_109039.mem)[i_107264 * m_33388 + i_107269];
                    double zt_res_107273 = zp_res_43884 * eta_p_107271;
                    bool zgze_res_107274 = eta_p_107272 <= zt_res_107273;
                    double zt_res_107275 = zp_res_43884 * eta_p_107272;
                    bool zgze_res_107276 = eta_p_107271 <= zt_res_107275;
                    bool x_107277 = zgze_res_107274 && zgze_res_107276;
                    bool not_res_107278 = !x_107277;
                    bool defunc_0_op_res_107281 = redout_107270 || not_res_107278;
                    bool redout_tmp_109719 = defunc_0_op_res_107281;
                    
                    redout_107270 = redout_tmp_109719;
                }
                defunc_0_reduce_comm_res_107268 = redout_107270;
                
                bool defunc_0_op_res_107284 = redout_107265 || defunc_0_reduce_comm_res_107268;
                bool redout_tmp_109718 = defunc_0_op_res_107284;
                
                redout_107265 = redout_tmp_109718;
            }
            defunc_0_reduce_comm_res_107263 = redout_107265;
            
            bool loop_cond_107285;
            
            if (defunc_0_reduce_comm_res_107263) {
                bool defunc_0_reduce_res_107286;
                bool redout_107288 = 0;
                
                for (int64_t i_107287 = 0; i_107287 < m_33388; i_107287++) {
                    bool defunc_0_reduce_res_107290;
                    bool redout_107292 = 0;
                    
                    for (int64_t i_107291 = 0; i_107291 < m_33388; i_107291++) {
                        double eta_p_107293 = ((double *) ext_mem_109039.mem)[i_107287 * m_33388 + i_107291];
                        bool zg_res_107294 = 0.0 < eta_p_107293;
                        bool defunc_0_op_res_107297 = redout_107292 || zg_res_107294;
                        bool redout_tmp_109721 = defunc_0_op_res_107297;
                        
                        redout_107292 = redout_tmp_109721;
                    }
                    defunc_0_reduce_res_107290 = redout_107292;
                    
                    bool defunc_0_op_res_107300 = redout_107288 || defunc_0_reduce_res_107290;
                    bool redout_tmp_109720 = defunc_0_op_res_107300;
                    
                    redout_107288 = redout_tmp_109720;
                }
                defunc_0_reduce_res_107286 = redout_107288;
                loop_cond_107285 = defunc_0_reduce_res_107286;
            } else {
                loop_cond_107285 = 0;
            }
            if (memblock_set(ctx, &mem_param_tmp_109470, &ext_mem_109045, "ext_mem_109045") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_tmp_109471, &ext_mem_109042, "ext_mem_109042") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_tmp_109472, &ext_mem_109039, "ext_mem_109039") != 0)
                return 1;
            
            bool loop_while_tmp_109473 = loop_cond_107285;
            double loss_tmp_109477 = descent_res_106559;
            
            if (memblock_set(ctx, &mem_param_108088, &mem_param_tmp_109470, "mem_param_tmp_109470") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_108091, &mem_param_tmp_109471, "mem_param_tmp_109471") != 0)
                return 1;
            if (memblock_set(ctx, &mem_param_108095, &mem_param_tmp_109472, "mem_param_tmp_109472") != 0)
                return 1;
            loop_while_105494 = loop_while_tmp_109473;
            loss_105498 = loss_tmp_109477;
        }
        if (memblock_set(ctx, &ext_mem_109055, &mem_param_108088, "mem_param_108088") != 0)
            return 1;
        if (memblock_set(ctx, &ext_mem_109054, &mem_param_108091, "mem_param_108091") != 0)
            return 1;
        if (memblock_set(ctx, &ext_mem_109053, &mem_param_108095, "mem_param_108095") != 0)
            return 1;
        final_plan_105489 = loop_while_105494;
        final_plan_105493 = loss_105498;
        if (memblock_unref(ctx, &ext_mem_108043, "ext_mem_108043") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108044, "ext_mem_108044") != 0)
            return 1;
        
        double defunc_res_107305;
        double defunc_res_107306;
        double defunc_res_107307;
        double defunc_res_107308;
        double defunc_res_107309;
        double redout_107314;
        double redout_107315;
        double redout_107316;
        double redout_107317;
        double redout_107318;
        
        redout_107314 = 0.0;
        redout_107315 = 0.0;
        redout_107316 = 0.0;
        redout_107317 = 0.0;
        redout_107318 = 0.0;
        for (int64_t i_107313 = 0; i_107313 < m_33388; i_107313++) {
            double eta_p_107323 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_107313];
            
            for (int64_t i_107327 = 0; i_107327 < m_33388; i_107327++) {
                double defunc_0_reduce_res_107330;
                double redout_107332 = 0.0;
                
                for (int64_t i_107331 = 0; i_107331 < m_33388; i_107331++) {
                    double eta_p_107333 = ((double *) A_mem_107604.mem)[tmp_104620 * (m_33388 * m_33388) + i_107313 * m_33388 + i_107331];
                    double eta_p_107334 = ((double *) ext_mem_109053.mem)[i_107331 * m_33388 + i_107327];
                    double zt_res_107335 = eta_p_107333 * eta_p_107334;
                    double zp_res_107338 = redout_107332 + zt_res_107335;
                    double redout_tmp_109731 = zp_res_107338;
                    
                    redout_107332 = redout_tmp_109731;
                }
                defunc_0_reduce_res_107330 = redout_107332;
                ((double *) mem_109072)[i_107327] = defunc_0_reduce_res_107330;
            }
            
            double defunc_res_107340;
            double defunc_0_reduce_res_107341;
            double defunc_res_107342;
            double defunc_res_107343;
            double defunc_res_107344;
            double defunc_res_107345;
            double defunc_res_107346;
            double defunc_res_107347;
            double redout_107349;
            double redout_107350;
            double redout_107351;
            double redout_107352;
            double redout_107353;
            double redout_107354;
            double redout_107355;
            double redout_107356;
            
            redout_107349 = 0.0;
            redout_107350 = 0.0;
            redout_107351 = 0.0;
            redout_107352 = 0.0;
            redout_107353 = 0.0;
            redout_107354 = 0.0;
            redout_107355 = 0.0;
            redout_107356 = 0.0;
            for (int64_t i_107348 = 0; i_107348 < m_33388; i_107348++) {
                double x_107357 = ((double *) ext_mem_109053.mem)[i_107313 * m_33388 + i_107348];
                double eta_p_107358 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_107348];
                double defunc_0_reduce_res_107360;
                double redout_107362 = 0.0;
                
                for (int64_t i_107361 = 0; i_107361 < m_33388; i_107361++) {
                    double eta_p_107363 = ((double *) mem_109072)[i_107361];
                    double eta_p_107364 = ((double *) A_mem_107604.mem)[lifted_lambda_res_104626 * (m_33388 * m_33388) + i_107361 * m_33388 + i_107348];
                    double zt_res_107365 = eta_p_107363 * eta_p_107364;
                    double zp_res_107368 = redout_107362 + zt_res_107365;
                    double redout_tmp_109740 = zp_res_107368;
                    
                    redout_107362 = redout_tmp_109740;
                }
                defunc_0_reduce_res_107360 = redout_107362;
                
                double zt_res_107369 = x_107357 * defunc_0_reduce_res_107360;
                double zt_res_107370 = eta_p_107323 * eta_p_107358;
                bool zeze_res_107371 = x_107357 == 0.0;
                double klu_res_107372;
                
                if (zeze_res_107371) {
                    klu_res_107372 = 0.0;
                } else {
                    double zs_res_107373 = x_107357 / zt_res_107370;
                    double log_res_107374 = futrts_log64(zs_res_107373);
                    double zt_res_107375 = x_107357 * log_res_107374;
                    
                    klu_res_107372 = zt_res_107375;
                }
                
                double klu_res_107376;
                
                if (zeze_res_107371) {
                    klu_res_107376 = 0.0;
                } else {
                    double zs_res_107377 = x_107357 / zt_res_107370;
                    double log_res_107378 = futrts_log64(zs_res_107377);
                    double zt_res_107379 = x_107357 * log_res_107378;
                    
                    klu_res_107376 = zt_res_107379;
                }
                
                double zp_res_107396 = redout_107349 + x_107357;
                double zp_res_107397 = redout_107350 + zt_res_107369;
                double zp_res_107398 = redout_107351 + x_107357;
                double zp_res_107399 = redout_107352 + x_107357;
                double zp_res_107400 = redout_107353 + x_107357;
                double zp_res_107401 = redout_107354 + klu_res_107372;
                double zp_res_107402 = redout_107355 + klu_res_107376;
                double zp_res_107403 = redout_107356 + x_107357;
                double redout_tmp_109732 = zp_res_107396;
                double redout_tmp_109733 = zp_res_107397;
                double redout_tmp_109734 = zp_res_107398;
                double redout_tmp_109735 = zp_res_107399;
                double redout_tmp_109736 = zp_res_107400;
                double redout_tmp_109737 = zp_res_107401;
                double redout_tmp_109738 = zp_res_107402;
                double redout_tmp_109739 = zp_res_107403;
                
                redout_107349 = redout_tmp_109732;
                redout_107350 = redout_tmp_109733;
                redout_107351 = redout_tmp_109734;
                redout_107352 = redout_tmp_109735;
                redout_107353 = redout_tmp_109736;
                redout_107354 = redout_tmp_109737;
                redout_107355 = redout_tmp_109738;
                redout_107356 = redout_tmp_109739;
            }
            defunc_res_107340 = redout_107349;
            defunc_0_reduce_res_107341 = redout_107350;
            defunc_res_107342 = redout_107351;
            defunc_res_107343 = redout_107352;
            defunc_res_107344 = redout_107353;
            defunc_res_107345 = redout_107354;
            defunc_res_107346 = redout_107355;
            defunc_res_107347 = redout_107356;
            
            double zp_res_107414 = redout_107314 + defunc_0_reduce_res_107341;
            double zp_res_107415 = redout_107315 + defunc_res_107343;
            double zp_res_107416 = redout_107316 + defunc_res_107344;
            double zp_res_107417 = redout_107317 + defunc_res_107345;
            double zp_res_107418 = redout_107318 + defunc_res_107346;
            
            ((double *) mem_109057)[i_107313] = defunc_res_107347;
            ((double *) mem_109059)[i_107313] = defunc_res_107342;
            ((double *) mem_109061)[i_107313] = defunc_res_107340;
            
            double redout_tmp_109722 = zp_res_107414;
            double redout_tmp_109723 = zp_res_107415;
            double redout_tmp_109724 = zp_res_107416;
            double redout_tmp_109725 = zp_res_107417;
            double redout_tmp_109726 = zp_res_107418;
            
            redout_107314 = redout_tmp_109722;
            redout_107315 = redout_tmp_109723;
            redout_107316 = redout_tmp_109724;
            redout_107317 = redout_tmp_109725;
            redout_107318 = redout_tmp_109726;
        }
        defunc_res_107305 = redout_107314;
        defunc_res_107306 = redout_107315;
        defunc_res_107307 = redout_107316;
        defunc_res_107308 = redout_107317;
        defunc_res_107309 = redout_107318;
        for (int64_t i_107428 = 0; i_107428 < m_33388; i_107428++) {
            double defunc_res_107433;
            double defunc_res_107434;
            double defunc_res_107435;
            double redout_107437;
            double redout_107438;
            double redout_107439;
            
            redout_107437 = 0.0;
            redout_107438 = 0.0;
            redout_107439 = 0.0;
            for (int64_t i_107436 = 0; i_107436 < m_33388; i_107436++) {
                double x_107440 = ((double *) ext_mem_109053.mem)[i_107436 * m_33388 + i_107428];
                double zp_res_107447 = redout_107437 + x_107440;
                double zp_res_107448 = redout_107438 + x_107440;
                double zp_res_107449 = redout_107439 + x_107440;
                double redout_tmp_109744 = zp_res_107447;
                double redout_tmp_109745 = zp_res_107448;
                double redout_tmp_109746 = zp_res_107449;
                
                redout_107437 = redout_tmp_109744;
                redout_107438 = redout_tmp_109745;
                redout_107439 = redout_tmp_109746;
            }
            defunc_res_107433 = redout_107437;
            defunc_res_107434 = redout_107438;
            defunc_res_107435 = redout_107439;
            ((double *) mem_109089)[i_107428] = defunc_res_107435;
            ((double *) mem_109091)[i_107428] = defunc_res_107434;
            ((double *) mem_109093)[i_107428] = defunc_res_107433;
        }
        if (memblock_unref(ctx, &ext_mem_109053, "ext_mem_109053") != 0)
            return 1;
        
        double defunc_0_reduce_res_107453;
        double redout_107455 = 0.0;
        
        for (int64_t i_107454 = 0; i_107454 < m_33388; i_107454++) {
            double eta_p_107457 = ((double *) mem_109061)[i_107454];
            double defunc_0_reduce_res_107458;
            double redout_107460 = 0.0;
            
            for (int64_t i_107459 = 0; i_107459 < m_33388; i_107459++) {
                double eta_p_107461 = ((double *) A_mem_107604.mem)[tmp_104620 * (m_33388 * m_33388) + i_107454 * m_33388 + i_107459];
                double eta_p_107462 = ((double *) mem_109061)[i_107459];
                double zt_res_107463 = eta_p_107461 * eta_p_107461;
                double zt_res_107464 = eta_p_107462 * zt_res_107463;
                double zp_res_107467 = redout_107460 + zt_res_107464;
                double redout_tmp_109748 = zp_res_107467;
                
                redout_107460 = redout_tmp_109748;
            }
            defunc_0_reduce_res_107458 = redout_107460;
            
            double zt_res_107468 = eta_p_107457 * defunc_0_reduce_res_107458;
            double zp_res_107471 = redout_107455 + zt_res_107468;
            double redout_tmp_109747 = zp_res_107471;
            
            redout_107455 = redout_tmp_109747;
        }
        defunc_0_reduce_res_107453 = redout_107455;
        
        double defunc_0_reduce_res_107472;
        double redout_107474 = 0.0;
        
        for (int64_t i_107473 = 0; i_107473 < m_33388; i_107473++) {
            double eta_p_107476 = ((double *) mem_109093)[i_107473];
            double defunc_0_reduce_res_107477;
            double redout_107479 = 0.0;
            
            for (int64_t i_107478 = 0; i_107478 < m_33388; i_107478++) {
                double eta_p_107480 = ((double *) A_mem_107604.mem)[lifted_lambda_res_104626 * (m_33388 * m_33388) + i_107473 * m_33388 + i_107478];
                double eta_p_107481 = ((double *) mem_109093)[i_107478];
                double zt_res_107482 = eta_p_107480 * eta_p_107480;
                double zt_res_107483 = eta_p_107481 * zt_res_107482;
                double zp_res_107486 = redout_107479 + zt_res_107483;
                double redout_tmp_109750 = zp_res_107486;
                
                redout_107479 = redout_tmp_109750;
            }
            defunc_0_reduce_res_107477 = redout_107479;
            
            double zt_res_107487 = eta_p_107476 * defunc_0_reduce_res_107477;
            double zp_res_107490 = redout_107474 + zt_res_107487;
            double redout_tmp_109749 = zp_res_107490;
            
            redout_107474 = redout_tmp_109749;
        }
        defunc_0_reduce_res_107472 = redout_107474;
        
        double zt_res_107491 = -2.0 * defunc_res_107305;
        double zp_res_107492 = defunc_0_reduce_res_107453 + zt_res_107491;
        double zp_res_107493 = defunc_0_reduce_res_107472 + zp_res_107492;
        double defunc_res_107494;
        double defunc_res_107495;
        double redout_107497;
        double redout_107498;
        
        redout_107497 = 0.0;
        redout_107498 = 0.0;
        for (int64_t i_107496 = 0; i_107496 < m_33388; i_107496++) {
            double eta_p_107499 = ((double *) mem_109057)[i_107496];
            double eta_p_107500 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_107496];
            double eta_p_107501 = ((double *) mem_109059)[i_107496];
            double defunc_res_107502;
            double defunc_res_107503;
            double redout_107505;
            double redout_107506;
            
            redout_107505 = 0.0;
            redout_107506 = 0.0;
            for (int64_t i_107504 = 0; i_107504 < m_33388; i_107504++) {
                double eta_p_107507 = ((double *) mem_109057)[i_107504];
                double eta_p_107508 = ((double *) distrs_mem_107605.mem)[tmp_104620 * m_33388 + i_107504];
                double eta_p_107509 = ((double *) mem_109059)[i_107504];
                double zt_res_107510 = eta_p_107500 * eta_p_107508;
                double zt_res_107511 = eta_p_107501 * eta_p_107509;
                bool zeze_res_107512 = zt_res_107511 == 0.0;
                double kl_res_107513;
                
                if (zeze_res_107512) {
                    kl_res_107513 = zt_res_107510;
                } else {
                    double zs_res_107514 = zt_res_107511 / zt_res_107510;
                    double log_res_107515 = futrts_log64(zs_res_107514);
                    double zt_res_107516 = zt_res_107511 * log_res_107515;
                    double zm_res_107517 = zt_res_107516 - zt_res_107511;
                    double zp_res_107518 = zt_res_107510 + zm_res_107517;
                    
                    kl_res_107513 = zp_res_107518;
                }
                
                double zt_res_107519 = eta_p_107499 * eta_p_107507;
                bool zeze_res_107520 = zt_res_107519 == 0.0;
                double kl_res_107521;
                
                if (zeze_res_107520) {
                    kl_res_107521 = zt_res_107510;
                } else {
                    double zs_res_107522 = zt_res_107519 / zt_res_107510;
                    double log_res_107523 = futrts_log64(zs_res_107522);
                    double zt_res_107524 = zt_res_107519 * log_res_107523;
                    double zm_res_107525 = zt_res_107524 - zt_res_107519;
                    double zp_res_107526 = zt_res_107510 + zm_res_107525;
                    
                    kl_res_107521 = zp_res_107526;
                }
                
                double zp_res_107531 = redout_107505 + kl_res_107513;
                double zp_res_107532 = redout_107506 + kl_res_107521;
                double redout_tmp_109753 = zp_res_107531;
                double redout_tmp_109754 = zp_res_107532;
                
                redout_107505 = redout_tmp_109753;
                redout_107506 = redout_tmp_109754;
            }
            defunc_res_107502 = redout_107505;
            defunc_res_107503 = redout_107506;
            
            double zp_res_107537 = redout_107497 + defunc_res_107502;
            double zp_res_107538 = redout_107498 + defunc_res_107503;
            double redout_tmp_109751 = zp_res_107537;
            double redout_tmp_109752 = zp_res_107538;
            
            redout_107497 = redout_tmp_109751;
            redout_107498 = redout_tmp_109752;
        }
        defunc_res_107494 = redout_107497;
        defunc_res_107495 = redout_107498;
        
        double defunc_res_107539;
        double defunc_res_107540;
        double redout_107542;
        double redout_107543;
        
        redout_107542 = 0.0;
        redout_107543 = 0.0;
        for (int64_t i_107541 = 0; i_107541 < m_33388; i_107541++) {
            double eta_p_107544 = ((double *) mem_109089)[i_107541];
            double eta_p_107545 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_107541];
            double eta_p_107546 = ((double *) mem_109091)[i_107541];
            double defunc_res_107547;
            double defunc_res_107548;
            double redout_107550;
            double redout_107551;
            
            redout_107550 = 0.0;
            redout_107551 = 0.0;
            for (int64_t i_107549 = 0; i_107549 < m_33388; i_107549++) {
                double eta_p_107552 = ((double *) mem_109089)[i_107549];
                double eta_p_107553 = ((double *) distrs_mem_107605.mem)[lifted_lambda_res_104626 * m_33388 + i_107549];
                double eta_p_107554 = ((double *) mem_109091)[i_107549];
                double zt_res_107555 = eta_p_107545 * eta_p_107553;
                double zt_res_107556 = eta_p_107546 * eta_p_107554;
                bool zeze_res_107557 = zt_res_107556 == 0.0;
                double kl_res_107558;
                
                if (zeze_res_107557) {
                    kl_res_107558 = zt_res_107555;
                } else {
                    double zs_res_107559 = zt_res_107556 / zt_res_107555;
                    double log_res_107560 = futrts_log64(zs_res_107559);
                    double zt_res_107561 = zt_res_107556 * log_res_107560;
                    double zm_res_107562 = zt_res_107561 - zt_res_107556;
                    double zp_res_107563 = zt_res_107555 + zm_res_107562;
                    
                    kl_res_107558 = zp_res_107563;
                }
                
                double zt_res_107564 = eta_p_107544 * eta_p_107552;
                bool zeze_res_107565 = zt_res_107564 == 0.0;
                double kl_res_107566;
                
                if (zeze_res_107565) {
                    kl_res_107566 = zt_res_107555;
                } else {
                    double zs_res_107567 = zt_res_107564 / zt_res_107555;
                    double log_res_107568 = futrts_log64(zs_res_107567);
                    double zt_res_107569 = zt_res_107564 * log_res_107568;
                    double zm_res_107570 = zt_res_107569 - zt_res_107564;
                    double zp_res_107571 = zt_res_107555 + zm_res_107570;
                    
                    kl_res_107566 = zp_res_107571;
                }
                
                double zp_res_107576 = redout_107550 + kl_res_107558;
                double zp_res_107577 = redout_107551 + kl_res_107566;
                double redout_tmp_109757 = zp_res_107576;
                double redout_tmp_109758 = zp_res_107577;
                
                redout_107550 = redout_tmp_109757;
                redout_107551 = redout_tmp_109758;
            }
            defunc_res_107547 = redout_107550;
            defunc_res_107548 = redout_107551;
            
            double zp_res_107582 = redout_107542 + defunc_res_107547;
            double zp_res_107583 = redout_107543 + defunc_res_107548;
            double redout_tmp_109755 = zp_res_107582;
            double redout_tmp_109756 = zp_res_107583;
            
            redout_107542 = redout_tmp_109755;
            redout_107543 = redout_tmp_109756;
        }
        defunc_res_107539 = redout_107542;
        defunc_res_107540 = redout_107543;
        
        double zt_res_107584 = defunc_res_104650 * defunc_res_104772;
        double zt_res_107585 = zt_res_107584 * zt_res_107584;
        double zt_res_107586 = defunc_res_107307 * defunc_res_107308;
        double zt_res_107587 = defunc_res_107306 * defunc_res_107309;
        double zp_res_107588 = zt_res_107586 + zt_res_107587;
        double zp_res_107589 = zt_res_107585 + zp_res_107588;
        double zt_res_107590 = defunc_res_107306 * defunc_res_107307;
        double zm_res_107591 = zp_res_107589 - zt_res_107590;
        double zt_res_107592 = rho1_33389 * defunc_res_107495;
        double zp_res_107593 = zp_res_107493 + zt_res_107592;
        double zt_res_107594 = rho2_33390 * defunc_res_107540;
        double zp_res_107595 = zp_res_107593 + zt_res_107594;
        double fma_res_107596 = futrts_fma64(zm_res_107591, eps_33391, zp_res_107595);
        
        ((double *) mem_109112)[(int64_t) 0] = zp_res_107493;
        ((double *) mem_109112)[(int64_t) 1] = defunc_res_107494;
        ((double *) mem_109112)[(int64_t) 2] = defunc_res_107539;
        ((double *) mem_109112)[(int64_t) 3] = zm_res_107591;
        ((double *) mem_109112)[(int64_t) 4] = fma_res_107596;
        lmad_copy_8b(ctx, 2, (uint64_t *) mem_107626.mem, (int64_t) 5 * i_104577, (int64_t []) {(int64_t) 5, (int64_t) 1}, (uint64_t *) mem_109112, (int64_t) 0, (int64_t []) {(int64_t) 0, (int64_t) 1}, (int64_t []) {(int64_t) 1, (int64_t) 5});
        
        int64_t tmp_63679;
        
        if (lifted_lambda_res_104587) {
            tmp_63679 = eta_p_104585;
        } else {
            tmp_63679 = defunc_0_op_res_104621;
        }
        
        int64_t tmp_63714;
        
        if (lifted_lambda_res_104587) {
            tmp_63714 = (int64_t) 1;
        } else {
            tmp_63714 = defunc_0_op_res_104623;
        }
        
        int64_t inpacc_tmp_109351 = tmp_63679;
        int64_t inpacc_tmp_109352 = tmp_63714;
        
        inpacc_63637 = inpacc_tmp_109351;
        inpacc_63639 = inpacc_tmp_109352;
    }
    inpacc_103768 = inpacc_63637;
    inpacc_103770 = inpacc_63639;
    if (memblock_unref(ctx, &mem_107623, "mem_107623") != 0)
        return 1;
    if (memblock_unref(ctx, &mem_107702, "mem_107702") != 0)
        return 1;
    if (memblock_unref(ctx, &mem_107750, "mem_107750") != 0)
        return 1;
    if (memblock_unref(ctx, &mem_107761, "mem_107761") != 0)
        return 1;
    if (memblock_unref(ctx, &mem_107785, "mem_107785") != 0)
        return 1;
    if (memblock_unref(ctx, &mem_107793, "mem_107793") != 0)
        return 1;
    if (memblock_unref(ctx, &mem_108069, "mem_108069") != 0)
        return 1;
    if (memblock_unref(ctx, &mem_108172, "mem_108172") != 0)
        return 1;
    if (memblock_unref(ctx, &mem_108174, "mem_108174") != 0)
        return 1;
    if (memblock_unref(ctx, &mem_108177, "mem_108177") != 0)
        return 1;
    if (memblock_unref(ctx, &mem_108207, "mem_108207") != 0)
        return 1;
    if (memblock_unref(ctx, &mem_108209, "mem_108209") != 0)
        return 1;
    if (memblock_set(ctx, &mem_out_109343, &mem_107626, "mem_107626") != 0)
        return 1;
    prim_out_109344 = defunc_0_reduce_res_103765;
    if (memblock_set(ctx, &*mem_out_p_109767, &mem_out_109343, "mem_out_109343") != 0)
        return 1;
    *out_prim_out_109768 = prim_out_109344;
    
  cleanup:
    {
        free(mem_107607);
        free(mem_107615);
        free(mem_107632);
        free(mem_107634);
        free(mem_107637);
        free(mem_107667);
        free(mem_107669);
        free(mem_107671);
        free(mem_107691);
        free(mem_107700);
        free(mem_107711);
        free(mem_107713);
        free(mem_107727);
        free(mem_107758);
        free(mem_108050);
        free(mem_108097);
        free(mem_108105);
        free(mem_108107);
        free(mem_108121);
        free(mem_108130);
        free(mem_108132);
        free(mem_108141);
        free(mem_108149);
        free(mem_108780);
        free(mem_108817);
        free(mem_108819);
        free(mem_108821);
        free(mem_108842);
        free(mem_108854);
        free(mem_108856);
        free(mem_108870);
        free(mem_108878);
        free(mem_108881);
        free(mem_108897);
        free(mem_108932);
        free(mem_108940);
        free(mem_108952);
        free(mem_108955);
        free(mem_108998);
        free(mem_109006);
        free(mem_109057);
        free(mem_109059);
        free(mem_109061);
        free(mem_109072);
        free(mem_109089);
        free(mem_109091);
        free(mem_109093);
        free(mem_109112);
        if (memblock_unref(ctx, &mem_param_tmp_109472, "mem_param_tmp_109472") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109471, "mem_param_tmp_109471") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109470, "mem_param_tmp_109470") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108815, "mem_108815") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108812, "mem_108812") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_109019, "mem_109019") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109684, "mem_param_tmp_109684") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108958, "mem_108958") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108950, "mem_param_108950") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_109016, "ext_mem_109016") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108884, "mem_108884") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_109039, "ext_mem_109039") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_109042, "ext_mem_109042") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_109045, "ext_mem_109045") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108782, "mem_108782") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108777, "mem_108777") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109593, "mem_param_tmp_109593") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109592, "mem_param_tmp_109592") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109591, "mem_param_tmp_109591") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109590, "mem_param_tmp_109590") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109589, "mem_param_tmp_109589") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108712, "mem_108712") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108723, "ext_mem_108723") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108700, "mem_108700") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108697, "mem_108697") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108695, "mem_108695") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108737, "ext_mem_108737") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108740, "ext_mem_108740") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108743, "ext_mem_108743") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108662, "mem_108662") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108673, "ext_mem_108673") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108650, "mem_108650") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108647, "mem_108647") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108645, "mem_108645") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108687, "ext_mem_108687") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108690, "ext_mem_108690") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108693, "ext_mem_108693") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108637, "mem_108637") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108629, "mem_108629") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108627, "mem_param_108627") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108624, "mem_param_108624") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108621, "mem_param_108621") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108618, "mem_param_108618") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108615, "mem_param_108615") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108755, "ext_mem_108755") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108756, "ext_mem_108756") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108757, "ext_mem_108757") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108758, "ext_mem_108758") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108759, "ext_mem_108759") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108580, "mem_108580") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108591, "ext_mem_108591") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108568, "mem_108568") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108565, "mem_108565") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108563, "mem_108563") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108605, "ext_mem_108605") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108608, "ext_mem_108608") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108611, "ext_mem_108611") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108530, "mem_108530") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108541, "ext_mem_108541") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108518, "mem_108518") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108515, "mem_108515") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108513, "mem_108513") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108555, "ext_mem_108555") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108558, "ext_mem_108558") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108561, "ext_mem_108561") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108505, "mem_108505") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108497, "mem_108497") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108762, "ext_mem_108762") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108765, "ext_mem_108765") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108768, "ext_mem_108768") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108771, "ext_mem_108771") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108775, "ext_mem_108775") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109535, "mem_param_tmp_109535") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109534, "mem_param_tmp_109534") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109533, "mem_param_tmp_109533") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109532, "mem_param_tmp_109532") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109531, "mem_param_tmp_109531") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109530, "mem_param_tmp_109530") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109529, "mem_param_tmp_109529") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109528, "mem_param_tmp_109528") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109527, "mem_param_tmp_109527") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108435, "mem_108435") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108446, "ext_mem_108446") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108423, "mem_108423") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108420, "mem_108420") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108418, "mem_108418") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108460, "ext_mem_108460") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108463, "ext_mem_108463") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108466, "ext_mem_108466") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108385, "mem_108385") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108396, "ext_mem_108396") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108373, "mem_108373") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108370, "mem_108370") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108368, "mem_108368") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108410, "ext_mem_108410") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108413, "ext_mem_108413") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108416, "ext_mem_108416") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108360, "mem_108360") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108352, "mem_108352") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108350, "mem_param_108350") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108347, "mem_param_108347") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108344, "mem_param_108344") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108341, "mem_param_108341") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108338, "mem_param_108338") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108334, "mem_param_108334") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108331, "mem_param_108331") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108328, "mem_param_108328") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108325, "mem_param_108325") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108487, "ext_mem_108487") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108488, "ext_mem_108488") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108489, "ext_mem_108489") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108490, "ext_mem_108490") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108491, "ext_mem_108491") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108492, "ext_mem_108492") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108493, "ext_mem_108493") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108494, "ext_mem_108494") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108495, "ext_mem_108495") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108290, "mem_108290") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108301, "ext_mem_108301") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108278, "mem_108278") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108275, "mem_108275") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108273, "mem_108273") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108315, "ext_mem_108315") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108318, "ext_mem_108318") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108321, "ext_mem_108321") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108240, "mem_108240") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108251, "ext_mem_108251") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108228, "mem_108228") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108225, "mem_108225") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108223, "mem_108223") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108265, "ext_mem_108265") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108268, "ext_mem_108268") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108271, "ext_mem_108271") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108095, "mem_param_108095") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108091, "mem_param_108091") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_108088, "mem_param_108088") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_109053, "ext_mem_109053") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_109054, "ext_mem_109054") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_109055, "ext_mem_109055") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109433, "mem_param_tmp_109433") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109432, "mem_param_tmp_109432") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109431, "mem_param_tmp_109431") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109430, "mem_param_tmp_109430") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_tmp_109429, "mem_param_tmp_109429") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108000, "mem_108000") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108011, "ext_mem_108011") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107988, "mem_107988") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107985, "mem_107985") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107983, "mem_107983") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108025, "ext_mem_108025") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108028, "ext_mem_108028") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108031, "ext_mem_108031") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107950, "mem_107950") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107961, "ext_mem_107961") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107938, "mem_107938") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107935, "mem_107935") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107933, "mem_107933") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107975, "ext_mem_107975") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107978, "ext_mem_107978") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107981, "ext_mem_107981") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107925, "mem_107925") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107917, "mem_107917") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_107915, "mem_param_107915") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_107912, "mem_param_107912") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_107909, "mem_param_107909") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_107906, "mem_param_107906") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_param_107903, "mem_param_107903") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108043, "ext_mem_108043") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108044, "ext_mem_108044") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108045, "ext_mem_108045") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108046, "ext_mem_108046") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_108047, "ext_mem_108047") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107868, "mem_107868") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107879, "ext_mem_107879") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107856, "mem_107856") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107853, "mem_107853") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107851, "mem_107851") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107893, "ext_mem_107893") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107896, "ext_mem_107896") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107899, "ext_mem_107899") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107818, "mem_107818") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107829, "ext_mem_107829") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107806, "mem_107806") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107803, "mem_107803") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107801, "mem_107801") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107843, "ext_mem_107843") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107846, "ext_mem_107846") != 0)
            return 1;
        if (memblock_unref(ctx, &ext_mem_107849, "ext_mem_107849") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108209, "mem_108209") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108207, "mem_108207") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108177, "mem_108177") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108174, "mem_108174") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108172, "mem_108172") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_108069, "mem_108069") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107793, "mem_107793") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107785, "mem_107785") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107761, "mem_107761") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107750, "mem_107750") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107702, "mem_107702") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107626, "mem_107626") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_107623, "mem_107623") != 0)
            return 1;
        if (memblock_unref(ctx, &mem_out_109343, "mem_out_109343") != 0)
            return 1;
    }
    return err;
}

int futhark_entry_ugw_armijo(struct futhark_context *ctx, struct futhark_f64_1d **out0, const double in0, const double in1, const double in2, const struct futhark_f64_2d *in3, const struct futhark_f64_1d *in4, const struct futhark_f64_2d *in5, const struct futhark_f64_1d *in6, const double in7, const double in8, const double in9, const double in10)
{
    int64_t mz2081Uz2084U_33563 = (int64_t) 0;
    double rho1_33564 = 0.0;
    double rho2_33565 = 0.0;
    double eps_33566 = 0.0;
    double exp_absorb_cutoff_33571 = 0.0;
    double safe_for_exp_33572 = 0.0;
    double tol_sinkhorn_33573 = 0.0;
    double tol_outerloop_33574 = 0.0;
    int ret = 0;
    
    lock_lock(&ctx->lock);
    
    struct memblock mem_out_109343;
    
    mem_out_109343.references = NULL;
    
    struct memblock nu_mem_107607;
    
    nu_mem_107607.references = NULL;
    
    struct memblock B_mem_107606;
    
    B_mem_107606.references = NULL;
    
    struct memblock mu_mem_107605;
    
    mu_mem_107605.references = NULL;
    
    struct memblock A_mem_107604;
    
    A_mem_107604.references = NULL;
    rho1_33564 = in0;
    rho2_33565 = in1;
    eps_33566 = in2;
    A_mem_107604 = in3->mem;
    mz2081Uz2084U_33563 = in3->shape[0];
    mz2081Uz2084U_33563 = in3->shape[1];
    mu_mem_107605 = in4->mem;
    mz2081Uz2084U_33563 = in4->shape[0];
    B_mem_107606 = in5->mem;
    mz2081Uz2084U_33563 = in5->shape[0];
    mz2081Uz2084U_33563 = in5->shape[1];
    nu_mem_107607 = in6->mem;
    mz2081Uz2084U_33563 = in6->shape[0];
    exp_absorb_cutoff_33571 = in7;
    safe_for_exp_33572 = in8;
    tol_sinkhorn_33573 = in9;
    tol_outerloop_33574 = in10;
    if (!((mz2081Uz2084U_33563 == in3->shape[0] && mz2081Uz2084U_33563 == in3->shape[1]) && (mz2081Uz2084U_33563 == in4->shape[0] && ((mz2081Uz2084U_33563 == in5->shape[0] && mz2081Uz2084U_33563 == in5->shape[1]) && mz2081Uz2084U_33563 == in6->shape[0])))) {
        ret = 1;
        set_error(ctx, msgprintf("Error: entry point arguments have invalid sizes.\n"));
    }
    if (ret == 0) {
        ret = futrts_entry_ugw_armijo(ctx, &mem_out_109343, A_mem_107604, mu_mem_107605, B_mem_107606, nu_mem_107607, mz2081Uz2084U_33563, rho1_33564, rho2_33565, eps_33566, exp_absorb_cutoff_33571, safe_for_exp_33572, tol_sinkhorn_33573, tol_outerloop_33574);
        if (ret == 0) {
            assert((*out0 = (struct futhark_f64_1d *) malloc(sizeof(struct futhark_f64_1d))) != NULL);
            (*out0)->mem = mem_out_109343;
            (*out0)->shape[0] = (int64_t) 5;
        }
    }
    lock_unlock(&ctx->lock);
    return ret;
}
int futhark_entry_ugw_armijo_euclidean(struct futhark_context *ctx, struct futhark_f64_2d **out0, const double in0, const double in1, const double in2, const struct futhark_f64_3d *in3, const double in4, const double in5, const double in6, const double in7)
{
    int64_t k_34109 = (int64_t) 0;
    int64_t m_34110 = (int64_t) 0;
    int64_t d_34111 = (int64_t) 0;
    double rho1_34112 = 0.0;
    double rho2_34113 = 0.0;
    double eps_34114 = 0.0;
    double exp_absorb_cutoff_34116 = 0.0;
    double safe_for_exp_34117 = 0.0;
    double tol_sinkhorn_34118 = 0.0;
    double tol_outerloop_34119 = 0.0;
    int64_t prim_out_109344 = (int64_t) 0;
    int ret = 0;
    
    lock_lock(&ctx->lock);
    
    struct memblock mem_out_109343;
    
    mem_out_109343.references = NULL;
    
    struct memblock pt_clouds_mem_107604;
    
    pt_clouds_mem_107604.references = NULL;
    rho1_34112 = in0;
    rho2_34113 = in1;
    eps_34114 = in2;
    pt_clouds_mem_107604 = in3->mem;
    k_34109 = in3->shape[0];
    m_34110 = in3->shape[1];
    d_34111 = in3->shape[2];
    exp_absorb_cutoff_34116 = in4;
    safe_for_exp_34117 = in5;
    tol_sinkhorn_34118 = in6;
    tol_outerloop_34119 = in7;
    if (!(k_34109 == in3->shape[0] && (m_34110 == in3->shape[1] && d_34111 == in3->shape[2]))) {
        ret = 1;
        set_error(ctx, msgprintf("Error: entry point arguments have invalid sizes.\n"));
    }
    if (ret == 0) {
        ret = futrts_entry_ugw_armijo_euclidean(ctx, &mem_out_109343, &prim_out_109344, pt_clouds_mem_107604, k_34109, m_34110, d_34111, rho1_34112, rho2_34113, eps_34114, exp_absorb_cutoff_34116, safe_for_exp_34117, tol_sinkhorn_34118, tol_outerloop_34119);
        if (ret == 0) {
            assert((*out0 = (struct futhark_f64_2d *) malloc(sizeof(struct futhark_f64_2d))) != NULL);
            (*out0)->mem = mem_out_109343;
            (*out0)->shape[0] = prim_out_109344;
            (*out0)->shape[1] = (int64_t) 5;
        }
    }
    lock_unlock(&ctx->lock);
    return ret;
}
int futhark_entry_ugw_armijo_pairwise(struct futhark_context *ctx, struct futhark_f64_2d **out0, const double in0, const double in1, const double in2, const struct futhark_f64_3d *in3, const struct futhark_f64_2d *in4, const double in5, const double in6, const double in7, const double in8)
{
    int64_t k_33497 = (int64_t) 0;
    int64_t m_33498 = (int64_t) 0;
    double rho1_33499 = 0.0;
    double rho2_33500 = 0.0;
    double eps_33501 = 0.0;
    double exp_absorb_cutoff_33504 = 0.0;
    double safe_for_exp_33505 = 0.0;
    double tol_sinkhorn_33506 = 0.0;
    double tol_outerloop_33507 = 0.0;
    int64_t prim_out_109344 = (int64_t) 0;
    int ret = 0;
    
    lock_lock(&ctx->lock);
    
    struct memblock mem_out_109343;
    
    mem_out_109343.references = NULL;
    
    struct memblock distrs_mem_107605;
    
    distrs_mem_107605.references = NULL;
    
    struct memblock A_mem_107604;
    
    A_mem_107604.references = NULL;
    rho1_33499 = in0;
    rho2_33500 = in1;
    eps_33501 = in2;
    A_mem_107604 = in3->mem;
    k_33497 = in3->shape[0];
    m_33498 = in3->shape[1];
    m_33498 = in3->shape[2];
    distrs_mem_107605 = in4->mem;
    k_33497 = in4->shape[0];
    m_33498 = in4->shape[1];
    exp_absorb_cutoff_33504 = in5;
    safe_for_exp_33505 = in6;
    tol_sinkhorn_33506 = in7;
    tol_outerloop_33507 = in8;
    if (!((k_33497 == in3->shape[0] && (m_33498 == in3->shape[1] && m_33498 == in3->shape[2])) && (k_33497 == in4->shape[0] && m_33498 == in4->shape[1]))) {
        ret = 1;
        set_error(ctx, msgprintf("Error: entry point arguments have invalid sizes.\n"));
    }
    if (ret == 0) {
        ret = futrts_entry_ugw_armijo_pairwise(ctx, &mem_out_109343, &prim_out_109344, A_mem_107604, distrs_mem_107605, k_33497, m_33498, rho1_33499, rho2_33500, eps_33501, exp_absorb_cutoff_33504, safe_for_exp_33505, tol_sinkhorn_33506, tol_outerloop_33507);
        if (ret == 0) {
            assert((*out0 = (struct futhark_f64_2d *) malloc(sizeof(struct futhark_f64_2d))) != NULL);
            (*out0)->mem = mem_out_109343;
            (*out0)->shape[0] = prim_out_109344;
            (*out0)->shape[1] = (int64_t) 5;
        }
    }
    lock_unlock(&ctx->lock);
    return ret;
}
int futhark_entry_ugw_armijo_pairwise_unif(struct futhark_context *ctx, struct futhark_f64_2d **out0, const double in0, const double in1, const double in2, const struct futhark_f64_3d *in3, const double in4, const double in5, const double in6, const double in7)
{
    int64_t k_33767 = (int64_t) 0;
    int64_t m_33768 = (int64_t) 0;
    double rho1_33769 = 0.0;
    double rho2_33770 = 0.0;
    double eps_33771 = 0.0;
    double exp_absorb_cutoff_33773 = 0.0;
    double safe_for_exp_33774 = 0.0;
    double tol_sinkhorn_33775 = 0.0;
    double tol_outerloop_33776 = 0.0;
    int64_t prim_out_109344 = (int64_t) 0;
    int ret = 0;
    
    lock_lock(&ctx->lock);
    
    struct memblock mem_out_109343;
    
    mem_out_109343.references = NULL;
    
    struct memblock A_mem_107604;
    
    A_mem_107604.references = NULL;
    rho1_33769 = in0;
    rho2_33770 = in1;
    eps_33771 = in2;
    A_mem_107604 = in3->mem;
    k_33767 = in3->shape[0];
    m_33768 = in3->shape[1];
    m_33768 = in3->shape[2];
    exp_absorb_cutoff_33773 = in4;
    safe_for_exp_33774 = in5;
    tol_sinkhorn_33775 = in6;
    tol_outerloop_33776 = in7;
    if (!(k_33767 == in3->shape[0] && (m_33768 == in3->shape[1] && m_33768 == in3->shape[2]))) {
        ret = 1;
        set_error(ctx, msgprintf("Error: entry point arguments have invalid sizes.\n"));
    }
    if (ret == 0) {
        ret = futrts_entry_ugw_armijo_pairwise_unif(ctx, &mem_out_109343, &prim_out_109344, A_mem_107604, k_33767, m_33768, rho1_33769, rho2_33770, eps_33771, exp_absorb_cutoff_33773, safe_for_exp_33774, tol_sinkhorn_33775, tol_outerloop_33776);
        if (ret == 0) {
            assert((*out0 = (struct futhark_f64_2d *) malloc(sizeof(struct futhark_f64_2d))) != NULL);
            (*out0)->mem = mem_out_109343;
            (*out0)->shape[0] = prim_out_109344;
            (*out0)->shape[1] = (int64_t) 5;
        }
    }
    lock_unlock(&ctx->lock);
    return ret;
}
  
